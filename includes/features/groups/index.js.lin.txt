     1	/** Grupos – Frontend (gestión simple)
     2	 * Requiere que el PHP haya localizado window.str_groups_ajax_obj (ver enqueue).
     3	 * Este fichero:
     4	 *  - Carga grupos + parejas libres
     5	 *  - Crea grupos (modal; con fallback a prompt)
     6	 *  - Asigna/Quita parejas en grupos
     7	 *  - Recalcula standings
     8	 */
     9	
    10	/* ────────────────────────────────────────────────────────────────
    11	   SHIM: crea window.strTorneo a partir de str_groups_ajax_obj
    12	   ──────────────────────────────────────────────────────────────── */
    13	(function (w) {
    14	  if (w.strTorneo) return;
    15	  var S = w.str_groups_ajax_obj || {};
    16	  if (!S || !S.ajax_url || !S.post_id) return;
    17	  var A = (S.actions || {});
    18	  w.strTorneo = {
    19	    ajaxUrl: S.ajax_url,
    20	    nonce:  S.nonce || '',
    21	    competicionId: parseInt(S.post_id, 10) || 0,
    22	    actions: {
    23	      cargar:    A.cargar    || 'saas_grupos_cargar',
    24	      aleatorio: A.aleatorio || 'saas_grupos_aleatorio',
    25	      asignar:   A.asignar   || 'saas_grupo_asignar',
    26	      standings: A.standings || 'saas_grupos_standings',
    27	      bracket:   A.bracket   || 'saas_bracket_volcar',
    28	      crear:     A.crear     || 'saas_grupo_crear',
    29	      quitar:    A.quitar    || 'saas_grupo_quitar'
    30	    }
    31	  };
    32	})(window);
    33	
    34	(function () {
    35	  "use strict";
    36	
    37	  // ---- GUARD: evita doble inicialización si el script se carga dos veces ----
    38	  if (window.__STR_GROUPS_BOOTED__) { try { console.warn('[GROUPS] Ya inicializado; salto.'); } catch(e) {} return; }
    39	  window.__STR_GROUPS_BOOTED__ = true;
    40	
    41	  // ────────────────────────────────────────────────────────────
    42	  // Utilidades / Config
    43	  // ────────────────────────────────────────────────────────────
    44	  const cfg = (window && window.strTorneo) ? window.strTorneo : {};
    45	  const AJAX = cfg.ajaxUrl || (window.ajaxurl || "/wp-admin/admin-ajax.php");
    46	  const NONCE = cfg.nonce || "";
    47	  const COMP_ID = parseInt(cfg.competicionId || 0, 10);
    48	  const ACTIONS = Object.assign({
    49	    crear:     'saas_grupo_crear',
    50	    cargar:    'saas_grupos_cargar',
    51	    asignar:   'saas_grupo_asignar',
    52	    quitar:    'saas_grupo_quitar',
    53	    aleatorio: 'saas_grupos_aleatorio',
    54	    standings: 'saas_grupos_standings',
    55	    bracket:   'saas_bracket_volcar',
    56	  }, (cfg.actions || {}));
    57	
    58	  const qs  = (sel) => document.querySelector(sel);
    59	  const qsa = (sel) => Array.from(document.querySelectorAll(sel));
    60	
    61	  // --- Supresión temporal del modal de "parejas" cuando operamos en grupos ---
    62	  function suppressPairsModal(ms = 4000) {
    63	    try { window.__STR_SUPPRESS_PAIRS_MODAL__ = Date.now() + ms; } catch(_) {}
    64	  }
    65	  function isPairsSuppressed() {
    66	    try { return window.__STR_SUPPRESS_PAIRS_MODAL__ && Date.now() < window.__STR_SUPPRESS_PAIRS_MODAL__; } catch(_) { return false; }
    67	  }
    68	
    69	  function encode(data) {
    70	    return Object.keys(data)
    71	      .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(data[k] == null ? "" : data[k]))
    72	      .join("&");
    73	  }
    74	
    75	  async function postAjax(action, data = {}) {
    76	    const payload = Object.assign({}, data, {
    77	      action,
    78	      nonce: NONCE,
    79	      _ajax_nonce: NONCE
    80	    });
    81	
    82	    const res = await fetch(AJAX, {
    83	      method: "POST",
    84	      credentials: "same-origin",
    85	      headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
    86	      body: encode(payload),
    87	    });
    88	
    89	    try {
    90	      const json = await res.json();
    91	      if (json && json.success) return json.data;
    92	      const msg = (json && (json.data?.message || json.message)) || "Error AJAX (success=false)";
    93	      throw new Error(msg);
    94	    } catch (e) {
    95	      let raw = "";
    96	      try { raw = await res.text(); } catch (_){}
    97	      if (!(e instanceof Error && e.message === "Unexpected end of JSON input")) {
    98	        console.error("[GRUPOS] AJAX error:", e.message, "RAW:", raw);
    99	        throw e;
   100	      }
   101	      console.error("[GRUPOS] Respuesta no JSON:", raw);
   102	      throw new Error("Respuesta no válida del servidor (no JSON).");
   103	    }
   104	  }
   105	
   106	  window.__STR_GROUPS_POST__ = postAjax;
   107	
   108	  function htmlEscape(str){
   109	    if(str==null) return "";
   110	    return String(str).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
   111	  }
   112	
   113	  // ⚠️ NUEVO HELPER: marcar error en el <select> sin usar alert()
   114	  function showSelectError(sel, message = "Selecciona una pareja libre.") {
   115	    if (!sel) return;
   116	    const wrap = sel.closest('.str-card-foot') || sel.parentElement;
   117	
   118	    sel.classList.add('str-field-error');
   119	    sel.setAttribute('aria-invalid', 'true');
   120	
   121	    let msg = wrap && wrap.querySelector('.str-inline-error');
   122	    if (!msg && wrap) {
   123	      msg = document.createElement('div');
   124	      msg.className = 'str-inline-error';
   125	      msg.textContent = message;
   126	      wrap.appendChild(msg);
   127	    } else if (msg) {
   128	      msg.textContent = message;
   129	    }
   130	
   131	    sel.focus();
   132	
   133	    setTimeout(() => {
   134	      if (msg && msg.parentNode) msg.parentNode.removeChild(msg);
   135	      sel.classList.remove('str-field-error');
   136	      sel.removeAttribute('aria-invalid');
   137	    }, 2200);
   138	  }
   139	
   140	  // ────────────────────────────────────────────────────────────
   141	  // Estado
   142	  // ────────────────────────────────────────────────────────────
   143	  const state = {
   144	    meta: { n_grupos: 0, n_parejas: 0, fase_final: "", modo_final: "" },
   145	    grupos: [],       // [{id, letra, tam, participantes:[{id,title,puntos?}]}]
   146	    libres: [],       // [{id,title}]
   147	    loading: false
   148	  };
   149	
   150	  // ────────────────────────────────────────────────────────────
   151	  // (OPCIÓN A) Declaración HOISTED del submit del modal
   152	  // ────────────────────────────────────────────────────────────
   153	  async function submitCreateModal() {
   154	    const btn  = document.getElementById('str-modal-create-btn');
   155	    const err  = document.getElementById('str-modal-err');
   156	    const name = (document.getElementById('str-modal-name')?.value || '').trim();
   157	
   158	    if (!COMP_ID) {
   159	      if (err) err.textContent = 'Competición inválida.', err.classList.add('show');
   160	      return;
   161	    }
   162	
   163	    try {
   164	      if (btn) btn.disabled = true, btn.textContent = 'Creando…';
   165	      await postAjax(ACTIONS.crear || 'saas_grupo_crear', { competicion_id: COMP_ID, nombre: name });
   166	      await Promise.all([
   167	        (typeof cargarGrupos === 'function' ? cargarGrupos() : Promise.resolve()),
   168	        (typeof cargarStandings === 'function' ? cargarStandings() : Promise.resolve()),
   169	      ]);
   170	      closeCreateModal();
   171	    } catch (e) {
   172	      if (err) {
   173	        err.textContent = (e && e.message) ? e.message : 'No se pudo crear el grupo.';
   174	        err.classList.add('show');
   175	      } else {
   176	        alert(e && e.message ? e.message : 'No se pudo crear el grupo.');
   177	      }
   178	    } finally {
   179	      if (btn) btn.disabled = false, btn.textContent = 'Crear';
   180	    }
   181	  }
   182	
   183	  // ────────────────────────────────────────────────────────────
   184	  // Modal "Crear grupo"
   185	  // ────────────────────────────────────────────────────────────
   186	  function ensureCreateModal() {
   187	    if (document.getElementById('str-modal-create-group')) return;
   188	
   189	    const overlay = document.createElement('div');
   190	    overlay.className = 'str-modal-overlay';
   191	    overlay.id = 'str-modal-overlay';
   192	
   193	    const modal = document.createElement('div');
   194	    modal.className = 'str-modal';
   195	    modal.id = 'str-modal-create-group';
   196	    modal.setAttribute('role', 'dialog');
   197	    modal.setAttribute('aria-modal', 'true');
   198	    modal.setAttribute('aria-labelledby', 'str-modal-create-title');
   199	
   200	    modal.innerHTML = `
   201	      <div class="str-modal-dialog" role="document">
   202	        <div class="str-modal-head">
   203	          <h3 class="str-modal-title" id="str-modal-create-title">Crear grupo</h3>
   204	        </div>
   205	        <div class="str-modal-body">
   206	          <form id="str-modal-create-form">
   207	            <div class="str-field">
   208	              <label for="str-modal-name">Nombre del grupo <span class="str-muted">(opcional, ej. A, B, C)</span></label>
   209	              <input type="text" id="str-modal-name" name="nombre" placeholder="A, B, C…" autocomplete="off" />
   210	              <div id="str-modal-err" class="str-error"></div>
   211	            </div>
   212	            <input type="hidden" id="str-modal-capacity" name="capacidad" value="" />
   213	          </form>
   214	        </div>
   215	        <div class="str-modal-foot">
   216	          <button type="button" class="str-btn" id="str-modal-cancel">Cancelar</button>
   217	          <button type="button" class="str-btn str-btn-primary" id="str-modal-create-btn">Crear</button>
   218	        </div>
   219	      </div>
   220	    `;
   221	
   222	    document.body.appendChild(overlay);
   223	    document.body.appendChild(modal);
   224	
   225	    overlay.addEventListener('click', closeCreateModal);
   226	    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeCreateModal(); });
   227	
   228	    // 👉 Aquí usamos la función hoisted
   229	    document.getElementById('str-modal-cancel')?.addEventListener('click', closeCreateModal);
   230	    document.getElementById('str-modal-create-btn')?.addEventListener('click', submitCreateModal);
   231	    document.getElementById('str-modal-create-form')?.addEventListener('submit', (e) => {
   232	      e.preventDefault();
   233	      submitCreateModal();
   234	    });
   235	  }
   236	
   237	  function openCreateModal() {
   238	    ensureCreateModal();
   239	    const overlay = document.getElementById('str-modal-overlay');
   240	    const modal   = document.getElementById('str-modal-create-group');
   241	    const input   = document.getElementById('str-modal-name');
   242	    const err     = document.getElementById('str-modal-err');
   243	
   244	    if (err) err.classList.remove('show'), (err.textContent = '');
   245	    overlay?.classList.add('show');
   246	    modal?.classList.add('show');
   247	    setTimeout(() => input?.focus(), 30);
   248	    trapFocus(modal);
   249	  }
   250	
   251	  function closeCreateModal() {
   252	    const overlay = document.getElementById('str-modal-overlay');
   253	    const modal   = document.getElementById('str-modal-create-group');
   254	    overlay?.classList.remove('show');
   255	    modal?.classList.remove('show');
   256	  }
   257	
   258	  function trapFocus(container) {
   259	    if (!container) return;
   260	    const focusables = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
   261	    const list = Array.from(focusables);
   262	    if (list.length === 0) return;
   263	    const first = list[0], last = list[list.length - 1];
   264	    container.addEventListener('keydown', function onKey(e) {
   265	      if (e.key !== 'Tab') return;
   266	      if (e.shiftKey) {
   267	        if (document.activeElement === first) { last.focus(); e.preventDefault(); }
   268	      } else {
   269	        if (document.activeElement === last) { first.focus(); e.preventDefault(); }
   270	      }
   271	    });
   272	  }
   273	
   274	  // ────────────────────────────────────────────────────────────
   275	  // Render UI
   276	  // ────────────────────────────────────────────────────────────
   277	  function ensureRoot() {
   278	    let mount = document.getElementById('str-gestion-grupos');
   279	    if (!mount) {
   280	      mount = document.createElement('div');
   281	      mount.id = 'str-gestion-grupos';
   282	      document.body.appendChild(mount);
   283	      try { console.info('[GROUPS] No existía #str-gestion-grupos. Se ha inyectado al final del <body>.'); } catch(_) {}
   284	    }
   285	    return mount;
   286	  }
   287	
   288	  function render() {
   289	    const wrap = ensureRoot();
   290	
   291	    const topBar = `
   292	      <div class="str-topbar">
   293	        <div class="str-topbar-left">
   294	          <div class="muted">Competición: #${COMP_ID}</div>
   295	          <div class="muted">Grupos: ${state.meta.n_grupos || state.grupos.length}</div>
   296	          <div class="muted">Parejas libres: ${state.libres.length}</div>
   297	        </div>
   298	        <div class="str-topbar-right">
   299	          <button id="btn-crear-grupo" class="str-btn str-btn-primary" type="button">Crear grupo</button>
   300	        </div>
   301	      </div>
   302	    `;
   303	
   304	    const libresOpt = state.libres.map(p => `<option value="${p.id}">${htmlEscape(p.title)}</option>`).join("");
   305	
   306	    const cards = state.grupos.map(g => {
   307	      // Cabecera de columnas dentro del card
   308	      const headRow = `
   309	        <li class="str-row str-row-head">
   310	          <div class="str-pair-name"><span>Pareja</span></div>
   311	          <div class="str-points"><span>Puntos</span></div>
   312	          <div class="str-actions"><span>Acciones</span></div>
   313	        </li>
   314	      `;
   315	
   316	      const filas = (g.participantes || []).map(p => {
   317	        const pts = (typeof p.puntos === 'number' ? p.puntos : 0);
   318	        return `
   319	          <li class="str-row">
   320	            <div class="str-pair-name">${htmlEscape(p.title)}</div>
   321	            <div class="str-points">
   322	              <input class="str-points-input" type="number" min="0" step="1"
   323	                     value="${pts}" inputmode="numeric" aria-label="Puntos" disabled />
   324	            </div>
   325	            <div class="str-actions">
   326	              <button class="str-btn str-btn-small str-btn-remove"
   327	                      data-grupo="${g.id}" data-pareja="${p.id}" type="button">Quitar</button>
   328	            </div>
   329	          </li>
   330	        `;
   331	      }).join("");
   332	
   333	      return `
   334	        <div class="str-card grupo" data-grupo="${g.id}">
   335	          <div class="str-card-head">
   336	            <div class="title">Grupo <b>${htmlEscape(g.letra || g.nombre || "?")}</b></div>
   337	            <div class="sub">Capacidad: ${g.tam ?? "-"} · Ocupadas: ${(g.participantes||[]).length}</div>
   338	          </div>
   339	
   340	          <ul class="str-list">
   341	            ${headRow}
   342	            ${filas || `<li class="str-row"><em>Sin participantes</em></li>`}
   343	          </ul>
   344	
   345	          <div class="str-card-foot">
   346	            <div class="str-add">
   347	              <select class="str-add-select">
   348	                <option value="">— Añadir pareja libre —</option>
   349	                ${libresOpt}
   350	              </select>
   351	              <button class="str-btn str-btn-small str-btn-add" type="button">Añadir</button>
   352	            </div>
   353	          </div>
   354	        </div>
   355	      `;
   356	    }).join("");
   357	
   358	    const html = `
   359	      ${topBar}
   360	      <div class="str-free-select">
   361	        <label class="muted">Parejas libres en este torneo</label>
   362	        <select id="str-free-select"><option value="">— Selecciona una pareja —</option>${libresOpt}</select>
   363	        <div class="muted">Puedes elegirla en el selector de cada grupo.</div>
   364	      </div>
   365	      <div class="str-grid-groups">${cards}</div>
   366	    `;
   367	    wrap.innerHTML = html;
   368	
   369	    // listeners
   370	    const btnCrear = qs("#btn-crear-grupo");
   371	    if (btnCrear) btnCrear.addEventListener("click", onCrearGrupo);
   372	
   373	    // ⚠️ CAMBIO: sin alert(); validación inline con showSelectError()
   374	    qsa(".str-btn-add").forEach(btn => {
   375	      btn.addEventListener("click", async () => {
   376	        const card = btn.closest(".str-card.grupo");
   377	        const gid  = parseInt(card?.getAttribute("data-grupo") || "0", 10);
   378	        const sel  = card?.querySelector(".str-add-select");
   379	        const pid  = sel ? parseInt(sel.value || "0", 10) : 0;
   380	
   381	        if (!gid || !pid) {
   382	          showSelectError(sel, "Selecciona una pareja libre.");
   383	          return;
   384	        }
   385	
   386	        try {
   387	          suppressPairsModal(5000);
   388	          btn.disabled = true; btn.textContent = "Añadiendo...";
   389	          await asignarPareja(gid, pid);
   390	          await recargar();
   391	        } catch (e) {
   392	          console.error(e); alert(e.message || "No se pudo añadir.");
   393	        } finally {
   394	          btn.disabled = false; btn.textContent = "Añadir";
   395	        }
   396	      });
   397	    });
   398	
   399	    qsa(".str-btn-remove").forEach(btn => {
   400	      btn.addEventListener("click", async () => {
   401	        const gid = parseInt(btn.getAttribute("data-grupo") || "0", 10);
   402	        const pid = parseInt(btn.getAttribute("data-pareja") || "0", 10);
   403	        if (!gid || !pid) return;
   404	        try {
   405	          btn.disabled = true; btn.textContent = "Quitando...";
   406	          await quitarPareja(gid, pid);
   407	          await recargar();
   408	        } catch (e) {
   409	          console.error(e); alert(e.message || "No se pudo quitar.");
   410	        } finally {
   411	          btn.disabled = false; btn.textContent = "Quitar";
   412	        }
   413	      });
   414	    });
   415	  }
   416	
   417	  // ────────────────────────────────────────────────────────────
   418	  // Acciones
   419	  // ────────────────────────────────────────────────────────────
   420	  async function cargarGrupos() {
   421	    if (!COMP_ID) return;
   422	    const data = await postAjax(ACTIONS.cargar, { competicion_id: COMP_ID });
   423	    state.meta   = data.meta   || state.meta;
   424	    state.grupos = Array.isArray(data.grupos) ? data.grupos : [];
   425	    state.libres = Array.isArray(data.parejas_libres) ? data.parejas_libres : [];
   426	  }
   427	
   428	  async function cargarStandings() {
   429	    try {
   430	      const data = await postAjax(ACTIONS.standings, { competicion_id: COMP_ID });
   431	      const wrap = qs("#str-standings");
   432	      if (wrap) {
   433	        wrap.innerHTML = `<div class="str-card"><div class="str-card-body"><em>Clasificación actualizada.</em></div></div>`;
   434	      }
   435	      void data;
   436	    } catch (e) {
   437	      console.error(e);
   438	    }
   439	  }
   440	
   441	  async function recargar() {
   442	    await Promise.all([cargarGrupos(), cargarStandings()]);
   443	    render();
   444	  }
   445	
   446	  // Abre modal (con fallback defensivo a prompt)
   447	  async function onCrearGrupo() {
   448	    try {
   449	      openCreateModal();
   450	    } catch (e) {
   451	      let nombre = window.prompt("Nombre del grupo (ej. A, B, C). Deja vacío para autogenerar:");
   452	      if (nombre == null) return; // cancel
   453	      nombre = String(nombre).trim();
   454	      try {
   455	        await postAjax(ACTIONS.crear, { competicion_id: COMP_ID, nombre });
   456	        await recargar();
   457	      } catch (err) {
   458	        console.error(err); alert(err.message || "No se pudo crear el grupo.");
   459	      }
   460	    }
   461	  }
   462	
   463	  async function asignarPareja(grupoId, parejaId) {
   464	    return postAjax(ACTIONS.asignar || 'saas_grupo_asignar', {
   465	      competicion_id: COMP_ID,
   466	      grupo_id: grupoId,
   467	      pareja_id: parejaId
   468	    });
   469	  }
   470	
   471	  async function quitarPareja(grupoId, parejaId) {
   472	    return postAjax(ACTIONS.quitar || 'saas_grupo_quitar', {
   473	      competicion_id: COMP_ID,
   474	      grupo_id: grupoId,
   475	      pareja_id: parejaId
   476	    });
   477	  }
   478	
   479	  // ────────────────────────────────────────────────────────────
   480	  // Init
   481	  // ────────────────────────────────────────────────────────────
   482	  document.addEventListener("DOMContentLoaded", async () => {
   483	    if (!COMP_ID) return;
   484	    try {
   485	      ensureCreateModal();  // modal montado desde el inicio
   486	      await cargarGrupos();
   487	      render();
   488	      await cargarStandings();
   489	      console.info('[GROUPS][BOOT]', { AJAX, NONCE, COMP_ID, from: {strTorneo: !!window.strTorneo, str_groups_ajax_obj: !!window.str_groups_ajax_obj}, ACTIONS });
   490	    } catch (e) {
   491	      console.error(e);
   492	    }
   493	  });
   494	
   495	  // Interceptores en captura
   496	  document.addEventListener('click', function (e) {
   497	    const btn = e.target && e.target.closest && e.target.closest('#btn-crear-grupo');
   498	    if (!btn) return;
   499	    e.preventDefault();
   500	    e.stopPropagation();
   501	    e.stopImmediatePropagation();
   502	    try {
   503	      openCreateModal();
   504	    } catch (err) {
   505	      console.error('[GROUPS][MODAL] fallback por error:', err);
   506	      const nombre = window.prompt("Nombre del grupo (ej. A, B, C). Deja vacío para autogenerar:");
   507	      if (nombre != null) {
   508	        postAjax(ACTIONS.crear || 'saas_grupo_crear', {
   509	          competicion_id: COMP_ID,
   510	          nombre: String(nombre).trim()
   511	        }).then(() => {
   512	          return Promise.all([
   513	            (typeof cargarGrupos === 'function' ? cargarGrupos() : Promise.resolve()),
   514	            (typeof cargarStandings === 'function' ? cargarStandings() : Promise.resolve())
   515	          ]);
   516	        }).then(render)
   517	          .catch((e) => alert(e && e.message ? e.message : 'No se pudo crear el grupo.'));
   518	      }
   519	    }
   520	  }, true);
   521	
   522	  document.addEventListener('click', function (e) {
   523	    const addBtn = e.target && e.target.closest && e.target.closest('#str-gestion-grupos .str-btn-add');
   524	    if (!addBtn) return;
   525	    e.stopPropagation();
   526	    e.stopImmediatePropagation();
   527	  }, true);
   528	
   529	})();
   530	
   531	/* ============================================================
   532	   DEBUG TRACE – clicks + llamadas AJAX (admin-ajax.php)
   533	   (Elimina este bloque cuando acabes de depurar)
   534	   ============================================================ */
   535	(function () {
   536	  try {
   537	    var SELECTORES_INTERES = [
   538	      '.str-btn-add',
   539	      '.js-add-pareja',
   540	      '.js-add-pareja-grupo',
   541	      '#btn-abrir-modal-pareja',
   542	      '.js-add-jugador',
   543	      '#btn-abrir-modal-invitacion-jugador'
   544	    ];
   545	
   546	    function matchedSelector(el) {
   547	      for (var i=0;i<SELECTORES_INTERES.length;i++){
   548	        try { if (el.matches(SELECTORES_INTERES[i])) return SELECTORES_INTERES[i]; } catch(_) {}
   549	      }
   550	      return null;
   551	    }
   552	
   553	    document.addEventListener('click', function (e) {
   554	      var el = e.target, depth = 0, hit = null;
   555	      while (el && depth < 6 && !hit) {
   556	        var m = matchedSelector(el);
   557	        if (m) hit = { node: el, selector: m };
   558	        el = el.parentElement; depth++;
   559	      }
   560	      if (!hit) return;
   561	
   562	      var text = (hit.node.textContent || '').trim().slice(0,120);
   563	      console.groupCollapsed(
   564	        '%c[TRACE CLICK]%c ' + hit.selector + '  %c' + (text || '(sin texto)'),
   565	        'color:#0ea5e9;font-weight:700', 'color:inherit', 'color:#64748b'
   566	      );
   567	      console.log('Elemento que hizo match:', hit.node);
   568	      if (hit.node.dataset) console.log('dataset:', JSON.parse(JSON.stringify(hit.node.dataset)));
   569	      console.trace('Stack');
   570	      console.groupEnd();
   571	    }, true);
   572	
   573	    if (typeof window.fetch === 'function') {
   574	      var _fetch = window.fetch;
   575	      window.fetch = function (input, init) {
   576	        try {
   577	          var url = (typeof input === 'string') ? input : (input && input.url) || '';
   578	          if (url.indexOf('/wp-admin/admin-ajax.php') !== -1) {
   579	            var method = (init && init.method) ? String(init.method).toUpperCase() : 'GET';
   580	            var bodyStr = '';
   581	            if (init && init.body) {
   582	              if (typeof init.body === 'string') bodyStr = init.body;
   583	              else if (init.body instanceof URLSearchParams) bodyStr = init.body.toString();
   584	              else if (typeof FormData !== 'undefined' && init.body instanceof FormData) {
   585	                var tmp=[]; init.body.forEach(function(v,k){ tmp.push(encodeURIComponent(k)+'='+encodeURIComponent(v)); });
   586	                bodyStr = tmp.join('&');
   587	              }
   588	            }
   589	            var m = bodyStr.match(/(?:^|&|;)action=([^&;]+)/i);
   590	            var actionName = m ? decodeURIComponent(m[1]) : '(sin action)';
   591	            console.groupCollapsed(
   592	              '%c[TRACE AJAX]%c ' + method + ' admin-ajax.php  %caction=' + actionName,
   593	              'color:#22c55e;font-weight:700', 'color:inherit', 'color:#64748b'
   594	            );
   595	            if (bodyStr) console.log('Body:', bodyStr.length>500 ? bodyStr.slice(0,500)+'…' : bodyStr);
   596	            console.trace('Stack');
   597	            console.groupEnd();
   598	          }
   599	        } catch (_) {}
   600	        return _fetch.apply(this, arguments);
   601	      };
   602	    }
   603	
   604	    if (window.jQuery && window.jQuery.ajax) {
   605	      (function ($) {
   606	        var _ajax = $.ajax;
   607	        $.ajax = function (opts) {
   608	          try {
   609	            var url = (typeof opts === 'string') ? opts : (opts && opts.url) || '';
   610	            if (url.indexOf('/wp-admin/admin-ajax.php') !== -1) {
   611	              var dataStr = '';
   612	              if (opts && opts.data) {
   613	                if (typeof opts.data === 'string') dataStr = opts.data;
   614	                else if (opts.data instanceof URLSearchParams) dataStr = opts.data.toString();
   615	                else if (typeof opts.data === 'object') {
   616	                  var parts=[]; for (var k in opts.data){ if(Object.prototype.hasOwnProperty.call(opts.data,k)){ parts.push(encodeURIComponent(k)+'='+encodeURIComponent(opts.data[k])); } }
   617	                  dataStr = parts.join('&');
   618	                }
   619	              }
   620	              var m = dataStr.match(/(?:^|&|;)action=([^&;]+)/i);
   621	              var actionName = m ? decodeURIComponent(m[1]) : '(sin action)';
   622	              console.groupCollapsed(
   623	                '%c[TRACE jQ.AJAX]%c admin-ajax.php  %caction=' + actionName,
   624	                'color:#84cc16;font-weight:700', 'color:inherit', 'color:#64748b'
   625	              );
   626	              if (dataStr) console.log('Data:', dataStr.length>500 ? dataStr.slice(0,500)+'…' : dataStr);
   627	              console.trace('Stack');
   628	              console.groupEnd();
   629	            }
   630	          } catch(_) {}
   631	          return _ajax.apply(this, arguments);
   632	        };
   633	      })(window.jQuery);
   634	    }
   635	
   636	    console.info('%c[TRACE ACTIVADO]%c Mira la consola: clicks relevantes y AJAX a admin-ajax.php.',
   637	      'color:#0ea5e9;font-weight:700','color:inherit');
   638	  } catch (e) {
   639	    console.error('[TRACE] fallo al inicializar:', e);
   640	  }
   641	})();
