===== BEGIN FILEMAP.json =====
     1	{
     2	  ".git/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/HEAD",
     3	  ".git/config": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/config",
     4	  ".git/description": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/description",
     5	  ".git/hooks/applypatch-msg.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/applypatch-msg.sample",
     6	  ".git/hooks/commit-msg.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/commit-msg.sample",
     7	  ".git/hooks/fsmonitor-watchman.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/fsmonitor-watchman.sample",
     8	  ".git/hooks/post-update.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/post-update.sample",
     9	  ".git/hooks/pre-applypatch.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-applypatch.sample",
    10	  ".git/hooks/pre-commit.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-commit.sample",
    11	  ".git/hooks/pre-merge-commit.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-merge-commit.sample",
    12	  ".git/hooks/pre-push.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-push.sample",
    13	  ".git/hooks/pre-rebase.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-rebase.sample",
    14	  ".git/hooks/pre-receive.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-receive.sample",
    15	  ".git/hooks/prepare-commit-msg.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/prepare-commit-msg.sample",
    16	  ".git/hooks/push-to-checkout.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/push-to-checkout.sample",
    17	  ".git/hooks/sendemail-validate.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/sendemail-validate.sample",
    18	  ".git/hooks/update.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/update.sample",
    19	  ".git/index": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/index",
    20	  ".git/info/exclude": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/info/exclude",
    21	  ".git/logs/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/logs/HEAD",
    22	  ".git/logs/refs/heads/main": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/logs/refs/heads/main",
    23	  ".git/logs/refs/remotes/origin/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/logs/refs/remotes/origin/HEAD",
    24	  ".git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.idx": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.idx",
    25	  ".git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.pack": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.pack",
    26	  ".git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.rev": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.rev",
    27	  ".git/packed-refs": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/packed-refs",
    28	  ".git/refs/heads/main": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/refs/heads/main",
    29	  ".git/refs/remotes/origin/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/refs/remotes/origin/HEAD"
===== END FILEMAP.json =====

===== BEGIN FULLCODE.txt =====
     1	===== BEGIN FILEMAP.json =====
     2	     1	{
     3	     2	  ".git/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/HEAD",
     4	     3	  ".git/config": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/config",
     5	     4	  ".git/description": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/description",
     6	     5	  ".git/hooks/applypatch-msg.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/applypatch-msg.sample",
     7	     6	  ".git/hooks/commit-msg.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/commit-msg.sample",
     8	     7	  ".git/hooks/fsmonitor-watchman.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/fsmonitor-watchman.sample",
     9	     8	  ".git/hooks/post-update.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/post-update.sample",
    10	     9	  ".git/hooks/pre-applypatch.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-applypatch.sample",
    11	    10	  ".git/hooks/pre-commit.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-commit.sample",
    12	    11	  ".git/hooks/pre-merge-commit.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-merge-commit.sample",
    13	    12	  ".git/hooks/pre-push.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-push.sample",
    14	    13	  ".git/hooks/pre-rebase.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-rebase.sample",
    15	    14	  ".git/hooks/pre-receive.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/pre-receive.sample",
    16	    15	  ".git/hooks/prepare-commit-msg.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/prepare-commit-msg.sample",
    17	    16	  ".git/hooks/push-to-checkout.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/push-to-checkout.sample",
    18	    17	  ".git/hooks/sendemail-validate.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/sendemail-validate.sample",
    19	    18	  ".git/hooks/update.sample": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/hooks/update.sample",
    20	    19	  ".git/index": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/index",
    21	    20	  ".git/info/exclude": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/info/exclude",
    22	    21	  ".git/logs/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/logs/HEAD",
    23	    22	  ".git/logs/refs/heads/main": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/logs/refs/heads/main",
    24	    23	  ".git/logs/refs/remotes/origin/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/logs/refs/remotes/origin/HEAD",
    25	    24	  ".git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.idx": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.idx",
    26	    25	  ".git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.pack": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.pack",
    27	    26	  ".git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.rev": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/objects/pack/pack-470d1bf7d18b909405c2e710c2b60ab4d9ea1397.rev",
    28	    27	  ".git/packed-refs": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/packed-refs",
    29	    28	  ".git/refs/heads/main": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/refs/heads/main",
    30	    29	  ".git/refs/remotes/origin/HEAD": "https://raw.githubusercontent.com/siickboyy/saas-torneos-plugin-mirror/main/.git/refs/remotes/origin/HEAD"
    31	===== END FILEMAP.json =====
    32	
===== END FULLCODE.txt =====

===== BEGIN LINMAP.json =====
     1	{
===== END LINMAP.json =====

===== BEGIN assets/css/dashboard-cliente.css =====
     1	/* === dashboard-cliente.css COMPLETO === */
     2	/* ===============================
     3	   TABLA COMPETICIONES PROFESIONAL
     4	   =============================== */
     5	
     6	.str-tabla-header-controls {
     7	  display: flex;
     8	  justify-content: flex-start;
     9	  align-items: center;
    10	  margin-bottom: 0.3rem;
    11	  width: 100%;
    12	}
    13	
    14	.str-table-search-wrapper {
    15	  position: relative;
    16	  display: inline-block;
    17	  width: 100%;
    18	  max-width: 430px;
    19	  margin-bottom: 1rem;
    20	}
    21	
    22	.str-table-search {
    23	  width: 100%;
    24	  padding: 0.65rem 1.1rem 0.65rem 2.8rem;
    25	  border: 1px solid #d0e2ff;
    26	  border-radius: 9px;
    27	  font-size: 1rem;
    28	  outline: none;
    29	  box-shadow: 0 1px 3px rgba(0,85,204,0.04);
    30	  margin-bottom: 0;
    31	  transition: border 0.15s;
    32	  z-index: 1;
    33	}
    34	.str-table-search:focus {
    35	  border-color: #0055cc;
    36	}
    37	@media (max-width: 800px) {
    38	  .str-table-search {
    39	    font-size: 0.96rem;
    40	    padding: 0.5rem 0.6rem 0.5rem 2.4rem;
    41	  }
    42	}
    43	
    44	
    45	/* Tabla */
    46	.str-tabla-wrapper {
    47	  width: 100%;
    48	  overflow-x: auto;
    49	  margin-top: 1.2rem;
    50	}
    51	.str-tabla {
    52	  width: 100%;
    53	  border-collapse: separate;
    54	  border-spacing: 0;
    55	  font-size: 1.01rem;
    56	  min-width: 620px;
    57	  background: #fff;
    58	  border-radius: 16px;
    59	  box-shadow: 0 3px 16px rgba(60,70,100,0.08);
    60	  overflow: hidden;
    61	}
    62	.str-tabla th,
    63	.str-tabla td {
    64	  padding: 0.95rem 1.2rem;
    65	  text-align: left;
    66	  border-bottom: 1px solid #e6eaf1;
    67	  font-weight: 600;
    68	  background: none;
    69	}
    70	.str-tabla th {
    71	  background: #f2f2f2;
    72	  font-size: 1.07rem;
    73	  position: sticky;
    74	  top: 0;
    75	  z-index: 1;
    76	  user-select: none;
    77	  cursor: pointer;
    78	  font-weight: 700;
    79	  vertical-align: middle;
    80	}
    81	.str-tabla th .str-table-sort-icon {
    82	  margin-left: 0.4em;
    83	  font-size: 1em;
    84	  color: #0055cc;
    85	  display: inline-block;
    86	  vertical-align: middle;
    87	}
    88	.str-tabla th:last-child, .str-tabla td:last-child { text-align: center; }
    89	.str-tabla tbody tr {
    90	  transition: background 0.17s;
    91	}
    92	.str-tabla tbody tr:hover {
    93	  background-color: #eaf3ff;
    94	}
    95	.str-tabla tbody tr:nth-child(even) {
    96	  background-color: #f8fbfe;
    97	}
    98	.str-tabla-intro {
    99	  color: #3d455c;
   100	  font-size: 1.08rem;
   101	  margin-bottom: 1.1em;
   102	  margin-top: 0.4em;
   103	  opacity: 0.87;
   104	}
   105	
   106	/* Botón "Ver competición" */
   107	.str-dashboard-btn,
   108	.str-dashboard-btn.str-btn-ver {
   109	  background: #0055cc;
   110	  color: #fff !important;
   111	  border-radius: 7px;
   112	  padding: 0.45rem 1.05rem;
   113	  font-size: 1rem;
   114	  font-weight: 600;
   115	  border: none;
   116	  box-shadow: 0 2px 7px rgba(0,85,204,0.07);
   117	  transition: background 0.18s, transform 0.18s;
   118	  cursor: pointer;
   119	  text-decoration: none !important;
   120	  display: inline-block;
   121	}
   122	.str-dashboard-btn:hover,
   123	.str-dashboard-btn.str-btn-ver:hover {
   124	  background: #003f99;
   125	  color: #fff !important;
   126	  transform: translateY(-2px) scale(1.04);
   127	  text-decoration: none !important;
   128	}
   129	
   130	/* Responsive para la tabla */
   131	@media (max-width: 800px) {
   132	  .str-tabla-wrapper {
   133	    overflow-x: auto;
   134	  }
   135	  .str-tabla {
   136	    min-width: 520px;
   137	    font-size: 0.97rem;
   138	  }
   139	  .str-tabla th, .str-tabla td {
   140	    padding: 0.7rem 0.5rem;
   141	  }
   142	  .str-table-search {
   143	    font-size: 0.96rem;
   144	    padding: 0.5rem 0.6rem 0.5rem 2.1rem;
   145	  }
   146	  .str-table-search-wrapper {
   147	    max-width: 100%;
   148	  }
   149	}
   150	
   151	
   152	/* Botones del panel */
   153	.str-dashboard-btn {
   154	  background-color: #0055cc;
   155	  color: #fff;
   156	  padding: 0.5rem 1rem;
   157	  border: none;
   158	  border-radius: 6px;
   159	  font-size: 0.95rem;
   160	  cursor: pointer;
   161	  transition: background 0.2s ease-in-out;
   162	}
   163	
   164	.str-dashboard-btn:hover {
   165	  background-color: #003f99;
   166	}
   167	
   168	/* Filtros o secciones generales */
   169	.str-dashboard-seccion {
   170	  margin-bottom: 2rem;
   171	}
   172	
   173	@media (max-width: 768px) {
   174	  .str-tabla-competicion {
   175	    font-size: 0.9rem;
   176	  }
   177	}
   178	
   179	/* ==== DASHBOARD CARDS HOME ==== */
   180	.str-dashboard-cards {
   181	  display: grid;
   182	  grid-template-columns: repeat(4, 1fr);
   183	  gap: 2rem;
   184	  margin-top: 2.5rem;
   185	}
   186	
   187	.str-dashboard-card,
   188	.str-dashboard-card *,
   189	.str-dashboard-card h3,
   190	.str-dashboard-card p {
   191	  text-decoration: none !important;
   192	}
   193	
   194	.str-dashboard-card {
   195	  background: #f5f8ff;
   196	  box-shadow: 0 6px 24px rgba(32, 96, 168, 0.07);
   197	  border-radius: 22px;
   198	  padding: 2.2rem 1.3rem 1.8rem 1.3rem;
   199	  text-align: center;
   200	  color: #232b36;
   201	  transition: box-shadow 0.2s, transform 0.2s;
   202	  position: relative;
   203	  cursor: pointer;
   204	  border: 1px solid #e3eeff;
   205	}
   206	
   207	.str-dashboard-card:hover, .str-dashboard-card:focus {
   208	  box-shadow: 0 10px 32px rgba(32, 96, 168, 0.15);
   209	  transform: translateY(-5px) scale(1.035);
   210	  border-color: #b2d3ff;
   211	}
   212	
   213	.str-dashboard-card-icon {
   214	  margin-bottom: 1.3rem;
   215	}
   216	.str-dashboard-card-icon svg {
   217	  display: block;
   218	  margin: 0 auto;
   219	}
   220	
   221	.str-dashboard-card h3 {
   222	  margin: 0 0 0.6rem 0;
   223	  font-size: 1.18rem;
   224	  font-weight: 700;
   225	  color: #0055cc;
   226	  letter-spacing: 0.01em;
   227	}
   228	
   229	.str-dashboard-card p {
   230	  margin: 0;
   231	  font-size: 1rem;
   232	  color: #49546b;
   233	  opacity: 0.90;
   234	  font-weight: 400;
   235	  line-height: 1.35;
   236	}
   237	.str-dashboard-card-icon {
   238	  margin-bottom: 1.3rem;
   239	  display: flex;
   240	  justify-content: center;
   241	  align-items: center;
   242	}
   243	
   244	.str-dashboard-card-icon i {
   245	  font-size: 2.4rem;
   246	  color: #0055cc;
   247	  background: #eaf3ff;
   248	  border-radius: 50%;
   249	  padding: 0.7rem;
   250	  width: 3.2rem;
   251	  height: 3.2rem;
   252	  display: flex;
   253	  justify-content: center;
   254	  align-items: center;
   255	}
   256	
   257	/* ==== DASHBOARD CARDS HOME Versión movil ==== */
   258	@media (max-width: 900px) {
   259	  .str-dashboard-cards {
   260	    display: grid;
   261	    grid-template-columns: 1fr 1fr;
   262	    gap: 1.2rem;
   263	    margin-top: 1.2rem;
   264	    justify-items: center;
   265	    width: 100%;
   266	    max-width: 100%;
   267	  }
   268	  .str-dashboard-card {
   269	    width: 100%;
   270	    max-width: 210px;
   271	    min-width: 0;
   272	    padding: 1.4rem 0.5rem 1.4rem 0.5rem;
   273	    font-size: 1.06rem;
   274	    box-sizing: border-box;
   275	  }
   276	  .str-dashboard-card-icon i {
   277	    font-size: 2rem;
   278	    width: 2.5rem;
   279	    height: 2.5rem;
   280	    padding: 0.6rem;
   281	  }
   282	}
   283	
   284	@media (max-width: 600px) {
   285	  .str-dashboard-cards {
   286	    gap: 0.8rem;
   287	    margin-top: 1rem;
   288	  }
   289	  .str-dashboard-card {
   290	    max-width: 170px;
   291	    padding: 1.25rem 0.2rem 1.1rem 0.2rem;
   292	    font-size: 1rem;
   293	  }
   294	  .str-dashboard-card-icon i {
   295	    font-size: 1.4rem;
   296	    width: 2rem;
   297	    height: 2rem;
   298	    padding: 0.32rem;
   299	  }
   300	}
   301	
===== END assets/css/dashboard-cliente.css =====

===== BEGIN assets/css/frontend.css =====
     1	/* === RESET BÁSICO === */
     2	* {
     3	  margin: 0;
     4	  padding: 0;
     5	  box-sizing: border-box;
     6	}
     7	
     8	/* === BASE GLOBAL === */
     9	:root {
    10	  --color-primario: #0055cc;
    11	  --color-secundario: #f5f5f5;
    12	  --color-texto: #222;
    13	  --color-fondo: #ffffff;
    14	  --fuente-principal: 'Inter', system-ui, sans-serif;
    15	}
    16	
    17	body {
    18	  font-family: var(--fuente-principal);
    19	  background-color: var(--color-fondo);
    20	  color: var(--color-texto);
    21	  font-size: 16px;
    22	  line-height: 1.6;
    23	  padding: 1rem;
    24	}
    25	
    26	/* === TÍTULOS === */
    27	h1, h2, h3 {
    28	  font-weight: bold;
    29	  margin: 1rem 0 0.5rem;
    30	}
    31	
    32	h1 {
    33	  font-size: 2rem;
    34	}
    35	
    36	h2 {
    37	  font-size: 1.5rem;
    38	}
    39	
    40	h3 {
    41	  font-size: 1.2rem;
    42	}
    43	
    44	/* === ENLACES === */
    45	a {
    46	  color: var(--color-primario);
    47	  text-decoration: none;
    48	}
    49	
    50	a:hover {
    51	  text-decoration: underline;
    52	}
    53	
    54	/* === BOTÓN GENÉRICO === */
    55	.str-btn {
    56	  display: inline-block;
    57	  background-color: var(--color-primario);
    58	  color: #fff;
    59	  padding: 0.6rem 1.2rem;
    60	  border: none;
    61	  border-radius: 6px;
    62	  font-weight: 600;
    63	  cursor: pointer;
    64	}
    65	
    66	.str-btn:hover {
    67	  background-color: #003f99;
    68	}
    69	
    70	/* === RESPONSIVE === */
    71	@media (max-width: 768px) {
    72	  body {
    73	    font-size: 15px;
    74	    padding: 0.5rem;
    75	  }
    76	
    77	  h1 {
    78	    font-size: 1.7rem;
    79	  }
    80	
    81	  h2 {
    82	    font-size: 1.4rem;
    83	  }
    84	
    85	  h3 {
    86	    font-size: 1.1rem;
    87	  }
    88	}
===== END assets/css/frontend.css =====

===== BEGIN assets/js/editar-torneo.js =====
     1	document.addEventListener('DOMContentLoaded', function () {
     2	  const btnEditar = document.getElementById('btn-editar-torneo');
     3	  const modal = document.getElementById('modal-editar-torneo');
     4	  const cerrarModal = document.getElementById('cerrar-modal-editar');
     5	  const btnGuardar = document.getElementById('guardar-torneo');
     6	
     7	  // Mostrar el modal
     8	  if (btnEditar && modal) {
     9	    btnEditar.addEventListener('click', function (e) {
    10	      e.preventDefault();
    11	      modal.style.display = 'flex';
    12	    });
    13	  }
    14	
    15	  // Cerrar el modal con la X
    16	  if (cerrarModal && modal) {
    17	    cerrarModal.addEventListener('click', function () {
    18	      modal.style.display = 'none';
    19	    });
    20	  }
    21	
    22	  // Cerrar el modal al hacer clic fuera del contenido
    23	  window.addEventListener('click', function (e) {
    24	    if (e.target === modal) {
    25	      modal.style.display = 'none';
    26	    }
    27	  });
    28	
    29	  // Guardar los datos del torneo por AJAX
    30	  if (btnGuardar) {
    31	    btnGuardar.addEventListener('click', function () {
    32	      const torneoID = btnGuardar.dataset.torneoId;
    33	      const titulo = document.querySelector('input[name="titulo"]').value;
    34	      const descripcion = document.querySelector('textarea[name="descripcion"]').value;
    35	      const fecha = document.querySelector('input[name="fecha_torneo"]').value;
    36	      const horaInicio = document.querySelector('input[name="hora_inicio"]').value;
    37	      const horaFin = document.querySelector('input[name="hora_fin"]').value;
    38	
    39	      const datos = new FormData();
    40	      datos.append('action', 'str_guardar_torneo_editado');
    41	      datos.append('torneo_id', torneoID);
    42	      datos.append('titulo', titulo);
    43	      datos.append('descripcion', descripcion);
    44	      datos.append('fecha_torneo', fecha);
    45	      datos.append('hora_inicio', horaInicio);
    46	      datos.append('hora_fin', horaFin);
    47	
    48	      fetch(str_ajax_obj.ajax_url, {
    49	        method: 'POST',
    50	        body: datos
    51	      })
    52	        .then(res => res.json())
    53	        .then(respuesta => {
    54	          if (respuesta.success) {
    55	            alert('✅ Torneo actualizado correctamente');
    56	            location.reload();
    57	          } else {
    58	            alert('❌ Error: ' + (respuesta.data || 'Intenta de nuevo.'));
    59	            console.error(respuesta);
    60	          }
    61	        })
    62	        .catch(err => {
    63	          alert('❌ Error de red o servidor');
    64	          console.error(err);
    65	        });
    66	    });
    67	  }
    68	});
===== END assets/js/editar-torneo.js =====

===== BEGIN assets/js/torneo-grupos-v2.js =====
     1	/* globals strTorneoV2 */
     2	(function(){
     3	  "use strict";
     4	
     5	  if (!window.strTorneoV2) { console.warn('[GROUPS v2] strTorneoV2 no definido'); return; }
     6	  const cfg = window.strTorneoV2;
     7	  const REST = cfg.restBase.replace(/\/+$/,''); // .../wp-json/saas/v1
     8	  const CID  = parseInt(cfg.competicionId||0,10);
     9	  const RID  = cfg.reqId || ('r'+Math.random().toString(36).slice(2,8));
    10	
    11	  const H = (html) => html; // sugar
    12	  const $ = (sel) => document.querySelector(sel);
    13	  const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    14	
    15	  async function restGet(path){
    16	    const res = await fetch(REST + path, { credentials:'same-origin' });
    17	    const ct  = res.headers.get('content-type')||'';
    18	    if (!ct.includes('application/json')) {
    19	      const raw = await res.text();
    20	      console.error('[GROUPS v2] RAW (no JSON):', raw);
    21	      throw new Error('Respuesta no JSON (GET '+path+')');
    22	    }
    23	    return await res.json();
    24	  }
    25	  async function restPost(path, data){
    26	    const res = await fetch(REST + path, {
    27	      method: 'POST',
    28	      headers: {
    29	        'Content-Type':'application/json',
    30	        'X-WP-Nonce': cfg.restNonce || '',
    31	      },
    32	      credentials:'same-origin',
    33	      body: JSON.stringify(data||{})
    34	    });
    35	    const ct  = res.headers.get('content-type')||'';
    36	    if (!ct.includes('application/json')) {
    37	      const raw = await res.text();
    38	      console.error('[GROUPS v2] RAW (no JSON):', raw);
    39	      throw new Error('Respuesta no JSON (POST '+path+')');
    40	    }
    41	    const json = await res.json();
    42	    if (!res.ok) {
    43	      const msg = (json && json.message) ? json.message : 'Error AJAX (success=false)';
    44	      throw new Error(msg);
    45	    }
    46	    return json;
    47	  }
    48	
    49	  const state = { meta:{}, grupos:[], libres:[] };
    50	
    51	  function renderGrupos(){
    52	    const wrap = $('#str-gestion-grupos');
    53	    if (!wrap) return;
    54	    const libresOpt = state.libres.map(p=>`<option value="${p.id}">${escapeHTML(p.title||'Pareja')}</option>`).join('');
    55	
    56	    const cards = state.grupos.map(g=>{
    57	      const rows = (g.participantes||[]).map(p=>{
    58	        if (p.placeholder) {
    59	          return `
    60	          <li class="str-row placeholder">
    61	            <div class="str-pair-name"><span class="badge">Placeholder</span></div>
    62	            <div class="str-actions">
    63	              <select class="str-pair-select" data-grupo="${g.id}">
    64	                <option value="">— Seleccionar pareja —</option>
    65	                ${libresOpt}
    66	              </select>
    67	              <button class="str-btn str-btn-small str-btn-assign" data-grupo="${g.id}" data-ph="${p.id}" type="button">Asignar</button>
    68	            </div>
    69	          </li>`;
    70	        }
    71	        return `
    72	        <li class="str-row">
    73	          <div class="str-pair-name">${escapeHTML(p.title||'Pareja')}</div>
    74	          <div class="str-actions"><span class="pill pill-ok">Asignada</span></div>
    75	        </li>`;
    76	      }).join('');
    77	
    78	      return `
    79	      <div class="str-card grupo">
    80	        <div class="str-card-head">
    81	          <div class="title">Grupo <b>${escapeHTML(g.letra||'?')}</b></div>
    82	          <div class="sub">Capacidad: ${g.tam} · Ocupadas: ${(g.participantes||[]).filter(x=>!x.placeholder).length}</div>
    83	        </div>
    84	        <ul class="str-list">${rows || `<li class="str-row"><em>Sin participantes</em></li>`}</ul>
    85	      </div>`;
    86	    }).join('');
    87	
    88	    wrap.innerHTML = `
    89	      <div class="str-groups-header">
    90	        <div class="str-groups-meta">
    91	          <span><b>Grupos:</b> ${state.grupos.length}</span>
    92	          <span><b>Parejas totales (aprox):</b> ${state.meta.n_parejas || '-'}</span>
    93	          <span><b>Fase final:</b> ${escapeHTML(state.meta.fase_final||'-')}</span>
    94	          <span><b>Modo final:</b> ${escapeHTML(state.meta.modo_final||'-')}</span>
    95	        </div>
    96	        <div class="str-groups-actions">
    97	          <button class="str-btn" id="btn-v2-recalc" type="button">Recalcular clasificación</button>
    98	          <button class="str-btn str-btn-primary" id="btn-v2-auto" type="button">Rellenar aleatoriamente</button>
    99	        </div>
   100	      </div>
   101	      <div class="str-grid-groups">${cards}</div>`;
   102	
   103	    const btnAuto  = $('#btn-v2-auto');
   104	    const btnRecal = $('#btn-v2-recalc');
   105	    if (btnAuto)  btnAuto.addEventListener('click', onAutoAssign);
   106	    if (btnRecal) btnRecal.addEventListener('click', cargarStandings);
   107	
   108	    $$('.str-btn-assign').forEach(btn=>{
   109	      btn.addEventListener('click', async ()=>{
   110	        try {
   111	          const gid = parseInt(btn.getAttribute('data-grupo'),10);
   112	          const ph  = parseInt(btn.getAttribute('data-ph'),10);
   113	          const sel = btn.parentElement.querySelector('.str-pair-select');
   114	          const pid = sel ? parseInt(sel.value,10) : 0;
   115	          if (!pid) { alert('Selecciona una pareja'); return; }
   116	          btn.disabled = true; btn.textContent = 'Asignando...';
   117	          await restPost(`/group/${gid}/assign`, {competicion_id:CID, pareja_id:pid, placeholder_id:ph});
   118	          await Promise.all([cargarGrupos(), cargarStandings()]);
   119	        } catch (e) {
   120	          console.error(e); alert(e.message||'Error al asignar');
   121	        } finally {
   122	          btn.disabled=false; btn.textContent='Asignar';
   123	        }
   124	      });
   125	    });
   126	  }
   127	
   128	  function renderStandings(data){
   129	    const wrap = $('#str-standings');
   130	    if (!wrap) return;
   131	    if (!data || !Array.isArray(data.grupos) || data.grupos.length===0) {
   132	      wrap.innerHTML = `<div class="str-card"><div class="str-card-body"><em>No hay standings todavía.</em></div></div>`;
   133	      return;
   134	    }
   135	    const tables = data.grupos.map(g=>{
   136	      const rows = (g.items||[]).map((it,i)=>`
   137	        <tr>
   138	          <td>${i+1}</td>
   139	          <td>${escapeHTML(it.title||'Pareja')}${it.placeholder? ' <span class="badge">PH</span>':''}</td>
   140	          <td>${it.pj}</td><td>${it.pg}</td><td>${it.pp}</td>
   141	          <td><b>${it.pts}</b></td>
   142	          <td>${it.sets_f}-${it.sets_c}</td>
   143	          <td>${it.juegos_f}-${it.juegos_c}</td>
   144	        </tr>
   145	      `).join('');
   146	      return `
   147	        <div class="str-card standings">
   148	          <div class="str-card-head"><div class="title">Clasificación · Grupo <b>${escapeHTML(g.letra||'?')}</b></div></div>
   149	          <div class="str-table-wrap">
   150	            <table class="str-table">
   151	              <thead><tr><th>#</th><th>Pareja</th><th>PJ</th><th>PG</th><th>PP</th><th>Pts</th><th>Sets</th><th>Juegos</th></tr></thead>
   152	              <tbody>${rows || `<tr><td colspan="8"><em>Sin datos</em></td></tr>`}</tbody>
   153	            </table>
   154	          </div>
   155	        </div>`;
   156	    }).join('');
   157	    wrap.innerHTML = tables;
   158	  }
   159	
   160	  async function cargarGrupos(){
   161	    const data = await restGet(`/groups?competicion_id=${CID}&rid=${encodeURIComponent(RID)}`);
   162	    state.meta   = data.meta || {};
   163	    state.grupos = Array.isArray(data.grupos) ? data.grupos : [];
   164	    state.libres = Array.isArray(data.parejas_libres) ? data.parejas_libres : [];
   165	    renderGrupos();
   166	  }
   167	
   168	  async function cargarStandings(){
   169	    const data = await restGet(`/groups/standings?competicion_id=${CID}&rid=${encodeURIComponent(RID)}`);
   170	    renderStandings(data);
   171	  }
   172	
   173	  async function onAutoAssign(){
   174	    const btn = $('#btn-v2-auto');
   175	    if (btn) { btn.disabled = true; btn.textContent = 'Rellenando...'; }
   176	    try {
   177	      await restPost('/groups/auto-assign', {competicion_id: CID});
   178	      await Promise.all([cargarGrupos(), cargarStandings()]);
   179	    } catch (e) {
   180	      console.error(e); alert(e.message||'No se pudo completar automáticamente');
   181	    } finally {
   182	      if (btn) { btn.disabled=false; btn.textContent='Rellenar aleatoriamente'; }
   183	    }
   184	  }
   185	
   186	  function escapeHTML(str){
   187	    if (str==null) return '';
   188	    return String(str).replace(/[&<>"']/g, function(m){
   189	      return ({
   190	        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
   191	      })[m] || m;
   192	    });
   193	  }
   194	
   195	  document.addEventListener('DOMContentLoaded', async ()=>{
   196	    if (!CID) return;
   197	    try {
   198	      await cargarGrupos();
   199	      await cargarStandings();
   200	    } catch (e) {
   201	      console.error('[GROUPS v2] init error', e);
   202	      alert(e.message || 'Error inicial (v2)');
   203	    }
   204	  });
   205	
   206	})();
===== END assets/js/torneo-grupos-v2.js =====

===== BEGIN includes/admin-columns/columns-competicion.php =====
     1	<?php
     2	/**
     3	 * Personalización de columnas y filtros para el CPT "competicion"
     4	 * Ruta: /saas-torneos-de-raqueta/includes/admin-columns/columns-competicion.php
     5	 */
     6	
     7	// SOLO en admin y para el CPT correcto
     8	add_action('admin_init', function() {
     9	    $screen = get_current_screen();
    10	    if (is_admin() && isset($_GET['post_type']) && $_GET['post_type'] === 'competicion') {
    11	        // Hooks de columnas y filtros
    12	        add_filter('manage_competicion_posts_columns', 'str_add_columns_competicion');
    13	        add_action('manage_competicion_posts_custom_column', 'str_show_columns_competicion', 10, 2);
    14	        add_filter('manage_edit-competicion_sortable_columns', 'str_sortable_columns_competicion');
    15	        add_action('restrict_manage_posts', 'str_filter_columns_competicion');
    16	        add_filter('parse_query', 'str_columns_competicion_filter_query');
    17	    }
    18	});
    19	
    20	/**
    21	 * Añade las nuevas columnas al listado del CPT competición.
    22	 * Ahora el Título va primero y el ID es la segunda columna.
    23	 */
    24	function str_add_columns_competicion($columns) {
    25	    $new_columns = array();
    26	
    27	    // Título como primera columna
    28	    $new_columns['title'] = __('Título');
    29	    // ID como segunda columna
    30	    $new_columns['id'] = 'ID';
    31	    // El resto de columnas personalizadas
    32	    $new_columns['usuario_creador'] = __('Usuario creador');
    33	    $new_columns['n_jugadores'] = __('Nº jugadores');
    34	    $new_columns['tipo_competicion'] = __('Tipo competición');
    35	    $new_columns['deporte'] = __('Deporte');
    36	    // Fecha siempre al final
    37	    $new_columns['date'] = $columns['date'];
    38	    return $new_columns;
    39	}
    40	
    41	/**
    42	 * Muestra el contenido de cada columna personalizada.
    43	 */
    44	function str_show_columns_competicion($column, $post_id) {
    45	    switch ($column) {
    46	        case 'id':
    47	            echo esc_html($post_id);
    48	            break;
    49	        case 'usuario_creador':
    50	            $user_id = get_post_field('post_author', $post_id);
    51	            $user = get_userdata($user_id);
    52	            echo $user ? esc_html($user->display_name) : '-';
    53	            break;
    54	        case 'n_jugadores':
    55	            $n_jugadores = get_field('n_jugadores', $post_id);
    56	            echo $n_jugadores ? esc_html($n_jugadores) : '-';
    57	            break;
    58	        case 'tipo_competicion':
    59	            $tipo = get_field('tipo_competicion', $post_id);
    60	            echo $tipo ? esc_html($tipo) : '-';
    61	            break;
    62	        case 'deporte':
    63	            $deporte = get_field('deporte', $post_id);
    64	            echo $deporte ? esc_html($deporte) : '-';
    65	            break;
    66	    }
    67	}
    68	
    69	/**
    70	 * Hace las columnas ordenables si lo necesitas (opcional, aquí solo para ID y título).
    71	 */
    72	function str_sortable_columns_competicion($columns) {
    73	    $columns['id'] = 'ID';
    74	    $columns['usuario_creador'] = 'author';
    75	    return $columns;
    76	}
    77	
    78	/**
    79	 * Añade los filtros arriba de la tabla de competiciones.
    80	 */
    81	function str_filter_columns_competicion() {
    82	    global $typenow;
    83	    if ($typenow !== 'competicion') return;
    84	
    85	    // Filtro por usuario creador
    86	    wp_dropdown_users(array(
    87	        'show_option_all' => 'Todos los usuarios',
    88	        'name' => 'admin_competicion_user',
    89	        'selected' => isset($_GET['admin_competicion_user']) ? intval($_GET['admin_competicion_user']) : 0,
    90	        'include_selected' => true,
    91	        'who' => 'authors'
    92	    ));
    93	
    94	    // Filtro por nº jugadores
    95	    $valores = array(4, 8, 16, 32, 64, 128, 256);
    96	    $valor_actual = isset($_GET['admin_n_jugadores']) ? intval($_GET['admin_n_jugadores']) : '';
    97	    echo '<select name="admin_n_jugadores"><option value="">Todos los jugadores</option>';
    98	    foreach ($valores as $valor) {
    99	        printf(
   100	            '<option value="%d"%s>%d</option>',
   101	            $valor,
   102	            $valor == $valor_actual ? ' selected="selected"' : '',
   103	            $valor
   104	        );
   105	    }
   106	    echo '</select>';
   107	
   108	    // Filtro por tipo de competición
   109	    $tipos = array('torneo' => 'Torneo', 'ranking' => 'Ranking');
   110	    $tipo_actual = isset($_GET['admin_tipo_competicion']) ? $_GET['admin_tipo_competicion'] : '';
   111	    echo '<select name="admin_tipo_competicion"><option value="">Todos los tipos</option>';
   112	    foreach ($tipos as $key => $label) {
   113	        printf(
   114	            '<option value="%s"%s>%s</option>',
   115	            esc_attr($key),
   116	            $key === $tipo_actual ? ' selected="selected"' : '',
   117	            esc_html($label)
   118	        );
   119	    }
   120	    echo '</select>';
   121	
   122	    // Filtro por deporte
   123	    $deportes = array('padel' => 'Pádel', 'tenis' => 'Tenis', 'pickleball' => 'Pickleball', 'tenis_playa' => 'Tenis Playa');
   124	    $deporte_actual = isset($_GET['admin_deporte']) ? $_GET['admin_deporte'] : '';
   125	    echo '<select name="admin_deporte"><option value="">Todos los deportes</option>';
   126	    foreach ($deportes as $key => $label) {
   127	        printf(
   128	            '<option value="%s"%s>%s</option>',
   129	            esc_attr($key),
   130	            $key === $deporte_actual ? ' selected="selected"' : '',
   131	            esc_html($label)
   132	        );
   133	    }
   134	    echo '</select>';
   135	}
   136	
   137	/**
   138	 * Lógica de filtrado según los dropdowns.
   139	 */
   140	function str_columns_competicion_filter_query($query) {
   141	    global $pagenow, $typenow;
   142	    if ($pagenow === 'edit.php' && $typenow === 'competicion' && $query->is_main_query()) {
   143	        // Filtrar por usuario
   144	        if (!empty($_GET['admin_competicion_user'])) {
   145	            $query->set('author', intval($_GET['admin_competicion_user']));
   146	        }
   147	        // Filtrar por nº jugadores (ACF)
   148	        if (!empty($_GET['admin_n_jugadores'])) {
   149	            $meta_query = $query->get('meta_query', array());
   150	            $meta_query[] = array(
   151	                'key' => 'n_jugadores',
   152	                'value' => intval($_GET['admin_n_jugadores']),
   153	                'compare' => '='
   154	            );
   155	            $query->set('meta_query', $meta_query);
   156	        }
   157	        // Filtrar por tipo de competición (ACF)
   158	        if (!empty($_GET['admin_tipo_competicion'])) {
   159	            $meta_query = $query->get('meta_query', array());
   160	            $meta_query[] = array(
   161	                'key' => 'tipo_competicion',
   162	                'value' => sanitize_text_field($_GET['admin_tipo_competicion']),
   163	                'compare' => '='
   164	            );
   165	            $query->set('meta_query', $meta_query);
   166	        }
   167	        // Filtrar por deporte (ACF)
   168	        if (!empty($_GET['admin_deporte'])) {
   169	            $meta_query = $query->get('meta_query', array());
   170	            $meta_query[] = array(
   171	                'key' => 'deporte',
   172	                'value' => sanitize_text_field($_GET['admin_deporte']),
   173	                'compare' => '='
   174	            );
   175	            $query->set('meta_query', $meta_query);
   176	        }
   177	    }
   178	}
===== END includes/admin-columns/columns-competicion.php =====

===== BEGIN includes/admin-columns/columns-jugadores.php =====
     1	<?php
     2	/**
     3	 * Personalización de columnas y filtros para el CPT "jugador_deportes"
     4	 * Ruta: /saas-torneos-de-raqueta/includes/admin-columns/columns-jugadores.php
     5	 */
     6	
     7	// SOLO en admin y para el CPT correcto
     8	add_action('admin_init', function() {
     9	    $screen = get_current_screen();
    10	    if (is_admin() && isset($_GET['post_type']) && $_GET['post_type'] === 'jugador_deportes') {
    11	        add_filter('manage_jugador_deportes_posts_columns', 'str_add_columns_jugadores');
    12	        add_action('manage_jugador_deportes_posts_custom_column', 'str_show_columns_jugadores', 10, 2);
    13	        add_filter('manage_edit-jugador_deportes_sortable_columns', 'str_sortable_columns_jugadores');
    14	        add_action('restrict_manage_posts', 'str_filter_columns_jugadores');
    15	        add_filter('parse_query', 'str_columns_jugadores_filter_query');
    16	    }
    17	});
    18	
    19	/**
    20	 * Añade las nuevas columnas al listado del CPT jugador_deportes.
    21	 * Título va primero, ID como segunda columna.
    22	 */
    23	function str_add_columns_jugadores($columns) {
    24	    $new_columns = array();
    25	
    26	    $new_columns['title'] = __('Título');
    27	    $new_columns['id'] = 'ID';
    28	    $new_columns['usuario_creador'] = __('Usuario creador');
    29	    $new_columns['date'] = $columns['date'];
    30	    return $new_columns;
    31	}
    32	
    33	/**
    34	 * Muestra el contenido de cada columna personalizada.
    35	 */
    36	function str_show_columns_jugadores($column, $post_id) {
    37	    switch ($column) {
    38	        case 'id':
    39	            echo esc_html($post_id);
    40	            break;
    41	        case 'usuario_creador':
    42	            $user_id = get_post_field('post_author', $post_id);
    43	            $user = get_userdata($user_id);
    44	            echo $user ? esc_html($user->display_name) : '-';
    45	            break;
    46	    }
    47	}
    48	
    49	/**
    50	 * Hace las columnas ordenables (opcional).
    51	 */
    52	function str_sortable_columns_jugadores($columns) {
    53	    $columns['id'] = 'ID';
    54	    $columns['usuario_creador'] = 'author';
    55	    return $columns;
    56	}
    57	
    58	/**
    59	 * Filtros arriba de la tabla de jugadores.
    60	 */
    61	function str_filter_columns_jugadores() {
    62	    global $typenow;
    63	    if ($typenow !== 'jugador_deportes') return;
    64	
    65	    // Filtro por usuario creador
    66	    wp_dropdown_users(array(
    67	        'show_option_all' => 'Todos los usuarios',
    68	        'name' => 'admin_jugador_user',
    69	        'selected' => isset($_GET['admin_jugador_user']) ? intval($_GET['admin_jugador_user']) : 0,
    70	        'include_selected' => true,
    71	        'who' => 'authors'
    72	    ));
    73	
    74	    // No hay filtro por fecha aquí, ya que WordPress ya lo ofrece por defecto (arriba: "Todas las fechas")
    75	}
    76	
    77	/**
    78	 * Lógica de filtrado según los dropdowns.
    79	 */
    80	function str_columns_jugadores_filter_query($query) {
    81	    global $pagenow, $typenow;
    82	    if ($pagenow === 'edit.php' && $typenow === 'jugador_deportes' && $query->is_main_query()) {
    83	        // Filtrar por usuario
    84	        if (!empty($_GET['admin_jugador_user'])) {
    85	            $query->set('author', intval($_GET['admin_jugador_user']));
    86	        }
    87	    }
    88	}
===== END includes/admin-columns/columns-jugadores.php =====

===== BEGIN includes/core/loader.php =====
     1	<?php
     2	/**
     3	 * Loader / Helpers comunes
     4	 * Ruta: includes/core/loader.php
     5	 */
     6	if ( ! defined('ABSPATH') ) exit;
     7	
     8	/** ==========================================================
     9	 * Helpers de rutas/urls
    10	 * ========================================================== */
    11	if ( ! function_exists('str_path') ) {
    12	    function str_path( $rel ) {
    13	        $rel = ltrim($rel, '/\\');
    14	        return trailingslashit( STR_PLUGIN_PATH . $rel );
    15	    }
    16	}
    17	if ( ! function_exists('str_url') ) {
    18	    function str_url( $rel ) {
    19	        $rel = ltrim($rel, '/\\');
    20	        return trailingslashit( STR_PLUGIN_URL . $rel );
    21	    }
    22	}
    23	
    24	/**
    25	 * Cargar seguro si existe (para migraciones progresivas)
    26	 */
    27	if ( ! function_exists('str_require_if_exists') ) {
    28	    function str_require_if_exists( $abs_path ) {
    29	        if ( file_exists( $abs_path ) ) {
    30	            require_once $abs_path;
    31	            return true;
    32	        }
    33	        return false;
    34	    }
    35	}
    36	
    37	/** ==========================================================
    38	 * Auto-enqueue de assets co-localizados con una plantilla
    39	 * (lo usaremos en Fase 2 cuando movamos plantillas a /includes/sports/…)
    40	 * ========================================================== */
    41	if ( ! function_exists('str_enqueue_template_assets') ) {
    42	    /**
    43	     * @param string $template_abs  Ruta absoluta de la plantilla (ej. …/index.php)
    44	     * @param string $handle_base   Prefijo de handles (ej. 'saas-padel-torneo')
    45	     */
    46	    function str_enqueue_template_assets( $template_abs, $handle_base ) {
    47	        $dir = dirname( $template_abs );
    48	        $basename = preg_replace('/\.php$/', '', basename( $template_abs )); // normalmente 'index'
    49	        $css = $dir . '/' . $basename . '.css';
    50	        $js  = $dir . '/' . $basename . '.js';
    51	
    52	        // Encolar solo si existen (esto no hace nada todavía mientras no movamos plantillas)
    53	        if ( file_exists( $css ) ) {
    54	            $rel = str_replace( STR_PLUGIN_PATH, '', $css );
    55	            wp_enqueue_style( $handle_base . '-css', str_url($rel), [], '1.0' );
    56	        }
    57	        if ( file_exists( $js ) ) {
    58	            $rel = str_replace( STR_PLUGIN_PATH, '', $js );
    59	            wp_enqueue_script( $handle_base . '-js', str_url($rel), ['jquery'], '1.0', true );
    60	        }
    61	    }
    62	}
    63	
    64	/** ==========================================================
    65	 * Encolado de módulos compartidos (players/pairs/groups…)
    66	 * (disponible para Fase 2+; ahora no altera nada)
    67	 * ========================================================== */
    68	if ( ! function_exists('str_enqueue_shared_modules') ) {
    69	    function str_enqueue_shared_modules( $args = [] ) {
    70	        $defaults = [
    71	            'players'   => false,
    72	            'pairs'     => false,
    73	            'groups'    => false,
    74	            'resultado' => false,
    75	        ];
    76	        $a = wp_parse_args( $args, $defaults );
    77	
    78	        // PLAYERS
    79	        if ( $a['players'] ) {
    80	            $js  = str_path('includes/features/players/index.js');
    81	            $css = str_path('includes/features/players/index.css');
    82	            if ( file_exists($js) )  wp_enqueue_script('saas-players-js', str_url('includes/features/players/index.js'), ['jquery'], '1.0', true);
    83	            if ( file_exists($css) ) wp_enqueue_style('saas-players-css',  str_url('includes/features/players/index.css'), [], '1.0');
    84	        }
    85	
    86	        // PAIRS
    87	        if ( $a['pairs'] ) {
    88	            $js  = str_path('includes/features/pairs/index.js');
    89	            $css = str_path('includes/features/pairs/index.css');
    90	            if ( file_exists($js) )  wp_enqueue_script('saas-pairs-js', str_url('includes/features/pairs/index.js'), ['jquery'], '1.0', true);
    91	            if ( file_exists($css) ) wp_enqueue_style('saas-pairs-css',  str_url('includes/features/pairs/index.css'), [], '1.0');
    92	        }
    93	
    94	        // GROUPS
    95	        if ( $a['groups'] ) {
    96	            $js  = str_path('includes/features/groups/index.js');
    97	            $css = str_path('includes/features/groups/index.css');
    98	            if ( file_exists($js) )  wp_enqueue_script('saas-groups-js', str_url('includes/features/groups/index.js'), ['jquery'], '1.0', true);
    99	            if ( file_exists($css) ) wp_enqueue_style('saas-groups-css',  str_url('includes/features/groups/index.css'), [], '1.0');
   100	        }
   101	
   102	        // RESULTADOS (ej. pádel)
   103	        if ( $a['resultado'] ) {
   104	            $js  = str_path('includes/sports/padel/torneo/form-resultado-partido.js');
   105	            $css = str_path('includes/sports/padel/torneo/form-resultado-partido.css');
   106	            if ( file_exists($js) )  wp_enqueue_script('saas-resultados-js', str_url('includes/sports/padel/torneo/form-resultado-partido.js'), ['jquery'], '1.0', true);
   107	            if ( file_exists($css) ) wp_enqueue_style('saas-resultados-css',  str_url('includes/sports/padel/torneo/form-resultado-partido.css'), [], '1.0');
   108	        }
   109	    }
   110	}
===== END includes/core/loader.php =====

===== BEGIN includes/cpt/cpt-competicion.php =====
     1	<?php
     2	// CPT: Competición (torneos, rankings, ligas, etc.)
     3	
     4	function str_register_cpt_competicion() {
     5	    $labels = [
     6	        'name'               => __('Competiciones', 'saas-torneos'),
     7	        'singular_name'      => __('Competición', 'saas-torneos'),
     8	        'add_new'            => __('Añadir nueva', 'saas-torneos'),
     9	        'add_new_item'       => __('Añadir nueva competición', 'saas-torneos'),
    10	        'edit_item'          => __('Editar competición', 'saas-torneos'),
    11	        'new_item'           => __('Nueva competición', 'saas-torneos'),
    12	        'all_items'          => __('Todas las competiciones', 'saas-torneos'),
    13	        'view_item'          => __('Ver competición', 'saas-torneos'),
    14	        'search_items'       => __('Buscar competiciones', 'saas-torneos'),
    15	        'not_found'          => __('No se encontraron competiciones', 'saas-torneos'),
    16	        'not_found_in_trash' => __('No hay competiciones en la papelera', 'saas-torneos'),
    17	        'menu_name'          => __('Competiciones', 'saas-torneos')
    18	    ];
    19	
    20	    $args = [
    21	        'labels'             => $labels,
    22	        'public'             => true, // ✅ importante para que genere URLs
    23	        'show_ui'            => true,
    24	        'show_in_menu'       => true,
    25	        'capability_type'    => 'post',
    26	        'hierarchical'       => false,
    27	        'supports'           => ['title'],
    28	        'menu_position'      => 20,
    29	        'menu_icon'          => 'dashicons-awards',
    30	        'has_archive'        => true, // ✅ permite archivo /competicion/
    31	        'rewrite'            => [
    32	            'slug' => 'competicion',
    33	            'with_front' => false
    34	        ],
    35	        'show_in_rest'       => false
    36	    ];
    37	
    38	    register_post_type('competicion', $args);
    39	}
    40	add_action('init', 'str_register_cpt_competicion');
===== END includes/cpt/cpt-competicion.php =====

===== BEGIN includes/cpt/cpt-grupo.php =====
     1	<?php
     2	/**
     3	 * Registro del Custom Post Type "grupo" para la gestión de grupos en torneos.
     4	 * Este CPT permitirá organizar las parejas/jugadores en grupos para la fase de grupos de cualquier competición.
     5	 */
     6	
     7	if ( ! defined( 'ABSPATH' ) ) {
     8	    exit; // Evita el acceso directo.
     9	}
    10	
    11	function str_registrar_cpt_grupo() {
    12	    $labels = array(
    13	        'name'                  => 'Grupos',
    14	        'singular_name'         => 'Grupo',
    15	        'menu_name'             => 'Grupos',
    16	        'name_admin_bar'        => 'Grupo',
    17	        'add_new'               => 'Añadir nuevo',
    18	        'add_new_item'          => 'Añadir nuevo grupo',
    19	        'new_item'              => 'Nuevo grupo',
    20	        'edit_item'             => 'Editar grupo',
    21	        'view_item'             => 'Ver grupo',
    22	        'all_items'             => 'Todos los grupos',
    23	        'search_items'          => 'Buscar grupos',
    24	        'parent_item_colon'     => 'Grupo padre:',
    25	        'not_found'             => 'No se han encontrado grupos.',
    26	        'not_found_in_trash'    => 'No se han encontrado grupos en la papelera.',
    27	    );
    28	
    29	    $args = array(
    30	        'labels'                => $labels,
    31	        'public'                => false, // No público, solo accesible vía queries o backend.
    32	        'show_ui'               => true,  // Se muestra en el admin para facilitar test y gestión.
    33	        'show_in_menu'          => true,
    34	        'menu_icon'             => 'dashicons-groups',
    35	        'supports'              => array( 'title' ),
    36	        'has_archive'           => false,
    37	        'rewrite'               => false,
    38	        'show_in_rest'          => false,
    39	        'capability_type'       => 'post',
    40	    );
    41	
    42	    register_post_type( 'grupo', $args );
    43	}
    44	add_action( 'init', 'str_registrar_cpt_grupo' );
===== END includes/cpt/cpt-grupo.php =====

===== BEGIN includes/cpt/cpt-jugadores.php =====
     1	<?php
     2	// CPT: Jugadores de deportes (individuales, asociados a competiciones)
     3	
     4	function str_register_cpt_jugadores() {
     5	    $labels = [
     6	        'name'               => __('Jugadores', 'saas-torneos'),
     7	        'singular_name'      => __('Jugador', 'saas-torneos'),
     8	        'add_new'            => __('Añadir nuevo', 'saas-torneos'),
     9	        'add_new_item'       => __('Añadir nuevo jugador', 'saas-torneos'),
    10	        'edit_item'          => __('Editar jugador', 'saas-torneos'),
    11	        'new_item'           => __('Nuevo jugador', 'saas-torneos'),
    12	        'all_items'          => __('Todos los jugadores', 'saas-torneos'),
    13	        'view_item'          => __('Ver jugador', 'saas-torneos'),
    14	        'search_items'       => __('Buscar jugadores', 'saas-torneos'),
    15	        'not_found'          => __('No se encontraron jugadores', 'saas-torneos'),
    16	        'not_found_in_trash' => __('No hay jugadores en la papelera', 'saas-torneos'),
    17	        'menu_name'          => __('Jugadores', 'saas-torneos')
    18	    ];
    19	
    20	    $args = [
    21	        'labels'             => $labels,
    22	        'public'             => true,
    23	        'show_ui'            => true, // útil en el admin para verlos fácilmente
    24	        'show_in_menu'       => true,
    25	        'capability_type'    => 'post',
    26	        'hierarchical'       => false,
    27	        'supports'           => ['title'],
    28	        'menu_position'      => 21,
    29	        'menu_icon'          => 'dashicons-groups', // Icono de grupo
    30	        'has_archive'        => true,
    31	        'rewrite'            => array('slug' => 'jugador', 'with_front' => false),
    32	        'show_in_rest'       => false
    33	    ];
    34	
    35	    register_post_type( 'jugador_deportes', $args );
    36	}
    37	add_action( 'init', 'str_register_cpt_jugadores' );
===== END includes/cpt/cpt-jugadores.php =====

===== BEGIN includes/cpt/cpt-parejas.php =====
     1	<?php
     2	// CPT: Parejas de jugadores para deportes dobles
     3	
     4	function str_register_cpt_parejas() {
     5	    $labels = [
     6	        'name'               => __('Parejas', 'saas-torneos'),
     7	        'singular_name'      => __('Pareja', 'saas-torneos'),
     8	        'add_new'            => __('Añadir nueva', 'saas-torneos'),
     9	        'add_new_item'       => __('Añadir nueva pareja', 'saas-torneos'),
    10	        'edit_item'          => __('Editar pareja', 'saas-torneos'),
    11	        'new_item'           => __('Nueva pareja', 'saas-torneos'),
    12	        'all_items'          => __('Todas las parejas', 'saas-torneos'),
    13	        'view_item'          => __('Ver pareja', 'saas-torneos'),
    14	        'search_items'       => __('Buscar parejas', 'saas-torneos'),
    15	        'not_found'          => __('No se encontraron parejas', 'saas-torneos'),
    16	        'not_found_in_trash' => __('No hay parejas en la papelera', 'saas-torneos'),
    17	        'menu_name'          => __('Parejas', 'saas-torneos')
    18	    ];
    19	
    20	    $args = [
    21	        'labels'             => $labels,
    22	        'public'             => false,
    23	        'show_ui'            => true,
    24	        'show_in_menu'       => true,
    25	        'capability_type'    => 'post',
    26	        'hierarchical'       => false,
    27	        'supports'           => ['title'],
    28	        'menu_position'      => 22,
    29	        'menu_icon'          => 'dashicons-heart', // Icono de corazón para parejas ♥
    30	        'has_archive'        => false,
    31	        'rewrite'            => false,
    32	        'show_in_rest'       => false
    33	    ];
    34	
    35	    register_post_type( 'pareja', $args );
    36	}
    37	add_action( 'init', 'str_register_cpt_parejas' );
===== END includes/cpt/cpt-parejas.php =====

===== BEGIN includes/cpt/cpt-partidos.php =====
     1	<?php
     2	// CPT: Partidos jugados dentro de competiciones
     3	
     4	function str_register_cpt_partidos() {
     5	    $labels = [
     6	        'name'               => __('Partidos', 'saas-torneos'),
     7	        'singular_name'      => __('Partido', 'saas-torneos'),
     8	        'add_new'            => __('Añadir nuevo', 'saas-torneos'),
     9	        'add_new_item'       => __('Añadir nuevo partido', 'saas-torneos'),
    10	        'edit_item'          => __('Editar partido', 'saas-torneos'),
    11	        'new_item'           => __('Nuevo partido', 'saas-torneos'),
    12	        'all_items'          => __('Todos los partidos', 'saas-torneos'),
    13	        'view_item'          => __('Ver partido', 'saas-torneos'),
    14	        'search_items'       => __('Buscar partidos', 'saas-torneos'),
    15	        'not_found'          => __('No se encontraron partidos', 'saas-torneos'),
    16	        'not_found_in_trash' => __('No hay partidos en la papelera', 'saas-torneos'),
    17	        'menu_name'          => __('Partidos', 'saas-torneos')
    18	    ];
    19	
    20	    $args = [
    21	        'labels'             => $labels,
    22	        'public'             => false,
    23	        'show_ui'            => true,
    24	        'show_in_menu'       => true,
    25	        'capability_type'    => 'post',
    26	        'hierarchical'       => false,
    27	        'supports'           => ['title'],
    28	        'menu_position'      => 23,
    29	        'menu_icon'          => 'dashicons-controls-play', // Icono tipo "play"
    30	        'has_archive'        => false,
    31	        'rewrite'            => false,
    32	        'show_in_rest'       => false
    33	    ];
    34	
    35	    register_post_type( 'partido', $args );
    36	}
    37	add_action( 'init', 'str_register_cpt_partidos' );
===== END includes/cpt/cpt-partidos.php =====

===== BEGIN includes/diagnostico.php =====
     1	<?php
     2	/**
     3	 * Archivo: /includes/diagnostico.php
     4	 * Propósito: Forzar la creación del archivo de log y dejar trazas mínimas al recargar la web.
     5	 */
     6	if ( ! defined('ABSPATH') ) { exit; }
     7	
     8	// --- Utilidad local de log (fallback) si aún no existe str_escribir_log ---
     9	if ( ! function_exists('str_escribir_log') ) {
    10	    function str_escribir_log($mensaje, $origen = '') {
    11	        $ruta_log  = plugin_dir_path( dirname(__FILE__) ) . 'debug-saas-torneos.log'; // raíz del plugin
    12	        $timestamp = date('[Y-m-d H:i:s]');
    13	        $origen    = $origen ? "[$origen]" : '';
    14	        if (is_array($mensaje) || is_object($mensaje)) {
    15	            $mensaje = print_r($mensaje, true);
    16	        }
    17	        @file_put_contents($ruta_log, "$timestamp $origen $mensaje" . PHP_EOL, FILE_APPEND | LOCK_EX);
    18	    }
    19	}
    20	
    21	// 1) Forzar creación del archivo de log e indicar que el diagnóstico cargó
    22	str_escribir_log('Diagnóstico cargado OK', 'DIAGNOSTICO');
    23	
    24	// 2) Dejar una traza de “arranque de petición” (BOOT)
    25	$uri        = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '';
    26	$is_admin   = function_exists('is_admin') ? (is_admin() ? 1 : 0) : 0;
    27	$doing_ajax = (defined('DOING_AJAX') && DOING_AJAX) ? 1 : 0;
    28	$user_id    = function_exists('get_current_user_id') ? (int) get_current_user_id() : 0;
    29	$roles      = [];
    30	if (function_exists('wp_get_current_user')) {
    31	    $u = wp_get_current_user();
    32	    $roles = is_object($u) ? (array) $u->roles : [];
    33	}
    34	str_escribir_log("BOOT | URI={$uri} | admin={$is_admin} | ajax={$doing_ajax} | user={$user_id} | roles=" . json_encode($roles), 'DIAGNOSTICO');
    35	
    36	// 3) Registrar captura de FATAL al finalizar la petición
    37	if ( ! function_exists('str_diag_shutdown') ) {
    38	    function str_diag_shutdown() {
    39	        $err = error_get_last();
    40	        if ($err && in_array($err['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR], true)) {
    41	            $uri = isset($_SERVER['REQUEST_URI']) ? $_SERVER['REQUEST_URI'] : '';
    42	            $msg = sprintf('FATAL: %s in %s:%d | URI=%s',
    43	                $err['message'], $err['file'], $err['line'], $uri
    44	            );
    45	            str_escribir_log($msg, 'DIAGNOSTICO');
    46	        }
    47	    }
    48	}
    49	register_shutdown_function('str_diag_shutdown');
===== END includes/diagnostico.php =====

===== BEGIN includes/features/groups/ajax/bracket-volcar.php =====
     1	<?php
     2	// AJAX: Volcar clasificados a bracket (stub con logs)
     3	// Acción: saas_bracket_volcar
     4	
     5	if (!defined('ABSPATH')) { exit; }
     6	
     7	add_action('wp_ajax_saas_bracket_volcar', 'saas_bracket_volcar');
     8	
     9	function saas_bracket_volcar() {
    10	    $t0 = microtime(true);
    11	    $req_id = function_exists('wp_generate_uuid4') ? wp_generate_uuid4() : uniqid('br_volcar_', true);
    12	
    13	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    14	    @ob_start();
    15	
    16	    if (function_exists('str_escribir_log')) {
    17	        str_escribir_log('[START] POST='.print_r($_POST, true).' | req_id='.$req_id, 'GROUPS:BRACKET');
    18	    }
    19	
    20	    // Seguridad
    21	    $nonce = isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : (isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce']) : '');
    22	    if (!$nonce || !wp_verify_nonce($nonce, 'str_nonce')) {
    23	        str_escribir_log('[DENY] Nonce inválido | req_id='.$req_id, 'GROUPS:BRACKET');
    24	        return str_groups_json_error(['message' => 'Nonce inválido.']);
    25	    }
    26	    if (!is_user_logged_in() || (!current_user_can('administrator') && !current_user_can('cliente'))) {
    27	        str_escribir_log('[DENY] Permisos insuficientes | req_id='.$req_id, 'GROUPS:BRACKET');
    28	        return str_groups_json_error(['message' => 'Permisos insuficientes.']);
    29	    }
    30	
    31	    // Aún no implementamos la lógica; solo confirmamos la traza
    32	    str_escribir_log('[END] STUB OK dur_ms='.round((microtime(true)-$t0)*1000).' | req_id='.$req_id, 'GROUPS:BRACKET');
    33	    return str_groups_json_ok(['message' => 'Volcado a bracket (stub).']);
    34	}
    35	
    36	// Helpers JSON
    37	if (!function_exists('str_groups_json_ok')) {
    38	    function str_groups_json_ok(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_success($data); }
    39	}
    40	if (!function_exists('str_groups_json_error')) {
    41	    function str_groups_json_error(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_error($data); }
    42	}
===== END includes/features/groups/ajax/bracket-volcar.php =====

===== BEGIN includes/features/groups/ajax/grupo-asignar-pareja.php =====
     1	<?php
     2	// AJAX: Asignar una pareja a un grupo
     3	// Acción: saas_grupo_asignar_pareja
     4	
     5	if (!defined('ABSPATH')) { exit; }
     6	
     7	add_action('wp_ajax_saas_grupo_asignar_pareja', 'saas_grupo_asignar_pareja');
     8	
     9	function saas_grupo_asignar_pareja() {
    10	    $t0 = microtime(true);
    11	    $req_id = function_exists('wp_generate_uuid4') ? wp_generate_uuid4() : uniqid('grp_asignar_', true);
    12	
    13	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    14	    @ob_start();
    15	
    16	    if (function_exists('str_escribir_log')) {
    17	        str_escribir_log('[START] POST='.print_r($_POST, true).' | req_id='.$req_id, 'GROUPS:ASIGNAR');
    18	    }
    19	
    20	    // Seguridad
    21	    $nonce = isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : (isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce']) : '');
    22	    if (!$nonce || !wp_verify_nonce($nonce, 'str_nonce')) {
    23	        str_escribir_log('[DENY] Nonce inválido | req_id='.$req_id, 'GROUPS:ASIGNAR');
    24	        return str_groups_json_error(['message' => 'Nonce inválido.']);
    25	    }
    26	    if (!is_user_logged_in() || (!current_user_can('administrator') && !current_user_can('cliente'))) {
    27	        str_escribir_log('[DENY] Permisos insuficientes | req_id='.$req_id, 'GROUPS:ASIGNAR');
    28	        return str_groups_json_error(['message' => 'Permisos insuficientes.']);
    29	    }
    30	
    31	    $comp_id  = isset($_POST['competicion_id']) ? intval($_POST['competicion_id']) : 0;
    32	    $grupo_id = isset($_POST['grupo_id']) ? intval($_POST['grupo_id']) : 0;
    33	    $pareja_id = isset($_POST['pareja_id']) ? intval($_POST['pareja_id']) : 0;
    34	
    35	    if (!$comp_id || !$grupo_id || !$pareja_id) {
    36	        str_escribir_log('[ERROR] Datos incompletos | req_id='.$req_id, 'GROUPS:ASIGNAR');
    37	        return str_groups_json_error(['message' => 'Datos incompletos.']);
    38	    }
    39	
    40	    // Validar que el grupo pertenece a la competición
    41	    $torneo_g = function_exists('get_field') ? get_field('torneo_asociado', $grupo_id) : 0;
    42	    $ok_comp  = false;
    43	    if (is_array($torneo_g)) {
    44	        foreach ($torneo_g as $item) {
    45	            $ok_comp = $ok_comp || ( (is_object($item) && isset($item->ID) ? intval($item->ID) : intval($item)) === $comp_id );
    46	        }
    47	    } else {
    48	        $ok_comp = (intval($torneo_g) === $comp_id);
    49	    }
    50	    if (!$ok_comp) {
    51	        str_escribir_log('[DENY] Grupo no pertenece a comp='.$comp_id.' | req_id='.$req_id, 'GROUPS:ASIGNAR');
    52	        return str_groups_json_error(['message' => 'Grupo no pertenece a la competición.']);
    53	    }
    54	
    55	    // Obtener participantes actuales
    56	    $miembros = function_exists('get_field') ? get_field('participantes_grupo', $grupo_id) : [];
    57	    $ids = [];
    58	    if (is_array($miembros)) {
    59	        foreach ($miembros as $item) { $ids[] = is_object($item) && isset($item->ID) ? intval($item->ID) : intval($item); }
    60	    } elseif (is_numeric($miembros)) {
    61	        $ids[] = intval($miembros);
    62	    }
    63	
    64	    // Evitar duplicados
    65	    if (in_array($pareja_id, $ids, true)) {
    66	        str_escribir_log('[END] Ya estaba asignada | pareja='.$pareja_id.' grupo='.$grupo_id.' | req_id='.$req_id, 'GROUPS:ASIGNAR');
    67	        return str_groups_json_ok(['message' => 'Pareja ya estaba en el grupo.']);
    68	    }
    69	
    70	    $ids[] = $pareja_id;
    71	    if (function_exists('update_field')) {
    72	        update_field('participantes_grupo', $ids, $grupo_id);
    73	    } else {
    74	        update_post_meta($grupo_id, 'participantes_grupo', $ids);
    75	    }
    76	
    77	    str_escribir_log('[END] OK pareja='.$pareja_id.' grupo='.$grupo_id.' dur_ms='.round((microtime(true)-$t0)*1000).' | req_id='.$req_id, 'GROUPS:ASIGNAR');
    78	    return str_groups_json_ok(['message' => 'Asignado']);
    79	}
    80	
    81	// Helpers JSON (si no están ya cargados por otro archivo)
    82	if (!function_exists('str_groups_json_ok')) {
    83	    function str_groups_json_ok(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_success($data); }
    84	}
    85	if (!function_exists('str_groups_json_error')) {
    86	    function str_groups_json_error(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_error($data); }
    87	}
===== END includes/features/groups/ajax/grupo-asignar-pareja.php =====

===== BEGIN includes/features/groups/ajax/grupo-crear.php =====
     1	<?php
     2	// /includes/features/groups/ajax/grupo-crear.php
     3	defined('ABSPATH') || exit;
     4	
     5	/**
     6	 * Registrar la acción AJAX (solo usuarios logueados).
     7	 * El JS llama a action: 'saas_grupo_crear'
     8	 */
     9	add_action('wp_ajax_saas_grupo_crear', 'saas_grupo_crear');
    10	
    11	/**
    12	 * Helpers mínimos (con guardas para no redeclarar si en el futuro
    13	 * incluyes otros archivos que definan lo mismo).
    14	 */
    15	if (!function_exists('str_groups__json_ok')) {
    16	    function str_groups__json_ok($data = []) {
    17	        if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    18	        wp_send_json_success($data);
    19	    }
    20	}
    21	if (!function_exists('str_groups__json_error')) {
    22	    function str_groups__json_error($data = [], $code = 400) {
    23	        if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    24	        wp_send_json_error($data, $code);
    25	    }
    26	}
    27	if (!function_exists('str_groups__require_caps')) {
    28	    function str_groups__require_caps() {
    29	        if (!is_user_logged_in() || (!current_user_can('administrator') && !current_user_can('cliente'))) {
    30	            str_groups__json_error(['message' => 'Permisos insuficientes.'], 403);
    31	        }
    32	    }
    33	}
    34	if (!function_exists('str_groups__check_nonce')) {
    35	    function str_groups__check_nonce() {
    36	        $nonce = isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce'])
    37	                 : (isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : '');
    38	        if (!$nonce || !wp_verify_nonce($nonce, 'str_nonce')) {
    39	            str_groups__json_error(['message' => 'Nonce inválido.'], 401);
    40	        }
    41	    }
    42	}
    43	if (!function_exists('str_groups__next_letter')) {
    44	    /**
    45	     * Devuelve el siguiente identificador disponible: A..Z, luego 1..99
    46	     */
    47	    function str_groups__next_letter($comp_id) {
    48	        $args = [
    49	            'post_type'      => 'grupo',
    50	            'post_status'    => 'publish',
    51	            'posts_per_page' => -1,
    52	            'fields'         => 'ids',
    53	            'meta_query'     => [[
    54	                'key'     => 'torneo_asociado',
    55	                'value'   => '"' . (int)$comp_id . '"',
    56	                'compare' => 'LIKE',
    57	            ]],
    58	        ];
    59	        $ids = get_posts($args);
    60	        $usadas = [];
    61	        foreach ($ids as $gid) {
    62	            $nombre = function_exists('get_field') ? get_field('nombre_grupo', $gid) : get_post_meta($gid, 'nombre_grupo', true);
    63	            if (!$nombre) {
    64	                $t = get_the_title($gid);
    65	                if (preg_match('~grupo\s+([A-Z0-9]+)~i', (string)$t, $m)) {
    66	                    $nombre = strtoupper($m[1]);
    67	                }
    68	            }
    69	            if ($nombre) { $usadas[] = strtoupper(trim($nombre)); }
    70	        }
    71	        $usadas = array_unique($usadas);
    72	        foreach (range('A','Z') as $L) {
    73	            if (!in_array($L, $usadas, true)) return $L;
    74	        }
    75	        for ($i=1; $i<=99; $i++) {
    76	            if (!in_array((string)$i, $usadas, true)) return (string)$i;
    77	        }
    78	        return wp_generate_password(4, false);
    79	    }
    80	}
    81	
    82	/**
    83	 * Controlador: crear grupo
    84	 * POST:
    85	 *  - competicion_id (int)  ← obligatorio
    86	 *  - nombre (string)       ← opcional (si viene "Grupo B", guardamos título "Grupo B" y ACF nombre="B")
    87	 */
    88	if (!function_exists('saas_grupo_crear')) {
    89	    function saas_grupo_crear() {
    90	        str_groups__check_nonce();
    91	        str_groups__require_caps();
    92	
    93	        $comp_id = isset($_POST['competicion_id']) ? (int) $_POST['competicion_id'] : 0;
    94	        $nombre  = isset($_POST['nombre']) ? sanitize_text_field($_POST['nombre']) : '';
    95	
    96	        if (!$comp_id || get_post_type($comp_id) !== 'competicion') {
    97	            str_groups__json_error(['message' => 'Competición inválida.']);
    98	        }
    99	
   100	        // Autogenerar identificador si no llega nombre
   101	        if ($nombre === '' || $nombre === null) {
   102	            $nombre = str_groups__next_letter($comp_id); // A, B, C...
   103	        }
   104	
   105	        // Construir TÍTULO y valor para el ACF 'nombre_grupo' evitando "Grupo Grupo X"
   106	        $nombre_field = $nombre;
   107	        if (preg_match('~^\s*grupo\s+(.+)$~i', $nombre, $m)) {
   108	            // Usuario pasó "Grupo B" → título "Grupo B", ACF nombre="B"
   109	            $title        = 'Grupo ' . trim($m[1]);
   110	            $nombre_field = trim($m[1]);
   111	        } else {
   112	            // Usuario pasó "B" → título "Grupo B", ACF nombre="B"
   113	            $title        = 'Grupo ' . trim($nombre);
   114	            $nombre_field = trim($nombre);
   115	        }
   116	
   117	        // Crear post grupo
   118	        $post_id = wp_insert_post([
   119	            'post_type'   => 'grupo',
   120	            'post_status' => 'publish',
   121	            'post_title'  => $title,
   122	            'post_author' => get_current_user_id(),
   123	        ], true);
   124	
   125	        if (is_wp_error($post_id) || !$post_id) {
   126	            $msg = is_wp_error($post_id) ? $post_id->get_error_message() : 'Error desconocido';
   127	            str_groups__json_error(['message' => 'No se pudo crear el grupo.', 'error' => $msg]);
   128	        }
   129	
   130	        // Guardar ACF/meta (compatibles con tu definición)
   131	        if (function_exists('update_field')) {
   132	            update_field('torneo_asociado', [$comp_id], $post_id); // relationship (return id)
   133	            update_field('nombre_grupo', $nombre_field, $post_id);
   134	            update_field('participantes_grupo', [], $post_id);     // vacío al crear
   135	        } else {
   136	            update_post_meta($post_id, 'torneo_asociado', [$comp_id]);
   137	            update_post_meta($post_id, 'nombre_grupo', $nombre_field);
   138	            update_post_meta($post_id, 'participantes_grupo', []);
   139	        }
   140	
   141	        str_groups__json_ok([
   142	            'message' => 'Grupo creado.',
   143	            'grupo'   => [
   144	                'id'     => $post_id,
   145	                'title'  => get_the_title($post_id),
   146	                'nombre' => $nombre_field,
   147	                'comp'   => $comp_id,
   148	            ],
   149	        ]);
   150	    }
   151	}
===== END includes/features/groups/ajax/grupo-crear.php =====

===== BEGIN includes/features/groups/ajax/grupo-eliminar.php =====
     1	<?php
     2	/**
     3	 * Handler AJAX: Eliminar grupo (envía a papelera)
     4	 * Alias compatible: str_grupo_eliminar  → apunta a saas_grupo_eliminar
     5	 *
     6	 * Seguridad:
     7	 *   - Nonce: check_ajax_referer('str_nonce', '_ajax_nonce')
     8	 *   - Permisos: admin o rol 'cliente' (o bien delete_post sobre el grupo)
     9	 *
    10	 * Comportamiento:
    11	 *   - Si el grupo tiene participantes, se vacía el ACF 'participantes_grupo'
    12	 *     antes de mandarlo a la papelera.
    13	 *   - Respuesta JSON con éxito o error detallado.
    14	 */
    15	
    16	if (!defined('ABSPATH')) { exit; }
    17	
    18	if (!function_exists('saas_grupo_eliminar')) {
    19	    function saas_grupo_eliminar() {
    20	
    21	        // Helpers de logging (mismo formato que el resto del módulo)
    22	        if (!function_exists('str_escribir_log')) {
    23	            function str_escribir_log($m, $o='GROUPS:DELETE') {
    24	                $ruta = defined('STR_PLUGIN_PATH') ? STR_PLUGIN_PATH . 'debug-saas-torneos.log' : __DIR__ . '/debug-saas-torneos.log';
    25	                if (!is_string($m)) { $m = print_r($m, true); }
    26	                @file_put_contents($ruta, "[".date('Y-m-d H:i:s')."] [$o] $m\n", FILE_APPEND);
    27	            }
    28	        }
    29	
    30	        try {
    31	            // === Nonce ===
    32	            if (!isset($_POST['_ajax_nonce'])) {
    33	                str_escribir_log('Nonce ausente');
    34	                wp_send_json_error(['message' => 'Nonce ausente.'], 400);
    35	            }
    36	            check_ajax_referer('str_nonce', '_ajax_nonce');
    37	
    38	            $comp_id  = isset($_POST['competicion_id']) ? absint($_POST['competicion_id']) : 0;
    39	            $grupo_id = isset($_POST['grupo_id'])       ? absint($_POST['grupo_id'])       : 0;
    40	
    41	            if (!$grupo_id) {
    42	                wp_send_json_error(['message' => 'ID de grupo inválido.'], 400);
    43	            }
    44	
    45	            $grupo = get_post($grupo_id);
    46	            if (!$grupo || $grupo->post_type !== 'grupo') {
    47	                wp_send_json_error(['message' => 'El post indicado no es un grupo válido.'], 404);
    48	            }
    49	
    50	            // === Permisos ===
    51	            $ok_caps = (is_user_logged_in() && (current_user_can('administrator') || current_user_can('cliente'))) || current_user_can('delete_post', $grupo_id);
    52	            if (!$ok_caps) {
    53	                wp_send_json_error(['message' => 'Permisos insuficientes.'], 403);
    54	            }
    55	
    56	            // === Si pasaron competicion_id, validamos pertenencia ===
    57	            if ($comp_id) {
    58	                // Reutilizamos helper si existe
    59	                $belongs = true;
    60	                if (function_exists('get_field')) {
    61	                    $raw = get_field('torneo_asociado', $grupo_id);
    62	                } else {
    63	                    $raw = get_post_meta($grupo_id, 'torneo_asociado', true);
    64	                }
    65	
    66	                // Normaliza a array de IDs
    67	                $ids = [];
    68	                if (!empty($raw)) {
    69	                    if (is_array($raw)) {
    70	                        foreach ($raw as $it) {
    71	                            if (is_numeric($it))        $ids[] = (int)$it;
    72	                            elseif (is_array($it) && isset($it['ID'])) $ids[] = (int)$it['ID'];
    73	                            elseif (is_object($it) && isset($it->ID))  $ids[] = (int)$it->ID;
    74	                        }
    75	                    } elseif (is_numeric($raw)) {
    76	                        $ids[] = (int)$raw;
    77	                    }
    78	                }
    79	                $belongs = in_array($comp_id, array_unique($ids), true);
    80	
    81	                if (!$belongs) {
    82	                    wp_send_json_error(['message' => 'El grupo no pertenece a esta competición.'], 400);
    83	                }
    84	            }
    85	
    86	            // === Vaciamos participantes (si los hubiera) para dejar todo consistente ===
    87	            $participantes = function_exists('get_field')
    88	                ? get_field('participantes_grupo', $grupo_id, false)
    89	                : get_post_meta($grupo_id, 'participantes_grupo', true);
    90	
    91	            if (!empty($participantes)) {
    92	                if (function_exists('update_field')) {
    93	                    @update_field('participantes_grupo', [], $grupo_id);
    94	                } else {
    95	                    update_post_meta($grupo_id, 'participantes_grupo', []);
    96	                }
    97	            }
    98	
    99	            // === Papelera (idempotente) ===
   100	            $status = get_post_status($grupo_id);
   101	            if ($status === 'trash') {
   102	                str_escribir_log("Ya estaba en papelera grupo_id=$grupo_id");
   103	            } else {
   104	                $trashed = wp_trash_post($grupo_id);
   105	                if (!$trashed || is_wp_error($trashed)) {
   106	                    $msg = is_wp_error($trashed) ? $trashed->get_error_message() : 'Error desconocido en wp_trash_post.';
   107	                    str_escribir_log("ERROR al enviar a papelera grupo_id=$grupo_id | $msg");
   108	                    wp_send_json_error(['message' => 'No se pudo eliminar el grupo.'], 400);
   109	                }
   110	            }
   111	
   112	            str_escribir_log("OK eliminado (papelera) grupo_id=$grupo_id comp_id=$comp_id actor=".get_current_user_id());
   113	
   114	            wp_send_json_success([
   115	                'message'  => 'Grupo eliminado correctamente.',
   116	                'grupo_id' => $grupo_id,
   117	                'comp_id'  => $comp_id,
   118	            ]);
   119	
   120	        } catch (\Throwable $e) {
   121	            str_escribir_log('EXCEPTION '.$e->getMessage());
   122	            wp_send_json_error(['message' => 'Excepción al eliminar el grupo.'], 500);
   123	        }
   124	    }
   125	}
===== END includes/features/groups/ajax/grupo-eliminar.php =====

===== BEGIN includes/features/groups/ajax/grupos-aleatorio.php =====
     1	<?php
     2	// AJAX: Rellenar grupos automáticamente con parejas libres
     3	// Acción: saas_grupos_aleatorio
     4	
     5	if (!defined('ABSPATH')) { exit; }
     6	
     7	add_action('wp_ajax_saas_grupos_aleatorio', 'saas_grupos_aleatorio');
     8	
     9	function saas_grupos_aleatorio() {
    10	    $t0 = microtime(true);
    11	    $req_id = function_exists('wp_generate_uuid4') ? wp_generate_uuid4() : uniqid('grp_auto_', true);
    12	
    13	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    14	    @ob_start();
    15	
    16	    if (function_exists('str_escribir_log')) {
    17	        str_escribir_log('[START] POST='.print_r($_POST, true).' | req_id='.$req_id, 'GROUPS:ALEATORIO');
    18	    }
    19	
    20	    // Seguridad
    21	    $nonce = isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : (isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce']) : '');
    22	    if (!$nonce || !wp_verify_nonce($nonce, 'str_nonce')) {
    23	        str_escribir_log('[DENY] Nonce inválido | req_id='.$req_id, 'GROUPS:ALEATORIO');
    24	        return str_groups_json_error(['message' => 'Nonce inválido.']);
    25	    }
    26	    if (!is_user_logged_in() || (!current_user_can('administrator') && !current_user_can('cliente'))) {
    27	        str_escribir_log('[DENY] Permisos insuficientes | req_id='.$req_id, 'GROUPS:ALEATORIO');
    28	        return str_groups_json_error(['message' => 'Permisos insuficientes.']);
    29	    }
    30	
    31	    $comp_id = isset($_POST['competicion_id']) ? intval($_POST['competicion_id']) : 0;
    32	    if (!$comp_id) {
    33	        return str_groups_json_error(['message' => 'ID de competición requerido.']);
    34	    }
    35	
    36	    // Grupos de la competición
    37	    $grupos = get_posts([
    38	        'post_type'      => 'grupo',
    39	        'post_status'    => 'publish',
    40	        'posts_per_page' => -1,
    41	        'meta_query'     => [[
    42	            'key'     => 'torneo_asociado',
    43	            'value'   => '"' . $comp_id . '"',
    44	            'compare' => 'LIKE',
    45	        ]]
    46	    ]);
    47	    if (!$grupos) {
    48	        return str_groups_json_error(['message' => 'No hay grupos creados para esta competición.']);
    49	    }
    50	
    51	    // Parejas del torneo
    52	    $parejas = get_posts([
    53	        'post_type'      => 'pareja',
    54	        'post_status'    => 'publish',
    55	        'posts_per_page' => -1,
    56	        'meta_query'     => [[
    57	            'key'     => 'torneo_asociado',
    58	            'value'   => '"' . $comp_id . '"',
    59	            'compare' => 'LIKE',
    60	        ]]
    61	    ]);
    62	    $parejas_ids = array_map(function($p){ return intval($p->ID); }, $parejas);
    63	
    64	    // Quitar las ya asignadas
    65	    $asignadas = [];
    66	    foreach ($grupos as $g) {
    67	        $miembros = function_exists('get_field') ? get_field('participantes_grupo', $g->ID) : [];
    68	        if (is_array($miembros)) {
    69	            foreach ($miembros as $item) { $asignadas[] = is_object($item)&&isset($item->ID) ? intval($item->ID) : intval($item); }
    70	        } elseif (is_numeric($miembros)) {
    71	            $asignadas[] = intval($miembros);
    72	        }
    73	    }
    74	    $asignadas = array_unique($asignadas);
    75	    $libres    = array_values(array_diff($parejas_ids, $asignadas));
    76	
    77	    shuffle($libres);
    78	
    79	    // Distribución round-robin simple
    80	    $i = 0;
    81	    foreach ($libres as $pid) {
    82	        $g = $grupos[$i % count($grupos)];
    83	        $miembros = function_exists('get_field') ? get_field('participantes_grupo', $g->ID) : [];
    84	        $ids = [];
    85	        if (is_array($miembros)) {
    86	            foreach ($miembros as $item) { $ids[] = is_object($item)&&isset($item->ID) ? intval($item->ID) : intval($item); }
    87	        } elseif (is_numeric($miembros)) {
    88	            $ids[] = intval($miembros);
    89	        }
    90	        if (!in_array($pid, $ids, true)) { $ids[] = $pid; }
    91	        if (function_exists('update_field')) {
    92	            update_field('participantes_grupo', $ids, $g->ID);
    93	        } else {
    94	            update_post_meta($g->ID, 'participantes_grupo', $ids);
    95	        }
    96	        $i++;
    97	    }
    98	
    99	    str_escribir_log('[END] OK auto-llenado libres='.count($libres).' dur_ms='.round((microtime(true)-$t0)*1000).' | req_id='.$req_id, 'GROUPS:ALEATORIO');
   100	    return str_groups_json_ok(['message' => 'Grupos rellenados automáticamente', 'libres_asignados' => count($libres)]);
   101	}
   102	
   103	// Helpers JSON
   104	if (!function_exists('str_groups_json_ok')) {
   105	    function str_groups_json_ok(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_success($data); }
   106	}
   107	if (!function_exists('str_groups_json_error')) {
   108	    function str_groups_json_error(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_error($data); }
   109	}
===== END includes/features/groups/ajax/grupos-aleatorio.php =====

===== BEGIN includes/features/groups/ajax/grupos-cargar.php =====
     1	<?php
     2	// AJAX: Cargar grupos de una competición + parejas libres
     3	// Acción: saas_grupos_cargar
     4	
     5	if (!defined('ABSPATH')) { exit; }
     6	
     7	add_action('wp_ajax_saas_grupos_cargar', 'saas_grupos_cargar');
     8	add_action('wp_ajax_nopriv_saas_grupos_cargar', 'saas_grupos_cargar'); // si no procede, quítalo
     9	
    10	function saas_grupos_cargar() {
    11	    $t0 = microtime(true);
    12	    $req_id = function_exists('wp_generate_uuid4') ? wp_generate_uuid4() : uniqid('grp_cargar_', true);
    13	
    14	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    15	    @ob_start();
    16	
    17	    // LOG: entrada cruda
    18	    if (function_exists('str_escribir_log')) {
    19	        str_escribir_log('[START] saas_grupos_cargar POST=' . print_r($_POST, true) . ' | req_id='.$req_id, 'GROUPS:CARGAR');
    20	    }
    21	
    22	    // Seguridad
    23	    $nonce = isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : (isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce']) : '');
    24	    if (!$nonce || !wp_verify_nonce($nonce, 'str_nonce')) {
    25	        str_escribir_log('[DENY] Nonce inválido | req_id='.$req_id, 'GROUPS:CARGAR');
    26	        return str_groups_json_error(['message' => 'Nonce inválido.']);
    27	    }
    28	
    29	    $comp_id = isset($_POST['competicion_id']) ? intval($_POST['competicion_id']) : (isset($_POST['post_id']) ? intval($_POST['post_id']) : 0);
    30	    if (!$comp_id) {
    31	        str_escribir_log('[DENY] competicion_id vacío | req_id='.$req_id, 'GROUPS:CARGAR');
    32	        return str_groups_json_error(['message' => 'ID de competición requerido.']);
    33	    }
    34	
    35	    // Query de grupos vinculados a esta competición (CPT: grupo, ACF: torneo_asociado)
    36	    $grupos = get_posts([
    37	        'post_type'      => 'grupo',
    38	        'post_status'    => 'publish',
    39	        'posts_per_page' => -1,
    40	        'meta_query'     => [[
    41	            'key'     => 'torneo_asociado',
    42	            'value'   => '"' . $comp_id . '"',
    43	            'compare' => 'LIKE',
    44	        ]]
    45	    ]);
    46	
    47	    // Todas las parejas del torneo (CPT: pareja, ACF: torneo_asociado)
    48	    $parejas_torneo = get_posts([
    49	        'post_type'      => 'pareja',
    50	        'post_status'    => 'publish',
    51	        'posts_per_page' => -1,
    52	        'meta_query'     => [[
    53	            'key'     => 'torneo_asociado',
    54	            'value'   => '"' . $comp_id . '"',
    55	            'compare' => 'LIKE',
    56	        ]]
    57	    ]);
    58	
    59	    $parejas_ids_torneo = array_map(function($p){ return intval($p->ID); }, $parejas_torneo);
    60	
    61	    // Construir estructura grupos
    62	    $payload_grupos = [];
    63	    $parejas_asignadas = [];
    64	
    65	    foreach ($grupos as $g) {
    66	        $nombre   = function_exists('get_field') ? get_field('nombre_grupo', $g->ID) : '';
    67	        $letra    = $nombre ? $nombre : $g->post_title;
    68	        $miembros = function_exists('get_field') ? get_field('participantes_grupo', $g->ID) : [];
    69	
    70	        // Normalizar lista de participantes a IDs
    71	        $ids = [];
    72	        if (is_array($miembros)) {
    73	            foreach ($miembros as $item) {
    74	                if (is_object($item) && isset($item->ID)) { $ids[] = intval($item->ID); }
    75	                else { $ids[] = intval($item); }
    76	            }
    77	        } elseif (is_numeric($miembros)) {
    78	            $ids[] = intval($miembros);
    79	        }
    80	
    81	        // Mapear a items del frontend
    82	        $items = [];
    83	        foreach ($ids as $pid) {
    84	            $title = get_the_title($pid);
    85	            $items[] = [
    86	                'id'          => $pid,
    87	                'title'       => $title ?: ('Pareja #'.$pid),
    88	                'placeholder' => false,
    89	            ];
    90	            $parejas_asignadas[] = $pid;
    91	        }
    92	
    93	        $payload_grupos[] = [
    94	            'id'            => $g->ID,
    95	            'letra'         => $letra,
    96	            'tam'           => max(count($ids), 0),
    97	            'participantes' => $items,
    98	        ];
    99	    }
   100	
   101	    // Parejas libres = todas del torneo - asignadas a algún grupo
   102	    $asignadas = array_unique($parejas_asignadas);
   103	    $libres    = array_values(array_diff($parejas_ids_torneo, $asignadas));
   104	    $libres_fmt = array_map(function($pid){
   105	        return [
   106	            'id'    => $pid,
   107	            'title' => get_the_title($pid) ?: ('Pareja #'.$pid),
   108	        ];
   109	    }, $libres);
   110	
   111	    $meta = [
   112	        'n_grupos'   => count($payload_grupos),
   113	        'n_parejas'  => count($parejas_ids_torneo),
   114	        'fase_final' => '',    // reservado
   115	        'modo_final' => '',    // reservado
   116	    ];
   117	
   118	    $out = [
   119	        'meta'           => $meta,
   120	        'grupos'         => $payload_grupos,
   121	        'parejas_libres' => $libres_fmt,
   122	    ];
   123	
   124	    if (function_exists('str_escribir_log')) {
   125	        str_escribir_log('[END] OK grupos='.count($payload_grupos).' libres='.count($libres_fmt).' dur_ms='.round((microtime(true)-$t0)*1000).' | req_id='.$req_id, 'GROUPS:CARGAR');
   126	    }
   127	
   128	    return str_groups_json_ok($out);
   129	}
   130	
   131	// Helpers JSON (protegidos para no redeclarar si vienen desde manage.php)
   132	if ( ! function_exists('str_groups_json_ok') ) {
   133	    function str_groups_json_ok($data = []) {
   134	        if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
   135	        wp_send_json_success($data);
   136	    }
   137	}
   138	
   139	if ( ! function_exists('str_groups_json_error') ) {
   140	    function str_groups_json_error($data = [], $code = 400) {
   141	        if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
   142	        // WP permite enviar código HTTP en el 2º parámetro
   143	        wp_send_json_error($data, $code);
   144	    }
   145	}
===== END includes/features/groups/ajax/grupos-cargar.php =====

===== BEGIN includes/features/groups/ajax/grupos-distribucion.php =====
     1	<?php
     2	/**
     3	 * AJAX Distribución de parejas en grupos (preview + aplicar)
     4	 * Ruta: includes/features/groups/ajax/grupos-distribucion.php
     5	 *
     6	 * Acciones:
     7	 *  - saas_grupos_distribucion_preview   (alias: str_grupos_distribucion_preview)
     8	 *  - saas_grupos_distribucion_aplicar   (alias: str_grupos_distribucion_aplicar)
     9	 *
    10	 * Requisitos:
    11	 *  - CPT: grupo, pareja
    12	 *  - ACF en grupo: torneo_asociado (relationship id/array), participantes_grupo (array ids), nombre_grupo (opcional)
    13	 *  - ACF en pareja: torneo_asociado (relationship con return object)  ← confirmado por el usuario
    14	 *
    15	 * Seguridad:
    16	 *  - check_ajax_referer('str_nonce', '_ajax_nonce')
    17	 *  - current_user_can('administrator') || current_user_can('cliente')
    18	 */
    19	
    20	if (!defined('ABSPATH')) { exit; }
    21	
    22	/* ------------------------ Utilidades compartidas ------------------------ */
    23	
    24	if (!function_exists('str_escribir_log')) {
    25	    function str_escribir_log($mensaje, $origen = 'GROUPS:DIST'){
    26	        $ruta = defined('STR_PLUGIN_PATH') ? STR_PLUGIN_PATH . 'debug-saas-torneos.log' : __DIR__ . '/../../../../debug-saas-torneos.log';
    27	        if (!is_string($mensaje)) { $mensaje = print_r($mensaje, true); }
    28	        @file_put_contents($ruta, sprintf("[%s] [%s] %s\n", date('Y-m-d H:i:s'), $origen, $mensaje), FILE_APPEND | LOCK_EX);
    29	    }
    30	}
    31	
    32	/** Normaliza un field ACF (object/ids/array serializado) a array de IDs int */
    33	function str_dist_normalize_ids($raw) {
    34	    if (empty($raw)) return [];
    35	    $out = [];
    36	    if (is_array($raw)) {
    37	        foreach ($raw as $item) {
    38	            if (is_numeric($item)) {
    39	                $out[] = (int)$item;
    40	            } elseif (is_object($item) && isset($item->ID)) {
    41	                $out[] = (int)$item->ID;
    42	            } elseif (is_array($item) && isset($item['ID'])) {
    43	                $out[] = (int)$item['ID'];
    44	            }
    45	        }
    46	    } elseif (is_numeric($raw)) {
    47	        $out[] = (int)$raw;
    48	    } elseif (is_object($raw) && isset($raw->ID)) {
    49	        $out[] = (int)$raw->ID;
    50	    }
    51	    return array_values(array_unique(array_filter($out)));
    52	}
    53	
    54	/** Valida nonce+permisos y devuelve array con comp_id y req_id */
    55	function str_dist_guard_common() {
    56	    if (!isset($_POST['_ajax_nonce'])) {
    57	        wp_send_json_error(['message' => 'Nonce ausente.'], 401);
    58	    }
    59	    check_ajax_referer('str_nonce', '_ajax_nonce');
    60	
    61	    if (!is_user_logged_in() || (!current_user_can('administrator') && !current_user_can('cliente'))) {
    62	        wp_send_json_error(['message' => 'Permisos insuficientes.'], 403);
    63	    }
    64	
    65	    $comp_id = isset($_POST['competicion_id']) ? absint($_POST['competicion_id']) : 0;
    66	    if (!$comp_id || get_post_type($comp_id) !== 'competicion') {
    67	        wp_send_json_error(['message' => 'Competición inválida.'], 400);
    68	    }
    69	
    70	    $req_id = isset($_POST['req_id']) ? sanitize_text_field($_POST['req_id']) : wp_generate_uuid4();
    71	    return [$comp_id, $req_id];
    72	}
    73	
    74	/** Carga contexto: grupos del torneo (con miembros) + parejas del torneo */
    75	function str_dist_fetch_context($comp_id) {
    76	    // Grupos del torneo (por ACF relationship LIKE para compat)
    77	    $grupos = get_posts([
    78	        'post_type'      => 'grupo',
    79	        'post_status'    => 'publish',
    80	        'posts_per_page' => -1,
    81	        'meta_query'     => [[
    82	            'key'     => 'torneo_asociado',
    83	            'value'   => '"' . (int)$comp_id . '"',
    84	            'compare' => 'LIKE',
    85	        ]],
    86	        'orderby' => ['date' => 'ASC', 'ID' => 'ASC'],
    87	    ]);
    88	
    89	    $ctx_grupos = [];
    90	    foreach ($grupos as $g) {
    91	        $miembros_raw = function_exists('get_field')
    92	            ? get_field('participantes_grupo', $g->ID, false)
    93	            : get_post_meta($g->ID, 'participantes_grupo', true);
    94	        $miembros = str_dist_normalize_ids($miembros_raw);
    95	
    96	        $nombre = function_exists('get_field') ? get_field('nombre_grupo', $g->ID) : '';
    97	        if (!$nombre) $nombre = $g->post_title ?: ('Grupo '.$g->ID);
    98	
    99	        $ctx_grupos[] = [
   100	            'id'       => (int)$g->ID,
   101	            'nombre'   => (string)$nombre,
   102	            'miembros' => $miembros, // ids de pareja o jugador
   103	        ];
   104	    }
   105	
   106	    // Parejas del torneo (ACF pareja.torneo_asociado = OBJECT → normalizamos)
   107	    $parejas_like = get_posts([
   108	        'post_type'      => 'pareja',
   109	        'post_status'    => 'publish',
   110	        'posts_per_page' => -1,
   111	        'meta_query'     => [[
   112	            'key'     => 'torneo_asociado',
   113	            'value'   => '"' . (int)$comp_id . '"',
   114	            'compare' => 'LIKE',
   115	        ]],
   116	        'fields'  => 'ids',
   117	    ]);
   118	
   119	    // Filtro de seguridad: de esas parejas, confirmar pertenencia leyendo el field (objeto)
   120	    $parejas_comp = [];
   121	    foreach ($parejas_like as $pid) {
   122	        $raw = function_exists('get_field') ? get_field('torneo_asociado', $pid, false) : get_post_meta($pid, 'torneo_asociado', true);
   123	        $ids = str_dist_normalize_ids($raw); // si return_format=object, caerá aquí (obj→id)
   124	        if (in_array((int)$comp_id, $ids, true)) {
   125	            $parejas_comp[] = (int)$pid;
   126	        }
   127	    }
   128	    $parejas_comp = array_values(array_unique($parejas_comp));
   129	
   130	    // Mapa miembros actuales por pareja_id → grupo_id (para recolocar controlado)
   131	    $pair_to_group = [];
   132	    foreach ($ctx_grupos as $g) {
   133	        foreach ($g['miembros'] as $pid) {
   134	            $pair_to_group[$pid] = (int)$g['id'];
   135	        }
   136	    }
   137	
   138	    return [
   139	        'grupos'         => $ctx_grupos,
   140	        'parejas'        => $parejas_comp,
   141	        'pair_to_group'  => $pair_to_group,
   142	    ];
   143	}
   144	
   145	/** Algoritmo de reparto random estable con semilla */
   146	function str_dist_shuffle_with_seed(array $arr, $seed = '') {
   147	    if ($seed === '' || $seed === null) {
   148	        shuffle($arr);
   149	        return $arr;
   150	    }
   151	    // PRNG determinista simple (no criptográfico)
   152	    $seed_str = (string)$seed;
   153	    $hash = md5($seed_str, true);
   154	    $state = unpack('N', substr($hash, 0, 4))[1];
   155	
   156	    $result = $arr;
   157	    for ($i = count($result) - 1; $i > 0; $i--) {
   158	        // LCG
   159	        $state = (1103515245 * $state + 12345) & 0x7fffffff;
   160	        $j = $state % ($i + 1);
   161	        $tmp = $result[$i];
   162	        $result[$i] = $result[$j];
   163	        $result[$j] = $tmp;
   164	    }
   165	    return $result;
   166	}
   167	
   168	/** Construye plan de distribución (no escribe BD) */
   169	function str_dist_build_plan(array $ctx, array $params) {
   170	    $policy       = isset($params['policy']) ? $params['policy'] : 'random';      // random | by_size
   171	    $seed         = isset($params['seed']) ? (string)$params['seed'] : '';
   172	    $target_size  = isset($params['target_size']) ? max(2, min(64, (int)$params['target_size'])) : 4;
   173	    $recolocar    = !empty($params['recolocar']) ? true : false;
   174	
   175	    $grupos  = $ctx['grupos'];
   176	    $parejas = $ctx['parejas'];
   177	    $p2g     = $ctx['pair_to_group'];
   178	
   179	    $summary = [
   180	        'groups'         => count($grupos),
   181	        'pairs_total'    => count($parejas),
   182	        'policy'         => $policy,
   183	        'target_size'    => $target_size,
   184	        'recolocar'      => $recolocar,
   185	        'notes'          => [],
   186	    ];
   187	
   188	    if (empty($grupos)) {
   189	        return ['plan' => [], 'summary' => $summary, 'error' => 'No hay grupos en esta competición. Crea grupos antes de distribuir.'];
   190	    }
   191	    if (empty($parejas)) {
   192	        $summary['notes'][] = 'No hay parejas asociadas a esta competición.';
   193	        // Plan vacío (no cambios)
   194	        $plan = [];
   195	        foreach ($grupos as $g) {
   196	            $plan[] = [
   197	                'grupo_id' => $g['id'],
   198	                'before'   => $g['miembros'],
   199	                'after'    => $g['miembros'],
   200	            ];
   201	        }
   202	        return ['plan' => $plan, 'summary' => $summary];
   203	    }
   204	
   205	    // Punto de partida: o bien solo libres, o todas (si recolocar)
   206	    $asignadas = array_keys($p2g);
   207	    $libres    = array_values(array_diff($parejas, $asignadas));
   208	    $pool      = $recolocar ? $parejas : $libres;
   209	
   210	    // Orden del pool
   211	    if ($policy === 'random') {
   212	        $pool = str_dist_shuffle_with_seed($pool, $seed);
   213	    } elseif ($policy === 'by_size') {
   214	        // Podemos mantener el orden actual pero la visita de grupos intentará aproximar a target_size
   215	        // (si quieres, aquí podrías ordenar por algún “seed” fijo también)
   216	    }
   217	
   218	    // Clonar estado actual si recolocar o no
   219	    $after = [];
   220	    foreach ($grupos as $g) {
   221	        $after[$g['id']] = $recolocar ? [] : $g['miembros'];
   222	    }
   223	
   224	    if ($policy === 'random') {
   225	        // Round-robin simple, repartiendo el pool sobre el array de grupos
   226	        $gids = array_map(fn($g)=>$g['id'], $grupos);
   227	        $gi = 0;
   228	        foreach ($pool as $pid) {
   229	            $target_gid = $gids[$gi % count($gids)];
   230	            $after[$target_gid][] = $pid;
   231	            $gi++;
   232	        }
   233	
   234	    } elseif ($policy === 'by_size') {
   235	        // Intentar aproximar tamaños a target_size
   236	        // 1) Si no recolocamos, calculamos capacidad “faltante” por grupo
   237	        $needs = [];
   238	        foreach ($grupos as $g) {
   239	            $curr = $recolocar ? 0 : count($g['miembros']);
   240	            $needs[$g['id']] = max(0, $target_size - $curr);
   241	        }
   242	
   243	        // 2) Asignar siguiendo “needs” (más hueco primero)
   244	        foreach ($pool as $pid) {
   245	            // escoger grupo con más necesidad actual
   246	            arsort($needs); // mayor necesidad primero
   247	            $chosen_gid = key($needs);
   248	            $after[$chosen_gid][] = $pid;
   249	            // actualizar necesidad
   250	            $needs[$chosen_gid] = max(0, $needs[$chosen_gid] - 1);
   251	        }
   252	    }
   253	
   254	    // Construir plan before/after
   255	    $plan = [];
   256	    foreach ($grupos as $g) {
   257	        $gid = $g['id'];
   258	        $plan[] = [
   259	            'grupo_id' => $gid,
   260	            'before'   => $g['miembros'],
   261	            'after'    => array_values(array_unique($after[$gid] ?? [])),
   262	        ];
   263	    }
   264	
   265	    return ['plan' => $plan, 'summary' => $summary];
   266	}
   267	
   268	/** Aplica plan a BD con rollback en caso de fallo */
   269	function str_dist_apply_plan(array $plan) {
   270	    $backup = [];
   271	    foreach ($plan as $item) {
   272	        $gid = (int)$item['grupo_id'];
   273	        // lee estado actual por si hay que restaurar
   274	        $raw = function_exists('get_field')
   275	            ? get_field('participantes_grupo', $gid, false)
   276	            : get_post_meta($gid, 'participantes_grupo', true);
   277	        $backup[$gid] = str_dist_normalize_ids($raw);
   278	    }
   279	
   280	    try {
   281	        foreach ($plan as $item) {
   282	            $gid   = (int)$item['grupo_id'];
   283	            $after = array_map('intval', (array)$item['after']);
   284	            if (function_exists('update_field')) {
   285	                if (false === update_field('participantes_grupo', $after, $gid)) {
   286	                    throw new Exception('Fallo update_field participantes_grupo en grupo '.$gid);
   287	                }
   288	            } else {
   289	                if (false === update_post_meta($gid, 'participantes_grupo', $after)) {
   290	                    throw new Exception('Fallo update_post_meta participantes_grupo en grupo '.$gid);
   291	                }
   292	            }
   293	        }
   294	        return true;
   295	    } catch (\Throwable $e) {
   296	        // rollback
   297	        foreach ($backup as $gid => $before) {
   298	            if (function_exists('update_field')) {
   299	                @update_field('participantes_grupo', $before, $gid);
   300	            } else {
   301	                @update_post_meta($gid, 'participantes_grupo', $before);
   302	            }
   303	        }
   304	        str_escribir_log('[APPLY][ERROR] '.$e->getMessage());
   305	        return false;
   306	    }
   307	}
   308	
   309	/* --------------------------- Handlers AJAX --------------------------- */
   310	
   311	/** PREVIEW */
   312	function saas_grupos_distribucion_preview() {
   313	    list($comp_id, $req_id) = str_dist_guard_common();
   314	
   315	    $policy      = isset($_POST['policy']) ? sanitize_text_field($_POST['policy']) : 'random';
   316	    $recolocar   = !empty($_POST['recolocar']) ? true : false;
   317	    $target_size = isset($_POST['target_size']) ? (int)$_POST['target_size'] : 4;
   318	    $seed        = isset($_POST['seed']) ? sanitize_text_field($_POST['seed']) : '';
   319	
   320	    $ctx   = str_dist_fetch_context($comp_id);
   321	    $built = str_dist_build_plan($ctx, [
   322	        'policy'      => $policy,
   323	        'recolocar'   => $recolocar,
   324	        'target_size' => $target_size,
   325	        'seed'        => $seed,
   326	    ]);
   327	
   328	    if (!empty($built['error'])) {
   329	        wp_send_json_error([
   330	            'message' => $built['error'],
   331	            'summary' => $built['summary'],
   332	            'req_id'  => $req_id,
   333	        ], 400);
   334	    }
   335	
   336	    str_escribir_log('[PREVIEW] OK comp='.$comp_id.' policy='.$policy.' recolocar='.(int)$recolocar.' target='.$target_size.' seed='.$seed.' plan_items='.count($built['plan']).' | req_id='.$req_id);
   337	
   338	    wp_send_json_success([
   339	        'plan'    => $built['plan'],
   340	        'summary' => $built['summary'],
   341	        'req_id'  => $req_id,
   342	    ]);
   343	}
   344	
   345	/** APLICAR */
   346	function saas_grupos_distribucion_aplicar() {
   347	    list($comp_id, $req_id) = str_dist_guard_common();
   348	
   349	    $policy      = isset($_POST['policy']) ? sanitize_text_field($_POST['policy']) : 'random';
   350	    $recolocar   = !empty($_POST['recolocar']) ? true : false;
   351	    $target_size = isset($_POST['target_size']) ? (int)$_POST['target_size'] : 4;
   352	    $seed        = isset($_POST['seed']) ? sanitize_text_field($_POST['seed']) : '';
   353	
   354	    $ctx   = str_dist_fetch_context($comp_id);
   355	    $built = str_dist_build_plan($ctx, [
   356	        'policy'      => $policy,
   357	        'recolocar'   => $recolocar,
   358	        'target_size' => $target_size,
   359	        'seed'        => $seed,
   360	    ]);
   361	
   362	    if (!empty($built['error'])) {
   363	        wp_send_json_error([
   364	            'message' => $built['error'],
   365	            'summary' => $built['summary'],
   366	            'req_id'  => $req_id,
   367	        ], 400);
   368	    }
   369	
   370	    $ok = str_dist_apply_plan($built['plan']);
   371	    if (!$ok) {
   372	        wp_send_json_error([
   373	            'message' => 'No se pudo aplicar la distribución (se revirtió el estado).',
   374	            'req_id'  => $req_id,
   375	        ], 500);
   376	    }
   377	
   378	    str_escribir_log('[APLICAR] OK comp='.$comp_id.' policy='.$policy.' recolocar='.(int)$recolocar.' target='.$target_size.' seed='.$seed.' plan_items='.count($built['plan']).' | req_id='.$req_id);
   379	
   380	    wp_send_json_success([
   381	        'message' => 'Distribución aplicada correctamente.',
   382	        'req_id'  => $req_id,
   383	    ]);
   384	}
===== END includes/features/groups/ajax/grupos-distribucion.php =====

===== BEGIN includes/features/groups/ajax/manage.php =====
     1	<?php
     2	// /includes/features/groups/ajax/manage.php
     3	defined('ABSPATH') || exit;
     4	
     5	/**
     6	 * Utilidades pequeñas
     7	 */
     8	if (!function_exists('str_escribir_log')) {
     9	    function str_escribir_log($mensaje, $origen = 'GRUPOS') {
    10	        $ruta = defined('STR_PLUGIN_PATH') ? STR_PLUGIN_PATH . 'debug-saas-torneos.log' : __DIR__ . '/debug-saas-torneos.log';
    11	        if (!is_string($mensaje)) { $mensaje = print_r($mensaje, true); }
    12	        @file_put_contents($ruta, sprintf("[%s] [%s] %s\n", date('Y-m-d H:i:s'), $origen, $mensaje), FILE_APPEND | LOCK_EX);
    13	    }
    14	}
    15	
    16	function str_groups_json_ok($data = []) {
    17	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    18	    wp_send_json_success($data);
    19	}
    20	function str_groups_json_error($data = [], $code = 400) {
    21	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    22	    wp_send_json_error($data, $code);
    23	}
    24	
    25	function str_groups_require_caps() {
    26	    if (!is_user_logged_in() || (!current_user_can('administrator') && !current_user_can('cliente'))) {
    27	        str_groups_json_error(['message' => 'Permisos insuficientes.'], 403);
    28	    }
    29	}
    30	
    31	function str_groups_check_nonce() {
    32	    $nonce = isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce'])
    33	            : (isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : '');
    34	    if (!$nonce || !wp_verify_nonce($nonce, 'str_nonce')) {
    35	        str_groups_json_error(['message' => 'Nonce inválido.'], 401);
    36	    }
    37	}
    38	
    39	/** Normaliza un campo relación (id/s, objetos) a array de IDs int */
    40	function str_groups_normalize_ids($raw) {
    41	    if (empty($raw)) return [];
    42	    $out = [];
    43	    if (is_array($raw)) {
    44	        foreach ($raw as $item) {
    45	            if (is_numeric($item)) $out[] = (int)$item;
    46	            elseif (is_object($item) && isset($item->ID)) $out[] = (int)$item->ID;
    47	            elseif (is_array($item) && isset($item['ID'])) $out[] = (int)$item['ID'];
    48	        }
    49	    } elseif (is_numeric($raw)) {
    50	        $out[] = (int)$raw;
    51	    } elseif (is_object($raw) && isset($raw->ID)) {
    52	        $out[] = (int)$raw->ID;
    53	    }
    54	    return array_values(array_unique(array_filter($out)));
    55	}
    56	
    57	/** Devuelve letras libres A..Z para autogenerar nombre de grupo */
    58	function str_groups_next_letter($comp_id) {
    59	    $ids = get_posts([
    60	        'post_type'      => 'grupo',
    61	        'post_status'    => 'publish',
    62	        'posts_per_page' => -1,
    63	        'meta_query'     => [[
    64	            'key'     => 'torneo_asociado',
    65	            'value'   => '"' . (int)$comp_id . '"',
    66	            'compare' => 'LIKE',
    67	        ]],
    68	        'fields' => 'ids',
    69	    ]);
    70	    $usadas = [];
    71	    foreach ($ids as $gid) {
    72	        $n = function_exists('get_field') ? get_field('nombre_grupo', $gid) : get_post_meta($gid, 'nombre_grupo', true);
    73	        if (!$n) {
    74	            $t = get_the_title($gid);
    75	            if (preg_match('~grupo\s+([A-Z0-9]+)~i', (string)$t, $m)) $n = strtoupper($m[1]);
    76	        }
    77	        if ($n) $usadas[] = strtoupper(trim($n));
    78	    }
    79	    $usadas = array_unique($usadas);
    80	
    81	    foreach (range('A','Z') as $L) if (!in_array($L, $usadas, true)) return $L;
    82	    for ($i=1; $i<=99; $i++) if (!in_array((string)$i, $usadas, true)) return (string)$i;
    83	    return wp_generate_password(4, false);
    84	}
    85	
    86	/** Valida que la pareja pertenece al torneo (campo ACF torneo_asociado) */
    87	function str_groups_pair_belongs_to_comp($pareja_id, $comp_id) {
    88	    $raw = function_exists('get_field') ? get_field('torneo_asociado', $pareja_id) : get_post_meta($pareja_id, 'torneo_asociado', true);
    89	    $ids = str_groups_normalize_ids($raw);
    90	    return in_array((int)$comp_id, $ids, true);
    91	}
    92	
    93	/** Comprueba que el grupo pertenece al torneo */
    94	function str_groups_group_belongs_to_comp($grupo_id, $comp_id) {
    95	    $raw = function_exists('get_field') ? get_field('torneo_asociado', $grupo_id) : get_post_meta($grupo_id, 'torneo_asociado', true);
    96	    $ids = str_groups_normalize_ids($raw);
    97	    return in_array((int)$comp_id, $ids, true);
    98	}
    99	
   100	/**
   101	 * ==============  ACCIONES AJAX
   102	 */
   103	add_action('wp_ajax_saas_grupo_crear',    'saas_grupo_crear');
   104	add_action('wp_ajax_saas_grupo_asignar',  'saas_grupo_asignar');
   105	add_action('wp_ajax_saas_grupo_quitar',   'saas_grupo_quitar');
   106	// Alias compat
   107	add_action('wp_ajax_str_grupo_crear',           'saas_grupo_crear');
   108	add_action('wp_ajax_str_grupo_asignar',         'saas_grupo_asignar');
   109	add_action('wp_ajax_str_grupo_quitar',          'saas_grupo_quitar');
   110	add_action('wp_ajax_str_grupo_asignar_pareja',  'saas_grupo_asignar');
   111	add_action('wp_ajax_str_grupo_quitar_pareja',   'saas_grupo_quitar');
   112	// Eliminar grupo (core + alias)
   113	add_action('wp_ajax_saas_grupo_eliminar', 'saas_grupo_eliminar');
   114	add_action('wp_ajax_str_grupo_eliminar',  'saas_grupo_eliminar');
   115	// Distribución (core + alias)
   116	add_action('wp_ajax_saas_grupos_distribucion_preview', 'saas_grupos_distribucion_preview');
   117	add_action('wp_ajax_saas_grupos_distribucion_aplicar', 'saas_grupos_distribucion_aplicar');
   118	add_action('wp_ajax_str_grupos_distribucion_preview', 'saas_grupos_distribucion_preview');
   119	add_action('wp_ajax_str_grupos_distribucion_aplicar', 'saas_grupos_distribucion_aplicar');
   120	
   121	/** Crear un grupo */
   122	function saas_grupo_crear() {
   123	    str_groups_check_nonce();
   124	    str_groups_require_caps();
   125	
   126	    $comp_id = isset($_POST['competicion_id']) ? (int)$_POST['competicion_id'] : 0;
   127	    $nombre  = isset($_POST['nombre']) ? sanitize_text_field($_POST['nombre']) : '';
   128	
   129	    if (!$comp_id || get_post_type($comp_id) !== 'competicion') {
   130	        str_groups_json_error(['message' => 'Competición inválida.']);
   131	    }
   132	
   133	    if ($nombre === '' || $nombre === null) $nombre = str_groups_next_letter($comp_id);
   134	
   135	    $nombre_field = $nombre;
   136	    if (preg_match('~^\s*grupo\s+~i', $nombre)) {
   137	        $title = trim($nombre);
   138	        if (preg_match('~^\s*grupo\s+(.+)$~i', $nombre, $m)) $nombre_field = trim($m[1]);
   139	    } else {
   140	        $title = 'Grupo ' . trim($nombre);
   141	    }
   142	
   143	    $post_id = wp_insert_post([
   144	        'post_type'   => 'grupo',
   145	        'post_status' => 'publish',
   146	        'post_title'  => $title,
   147	        'post_author' => get_current_user_id(),
   148	    ], true);
   149	
   150	    if (is_wp_error($post_id) || !$post_id) {
   151	        str_escribir_log('[GRUPOS:CREAR][ERROR] ' . (is_wp_error($post_id) ? $post_id->get_error_message() : 'ID=0'));
   152	        str_groups_json_error(['message' => 'No se pudo crear el grupo.']);
   153	    }
   154	
   155	    if (function_exists('update_field')) {
   156	        update_field('torneo_asociado', array($comp_id), $post_id);
   157	        update_field('nombre_grupo', $nombre_field, $post_id);
   158	        update_field('participantes_grupo', [], $post_id);
   159	    } else {
   160	        update_post_meta($post_id, 'torneo_asociado', array($comp_id));
   161	        update_post_meta($post_id, 'nombre_grupo', $nombre_field);
   162	        update_post_meta($post_id, 'participantes_grupo', []);
   163	    }
   164	
   165	    str_groups_json_ok([
   166	        'message' => 'Grupo creado.',
   167	        'grupo'   => [
   168	            'id'      => $post_id,
   169	            'title'   => get_the_title($post_id),
   170	            'nombre'  => $nombre_field,
   171	            'comp'    => $comp_id,
   172	            'miembros'=> [],
   173	        ]
   174	    ]);
   175	}
   176	
   177	/** Asignar pareja */
   178	function saas_grupo_asignar() {
   179	    str_groups_check_nonce();
   180	    str_groups_require_caps();
   181	
   182	    $comp_id   = isset($_POST['competicion_id']) ? (int)$_POST['competicion_id'] : 0;
   183	    $grupo_id  = isset($_POST['grupo_id']) ? (int)$_POST['grupo_id'] : 0;
   184	    $pareja_id = isset($_POST['pareja_id']) ? (int)$_POST['pareja_id'] : 0;
   185	
   186	    if (!$comp_id || !$grupo_id || !$pareja_id) {
   187	        str_groups_json_error(['message' => 'Datos incompletos.']);
   188	    }
   189	    if (get_post_type($grupo_id) !== 'grupo' || get_post_status($grupo_id) !== 'publish') {
   190	        str_groups_json_error(['message' => 'Grupo inválido.']);
   191	    }
   192	    if (get_post_type($pareja_id) !== 'pareja' || get_post_status($pareja_id) !== 'publish') {
   193	        if (get_post_type($pareja_id) !== 'jugador_deportes') {
   194	            str_groups_json_error(['message' => 'Pareja/Jugador inválido.']);
   195	        }
   196	    }
   197	    if (!str_groups_group_belongs_to_comp($grupo_id, $comp_id)) {
   198	        str_groups_json_error(['message' => 'El grupo no pertenece a esta competición.']);
   199	    }
   200	    if (get_post_type($pareja_id) === 'pareja' && !str_groups_pair_belongs_to_comp($pareja_id, $comp_id)) {
   201	        str_groups_json_error(['message' => 'La pareja no está asociada a este torneo.']);
   202	    }
   203	
   204	    $raw = function_exists('get_field') ? get_field('participantes_grupo', $grupo_id)
   205	                                        : get_post_meta($grupo_id, 'participantes_grupo', true);
   206	    $ids = str_groups_normalize_ids($raw);
   207	    if (!in_array($pareja_id, $ids, true)) $ids[] = $pareja_id;
   208	
   209	    if (function_exists('update_field')) update_field('participantes_grupo', $ids, $grupo_id);
   210	    else update_post_meta($grupo_id, 'participantes_grupo', $ids);
   211	
   212	    str_groups_json_ok([
   213	        'message' => 'Asignado.',
   214	        'grupo_id'=> $grupo_id,
   215	        'miembros'=> $ids,
   216	    ]);
   217	}
   218	
   219	/** Quitar pareja */
   220	function saas_grupo_quitar() {
   221	    str_groups_check_nonce();
   222	    str_groups_require_caps();
   223	
   224	    $comp_id   = isset($_POST['competicion_id']) ? (int)$_POST['competicion_id'] : 0;
   225	    $grupo_id  = isset($_POST['grupo_id'])       ? (int)$_POST['grupo_id']       : 0;
   226	    $pareja_id = isset($_POST['pareja_id'])      ? (int)$_POST['pareja_id']      : 0;
   227	
   228	    if (!$grupo_id || !$pareja_id) {
   229	        str_groups_json_error(['message' => 'Datos incompletos (grupo/pareja).']);
   230	    }
   231	
   232	    if (!$comp_id && $grupo_id) {
   233	        $raw = function_exists('get_field')
   234	            ? get_field('torneo_asociado', $grupo_id)
   235	            : get_post_meta($grupo_id, 'torneo_asociado', true);
   236	        $ids = str_groups_normalize_ids($raw);
   237	        if (count($ids) === 1) $comp_id = (int)$ids[0];
   238	    }
   239	    if (!$comp_id) str_groups_json_error(['message' => 'ID de competición no determinado.']);
   240	
   241	    if (get_post_type($grupo_id) !== 'grupo' || get_post_status($grupo_id) !== 'publish') {
   242	        str_groups_json_error(['message' => 'Grupo inválido.']);
   243	    }
   244	    if (!str_groups_group_belongs_to_comp($grupo_id, $comp_id)) {
   245	        str_groups_json_error(['message' => 'El grupo no pertenece a esta competición.']);
   246	    }
   247	
   248	    $raw = function_exists('get_field')
   249	        ? get_field('participantes_grupo', $grupo_id)
   250	        : get_post_meta($grupo_id, 'participantes_grupo', true);
   251	
   252	    $ids = str_groups_normalize_ids($raw);
   253	    $ids = array_values(array_diff($ids, [(int)$pareja_id]));
   254	
   255	    if (function_exists('update_field')) update_field('participantes_grupo', $ids, $grupo_id);
   256	    else update_post_meta($grupo_id, 'participantes_grupo', $ids);
   257	
   258	    str_groups_json_ok([
   259	        'message'  => 'Quitado.',
   260	        'grupo_id' => $grupo_id,
   261	        'miembros' => $ids,
   262	    ]);
   263	}
   264	
   265	/**
   266	 * ===== Bootstrap RENOMBRAR GRUPO (Fase 1) =====
   267	 */
   268	(function () {
   269	    $candidatos = [
   270	        __DIR__ . '/grupo-renombrar.php',
   271	        dirname(__DIR__) . '/grupo-renombrar.php',
   272	        dirname(__DIR__, 2) . '/groups/grupo-renombrar.php',
   273	    ];
   274	    $cargado = false;
   275	    foreach ($candidatos as $path) {
   276	        if (file_exists($path)) {
   277	            require_once $path;
   278	            str_escribir_log('BOOT-AJAX-RENAME loaded: ' . $path, 'GROUPS:RENAME');
   279	            $cargado = true;
   280	            break;
   281	        }
   282	    }
   283	    if (!$cargado) {
   284	        str_escribir_log('BOOT-AJAX-MISSING grupo-renombrar.php | tried: ' . implode(' | ', $candidatos), 'GROUPS:RENAME');
   285	    }
   286	
   287	    if (function_exists('saas_grupo_renombrar')) {
   288	        add_action('wp_ajax_saas_grupo_renombrar', 'saas_grupo_renombrar');
   289	        add_action('wp_ajax_str_grupo_renombrar',  'saas_grupo_renombrar');
   290	    } else {
   291	        add_action('wp_ajax_saas_grupo_renombrar', function(){ str_groups_json_error(['message'=>'Handler renombrar no cargado.'], 500); });
   292	        add_action('wp_ajax_str_grupo_renombrar',  function(){ str_groups_json_error(['message'=>'Handler renombrar no cargado.'], 500); });
   293	    }
   294	})();
   295	
   296	// === Bootstrap DISTRIBUCIÓN (preview + aplicar) ===============================
   297	$__str_grupos_dist_file = __DIR__ . '/grupos-distribucion.php';
   298	if (file_exists($__str_grupos_dist_file)) {
   299	    require_once $__str_grupos_dist_file;
   300	} else {
   301	    if (!function_exists('str_escribir_log')) {
   302	        function str_escribir_log($m,$o='GROUPS:DIST'){ @file_put_contents(__DIR__.'/../../../../debug-saas-torneos.log', "[".date('Y-m-d H:i:s')."] [$o] $m\n", FILE_APPEND); }
   303	    }
   304	    str_escribir_log('BOOT-AJAX-MISSING grupos-distribucion.php');
   305	}
   306	
   307	// === Bootstrap ELIMINAR GRUPO ===============================================
   308	$__str_grupo_eliminar_file = __DIR__ . '/grupo-eliminar.php';
   309	if (file_exists($__str_grupo_eliminar_file)) {
   310	    if (!function_exists('saas_grupo_eliminar')) {
   311	        require_once $__str_grupo_eliminar_file;
   312	        if (function_exists('str_escribir_log')) {
   313	            str_escribir_log('BOOT-AJAX-DELETE loaded: ' . $__str_grupo_eliminar_file, 'GROUPS:DELETE');
   314	        }
   315	    }
   316	} else {
   317	    if (!function_exists('str_escribir_log')) {
   318	        function str_escribir_log($m, $o='GRUPOS'){ @file_put_contents(__DIR__.'/../../../../debug-saas-torneos.log', "[".date('Y-m-d H:i:s')."] [$o] $m\n", FILE_APPEND); }
   319	    }
   320	    str_escribir_log('BOOT-AJAX-MISSING grupo-eliminar.php', 'GROUPS:DELETE');
   321	}
   322	add_action('wp_ajax_saas_grupo_eliminar', 'saas_grupo_eliminar');
   323	add_action('wp_ajax_str_grupo_eliminar',  'saas_grupo_eliminar');
   324	
   325	
   326	/* ────────────────────────────────────────────────────────────────
   327	   MOUNT POINT FRONTEND PARA GRUPOS
   328	   - Coloca <div id="str-gestion-grupos"></div> en el frontend de
   329	     single "competicion" SI NO EXISTE ya en el HTML de la plantilla.
   330	   - Con prioridad 5 (antes de la mayoría de scripts de footer).
   331	   ──────────────────────────────────────────────────────────────── */
   332	add_action('wp_footer', function () {
   333	    if (is_admin()) return;
   334	    if (!is_singular('competicion')) return;
   335	
   336	    // No podemos "comprobar" el DOM desde PHP, así que lo imprimimos siempre.
   337	    echo '<div id="str-gestion-grupos"></div>';
   338	    if (function_exists('str_escribir_log')) {
   339	        str_escribir_log('Mount point impreso en wp_footer para single competicion.', 'GROUPS:MOUNT');
   340	    }
   341	}, 5);
   342	
   343	/* (Opcional) Fallback: añadir también al final del contenido si el tema sí usa the_content */
   344	add_filter('the_content', function ($content) {
   345	    if (!is_singular('competicion')) return $content;
   346	    // Si ya hay un contenedor similar en el contenido, no duplicamos
   347	    if (strpos($content, 'id="str-gestion-grupos"') !== false) return $content;
   348	    return $content . "\n\n" . '<div id="str-gestion-grupos"></div>';
   349	}, 99);
===== END includes/features/groups/ajax/manage.php =====

===== BEGIN includes/features/groups/ajax/standings-grupo.php =====
     1	<?php
     2	// AJAX: Standings de grupos (provisional: usa clasificación_grupo si existe; si no, lista participantes con ceros)
     3	// Acción: saas_grupos_standings
     4	
     5	if (!defined('ABSPATH')) { exit; }
     6	
     7	add_action('wp_ajax_saas_grupos_standings', 'saas_grupos_standings');
     8	add_action('wp_ajax_nopriv_saas_grupos_standings', 'saas_grupos_standings');
     9	
    10	function saas_grupos_standings() {
    11	    $t0 = microtime(true);
    12	    $req_id = function_exists('wp_generate_uuid4') ? wp_generate_uuid4() : uniqid('grp_stand_', true);
    13	
    14	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    15	    @ob_start();
    16	
    17	    if (function_exists('str_escribir_log')) {
    18	        str_escribir_log('[START] POST='.print_r($_POST, true).' | req_id='.$req_id, 'GROUPS:STANDINGS');
    19	    }
    20	
    21	    // Seguridad (puede permitir nopriv, pero siempre con nonce)
    22	    $nonce = isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce']) : (isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce']) : '');
    23	    if (!$nonce || !wp_verify_nonce($nonce, 'str_nonce')) {
    24	        str_escribir_log('[DENY] Nonce inválido | req_id='.$req_id, 'GROUPS:STANDINGS');
    25	        return str_groups_json_error(['message' => 'Nonce inválido.']);
    26	    }
    27	
    28	    $comp_id = isset($_POST['competicion_id']) ? intval($_POST['competicion_id']) : 0;
    29	    if (!$comp_id) {
    30	        return str_groups_json_error(['message' => 'ID de competición requerido.']);
    31	    }
    32	
    33	    $grupos = get_posts([
    34	        'post_type'      => 'grupo',
    35	        'post_status'    => 'publish',
    36	        'posts_per_page' => -1,
    37	        'meta_query'     => [[
    38	            'key'     => 'torneo_asociado',
    39	            'value'   => '"' . $comp_id . '"',
    40	            'compare' => 'LIKE',
    41	        ]]
    42	    ]);
    43	
    44	    $out = ['grupos' => []];
    45	
    46	    foreach ($grupos as $g) {
    47	        $nombre = function_exists('get_field') ? get_field('nombre_grupo', $g->ID) : '';
    48	        $letra  = $nombre ? $nombre : $g->post_title;
    49	
    50	        $rows = [];
    51	
    52	        // Si hay repeater 'clasificacion_grupo', lo usamos
    53	        if (function_exists('have_rows') && have_rows('clasificacion_grupo', $g->ID)) {
    54	            while (have_rows('clasificacion_grupo', $g->ID)) {
    55	                the_row();
    56	                $part = get_sub_field('clas_participante');
    57	                $pos  = intval(get_sub_field('posicion'));
    58	                $pts  = intval(get_sub_field('puntos'));
    59	
    60	                // normalizar ID
    61	                if (is_array($part)) { $part = reset($part); }
    62	                $pid = (is_object($part) && isset($part->ID)) ? intval($part->ID) : intval($part);
    63	
    64	                $rows[] = [
    65	                    'id'        => $pid,
    66	                    'title'     => get_the_title($pid) ?: ('Participante #'.$pid),
    67	                    'pj'        => 0, 'pg' => 0, 'pp' => 0,
    68	                    'pts'       => $pts,
    69	                    'sets_f'    => 0, 'sets_c' => 0,
    70	                    'juegos_f'  => 0, 'juegos_c'=> 0,
    71	                    'pos'       => $pos,
    72	                ];
    73	            }
    74	            // ordenar por pos asc, luego pts desc
    75	            usort($rows, function($a,$b){
    76	                if ($a['pos'] && $b['pos'] && $a['pos'] !== $b['pos']) return $a['pos'] <=> $b['pos'];
    77	                return $b['pts'] <=> $a['pts'];
    78	            });
    79	        } else {
    80	            // Si no hay clasificacion guardada, listar participantes actuales con valores a 0
    81	            $miembros = function_exists('get_field') ? get_field('participantes_grupo', $g->ID) : [];
    82	            $ids = [];
    83	            if (is_array($miembros)) {
    84	                foreach ($miembros as $item) { $ids[] = is_object($item) && isset($item->ID) ? intval($item->ID) : intval($item); }
    85	            } elseif (is_numeric($miembros)) {
    86	                $ids[] = intval($miembros);
    87	            }
    88	            foreach ($ids as $pid) {
    89	                $rows[] = [
    90	                    'id'       => $pid,
    91	                    'title'    => get_the_title($pid) ?: ('Participante #'.$pid),
    92	                    'pj'       => 0, 'pg'=>0, 'pp'=>0,
    93	                    'pts'      => 0,
    94	                    'sets_f'   => 0, 'sets_c'=>0,
    95	                    'juegos_f' => 0, 'juegos_c'=>0,
    96	                ];
    97	            }
    98	        }
    99	
   100	        $out['grupos'][] = [
   101	            'id'    => $g->ID,
   102	            'letra' => $letra,
   103	            'items' => $rows,
   104	        ];
   105	    }
   106	
   107	    str_escribir_log('[END] OK grupos='.count($out['grupos']).' dur_ms='.round((microtime(true)-$t0)*1000).' | req_id='.$req_id, 'GROUPS:STANDINGS');
   108	    return str_groups_json_ok($out);
   109	}
   110	
   111	// Helpers JSON
   112	if (!function_exists('str_groups_json_ok')) {
   113	    function str_groups_json_ok(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_success($data); }
   114	}
   115	if (!function_exists('str_groups_json_error')) {
   116	    function str_groups_json_error(array $data){ if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); } wp_send_json_error($data); }
   117	}
===== END includes/features/groups/ajax/standings-grupo.php =====

===== BEGIN includes/features/groups/grupo-renombrar.php =====
     1	<?php
     2	/**
     3	 * Handler AJAX: Renombrar grupo
     4	 * Acción alias: str_grupo_renombrar  → apunta a saas_grupo_renombrar
     5	 * Seguridad: check_ajax_referer('str_nonce', '_ajax_nonce')
     6	 * Permisos: usuario con capacidad para editar el post del grupo
     7	 * Logs: [GROUPS:RENAME]
     8	 */
     9	
    10	if ( ! defined('ABSPATH') ) { exit; }
    11	
    12	if ( ! function_exists('saas_grupo_renombrar') ) {
    13	    function saas_grupo_renombrar() {
    14	        try {
    15	            // Valida nonce (ajustar la clave si tu front usa otra)
    16	            if ( ! isset($_POST['_ajax_nonce']) ) {
    17	                wp_send_json_error(['msg' => 'Nonce ausente.'], 400);
    18	            }
    19	            check_ajax_referer('str_nonce', '_ajax_nonce');
    20	
    21	            $grupo_id        = isset($_POST['grupo_id']) ? absint($_POST['grupo_id']) : 0;
    22	            $nuevo_nombre    = isset($_POST['nombre']) ? trim(wp_strip_all_tags($_POST['nombre'])) : '';
    23	            $competicion_id  = isset($_POST['competicion_id']) ? absint($_POST['competicion_id']) : 0;
    24	
    25	            if ( ! $grupo_id ) {
    26	                wp_send_json_error(['msg' => 'ID de grupo inválido.'], 400);
    27	            }
    28	
    29	            $grupo = get_post($grupo_id);
    30	            if ( ! $grupo || $grupo->post_type !== 'grupo' ) {
    31	                wp_send_json_error(['msg' => 'El post indicado no es un grupo válido.'], 404);
    32	            }
    33	
    34	            // Permisos mínimos: poder editar ese post
    35	            if ( ! current_user_can('edit_post', $grupo_id) ) {
    36	                wp_send_json_error(['msg' => 'Permisos insuficientes.'], 403);
    37	            }
    38	
    39	            // Normaliza nombre
    40	            $nuevo_nombre = $nuevo_nombre !== '' ? $nuevo_nombre : $grupo->post_title;
    41	
    42	            // (Opcional) Evitar duplicados por competición si tenemos su ID
    43	            if ( $competicion_id ) {
    44	                $siblings = get_posts([
    45	                    'post_type'      => 'grupo',
    46	                    'post_status'    => 'any',
    47	                    'posts_per_page' => -1,
    48	                    'post_parent'    => $competicion_id,
    49	                    'fields'         => 'ids',
    50	                    'exclude'        => [$grupo_id],
    51	                ]);
    52	
    53	                if ( ! is_wp_error($siblings) && $siblings ) {
    54	                    foreach ($siblings as $sib_id) {
    55	                        $sib = get_post($sib_id);
    56	                        if ( $sib && strcasecmp(trim($sib->post_title), trim($nuevo_nombre)) === 0 ) {
    57	                            wp_send_json_error(['msg' => 'Ya existe otro grupo con ese nombre en esta competición.'], 409);
    58	                        }
    59	                    }
    60	                }
    61	            }
    62	
    63	            // Actualiza título del post
    64	            $update = wp_update_post([
    65	                'ID'         => $grupo_id,
    66	                'post_title' => $nuevo_nombre,
    67	            ], true);
    68	
    69	            if ( is_wp_error($update) ) {
    70	                error_log('[GROUPS:RENAME] Error wp_update_post grupo_id='.$grupo_id.' → '.$update->get_error_message());
    71	                wp_send_json_error(['msg' => 'No se pudo actualizar el nombre del grupo.'], 500);
    72	            }
    73	
    74	            // Si usas ACF "nombre_grupo", mantenlo sincronizado (no es obligatorio)
    75	            if ( function_exists('update_field') && get_field('nombre_grupo', $grupo_id, false) !== null ) {
    76	                @update_field('nombre_grupo', $nuevo_nombre, $grupo_id);
    77	            }
    78	
    79	            // Log OK
    80	            $actor = get_current_user_id();
    81	            error_log('[GROUPS:RENAME] OK grupo_id='.$grupo_id.' nuevo_nombre="'.$nuevo_nombre.'" actor='.$actor.' comp_id='.$competicion_id);
    82	
    83	            wp_send_json_success([
    84	                'grupo_id'   => $grupo_id,
    85	                'nombre'     => $nuevo_nombre,
    86	                'comp_id'    => $competicion_id,
    87	                'message'    => 'Grupo renombrado correctamente.',
    88	            ]);
    89	        } catch (\Throwable $e) {
    90	            error_log('[GROUPS:RENAME] EXCEPTION '.$e->getMessage());
    91	            wp_send_json_error(['msg' => 'Excepción no controlada al renombrar el grupo.'], 500);
    92	        }
    93	    }
    94	}
===== END includes/features/groups/grupo-renombrar.php =====

===== BEGIN includes/features/groups/index.css =====
     1	/* ==========================================================================
     2	   Torneo · Módulo de Grupos / Standings / Bracket
     3	   Ruta: /saas-torneos-de-raqueta/assets/css/torneo-grupos.css
     4	   ========================================================================== */
     5	
     6	/* ---- Utilidades de layout ---- */
     7	.str-grid-2col {
     8	  display: grid;
     9	  grid-template-columns: 1.1fr 0.9fr;
    10	  gap: 18px;
    11	}
    12	@media (max-width: 992px) {
    13	  .str-grid-2col { grid-template-columns: 1fr; }
    14	}
    15	
    16	/* ---- Botones genéricos del módulo (no pisa los existentes) ---- */
    17	.str-btn {
    18	  display: inline-flex;
    19	  align-items: center;
    20	  gap: 8px;
    21	  padding: 10px 14px;
    22	  border: 1px solid #dbe6ff;
    23	  background: #f8fbff;
    24	  color: #1a2156;
    25	  border-radius: 10px;
    26	  font-weight: 600;
    27	  cursor: pointer;
    28	  transition: box-shadow .15s, transform .06s ease-in-out, background .15s, color .15s, border-color .15s;
    29	  user-select: none;
    30	  text-decoration: none;
    31	}
    32	.str-btn:hover { box-shadow: 0 3px 10px rgba(40,65,100,0.12); }
    33	.str-btn:active { transform: translateY(1px); }
    34	
    35	/* Primario azul genérico */
    36	.str-btn-primary,
    37	.str-btn--primary {
    38	  border-color: #2152ff;
    39	  background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%);
    40	  color: #fff;
    41	}
    42	.str-btn-primary:hover,
    43	.str-btn--primary:hover {
    44	  box-shadow: 0 3px 12px rgba(33,82,255,0.25);
    45	  filter: brightness(0.97);
    46	}
    47	.str-btn-primary:active,
    48	.str-btn--primary:active { transform: translateY(1px); }
    49	
    50	/* Tamaño pequeño */
    51	.str-btn-small {
    52	  padding: 7px 10px;
    53	  font-size: .92rem;
    54	  border-radius: 8px;
    55	}
    56	
    57	/* ---- Pills & Badges ---- */
    58	.pill {
    59	  display: inline-flex;
    60	  align-items: center;
    61	  padding: 4px 8px;
    62	  font-size: .83rem;
    63	  border-radius: 999px;
    64	  border: 1px solid #e3ecff;
    65	  background: #f6f9ff;
    66	  color: #26457c;
    67	}
    68	.pill-ok {
    69	  border-color: #c9f0d7;
    70	  background: #ecfdf5;
    71	  color: #0f5132;
    72	}
    73	.badge {
    74	  display: inline-flex;
    75	  align-items: center;
    76	  font-size: .78rem;
    77	  padding: 2px 8px;
    78	  border-radius: 999px;
    79	  background: #fff1d6;
    80	  color: #874d00;
    81	  border: 1px solid #ffe2ae;
    82	}
    83	
    84	/* ---- Cabecera del bloque de grupos ---- */
    85	.str-groups-header {
    86	  display: flex;
    87	  align-items: center;
    88	  justify-content: space-between;
    89	  gap: 12px;
    90	  margin-bottom: 10px;
    91	}
    92	.str-groups-meta {
    93	  display: flex;
    94	  flex-wrap: wrap;
    95	  gap: 12px 18px;
    96	  color: #4a5b8a;
    97	  font-size: .95rem;
    98	}
    99	.str-groups-meta b { color: #173a9c; }
   100	.str-groups-actions { display: flex; gap: 10px; }
   101	@media (max-width: 640px) {
   102	  .str-groups-header { flex-direction: column; align-items: flex-start; }
   103	  .str-groups-actions { width: 100%; }
   104	  .str-groups-actions .str-btn { width: 100%; justify-content: center; }
   105	}
   106	
   107	/* ---- Cards de grupos (grid) ---- */
   108	.str-grid-groups {
   109	  display: grid;
   110	  grid-template-columns: repeat( auto-fill, minmax(260px, 1fr) );
   111	  gap: 16px;
   112	}
   113	
   114	/* Reutiliza .str-card de la plantilla; afinamos variantes */
   115	.str-card.grupo .str-card-head .title b { color: #183C86; }
   116	.str-card.standings .str-card-head .title b { color: #183C86; }
   117	
   118	/* ---- Listas de participantes en grupo ---- */
   119	.str-list {
   120	  list-style: none;
   121	  margin: 0;
   122	  padding: 10px 12px 16px 12px;
   123	}
   124	.str-row {
   125	  display: grid;
   126	  grid-template-columns: 1fr auto;
   127	  align-items: center;
   128	  gap: 10px;
   129	  padding: 10px 12px;
   130	  margin-bottom: 8px;
   131	  border: 1px solid #eef3fb;
   132	  border-radius: 10px;
   133	  background: #f9fbff;
   134	}
   135	.str-row.placeholder {
   136	  background: #fffaf3;
   137	  border-color: #ffe6bf;
   138	}
   139	.str-pair-name {
   140	  color: #1a2156;
   141	  font-weight: 600;
   142	  font-size: .98rem;
   143	}
   144	.str-actions { display: flex; align-items: center; gap: 8px; }
   145	
   146	/* Select “Añadir pareja libre ...” – adaptativo + ellipsis */
   147	.str-pair-select,
   148	.str-select {
   149	  min-width: 0;
   150	  width: 100%;
   151	  padding: 8px 10px;
   152	  border-radius: 8px;
   153	  border: 1.5px solid #d8e4ff;
   154	  background: #fff;
   155	  font-size: .95rem;
   156	  color: #1a2156;
   157	  outline: none;
   158	  transition: border .15s, background .15s;
   159	  white-space: nowrap;
   160	  overflow: hidden;
   161	  text-overflow: ellipsis;
   162	}
   163	.str-pair-select:focus,
   164	.str-select:focus {
   165	  border-color: #2152ff;
   166	  background: #f5f9ff;
   167	}
   168	
   169	/* Fila de añadir: select flexible + botón visible */
   170	.str-row-add {
   171	  display: flex;
   172	  gap: 8px;
   173	  padding: 10px 12px;
   174	  border-top: 1px dashed #e5e7eb;
   175	  background: #fcfcfd;
   176	}
   177	.str-row-add .str-select { flex: 1 1 auto; min-width: 0; }
   178	.str-row-add .str-btn { flex: 0 0 auto; }
   179	
   180	/* ---- Tabla de standings ---- */
   181	.str-table-wrap { width: 100%; overflow-x: auto; }
   182	.str-table {
   183	  width: 100%;
   184	  border-collapse: collapse;
   185	  font-size: .95rem;
   186	  color: #1a2156;
   187	}
   188	.str-table th,
   189	.str-table td {
   190	  border-bottom: 1px solid #eef3fb;
   191	  padding: 10px 10px;
   192	  text-align: left;
   193	  white-space: nowrap;
   194	}
   195	.str-table thead th {
   196	  background: #f4f8ff;
   197	  color: #1b2f6b;
   198	  font-weight: 700;
   199	  font-size: .92rem;
   200	}
   201	.str-table tbody tr:hover { background: #fafcff; }
   202	
   203	/* ---- Bracket (acciones) ---- */
   204	#str-bracket .str-card-body p { margin-bottom: 10px; }
   205	#str-bracket .str-actions {
   206	  display: flex;
   207	  align-items: center;
   208	  gap: 12px;
   209	  flex-wrap: wrap;
   210	}
   211	#str-bracket .str-inline {
   212	  display: inline-flex;
   213	  align-items: center;
   214	  gap: 8px;
   215	  font-size: .95rem;
   216	  color: #293d7a;
   217	}
   218	
   219	/* ---- Mensajería sutil ---- */
   220	.str-muted { color: #6b7ea5; }
   221	
   222	/* ---- Pequeñas adaptaciones responsive ---- */
   223	@media (max-width: 480px) {
   224	  .str-pair-select { min-width: 140px; }
   225	  .str-row { grid-template-columns: 1fr; }
   226	  .str-actions { justify-content: space-between; }
   227	  .str-table th, .str-table td { padding: 8px; }
   228	}
   229	
   230	/* ---- Compatibilidad con el resto de la estética ---- */
   231	#str-gestion-grupos .str-card-body,
   232	#str-standings .str-card-body,
   233	#str-bracket .str-card-body {
   234	  padding-top: 14px;
   235	  padding-bottom: 16px;
   236	}
   237	#str-gestion-grupos .str-card-head,
   238	#str-standings .str-card-head,
   239	#str-bracket .str-card-head {
   240	  padding-top: 14px;
   241	  padding-bottom: 14px;
   242	  border-bottom: 1px solid #eef3fb;
   243	}
   244	#str-gestion-grupos .title,
   245	#str-standings .title,
   246	#str-bracket .title {
   247	  font-weight: 700;
   248	  color: #1a2156;
   249	  font-size: 1.06rem;
   250	}
   251	
   252	/* ────────────────────────────────────────────────────────────
   253	   MODAL "Crear grupo"
   254	   ──────────────────────────────────────────────────────────── */
   255	.str-modal-overlay {
   256	  position: fixed; inset: 0; background: rgba(15, 23, 42, 0.55);
   257	  display: none; z-index: 9990;
   258	}
   259	.str-modal-overlay.show { display: block; }
   260	
   261	.str-modal {
   262	  position: fixed; inset: 0; display: none; z-index: 9991;
   263	  align-items: center; justify-content: center; padding: 1rem;
   264	  color: #0f172a;
   265	}
   266	.str-modal.show { display: flex; }
   267	
   268	.str-modal-dialog {
   269	  width: 100%; max-width: 520px; border-radius: 16px;
   270	  background: #fff; box-shadow: 0 20px 40px rgba(0,0,0,.2);
   271	  overflow: hidden;
   272	}
   273	
   274	.str-modal-head { padding: 16px 20px; border-bottom: 1px solid #eef2f7; }
   275	.str-modal-title { margin: 0; font-size: 18px; font-weight: 700; color: #0f172a; }
   276	
   277	.str-modal-body { padding: 16px 20px; }
   278	.str-field { margin-bottom: 12px; }
   279	.str-field label {
   280	  display: block; font-size: 13px; color: #64748b; margin-bottom: 6px;
   281	}
   282	
   283	/* Fix visibilidad inputs modal */
   284	.str-modal .str-field input[type="text"],
   285	.str-modal .str-field input[type="number"],
   286	.str-modal .str-field select,
   287	.str-modal .str-field textarea {
   288	  width: 100%; height: 40px; padding: 8px 12px; border-radius: 10px;
   289	  border: 1px solid #dbe2ea; outline: none;
   290	  background-color: #ffffff !important;
   291	  color: #0f172a !important;
   292	  caret-color: #0f172a;
   293	}
   294	.str-modal .str-field input::placeholder,
   295	.str-modal .str-field textarea::placeholder {
   296	  color: #94a3b8 !important;
   297	  opacity: 1;
   298	}
   299	.str-modal .str-field input:-webkit-autofill,
   300	.str-modal .str-field input:-webkit-autofill:hover,
   301	.str-modal .str-field input:-webkit-autofill:focus {
   302	  -webkit-text-fill-color: #0f172a !important;
   303	  -webkit-box-shadow: 0 0 0px 1000px #ffffff inset;
   304	  box-shadow: 0 0 0px 1000px #ffffff inset;
   305	}
   306	.str-modal .str-field input:focus,
   307	.str-modal .str-field select:focus,
   308	.str-modal .str-field textarea:focus {
   309	  border-color: #4f46e5;
   310	  box-shadow: 0 0 0 3px rgba(79,70,229,.12);
   311	  background-color: #ffffff;
   312	  color: #0f172a;
   313	}
   314	
   315	.str-modal-foot {
   316	  padding: 14px 20px; display: flex; gap: 10px; justify-content: flex-end;
   317	  border-top: 1px solid #eef2f7; background: #fafbfc;
   318	}
   319	
   320	/* Botones dentro del modal (coherentes con los azules) */
   321	.str-modal .str-btn {
   322	  display: inline-flex;
   323	  align-items: center;
   324	  gap: .5rem;
   325	  padding: 8px 14px;
   326	  border-radius: 10px;
   327	  border: 1px solid #dbe6ff;
   328	  background: #f8fbff;
   329	  color: #1a2156;
   330	  cursor: pointer;
   331	  transition: box-shadow .15s, transform .06s ease-in-out, background .15s, color .15s, border-color .15s;
   332	}
   333	.str-modal .str-btn:hover { box-shadow: 0 3px 10px rgba(40,65,100,0.12); }
   334	.str-modal .str-btn:active { transform: translateY(1px); }
   335	.str-modal .str-btn:disabled { opacity: .6; cursor: not-allowed; }
   336	
   337	.str-modal .str-btn-primary {
   338	  border-color: #2152ff !important;
   339	  background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%) !important;
   340	  color: #fff !important;
   341	}
   342	.str-modal .str-btn-primary:hover {
   343	  box-shadow: 0 3px 12px rgba(33,82,255,0.25) !important;
   344	  filter: brightness(0.97);
   345	}
   346	
   347	/* ---- Accesibilidad botones (teclado) ---- */
   348	.str-btn:focus-visible,
   349	.str-modal .str-btn:focus-visible {
   350	  outline: 2px solid #2152ff;
   351	  outline-offset: 2px;
   352	}
   353	
   354	/* ---- Botón de peligro (Quitar / Eliminar) ---- */
   355	.str-btn-danger {
   356	  border-color: #ef4444;
   357	  background: #fff;
   358	  color: #b91c1c;
   359	}
   360	.str-btn-danger:hover,
   361	.str-btn-danger:active,
   362	.str-btn-danger:focus-visible {
   363	  border-color: #ef4444;
   364	  background: #ef4444;            /* rojo sólido al pasar/clicar */
   365	  color: #111;                    /* texto oscuro para contraste */
   366	  box-shadow: 0 3px 12px rgba(239,68,68,.28);
   367	}
   368	
   369	/* ────────────────────────────────────────────────────────────
   370	   MEJORAS ESPECÍFICAS SOLICITADAS
   371	   ──────────────────────────────────────────────────────────── */
   372	
   373	/* 1) “Distribuir parejas” y “Editar” → azules desde el inicio */
   374	#str-btn-distribuir,
   375	.str-card-actions .js-editar-grupo {
   376	  border-color: #2152ff;
   377	  background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%);
   378	  color: #fff;
   379	}
   380	#str-btn-distribuir:hover,
   381	.str-card-actions .js-editar-grupo:hover {
   382	  box-shadow: 0 3px 12px rgba(33,82,255,0.25);
   383	  filter: brightness(0.97);
   384	}
   385	
   386	/* 2) “Crear grupo” ya es azul; reforzamos por si el tema pisa */
   387	#str-btn-crear-grupo {
   388	  border-color: #2152ff !important;
   389	  background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%) !important;
   390	  color: #fff !important;
   391	}
   392	#str-btn-crear-grupo:hover {
   393	  box-shadow: 0 3px 12px rgba(33,82,255,0.25) !important;
   394	  filter: brightness(0.97);
   395	}
   396	
   397	/* 3) Selector maestro: mismo tratamiento de ellipsis */
   398	#str-select-libres {
   399	  white-space: nowrap;
   400	  overflow: hidden;
   401	  text-overflow: ellipsis;
   402	}
   403	
   404	/* Confirmación inline (si se usa) */
   405	.str-delete-confirm {
   406	  display: none;
   407	  align-items: center;
   408	  gap: 10px;
   409	  margin-right: auto;
   410	  color: #991b1b;
   411	}
   412	.str-delete-confirm.show { display: flex; }
   413	
   414	/* =========================
   415	   PATCH hover/activos (grupos)
   416	   ========================= */
   417	
   418	/* 1) "Editar" y "Añadir" con el mismo look que "Distribuir parejas" */
   419	#str-btn-distribuir,
   420	.str-card-actions .js-editar-grupo,
   421	.str-row-add .str-btn {
   422	  border-color: #2152ff !important;
   423	  background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%) !important;
   424	  color: #fff !important;
   425	}
   426	
   427	/* Hover/Focus – que no se “apague” */
   428	#str-btn-distribuir:hover,
   429	#str-btn-distribuir:focus-visible,
   430	.str-card-actions .js-editar-grupo:hover,
   431	.str-card-actions .js-editar-grupo:focus-visible,
   432	.str-row-add .str-btn:hover,
   433	.str-row-add .str-btn:focus-visible {
   434	  background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%) !important;
   435	  border-color: #2152ff !important;
   436	  color: #fff !important;
   437	  box-shadow: 0 3px 12px rgba(33,82,255,0.25);
   438	  filter: brightness(0.97);
   439	  outline: none;
   440	}
   441	
   442	/* 2) "Quitar": rojo MUY sólido al hover/active/focus */
   443	.str-btn-danger {
   444	  border-color: #ef4444;
   445	  background: #fff;
   446	  color: #b91c1c;
   447	}
   448	
   449	.str-btn-danger:hover,
   450	.str-btn-danger:active,
   451	.str-btn-danger:focus-visible {
   452	  background: #dc2626 !important;   /* rojo sólido más intenso */
   453	  border-color: #dc2626 !important;
   454	  color: #111 !important;           /* texto oscuro como pediste */
   455	  box-shadow: 0 4px 16px rgba(220, 38, 38, .35);
   456	}
   457	
   458	/* ───────── Grupos: 3 columnas (Pareja · Puntos · Acciones) ───────── */
   459	.str-list { margin: 0; padding: 0; list-style: none; }
   460	
   461	.str-row {
   462	  display: grid;
   463	  grid-template-columns: 1fr 120px 120px; /* nombre | puntos | acciones */
   464	  align-items: center;
   465	  gap: 12px;
   466	  padding: 10px 12px;
   467	  background: #fff;
   468	  border: 1px solid #eef2f7;
   469	  border-radius: 10px;
   470	  margin: 8px 0;
   471	}
   472	
   473	.str-row-head {
   474	  background: #f5f8ff;
   475	  border-color: #e3e8ff;
   476	  font-weight: 600;
   477	  color: #4b5563;
   478	}
   479	
   480	.str-row-head .str-pair-name span,
   481	.str-row-head .str-points span,
   482	.str-row-head .str-actions span {
   483	  font-size: 12px;
   484	  text-transform: uppercase;
   485	  letter-spacing: .02em;
   486	}
   487	
   488	/* Columna: nombre */
   489	.str-pair-name {
   490	  min-width: 0; 
   491	  overflow: hidden; 
   492	  text-overflow: ellipsis; 
   493	  white-space: nowrap;
   494	}
   495	
   496	/* Columna: puntos */
   497	.str-points {
   498	  display: flex;
   499	  align-items: center;
   500	  justify-content: center;
   501	}
   502	
   503	.str-points-input {
   504	  width: 100%;
   505	  max-width: 96px;
   506	  height: 36px;
   507	  border: 1px solid #e5e7eb;
   508	  border-radius: 8px;
   509	  padding: 0 10px;
   510	  font-size: 14px;
   511	  text-align: center;
   512	  background: #f9fafb;
   513	  color: #374151;
   514	}
   515	.str-points-input:disabled {
   516	  opacity: .8;
   517	  cursor: not-allowed;
   518	}
   519	
   520	/* Columna: acciones (mantiene tu estilo de Quitar) */
   521	.str-actions {
   522	  display: flex;
   523	  justify-content: flex-end;
   524	}
   525	
   526	/* Responsivo: apilar puntos bajo el nombre en móvil */
   527	@media (max-width: 640px) {
   528	  .str-row {
   529	    grid-template-columns: 1fr 1fr; /* nombre | (puntos/acciones apilados) */
   530	    grid-template-areas:
   531	      "name actions"
   532	      "points actions";
   533	  }
   534	  .str-row .str-pair-name { grid-area: name; }
   535	  .str-row .str-points    { grid-area: points; justify-content: flex-start; }
   536	  .str-row .str-actions   { grid-area: actions; align-items: center; }
   537	  .str-row-head {
   538	    display: none; /* ocultamos la cabecera en móvil para no recargar */
   539	  }
   540	}
   541	
   542	/* ────────────────────────────────────────────────────────────
   543	   PATCH · Rejilla de grupos ocupando todo el ancho (selector correcto)
   544	   ──────────────────────────────────────────────────────────── */
   545	
   546	#str-grupos-wrapper .str-grid {
   547	  display: grid !important;
   548	  /* colapsa columnas libres y estira los tracks */
   549	  grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)) !important;
   550	  gap: 16px !important;
   551	  width: 100% !important;
   552	}
   553	
   554	/* En pantallas grandes, permite columnas algo más anchas */
   555	@media (min-width: 1200px) {
   556	  #str-grupos-wrapper .str-grid {
   557	    grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)) !important;
   558	    gap: 18px !important;
   559	  }
   560	}
   561	
   562	/* En móvil, una sola columna */
   563	@media (max-width: 640px) {
   564	  #str-grupos-wrapper .str-grid {
   565	    grid-template-columns: 1fr !important;
   566	  }
   567	}
   568	
   569	/* Asegura que las tarjetas no limiten el track */
   570	#str-grupos-wrapper .str-grid .str-card {
   571	  width: 100% !important;
   572	  max-width: none !important;
   573	  min-width: 0 !important;
   574	}
   575	
===== END includes/features/groups/index.css =====

===== BEGIN includes/features/groups/index.js =====
     1	/** Grupos – Frontend (gestión simple)
     2	 * Requiere que el PHP haya localizado window.str_groups_ajax_obj (ver enqueue).
     3	 * Este fichero:
     4	 *  - Carga grupos + parejas libres
     5	 *  - Crea grupos (modal; con fallback a prompt)
     6	 *  - Asigna/Quita parejas en grupos
     7	 *  - Recalcula standings
     8	 */
     9	
    10	/* ────────────────────────────────────────────────────────────────
    11	   SHIM: crea window.strTorneo a partir de str_groups_ajax_obj
    12	   ──────────────────────────────────────────────────────────────── */
    13	(function (w) {
    14	  if (w.strTorneo) return;
    15	  var S = w.str_groups_ajax_obj || {};
    16	  if (!S || !S.ajax_url || !S.post_id) return;
    17	  var A = (S.actions || {});
    18	  w.strTorneo = {
    19	    ajaxUrl: S.ajax_url,
    20	    nonce:  S.nonce || '',
    21	    competicionId: parseInt(S.post_id, 10) || 0,
    22	    actions: {
    23	      cargar:    A.cargar    || 'saas_grupos_cargar',
    24	      aleatorio: A.aleatorio || 'saas_grupos_aleatorio',
    25	      asignar:   A.asignar   || 'saas_grupo_asignar',
    26	      standings: A.standings || 'saas_grupos_standings',
    27	      bracket:   A.bracket   || 'saas_bracket_volcar',
    28	      crear:     A.crear     || 'saas_grupo_crear',
    29	      quitar:    A.quitar    || 'saas_grupo_quitar'
    30	    }
    31	  };
    32	})(window);
    33	
    34	(function () {
    35	  "use strict";
    36	
    37	  // ---- GUARD: evita doble inicialización si el script se carga dos veces ----
    38	  if (window.__STR_GROUPS_BOOTED__) { try { console.warn('[GROUPS] Ya inicializado; salto.'); } catch(e) {} return; }
    39	  window.__STR_GROUPS_BOOTED__ = true;
    40	
    41	  // ────────────────────────────────────────────────────────────
    42	  // Utilidades / Config
    43	  // ────────────────────────────────────────────────────────────
    44	  const cfg = (window && window.strTorneo) ? window.strTorneo : {};
    45	  const AJAX = cfg.ajaxUrl || (window.ajaxurl || "/wp-admin/admin-ajax.php");
    46	  const NONCE = cfg.nonce || "";
    47	  const COMP_ID = parseInt(cfg.competicionId || 0, 10);
    48	  const ACTIONS = Object.assign({
    49	    crear:     'saas_grupo_crear',
    50	    cargar:    'saas_grupos_cargar',
    51	    asignar:   'saas_grupo_asignar',
    52	    quitar:    'saas_grupo_quitar',
    53	    aleatorio: 'saas_grupos_aleatorio',
    54	    standings: 'saas_grupos_standings',
    55	    bracket:   'saas_bracket_volcar',
    56	  }, (cfg.actions || {}));
    57	
    58	  const qs  = (sel) => document.querySelector(sel);
    59	  const qsa = (sel) => Array.from(document.querySelectorAll(sel));
    60	
    61	  // --- Supresión temporal del modal de "parejas" cuando operamos en grupos ---
    62	  function suppressPairsModal(ms = 4000) {
    63	    try { window.__STR_SUPPRESS_PAIRS_MODAL__ = Date.now() + ms; } catch(_) {}
    64	  }
    65	  function isPairsSuppressed() {
    66	    try { return window.__STR_SUPPRESS_PAIRS_MODAL__ && Date.now() < window.__STR_SUPPRESS_PAIRS_MODAL__; } catch(_) { return false; }
    67	  }
    68	
    69	  function encode(data) {
    70	    return Object.keys(data)
    71	      .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(data[k] == null ? "" : data[k]))
    72	      .join("&");
    73	  }
    74	
    75	  async function postAjax(action, data = {}) {
    76	    const payload = Object.assign({}, data, {
    77	      action,
    78	      nonce: NONCE,
    79	      _ajax_nonce: NONCE
    80	    });
    81	
    82	    const res = await fetch(AJAX, {
    83	      method: "POST",
    84	      credentials: "same-origin",
    85	      headers: { "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8" },
    86	      body: encode(payload),
    87	    });
    88	
    89	    try {
    90	      const json = await res.json();
    91	      if (json && json.success) return json.data;
    92	      const msg = (json && (json.data?.message || json.message)) || "Error AJAX (success=false)";
    93	      throw new Error(msg);
    94	    } catch (e) {
    95	      let raw = "";
    96	      try { raw = await res.text(); } catch (_){}
    97	      if (!(e instanceof Error && e.message === "Unexpected end of JSON input")) {
    98	        console.error("[GRUPOS] AJAX error:", e.message, "RAW:", raw);
    99	        throw e;
   100	      }
   101	      console.error("[GRUPOS] Respuesta no JSON:", raw);
   102	      throw new Error("Respuesta no válida del servidor (no JSON).");
   103	    }
   104	  }
   105	
   106	  window.__STR_GROUPS_POST__ = postAjax;
   107	
   108	  function htmlEscape(str){
   109	    if(str==null) return "";
   110	    return String(str).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
   111	  }
   112	
   113	  // ⚠️ NUEVO HELPER: marcar error en el <select> sin usar alert()
   114	  function showSelectError(sel, message = "Selecciona una pareja libre.") {
   115	    if (!sel) return;
   116	    const wrap = sel.closest('.str-card-foot') || sel.parentElement;
   117	
   118	    sel.classList.add('str-field-error');
   119	    sel.setAttribute('aria-invalid', 'true');
   120	
   121	    let msg = wrap && wrap.querySelector('.str-inline-error');
   122	    if (!msg && wrap) {
   123	      msg = document.createElement('div');
   124	      msg.className = 'str-inline-error';
   125	      msg.textContent = message;
   126	      wrap.appendChild(msg);
   127	    } else if (msg) {
   128	      msg.textContent = message;
   129	    }
   130	
   131	    sel.focus();
   132	
   133	    setTimeout(() => {
   134	      if (msg && msg.parentNode) msg.parentNode.removeChild(msg);
   135	      sel.classList.remove('str-field-error');
   136	      sel.removeAttribute('aria-invalid');
   137	    }, 2200);
   138	  }
   139	
   140	  // ────────────────────────────────────────────────────────────
   141	  // Estado
   142	  // ────────────────────────────────────────────────────────────
   143	  const state = {
   144	    meta: { n_grupos: 0, n_parejas: 0, fase_final: "", modo_final: "" },
   145	    grupos: [],       // [{id, letra, tam, participantes:[{id,title,puntos?}]}]
   146	    libres: [],       // [{id,title}]
   147	    loading: false
   148	  };
   149	
   150	  // ────────────────────────────────────────────────────────────
   151	  // (OPCIÓN A) Declaración HOISTED del submit del modal
   152	  // ────────────────────────────────────────────────────────────
   153	  async function submitCreateModal() {
   154	    const btn  = document.getElementById('str-modal-create-btn');
   155	    const err  = document.getElementById('str-modal-err');
   156	    const name = (document.getElementById('str-modal-name')?.value || '').trim();
   157	
   158	    if (!COMP_ID) {
   159	      if (err) err.textContent = 'Competición inválida.', err.classList.add('show');
   160	      return;
   161	    }
   162	
   163	    try {
   164	      if (btn) btn.disabled = true, btn.textContent = 'Creando…';
   165	      await postAjax(ACTIONS.crear || 'saas_grupo_crear', { competicion_id: COMP_ID, nombre: name });
   166	      await Promise.all([
   167	        (typeof cargarGrupos === 'function' ? cargarGrupos() : Promise.resolve()),
   168	        (typeof cargarStandings === 'function' ? cargarStandings() : Promise.resolve()),
   169	      ]);
   170	      closeCreateModal();
   171	    } catch (e) {
   172	      if (err) {
   173	        err.textContent = (e && e.message) ? e.message : 'No se pudo crear el grupo.';
   174	        err.classList.add('show');
   175	      } else {
   176	        alert(e && e.message ? e.message : 'No se pudo crear el grupo.');
   177	      }
   178	    } finally {
   179	      if (btn) btn.disabled = false, btn.textContent = 'Crear';
   180	    }
   181	  }
   182	
   183	  // ────────────────────────────────────────────────────────────
   184	  // Modal "Crear grupo"
   185	  // ────────────────────────────────────────────────────────────
   186	  function ensureCreateModal() {
   187	    if (document.getElementById('str-modal-create-group')) return;
   188	
   189	    const overlay = document.createElement('div');
   190	    overlay.className = 'str-modal-overlay';
   191	    overlay.id = 'str-modal-overlay';
   192	
   193	    const modal = document.createElement('div');
   194	    modal.className = 'str-modal';
   195	    modal.id = 'str-modal-create-group';
   196	    modal.setAttribute('role', 'dialog');
   197	    modal.setAttribute('aria-modal', 'true');
   198	    modal.setAttribute('aria-labelledby', 'str-modal-create-title');
   199	
   200	    modal.innerHTML = `
   201	      <div class="str-modal-dialog" role="document">
   202	        <div class="str-modal-head">
   203	          <h3 class="str-modal-title" id="str-modal-create-title">Crear grupo</h3>
   204	        </div>
   205	        <div class="str-modal-body">
   206	          <form id="str-modal-create-form">
   207	            <div class="str-field">
   208	              <label for="str-modal-name">Nombre del grupo <span class="str-muted">(opcional, ej. A, B, C)</span></label>
   209	              <input type="text" id="str-modal-name" name="nombre" placeholder="A, B, C…" autocomplete="off" />
   210	              <div id="str-modal-err" class="str-error"></div>
   211	            </div>
   212	            <input type="hidden" id="str-modal-capacity" name="capacidad" value="" />
   213	          </form>
   214	        </div>
   215	        <div class="str-modal-foot">
   216	          <button type="button" class="str-btn" id="str-modal-cancel">Cancelar</button>
   217	          <button type="button" class="str-btn str-btn-primary" id="str-modal-create-btn">Crear</button>
   218	        </div>
   219	      </div>
   220	    `;
   221	
   222	    document.body.appendChild(overlay);
   223	    document.body.appendChild(modal);
   224	
   225	    overlay.addEventListener('click', closeCreateModal);
   226	    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeCreateModal(); });
   227	
   228	    // 👉 Aquí usamos la función hoisted
   229	    document.getElementById('str-modal-cancel')?.addEventListener('click', closeCreateModal);
   230	    document.getElementById('str-modal-create-btn')?.addEventListener('click', submitCreateModal);
   231	    document.getElementById('str-modal-create-form')?.addEventListener('submit', (e) => {
   232	      e.preventDefault();
   233	      submitCreateModal();
   234	    });
   235	  }
   236	
   237	  function openCreateModal() {
   238	    ensureCreateModal();
   239	    const overlay = document.getElementById('str-modal-overlay');
   240	    const modal   = document.getElementById('str-modal-create-group');
   241	    const input   = document.getElementById('str-modal-name');
   242	    const err     = document.getElementById('str-modal-err');
   243	
   244	    if (err) err.classList.remove('show'), (err.textContent = '');
   245	    overlay?.classList.add('show');
   246	    modal?.classList.add('show');
   247	    setTimeout(() => input?.focus(), 30);
   248	    trapFocus(modal);
   249	  }
   250	
   251	  function closeCreateModal() {
   252	    const overlay = document.getElementById('str-modal-overlay');
   253	    const modal   = document.getElementById('str-modal-create-group');
   254	    overlay?.classList.remove('show');
   255	    modal?.classList.remove('show');
   256	  }
   257	
   258	  function trapFocus(container) {
   259	    if (!container) return;
   260	    const focusables = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
   261	    const list = Array.from(focusables);
   262	    if (list.length === 0) return;
   263	    const first = list[0], last = list[list.length - 1];
   264	    container.addEventListener('keydown', function onKey(e) {
   265	      if (e.key !== 'Tab') return;
   266	      if (e.shiftKey) {
   267	        if (document.activeElement === first) { last.focus(); e.preventDefault(); }
   268	      } else {
   269	        if (document.activeElement === last) { first.focus(); e.preventDefault(); }
   270	      }
   271	    });
   272	  }
   273	
   274	  // ────────────────────────────────────────────────────────────
   275	  // Render UI
   276	  // ────────────────────────────────────────────────────────────
   277	  function ensureRoot() {
   278	    let mount = document.getElementById('str-gestion-grupos');
   279	    if (!mount) {
   280	      mount = document.createElement('div');
   281	      mount.id = 'str-gestion-grupos';
   282	      document.body.appendChild(mount);
   283	      try { console.info('[GROUPS] No existía #str-gestion-grupos. Se ha inyectado al final del <body>.'); } catch(_) {}
   284	    }
   285	    return mount;
   286	  }
   287	
   288	  function render() {
   289	    const wrap = ensureRoot();
   290	
   291	    const topBar = `
   292	      <div class="str-topbar">
   293	        <div class="str-topbar-left">
   294	          <div class="muted">Competición: #${COMP_ID}</div>
   295	          <div class="muted">Grupos: ${state.meta.n_grupos || state.grupos.length}</div>
   296	          <div class="muted">Parejas libres: ${state.libres.length}</div>
   297	        </div>
   298	        <div class="str-topbar-right">
   299	          <button id="btn-crear-grupo" class="str-btn str-btn-primary" type="button">Crear grupo</button>
   300	        </div>
   301	      </div>
   302	    `;
   303	
   304	    const libresOpt = state.libres.map(p => `<option value="${p.id}">${htmlEscape(p.title)}</option>`).join("");
   305	
   306	    const cards = state.grupos.map(g => {
   307	      // Cabecera de columnas dentro del card
   308	      const headRow = `
   309	        <li class="str-row str-row-head">
   310	          <div class="str-pair-name"><span>Pareja</span></div>
   311	          <div class="str-points"><span>Puntos</span></div>
   312	          <div class="str-actions"><span>Acciones</span></div>
   313	        </li>
   314	      `;
   315	
   316	      const filas = (g.participantes || []).map(p => {
   317	        const pts = (typeof p.puntos === 'number' ? p.puntos : 0);
   318	        return `
   319	          <li class="str-row">
   320	            <div class="str-pair-name">${htmlEscape(p.title)}</div>
   321	            <div class="str-points">
   322	              <input class="str-points-input" type="number" min="0" step="1"
   323	                     value="${pts}" inputmode="numeric" aria-label="Puntos" disabled />
   324	            </div>
   325	            <div class="str-actions">
   326	              <button class="str-btn str-btn-small str-btn-remove"
   327	                      data-grupo="${g.id}" data-pareja="${p.id}" type="button">Quitar</button>
   328	            </div>
   329	          </li>
   330	        `;
   331	      }).join("");
   332	
   333	      return `
   334	        <div class="str-card grupo" data-grupo="${g.id}">
   335	          <div class="str-card-head">
   336	            <div class="title">Grupo <b>${htmlEscape(g.letra || g.nombre || "?")}</b></div>
   337	            <div class="sub">Capacidad: ${g.tam ?? "-"} · Ocupadas: ${(g.participantes||[]).length}</div>
   338	          </div>
   339	
   340	          <ul class="str-list">
   341	            ${headRow}
   342	            ${filas || `<li class="str-row"><em>Sin participantes</em></li>`}
   343	          </ul>
   344	
   345	          <div class="str-card-foot">
   346	            <div class="str-add">
   347	              <select class="str-add-select">
   348	                <option value="">— Añadir pareja libre —</option>
   349	                ${libresOpt}
   350	              </select>
   351	              <button class="str-btn str-btn-small str-btn-add" type="button">Añadir</button>
   352	            </div>
   353	          </div>
   354	        </div>
   355	      `;
   356	    }).join("");
   357	
   358	    const html = `
   359	      ${topBar}
   360	      <div class="str-free-select">
   361	        <label class="muted">Parejas libres en este torneo</label>
   362	        <select id="str-free-select"><option value="">— Selecciona una pareja —</option>${libresOpt}</select>
   363	        <div class="muted">Puedes elegirla en el selector de cada grupo.</div>
   364	      </div>
   365	      <div class="str-grid-groups">${cards}</div>
   366	    `;
   367	    wrap.innerHTML = html;
   368	
   369	    // listeners
   370	    const btnCrear = qs("#btn-crear-grupo");
   371	    if (btnCrear) btnCrear.addEventListener("click", onCrearGrupo);
   372	
   373	    // ⚠️ CAMBIO: sin alert(); validación inline con showSelectError()
   374	    qsa(".str-btn-add").forEach(btn => {
   375	      btn.addEventListener("click", async () => {
   376	        const card = btn.closest(".str-card.grupo");
   377	        const gid  = parseInt(card?.getAttribute("data-grupo") || "0", 10);
   378	        const sel  = card?.querySelector(".str-add-select");
   379	        const pid  = sel ? parseInt(sel.value || "0", 10) : 0;
   380	
   381	        if (!gid || !pid) {
   382	  if (sel) {
   383	    sel.classList.add('str-field-error');
   384	    const holder = sel.closest('.str-card-foot') || sel.parentElement;
   385	    let tip = holder && holder.querySelector('.str-inline-error');
   386	    if (!tip && holder) {
   387	      tip = document.createElement('div');
   388	      tip.className = 'str-inline-error';
   389	      tip.textContent = 'Selecciona una pareja libre.';
   390	      holder.appendChild(tip);
   391	    }
   392	    sel.focus();
   393	    setTimeout(() => {
   394	      if (tip && tip.parentNode) tip.parentNode.removeChild(tip);
   395	      sel.classList.remove('str-field-error');
   396	    }, 2000);
   397	  }
   398	  return;
   399	}
   400	
   401	        try {
   402	          suppressPairsModal(5000);
   403	          btn.disabled = true; btn.textContent = "Añadiendo...";
   404	          await asignarPareja(gid, pid);
   405	          await recargar();
   406	        } catch (e) {
   407	          console.error(e); alert(e.message || "No se pudo añadir.");
   408	        } finally {
   409	          btn.disabled = false; btn.textContent = "Añadir";
   410	        }
   411	      });
   412	    });
   413	
   414	    qsa(".str-btn-remove").forEach(btn => {
   415	      btn.addEventListener("click", async () => {
   416	        const gid = parseInt(btn.getAttribute("data-grupo") || "0", 10);
   417	        const pid = parseInt(btn.getAttribute("data-pareja") || "0", 10);
   418	        if (!gid || !pid) return;
   419	        try {
   420	          btn.disabled = true; btn.textContent = "Quitando...";
   421	          await quitarPareja(gid, pid);
   422	          await recargar();
   423	        } catch (e) {
   424	          console.error(e); alert(e.message || "No se pudo quitar.");
   425	        } finally {
   426	          btn.disabled = false; btn.textContent = "Quitar";
   427	        }
   428	      });
   429	    });
   430	  }
   431	
   432	  // ────────────────────────────────────────────────────────────
   433	  // Acciones
   434	  // ────────────────────────────────────────────────────────────
   435	  async function cargarGrupos() {
   436	    if (!COMP_ID) return;
   437	    const data = await postAjax(ACTIONS.cargar, { competicion_id: COMP_ID });
   438	    state.meta   = data.meta   || state.meta;
   439	    state.grupos = Array.isArray(data.grupos) ? data.grupos : [];
   440	    state.libres = Array.isArray(data.parejas_libres) ? data.parejas_libres : [];
   441	  }
   442	
   443	  async function cargarStandings() {
   444	    try {
   445	      const data = await postAjax(ACTIONS.standings, { competicion_id: COMP_ID });
   446	      const wrap = qs("#str-standings");
   447	      if (wrap) {
   448	        wrap.innerHTML = `<div class="str-card"><div class="str-card-body"><em>Clasificación actualizada.</em></div></div>`;
   449	      }
   450	      void data;
   451	    } catch (e) {
   452	      console.error(e);
   453	    }
   454	  }
   455	
   456	  async function recargar() {
   457	    await Promise.all([cargarGrupos(), cargarStandings()]);
   458	    render();
   459	  }
   460	
   461	  // Abre modal (con fallback defensivo a prompt)
   462	  async function onCrearGrupo() {
   463	    try {
   464	      openCreateModal();
   465	    } catch (e) {
   466	      let nombre = window.prompt("Nombre del grupo (ej. A, B, C). Deja vacío para autogenerar:");
   467	      if (nombre == null) return; // cancel
   468	      nombre = String(nombre).trim();
   469	      try {
   470	        await postAjax(ACTIONS.crear, { competicion_id: COMP_ID, nombre });
   471	        await recargar();
   472	      } catch (err) {
   473	        console.error(err); alert(err.message || "No se pudo crear el grupo.");
   474	      }
   475	    }
   476	  }
   477	
   478	  async function asignarPareja(grupoId, parejaId) {
   479	    return postAjax(ACTIONS.asignar || 'saas_grupo_asignar', {
   480	      competicion_id: COMP_ID,
   481	      grupo_id: grupoId,
   482	      pareja_id: parejaId
   483	    });
   484	  }
   485	
   486	  async function quitarPareja(grupoId, parejaId) {
   487	    return postAjax(ACTIONS.quitar || 'saas_grupo_quitar', {
   488	      competicion_id: COMP_ID,
   489	      grupo_id: grupoId,
   490	      pareja_id: parejaId
   491	    });
   492	  }
   493	
   494	  // ────────────────────────────────────────────────────────────
   495	  // Init
   496	  // ────────────────────────────────────────────────────────────
   497	  document.addEventListener("DOMContentLoaded", async () => {
   498	    if (!COMP_ID) return;
   499	    try {
   500	      ensureCreateModal();  // modal montado desde el inicio
   501	      await cargarGrupos();
   502	      render();
   503	      await cargarStandings();
   504	      console.info('[GROUPS][BOOT]', { AJAX, NONCE, COMP_ID, from: {strTorneo: !!window.strTorneo, str_groups_ajax_obj: !!window.str_groups_ajax_obj}, ACTIONS });
   505	    } catch (e) {
   506	      console.error(e);
   507	    }
   508	  });
   509	
   510	  // Interceptores en captura
   511	  document.addEventListener('click', function (e) {
   512	    const btn = e.target && e.target.closest && e.target.closest('#btn-crear-grupo');
   513	    if (!btn) return;
   514	    e.preventDefault();
   515	    e.stopPropagation();
   516	    e.stopImmediatePropagation();
   517	    try {
   518	      openCreateModal();
   519	    } catch (err) {
   520	      console.error('[GROUPS][MODAL] fallback por error:', err);
   521	      const nombre = window.prompt("Nombre del grupo (ej. A, B, C). Deja vacío para autogenerar:");
   522	      if (nombre != null) {
   523	        postAjax(ACTIONS.crear || 'saas_grupo_crear', {
   524	          competicion_id: COMP_ID,
   525	          nombre: String(nombre).trim()
   526	        }).then(() => {
   527	          return Promise.all([
   528	            (typeof cargarGrupos === 'function' ? cargarGrupos() : Promise.resolve()),
   529	            (typeof cargarStandings === 'function' ? cargarStandings() : Promise.resolve())
   530	          ]);
   531	        }).then(render)
   532	          .catch((e) => alert(e && e.message ? e.message : 'No se pudo crear el grupo.'));
   533	      }
   534	    }
   535	  }, true);
   536	
   537	  document.addEventListener('click', function (e) {
   538	    const addBtn = e.target && e.target.closest && e.target.closest('#str-gestion-grupos .str-btn-add');
   539	    if (!addBtn) return;
   540	    e.stopPropagation();
   541	    e.stopImmediatePropagation();
   542	  }, true);
   543	
   544	})();
   545	
   546	/* ============================================================
   547	   DEBUG TRACE – clicks + llamadas AJAX (admin-ajax.php)
   548	   (Elimina este bloque cuando acabes de depurar)
   549	   ============================================================ */
   550	(function () {
   551	  try {
   552	    var SELECTORES_INTERES = [
   553	      '.str-btn-add',
   554	      '.js-add-pareja',
   555	      '.js-add-pareja-grupo',
   556	      '#btn-abrir-modal-pareja',
   557	      '.js-add-jugador',
   558	      '#btn-abrir-modal-invitacion-jugador'
   559	    ];
   560	
   561	    function matchedSelector(el) {
   562	      for (var i=0;i<SELECTORES_INTERES.length;i++){
   563	        try { if (el.matches(SELECTORES_INTERES[i])) return SELECTORES_INTERES[i]; } catch(_) {}
   564	      }
   565	      return null;
   566	    }
   567	
   568	    document.addEventListener('click', function (e) {
   569	      var el = e.target, depth = 0, hit = null;
   570	      while (el && depth < 6 && !hit) {
   571	        var m = matchedSelector(el);
   572	        if (m) hit = { node: el, selector: m };
   573	        el = el.parentElement; depth++;
   574	      }
   575	      if (!hit) return;
   576	
   577	      var text = (hit.node.textContent || '').trim().slice(0,120);
   578	      console.groupCollapsed(
   579	        '%c[TRACE CLICK]%c ' + hit.selector + '  %c' + (text || '(sin texto)'),
   580	        'color:#0ea5e9;font-weight:700', 'color:inherit', 'color:#64748b'
   581	      );
   582	      console.log('Elemento que hizo match:', hit.node);
   583	      if (hit.node.dataset) console.log('dataset:', JSON.parse(JSON.stringify(hit.node.dataset)));
   584	      console.trace('Stack');
   585	      console.groupEnd();
   586	    }, true);
   587	
   588	    if (typeof window.fetch === 'function') {
   589	      var _fetch = window.fetch;
   590	      window.fetch = function (input, init) {
   591	        try {
   592	          var url = (typeof input === 'string') ? input : (input && input.url) || '';
   593	          if (url.indexOf('/wp-admin/admin-ajax.php') !== -1) {
   594	            var method = (init && init.method) ? String(init.method).toUpperCase() : 'GET';
   595	            var bodyStr = '';
   596	            if (init && init.body) {
   597	              if (typeof init.body === 'string') bodyStr = init.body;
   598	              else if (init.body instanceof URLSearchParams) bodyStr = init.body.toString();
   599	              else if (typeof FormData !== 'undefined' && init.body instanceof FormData) {
   600	                var tmp=[]; init.body.forEach(function(v,k){ tmp.push(encodeURIComponent(k)+'='+encodeURIComponent(v)); });
   601	                bodyStr = tmp.join('&');
   602	              }
   603	            }
   604	            var m = bodyStr.match(/(?:^|&|;)action=([^&;]+)/i);
   605	            var actionName = m ? decodeURIComponent(m[1]) : '(sin action)';
   606	            console.groupCollapsed(
   607	              '%c[TRACE AJAX]%c ' + method + ' admin-ajax.php  %caction=' + actionName,
   608	              'color:#22c55e;font-weight:700', 'color:inherit', 'color:#64748b'
   609	            );
   610	            if (bodyStr) console.log('Body:', bodyStr.length>500 ? bodyStr.slice(0,500)+'…' : bodyStr);
   611	            console.trace('Stack');
   612	            console.groupEnd();
   613	          }
   614	        } catch (_) {}
   615	        return _fetch.apply(this, arguments);
   616	      };
   617	    }
   618	
   619	    if (window.jQuery && window.jQuery.ajax) {
   620	      (function ($) {
   621	        var _ajax = $.ajax;
   622	        $.ajax = function (opts) {
   623	          try {
   624	            var url = (typeof opts === 'string') ? opts : (opts && opts.url) || '';
   625	            if (url.indexOf('/wp-admin/admin-ajax.php') !== -1) {
   626	              var dataStr = '';
   627	              if (opts && opts.data) {
   628	                if (typeof opts.data === 'string') dataStr = opts.data;
   629	                else if (opts.data instanceof URLSearchParams) dataStr = opts.data.toString();
   630	                else if (typeof opts.data === 'object') {
   631	                  var parts=[]; for (var k in opts.data){ if(Object.prototype.hasOwnProperty.call(opts.data,k)){ parts.push(encodeURIComponent(k)+'='+encodeURIComponent(opts.data[k])); } }
   632	                  dataStr = parts.join('&');
   633	                }
   634	              }
   635	              var m = dataStr.match(/(?:^|&|;)action=([^&;]+)/i);
   636	              var actionName = m ? decodeURIComponent(m[1]) : '(sin action)';
   637	              console.groupCollapsed(
   638	                '%c[TRACE jQ.AJAX]%c admin-ajax.php  %caction=' + actionName,
   639	                'color:#84cc16;font-weight:700', 'color:inherit', 'color:#64748b'
   640	              );
   641	              if (dataStr) console.log('Data:', dataStr.length>500 ? dataStr.slice(0,500)+'…' : dataStr);
   642	              console.trace('Stack');
   643	              console.groupEnd();
   644	            }
   645	          } catch(_) {}
   646	          return _ajax.apply(this, arguments);
   647	        };
   648	      })(window.jQuery);
   649	    }
   650	
   651	    console.info('%c[TRACE ACTIVADO]%c Mira la consola: clicks relevantes y AJAX a admin-ajax.php.',
   652	      'color:#0ea5e9;font-weight:700','color:inherit');
   653	  } catch (e) {
   654	    console.error('[TRACE] fallo al inicializar:', e);
   655	  }
   656	})();
===== END includes/features/groups/index.js =====

===== BEGIN includes/features/groups/index.php =====
===== END includes/features/groups/index.php =====

===== BEGIN includes/features/groups/render-grupos.php =====
     1	<?php
     2	/**
     3	 * Render de gestión de grupos en frontend (server-side)
     4	 * - Lista parejas libres
     5	 * - Lista grupos con participantes
     6	 * - Acciones: crear grupo, asignar pareja, quitar pareja (con modal)
     7	 * - Renombrar grupo + Eliminar grupo (modal Editar)
     8	 * - Distribuir parejas (modal): vista previa y aplicación
     9	 *
    10	 * Acciones AJAX esperadas (con alias):
    11	 *  - str_grupo_crear           (core: saas_grupo_crear)
    12	 *  - str_grupo_asignar_pareja  (core: saas_grupo_asignar)
    13	 *  - str_grupo_quitar_pareja   (core: saas_grupo_quitar)
    14	 *  - str_grupo_renombrar       (core: saas_grupo_renombrar)
    15	 *  - str_grupo_eliminar        (core: saas_grupo_eliminar)
    16	 */
    17	
    18	if ( ! defined('ABSPATH') ) { exit; }
    19	
    20	if (!function_exists('str_competicion_grupos_render')):
    21	
    22	function str_competicion_grupos_render($args = []) {
    23	    $args = wp_parse_args($args, [
    24	        'competicion_id' => 0,
    25	        'print_css'      => true,
    26	    ]);
    27	
    28	    $comp_id = absint($args['competicion_id']);
    29	    if ( ! $comp_id ) return '<!-- STR grupos: competicion_id vacío -->';
    30	
    31	    if (!function_exists('str_escribir_log')) {
    32	        function str_escribir_log($m, $o='STR'){ @file_put_contents(WP_PLUGIN_DIR.'/saas-torneos-de-raqueta/debug-saas-torneos.log', "[".date('Y-m-d H:i:s')."] [$o] $m\n", FILE_APPEND); }
    33	    }
    34	
    35	    $nonce = wp_create_nonce('str_nonce');
    36	
    37	    // === PUNTOS: función mínima, con filtro y meta opcional ===
    38	    $__str_points_cache = [];
    39	    $str_get_points = function(int $pair_id) use (&$__str_points_cache, $comp_id) : int {
    40	        if (isset($__str_points_cache[$pair_id])) return $__str_points_cache[$pair_id];
    41	
    42	        // 1) filtro (puedes enganchar tus cálculos reales desde partidos)
    43	        $pts = apply_filters('str_pair_points', null, $pair_id, (int)$comp_id);
    44	
    45	        // 2) metas opcionales (si algún día los guardas en meta/ACF)
    46	        if ($pts === null) {
    47	            foreach (['str_puntos_comp_'.(int)$comp_id, 'str_puntos', 'puntos'] as $mk) {
    48	                $v = get_post_meta($pair_id, $mk, true);
    49	                if ($v !== '' && $v !== null) { $pts = (int)$v; break; }
    50	            }
    51	        }
    52	
    53	        if ($pts === null) $pts = 0; // 3) por defecto
    54	        return $__str_points_cache[$pair_id] = (int)$pts;
    55	    };
    56	
    57	    // =============================
    58	    // 1) Obtener GRUPOS del torneo
    59	    // =============================
    60	    $grupos = get_posts([
    61	        'post_type'      => 'grupo',
    62	        'post_status'    => 'publish',
    63	        'posts_per_page' => -1,
    64	        'meta_query'     => [[
    65	            'key'     => 'torneo_asociado',
    66	            'value'   => '"' . $comp_id . '"',
    67	            'compare' => 'LIKE',
    68	        ]],
    69	        'orderby' => ['date' => 'ASC', 'ID' => 'ASC'],
    70	    ]);
    71	
    72	    // Mapa de nombres de grupos (para el front)
    73	    $map_grupos = []; // gid => "Grupo A"
    74	    foreach ($grupos as $g) {
    75	        $nombre_g = function_exists('get_field') ? get_field('nombre_grupo', $g->ID) : '';
    76	        if (!$nombre_g) $nombre_g = $g->post_title ?: ('Grupo '.$g->ID);
    77	        // Siempre mostramos con prefijo "Grupo "
    78	        $map_grupos[$g->ID] = 'Grupo ' . trim($nombre_g);
    79	    }
    80	
    81	    // =============================
    82	    // 2) Obtener PAREJAS del torneo
    83	    // =============================
    84	    $parejas_eq = get_posts([
    85	        'post_type'      => 'pareja',
    86	        'post_status'    => 'publish',
    87	        'posts_per_page' => -1,
    88	        'meta_query'     => [[
    89	            'key'     => 'torneo_asociado',
    90	            'value'   => $comp_id,
    91	            'compare' => '=',
    92	        ]],
    93	        'fields'  => 'ids',
    94	    ]);
    95	    $parejas_like = get_posts([
    96	        'post_type'      => 'pareja',
    97	        'post_status'    => 'publish',
    98	        'posts_per_page' => -1,
    99	        'meta_query'     => [[
   100	            'key'     => 'torneo_asociado',
   101	            'value'   => '"' . $comp_id . '"',
   102	            'compare' => 'LIKE',
   103	        ]],
   104	        'fields'  => 'ids',
   105	    ]);
   106	    $parejas_torneo = array_values(array_unique(array_merge($parejas_eq, $parejas_like)));
   107	
   108	    // Mapa de nombres de pareja (para el front)
   109	    $map_parejas = []; // pid => "Nombre pareja"
   110	    foreach ($parejas_torneo as $pid) {
   111	        $t = get_the_title($pid);
   112	        $map_parejas[$pid] = $t ? $t : ('Pareja #'.$pid);
   113	    }
   114	
   115	    // 3) Parejas asignadas a algún grupo
   116	    $parejas_asignadas = [];
   117	    $grupos_participantes = []; // gid => [pids]
   118	    foreach ($grupos as $g) {
   119	        $participantes = function_exists('get_field')
   120	            ? get_field('participantes_grupo', $g->ID, false)
   121	            : get_post_meta($g->ID, 'participantes_grupo', true);
   122	        if (empty($participantes)) $participantes = [];
   123	        if (!is_array($participantes)) $participantes = (array)$participantes;
   124	        $participantes = array_map('absint', $participantes);
   125	        $grupos_participantes[$g->ID] = $participantes;
   126	        $parejas_asignadas = array_merge($parejas_asignadas, $participantes);
   127	    }
   128	    $parejas_asignadas = array_unique(array_filter($parejas_asignadas));
   129	
   130	    // 4) Parejas libres = todas del torneo – asignadas
   131	    $parejas_libres = array_values(array_diff($parejas_torneo, $parejas_asignadas));
   132	
   133	    $nombre_pareja = function($pareja_id) use ($map_parejas) {
   134	        return $map_parejas[$pareja_id] ?? ('Pareja #'.$pareja_id);
   135	    };
   136	
   137	    ob_start();
   138	    ?>
   139	
   140	    <?php if (!empty($args['print_css'])): ?>
   141	    <style>
   142	      /* Contenedor y elementos */
   143	      .str-grupos-wrapper{margin:1.5rem 0;border:1px solid #e5e7eb;border-radius:12px;padding:16px;background:#fff}
   144	      .str-grupos-header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap}
   145	      .str-grupos-actions{display:flex;gap:8px;flex-wrap:wrap}
   146	      .str-badge{display:inline-flex;align-items:center;gap:.4rem;font-size:.85rem;border:1px solid #e5e7eb;border-radius:999px;padding:.25rem .6rem;background:#f9fafb}
   147	      .str-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
   148	      .str-card{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff}
   149	      .str-card-hd{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:#f8fafc;border-bottom:1px solid #e5e7eb}
   150	      .str-card-ttl{font-weight:600}
   151	      .str-card-actions{display:flex;gap:6px}
   152	      .str-btn{appearance:none;border:1px solid #dbe6ff;background:#f8fbff;border-radius:10px;padding:10px 14px;cursor:pointer;color:#1a2156;font-weight:600;display:inline-flex;align-items:center;gap:8px;transition:box-shadow .15s, transform .06s, background .15s}
   153	      .str-btn:hover{box-shadow:0 3px 10px rgba(40,65,100,0.12)}
   154	      .str-btn:active{transform:translateY(1px)}
   155	      .str-btn--primary{border-color:#2152ff;background:linear-gradient(92deg,#2152ff 0%,#3273f8 100%);color:#fff}
   156	      .str-btn--primary:hover{box-shadow:0 3px 12px rgba(33,82,255,0.25)}
   157	      .str-btn-danger{border-color:#fecaca;background:#fff5f5;color:#7f1d1d}
   158	      .str-btn-danger:hover{background:#ef4444;color:#fff;border-color:#ef4444}
   159	      .str-list{list-style:none;margin:0;padding:8px 12px;display:flex;flex-direction:column;gap:6px}
   160	      .str-list li{border:1px solid #eef2f7;border-radius:8px;padding:6px 8px}
   161	      /* NUEVO: maquetación de la fila con columna de puntos */
   162	      .str-li{display:flex;align-items:center;justify-content:space-between;gap:8px}
   163	      .str-li .str-name{flex:1 1 auto;min-width:0}
   164	      .str-points{min-width:58px;text-align:center;border:1px solid #e5e7eb;border-radius:999px;padding:2px 10px;background:#f8fafc;font-variant-numeric:tabular-nums}
   165	      .str-row-add{display:flex;gap:6px;padding:10px 12px;border-top:1px dashed #e5e7eb;background:#fcfcfd}
   166	      .str-select{width:100%;padding:8px 10px;border:1.5px solid #d8e4ff;border-radius:8px;background:#fff;color:#1a2156}
   167	      .str-select:focus{border-color:#2152ff;background:#f5f9ff;outline:none}
   168	      .str-muted{color:#6b7280;font-size:.9rem}
   169	
   170	      /* Modal base */
   171	      .str-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:9999}
   172	      .str-modal.is-open{display:flex}
   173	      .str-dialog{background:#fff;border-radius:12px;max-width:560px;width:92%;box-shadow:0 15px 40px rgba(0,0,0,.2);overflow:hidden}
   174	      .str-dialog-hd{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #e5e7eb}
   175	      .str-dialog-bd{padding:14px}
   176	      .str-dialog-ft{padding:12px 14px;display:flex;justify-content:flex-end;gap:8px;border-top:1px solid #e5e7eb}
   177	      .str-input{width:100%;padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px}
   178	
   179	      /* Vista previa distribución */
   180	      .str-prev-wrap{max-height:320px;overflow:auto;border:1px solid #eef2f7;border-radius:10px;padding:8px;background:#fafafa}
   181	      .str-prev-card{border:1px solid #e5e7eb;border-radius:10px;margin-bottom:10px;background:#fff}
   182	      .str-prev-head{padding:8px 10px;border-bottom:1px solid #eef2f7;font-weight:600}
   183	      .str-prev-body{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px}
   184	      .str-chip{display:inline-block;border:1px solid #e5e7eb;border-radius:999px;padding:2px 8px;margin:2px;background:#f8fafc;font-size:.9rem}
   185	      .str-colcap{font-size:.85rem;color:#64748b;margin-bottom:6px}
   186	    </style>
   187	    <?php endif; ?>
   188	
   189	    <div id="str-grupos-wrapper"
   190	         class="str-grupos-wrapper"
   191	         data-ajax="<?php echo esc_attr(admin_url('admin-ajax.php')); ?>"
   192	         data-nonce="<?php echo esc_attr($nonce); ?>"
   193	         data-comp="<?php echo esc_attr($comp_id); ?>">
   194	
   195	        <div class="str-grupos-header">
   196	            <div class="str-badges">
   197	                <span class="str-badge">Grupos: <strong><?php echo count($grupos); ?></strong></span>
   198	                <span class="str-badge">Parejas totales: <strong><?php echo count($parejas_torneo); ?></strong></span>
   199	                <span class="str-badge">Parejas libres: <strong id="str-count-libres"><?php echo count($parejas_libres); ?></strong></span>
   200	            </div>
   201	            <div class="str-grupos-actions">
   202	                <button class="str-btn" id="str-btn-distribuir">Distribuir parejas</button>
   203	                <button class="str-btn str-btn--primary" id="str-btn-crear-grupo">Crear grupo</button>
   204	            </div>
   205	        </div>
   206	
   207	        <!-- Selector maestro de parejas libres -->
   208	        <div style="margin:0 0 12px 0;">
   209	            <label class="str-muted" for="str-select-libres">Parejas libres:</label>
   210	            <select id="str-select-libres" class="str-select">
   211	                <option value="">— Selecciona una pareja libre —</option>
   212	                <?php foreach ($parejas_libres as $pid): ?>
   213	                    <option value="<?php echo esc_attr($pid); ?>"><?php echo esc_html($nombre_pareja($pid)); ?></option>
   214	                <?php endforeach; ?>
   215	            </select>
   216	        </div>
   217	
   218	        <!-- GRID DE GRUPOS -->
   219	        <div class="str-grid">
   220	            <?php if (empty($grupos)): ?>
   221	                <div class="str-card">
   222	                    <div class="str-card-hd">
   223	                        <div class="str-card-ttl">Aún no hay grupos</div>
   224	                    </div>
   225	                    <div class="str-list">
   226	                        <li class="str-muted">Usa “Crear grupo” para empezar.</li>
   227	                    </div>
   228	                </div>
   229	            <?php else: ?>
   230	                <?php foreach ($grupos as $grupo): ?>
   231	                    <?php
   232	                        $gid = $grupo->ID;
   233	                        $nombre_g = $map_grupos[$gid] ?? ($grupo->post_title ?: 'Grupo '.$gid); // ya viene “Grupo X”
   234	                        $participantes = $grupos_participantes[$gid] ?? [];
   235	                    ?>
   236	                    <div class="str-card" data-grupo-id="<?php echo esc_attr($gid); ?>">
   237	                        <div class="str-card-hd">
   238	                            <div class="str-card-ttl"><?php echo esc_html($nombre_g); ?></div>
   239	                            <div class="str-card-actions">
   240	                                <button class="str-btn js-editar-grupo"
   241	                                        data-grupo-id="<?php echo esc_attr($gid); ?>"
   242	                                        data-grupo-nombre="<?php echo esc_attr(preg_replace('~^\s*Grupo\s+~i','',$nombre_g)); ?>">
   243	                                    Editar
   244	                                </button>
   245	                            </div>
   246	                        </div>
   247	                        <ul class="str-list">
   248	                            <?php if (empty($participantes)): ?>
   249	                                <li class="str-li">
   250	                                    <span class="str-name str-muted">Sin participantes</span>
   251	                                    <span class="str-points">—</span>
   252	                                    <span><!-- vacío --></span>
   253	                                </li>
   254	                            <?php else: ?>
   255	                                <?php foreach ($participantes as $pid): ?>
   256	                                    <li class="str-li">
   257	                                        <span class="str-name"><?php echo esc_html($nombre_pareja($pid)); ?></span>
   258	
   259	                                        <!-- NUEVO: puntos visibles (y listos para tiempo real) -->
   260	                                        <span class="str-points str-points-val" data-pair-id="<?php echo esc_attr($pid); ?>">
   261	                                            <?php echo (int) $str_get_points((int)$pid); ?>
   262	                                        </span>
   263	
   264	                                        <button class="str-btn str-btn-danger js-quitar-pareja"
   265	                                                data-grupo-id="<?php echo esc_attr($gid); ?>"
   266	                                                data-pareja-id="<?php echo esc_attr($pid); ?>">
   267	                                            Quitar
   268	                                        </button>
   269	                                    </li>
   270	                                <?php endforeach; ?>
   271	                            <?php endif; ?>
   272	                        </ul>
   273	                        <div class="str-row-add">
   274	                            <select class="str-select js-select-pareja" data-grupo-id="<?php echo esc_attr($gid); ?>">
   275	                                <option value="">— Añadir pareja libre a este grupo —</option>
   276	                                <?php foreach ($parejas_libres as $pid): ?>
   277	                                    <option value="<?php echo esc_attr($pid); ?>"><?php echo esc_html($nombre_pareja($pid)); ?></option>
   278	                                <?php endforeach; ?>
   279	                            </select>
   280	                            <button class="str-btn js-add-pareja" data-grupo-id="<?php echo esc_attr($gid); ?>">Añadir</button>
   281	                        </div>
   282	                    </div>
   283	                <?php endforeach; ?>
   284	            <?php endif; ?>
   285	        </div>
   286	    </div>
   287	
   288	    <!-- Datos para JS: nombres de grupos y parejas -->
   289	    <script id="str-json-data" type="application/json">
   290	    <?php
   291	      echo wp_json_encode([
   292	        'groups'       => $map_grupos,             // gid => "Grupo A"
   293	        'pairs'        => $map_parejas,            // pid => "Nombre pareja"
   294	        'groupsPairs'  => $grupos_participantes,   // gid => [pids]
   295	        'freePairs'    => $parejas_libres,         // [pids]
   296	      ]);
   297	    ?>
   298	    </script>
   299	
   300	    <!-- MODALES + JS existentes (sin cambios) -->
   301	    <div class="str-modal" id="str-modal-crear">
   302	        <div class="str-dialog" role="dialog" aria-modal="true" aria-labelledby="str-modal-crear-ttl">
   303	            <div class="str-dialog-hd">
   304	                <strong id="str-modal-crear-ttl">Crear grupo</strong>
   305	                <button class="str-btn" data-close="#str-modal-crear">✕</button>
   306	            </div>
   307	            <div class="str-dialog-bd">
   308	                <label class="str-muted" for="str-inp-nombre-grupo">Nombre del grupo (opcional)</label>
   309	                <input id="str-inp-nombre-grupo" class="str-input" type="text" placeholder="Ej. A, B, C...">
   310	                <p class="str-muted" style="margin-top:8px">Si lo dejas en blanco se autogenerará.</p>
   311	            </div>
   312	            <div class="str-dialog-ft">
   313	                <button class="str-btn" data-close="#str-modal-crear">Cancelar</button>
   314	                <button class="str-btn str-btn--primary" id="str-btn-crear-confirm">Crear</button>
   315	            </div>
   316	        </div>
   317	    </div>
   318	
   319	    <div class="str-modal" id="str-modal-rename">
   320	        <div class="str-dialog" role="dialog" aria-modal="true" aria-labelledby="str-modal-rename-ttl">
   321	            <div class="str-dialog-hd">
   322	                <strong id="str-modal-rename-ttl">Renombrar grupo</strong>
   323	                <button class="str-btn" data-close="#str-modal-rename">✕</button>
   324	            </div>
   325	            <div class="str-dialog-bd">
   326	                <input id="str-inp-rename" class="str-input" type="text" placeholder="Nuevo nombre del grupo">
   327	                <input id="str-inp-rename-grupo-id" type="hidden" value="">
   328	                <p class="str-muted" style="margin-top:8px">El nombre debe ser único dentro de esta competición.</p>
   329	            </div>
   330	            <div class="str-dialog-ft" style="justify-content:space-between">
   331	                <button class="str-btn str-btn-danger" id="str-btn-eliminar-grupo">Eliminar grupo</button>
   332	                <div>
   333	                    <button class="str-btn" data-close="#str-modal-rename">Cancelar</button>
   334	                    <button class="str-btn str-btn--primary" id="str-btn-rename-confirm">Guardar</button>
   335	                </div>
   336	            </div>
   337	        </div>
   338	    </div>
   339	
   340	    <div class="str-modal" id="str-modal-distribuir">
   341	        <div class="str-dialog" role="dialog" aria-modal="true" aria-labelledby="str-modal-dist-ttl">
   342	            <div class="str-dialog-hd">
   343	                <strong id="str-modal-dist-ttl">Distribuir parejas en grupos</strong>
   344	                <button class="str-btn" data-close="#str-modal-distribuir">✕</button>
   345	            </div>
   346	            <div class="str-dialog-bd">
   347	                <div class="str-field" style="margin-bottom:10px">
   348	                    <label class="str-muted">Política</label>
   349	                    <select id="str-pol" class="str-input">
   350	                        <option value="random">Aleatorio (estable con semilla)</option>
   351	                        <option value="roundrobin">Round-robin (equilibrado)</option>
   352	                    </select>
   353	                </div>
   354	
   355	                <div class="str-field" style="margin-bottom:10px">
   356	                    <label class="str-muted">Tamaño objetivo por grupo</label>
   357	                    <input id="str-target" class="str-input" type="number" min="2" step="1" value="4">
   358	                </div>
   359	
   360	                <div class="str-field" style="margin-bottom:10px">
   361	                    <label class="str-muted">Semilla <span class="str-muted">(opcional, para repetir el reparto aleatorio)</span></label>
   362	                    <input id="str-seed" class="str-input" type="text" placeholder="Escribe un texto o número; si repites la misma semilla, obtendrás el mismo reparto">
   363	                </div>
   364	
   365	                <div class="str-field" style="margin-bottom:10px">
   366	                    <label class="str-muted"><input type="checkbox" id="str-relocate"> Recolocar parejas ya asignadas</label>
   367	                    <p class="str-muted" style="margin:6px 0 0">
   368	                        Desmarcado: solo reparte parejas libres. Marcado: puede mover parejas entre grupos para equilibrar.
   369	                    </p>
   370	                </div>
   371	
   372	                <div id="str-prev-meta" class="str-muted" style="margin:10px 0; display:none;"></div>
   373	                <div class="str-prev-wrap" id="str-prev-wrap" style="display:none"></div>
   374	            </div>
   375	            <div class="str-dialog-ft">
   376	                <button class="str-btn" data-close="#str-modal-distribuir">Cerrar</button>
   377	                <button class="str-btn" id="str-btn-prev">Ver vista previa</button>
   378	                <button class="str-btn str-btn--primary" id="str-btn-apply">Aplicar</button>
   379	            </div>
   380	        </div>
   381	    </div>
   382	
   383	    <div class="str-modal" id="str-modal-confirm">
   384	        <div class="str-dialog" role="dialog" aria-modal="true" aria-labelledby="str-modal-confirm-ttl">
   385	            <div class="str-dialog-hd">
   386	                <strong id="str-modal-confirm-ttl">Quitar pareja del grupo</strong>
   387	                <button class="str-btn" data-close="#str-modal-confirm">✕</button>
   388	            </div>
   389	            <div class="str-dialog-bd">
   390	                <p style="margin:0 0 8px">
   391	                    ¿Seguro que quieres quitar <b id="str-conf-pair"></b> de <b id="str-conf-group"></b>?
   392	                </p>
   393	                <p class="str-muted" style="margin:6px 0 0">
   394	                    Esta acción no elimina la pareja, solo la saca del grupo.
   395	                </p>
   396	                <input type="hidden" id="str-conf-gid" value="">
   397	                <input type="hidden" id="str-conf-pid" value="">
   398	            </div>
   399	            <div class="str-dialog-ft">
   400	                <button class="str-btn" data-close="#str-modal-confirm">Cancelar</button>
   401	                <button class="str-btn str-btn-danger" id="str-conf-accept">Quitar</button>
   402	            </div>
   403	        </div>
   404	    </div>
   405	
   406	    <script>
   407	    (function(){
   408	        const $wrap  = document.getElementById('str-grupos-wrapper');
   409	        if (!$wrap) return;
   410	        const AJAX  = $wrap.dataset.ajax;
   411	        const NONCE = $wrap.dataset.nonce;
   412	        const COMP  = $wrap.dataset.comp;
   413	
   414	        // Datos de nombres y estado
   415	        const DATA = JSON.parse(document.getElementById('str-json-data').textContent || '{}');
   416	        const GROUP_NAME = (gid) => DATA.groups?.[gid] || ('Grupo ' + gid);
   417	        const PAIR_NAME  = (pid) => DATA.pairs?.[pid]  || ('Pareja #' + pid);
   418	
   419	        const open  = sel => document.querySelector(sel)?.classList.add('is-open');
   420	        const close = sel => document.querySelector(sel)?.classList.remove('is-open');
   421	
   422	        // ===== Crear grupo =====
   423	        document.getElementById('str-btn-crear-grupo')?.addEventListener('click', () => open('#str-modal-crear'));
   424	        document.querySelectorAll('[data-close="#str-modal-crear"]').forEach(btn => btn.addEventListener('click', () => close('#str-modal-crear')));
   425	
   426	        document.getElementById('str-btn-crear-confirm')?.addEventListener('click', async () => {
   427	            const nombre = document.getElementById('str-inp-nombre-grupo').value.trim();
   428	            const fd = new FormData();
   429	            fd.append('action','str_grupo_crear');
   430	            fd.append('_ajax_nonce', NONCE);
   431	            fd.append('competicion_id', COMP);
   432	            fd.append('nombre', nombre);
   433	            const r = await fetch(AJAX, {method:'POST', body:fd});
   434	            let j; try{ j = await r.json(); }catch(e){}
   435	            if (j && j.success){
   436	                location.reload();
   437	            } else {
   438	                alert((j && j.data && j.data.message) ? j.data.message : 'No se pudo crear el grupo.');
   439	            }
   440	        });
   441	
   442	        // ===== Asignar pareja =====
   443	        document.querySelectorAll('.js-add-pareja').forEach(btn => {
   444	            btn.addEventListener('click', async () => {
   445	                const gid = btn.dataset.grupoId;
   446	                const select = btn.parentElement.querySelector('.js-select-pareja');
   447	                const pid = select?.value;
   448	                if (!pid){ alert('Selecciona una pareja libre.'); return; }
   449	
   450	                const fd = new FormData();
   451	                fd.append('action','str_grupo_asignar_pareja');
   452	                fd.append('_ajax_nonce', NONCE);
   453	                fd.append('competicion_id', COMP);
   454	                fd.append('grupo_id', gid);
   455	                fd.append('pareja_id', pid);
   456	
   457	                const r = await fetch(AJAX,{method:'POST', body:fd});
   458	                let j; try{ j = await r.json(); }catch(e){}
   459	                if (j && j.success){ location.reload(); }
   460	                else { alert((j && j.data && j.data.message) ? j.data.message : 'No se pudo asignar la pareja al grupo.'); }
   461	            });
   462	        });
   463	
   464	        // Atajo maestro → precarga selects
   465	        const master = document.getElementById('str-select-libres');
   466	        if (master){
   467	            master.addEventListener('change', () => {
   468	                document.querySelectorAll('.js-select-pareja').forEach(sel => { sel.value = master.value || ''; });
   469	            });
   470	        }
   471	
   472	        // ===== Quitar pareja (con modal propio) =====
   473	        const modalConfirm = '#str-modal-confirm';
   474	        const confPair  = document.getElementById('str-conf-pair');
   475	        const confGroup = document.getElementById('str-conf-group');
   476	        const confGid   = document.getElementById('str-conf-gid');
   477	        const confPid   = document.getElementById('str-conf-pid');
   478	
   479	        // abrir modal con datos
   480	        document.querySelectorAll('.js-quitar-pareja').forEach(btn => {
   481	            btn.addEventListener('click', () => {
   482	                const gid = btn.dataset.grupoId;
   483	                const pid = btn.dataset.parejaId;
   484	                confGid.value = gid;
   485	                confPid.value = pid;
   486	                confPair.textContent  = PAIR_NAME(parseInt(pid,10));
   487	                confGroup.textContent = GROUP_NAME(parseInt(gid,10));
   488	                open(modalConfirm);
   489	            });
   490	        });
   491	
   492	        // confirmar eliminación
   493	        document.getElementById('str-conf-accept')?.addEventListener('click', async () => {
   494	            const gid = confGid.value;
   495	            const pid = confPid.value;
   496	            if (!gid || !pid) return;
   497	
   498	            const fd = new FormData();
   499	            fd.append('action','str_grupo_quitar_pareja');
   500	            fd.append('_ajax_nonce', NONCE);
   501	            fd.append('grupo_id', gid);
   502	            fd.append('pareja_id', pid);
   503	
   504	            const r = await fetch(AJAX,{method:'POST', body:fd});
   505	            let j; try{ j = await r.json(); }catch(e){}
   506	            if (j && j.success){ location.reload(); }
   507	            else { alert((j && j.data && j.data.message) ? j.data.message : 'No se pudo quitar la pareja.'); }
   508	        });
   509	
   510	        // ===== Editar (Renombrar / Eliminar grupo) =====
   511	        const modalRename   = '#str-modal-rename';
   512	        const inpRename     = document.getElementById('str-inp-rename');
   513	        const inpRenameId   = document.getElementById('str-inp-rename-grupo-id');
   514	
   515	        document.querySelectorAll('[data-close="#str-modal-rename"]').forEach(btn => btn.addEventListener('click', () => close(modalRename)));
   516	
   517	        document.querySelectorAll('.js-editar-grupo').forEach(btn => {
   518	            btn.addEventListener('click', () => {
   519	                const gid = btn.dataset.grupoId;
   520	                const name = btn.dataset.grupoNombre || '';
   521	                inpRename.value = name;
   522	                inpRenameId.value = gid;
   523	                open(modalRename);
   524	                setTimeout(()=>{ inpRename.focus(); }, 50);
   525	            });
   526	        });
   527	
   528	        // Guardar nombre
   529	        document.getElementById('str-btn-rename-confirm')?.addEventListener('click', async () => {
   530	            const newName = (inpRename.value || '').trim();
   531	            const gid     = (inpRenameId.value || '').trim();
   532	            if (!gid) { alert('Grupo no válido'); return; }
   533	            if (!newName) { alert('Escribe un nombre para el grupo.'); return; }
   534	
   535	            const fd = new FormData();
   536	            fd.append('action','str_grupo_renombrar');
   537	            fd.append('_ajax_nonce', NONCE);
   538	            fd.append('competicion_id', COMP);
   539	            fd.append('grupo_id', gid);
   540	            fd.append('nombre', newName);
   541	
   542	            const r = await fetch(AJAX, {method:'POST', body: fd});
   543	            let j; try{ j = await r.json(); }catch(e){}
   544	            if (j && j.success){ location.reload(); }
   545	            else { alert((j && j.data && j.data.msg) ? j.data.msg : (j && j.data && j.data.message) ? j.data.message : 'No se pudo renombrar el grupo.'); }
   546	        });
   547	
   548	        // Eliminar grupo
   549	        document.getElementById('str-btn-eliminar-grupo')?.addEventListener('click', async () => {
   550	            const gid = (inpRenameId.value || '').trim();
   551	            if (!gid) { alert('Grupo no válido'); return; }
   552	            const seguro = confirm('Esta acción enviará el grupo a la papelera y desaparecerá de la lista. ¿Continuar?');
   553	            if (!seguro) return;
   554	
   555	            const fd = new FormData();
   556	            fd.append('action','str_grupo_eliminar');
   557	            fd.append('_ajax_nonce', NONCE);
   558	            fd.append('competicion_id', COMP);
   559	            fd.append('grupo_id', gid);
   560	
   561	            const r = await fetch(AJAX, {method:'POST', body: fd});
   562	            let j; try{ j = await r.json(); }catch(e){}
   563	            if (j && j.success){ location.reload(); }
   564	            else { alert((j && j.data && j.data.message) ? j.data.message : 'No se pudo eliminar el grupo.'); }
   565	        });
   566	
   567	        // ===== Distribuir parejas (igual que antes) =====
   568	        const modalDist = '#str-modal-distribuir';
   569	        const polSel    = document.getElementById('str-pol');
   570	        const targetInp = document.getElementById('str-target');
   571	        const seedInp   = document.getElementById('str-seed');
   572	        const relocate  = document.getElementById('str-relocate');
   573	        const prevWrap  = document.getElementById('str-prev-wrap');
   574	        const prevMeta  = document.getElementById('str-prev-meta');
   575	
   576	        document.getElementById('str-btn-distribuir')?.addEventListener('click', () => {
   577	            open(modalDist);
   578	            prevWrap.style.display = 'none';
   579	            prevMeta.style.display = 'none';
   580	            prevWrap.innerHTML = '';
   581	        });
   582	        document.querySelectorAll('[data-close="#str-modal-distribuir"]').forEach(btn =>
   583	            btn.addEventListener('click', () => close(modalDist))
   584	        );
   585	
   586	        function seededRandom(seed){
   587	            let x = 0;
   588	            for (let i=0;i<seed.length;i++) x = (x ^ seed.charCodeAt(i)) >>> 0;
   589	            if (x===0) x = 0x9e3779b9;
   590	            return function(){
   591	                x ^= x << 13; x ^= x >>> 17; x ^= x << 5;
   592	                return ((x>>>0) / 4294967296);
   593	            };
   594	        }
   595	        function shuffle(arr, rnd){
   596	            const a = arr.slice();
   597	            for(let i=a.length-1;i>0;i--){
   598	                const j = Math.floor(rnd()* (i+1));
   599	                [a[i],a[j]] = [a[j],a[i]];
   600	            }
   601	            return a;
   602	        }
   603	
   604	        function buildPreview(){
   605	            const target = Math.max(2, parseInt(targetInp.value||'4',10));
   606	            const policy = polSel.value;
   607	            const seed   = seedInp.value.trim() || (new Date().toISOString().slice(0,10));
   608	            const rnd    = seededRandom(seed);
   609	
   610	            const groups = Object.keys(DATA.groupsPairs || {}).map(gid => parseInt(gid,10));
   611	            const current = {};
   612	            groups.forEach(gid => current[gid] = (DATA.groupsPairs[gid]||[]).slice());
   613	
   614	            const free = (DATA.freePairs||[]).slice();
   615	
   616	            const plan = {};
   617	            groups.forEach(gid => plan[gid] = { before: current[gid].slice(), after: current[gid].slice() });
   618	
   619	            let candidates = [];
   620	            if (relocate.checked){
   621	                const all = new Set();
   622	                free.forEach(p=>all.add(p));
   623	                groups.forEach(gid => (current[gid]||[]).forEach(p=>all.add(p)));
   624	                candidates = Array.from(all);
   625	            } else {
   626	                candidates = free.slice();
   627	            }
   628	            candidates = shuffle(candidates, rnd);
   629	
   630	            if (policy === 'roundrobin'){
   631	                let idx = 0;
   632	                while (candidates.length){
   633	                    const gid = groups[idx % groups.length];
   634	                    if (plan[gid].after.length < target){
   635	                        const p = candidates.shift();
   636	                        if (!plan[gid].after.includes(p)){
   637	                            if (relocate.checked){
   638	                                groups.forEach(g => {
   639	                                    if (g!==gid){
   640	                                        const i = plan[g].after.indexOf(p);
   641	                                        if (i>=0) plan[g].after.splice(i,1);
   642	                                    }
   643	                                });
   644	                            }
   645	                            plan[gid].after.push(p);
   646	                        }
   647	                    }
   648	                    idx++;
   649	                    if (groups.every(g => plan[g].after.length >= target)) break;
   650	                }
   651	            } else {
   652	                groups.forEach(gid => {
   653	                    while (plan[gid].after.length < target && candidates.length){
   654	                        const p = candidates.shift();
   655	                        if (relocate.checked){
   656	                            groups.forEach(g => {
   657	                                if (g!==gid){
   658	                                    const i = plan[g].after.indexOf(p);
   659	                                    if (i>=0) plan[g].after.splice(i,1);
   660	                                }
   661	                            });
   662	                        }
   663	                        if (!plan[gid].after.includes(p)){
   664	                            plan[gid].after.push(p);
   665	                        }
   666	                    }
   667	                });
   668	            }
   669	
   670	            prevMeta.textContent = `Grupos: ${groups.length} · Política: ${policy} · Tamaño objetivo: ${target}`;
   671	            prevMeta.style.display = 'block';
   672	
   673	            prevWrap.innerHTML = '';
   674	            groups.forEach(gid => {
   675	                const card = document.createElement('div');
   676	                card.className = 'str-prev-card';
   677	                card.innerHTML = `
   678	                    <div class="str-prev-head">${GROUP_NAME(gid)}</div>
   679	                    <div class="str-prev-body">
   680	                        <div>
   681	                            <div class="str-colcap">Antes</div>
   682	                            <div class="str-chips"></div>
   683	                        </div>
   684	                        <div>
   685	                            <div class="str-colcap">Después</div>
   686	                            <div class="str-chips"></div>
   687	                        </div>
   688	                    </div>
   689	                `;
   690	                const [colBefore, colAfter] = card.querySelectorAll('.str-chips');
   691	                (plan[gid].before || []).forEach(pid => {
   692	                    const c = document.createElement('span');
   693	                    c.className = 'str-chip';
   694	                    c.textContent = PAIR_NAME(pid);
   695	                    colBefore.appendChild(c);
   696	                });
   697	                (plan[gid].after || []).forEach(pid => {
   698	                    const c = document.createElement('span');
   699	                    c.className = 'str-chip';
   700	                    c.textContent = PAIR_NAME(pid);
   701	                    colAfter.appendChild(c);
   702	                });
   703	                prevWrap.appendChild(card);
   704	            });
   705	            prevWrap.style.display = 'block';
   706	
   707	            return plan;
   708	        }
   709	
   710	        let lastPlan = null;
   711	        document.getElementById('str-btn-prev')?.addEventListener('click', () => {
   712	            lastPlan = buildPreview();
   713	        });
   714	
   715	        document.getElementById('str-btn-apply')?.addEventListener('click', async () => {
   716	            if (!lastPlan) lastPlan = buildPreview();
   717	            const moves = [];
   718	            Object.keys(lastPlan).forEach(gid => {
   719	                const before = lastPlan[gid].before || [];
   720	                const after  = lastPlan[gid].after  || [];
   721	                const add    = after.filter(p => !before.includes(p));
   722	                const remove = before.filter(p => !after.includes(p));
   723	                moves.push({gid: parseInt(gid,10), add, remove});
   724	            });
   725	
   726	            for (const m of moves){
   727	                for (const pid of m.remove){
   728	                    const fd = new FormData();
   729	                    fd.append('action','str_grupo_quitar_pareja');
   730	                    fd.append('_ajax_nonce', NONCE);
   731	                    fd.append('grupo_id', m.gid);
   732	                    fd.append('pareja_id', pid);
   733	                    await fetch(AJAX,{method:'POST', body:fd});
   734	                }
   735	                for (const pid of m.add){
   736	                    const fd = new FormData();
   737	                    fd.append('action','str_grupo_asignar_pareja');
   738	                    fd.append('_ajax_nonce', NONCE);
   739	                    fd.append('competicion_id', COMP);
   740	                    fd.append('grupo_id', m.gid);
   741	                    fd.append('pareja_id', pid);
   742	                    await fetch(AJAX,{method:'POST', body:fd});
   743	                }
   744	            }
   745	            location.reload();
   746	        });
   747	
   748	        // Cerrar modales por overlay y ESC
   749	        document.querySelectorAll('.str-modal').forEach(m => {
   750	            m.addEventListener('click', (e) => { if (e.target === m) m.classList.remove('is-open'); });
   751	        });
   752	        document.addEventListener('keydown', (e) => {
   753	            if (e.key === 'Escape'){
   754	                document.querySelectorAll('.str-modal.is-open').forEach(m => m.classList.remove('is-open'));
   755	            }
   756	        });
   757	    })();
   758	    </script>
   759	
   760	    <?php
   761	    return ob_get_clean();
   762	}
   763	
   764	endif; // function_exists
===== END includes/features/groups/render-grupos.php =====

===== BEGIN includes/features/groups_v2/bootstrap.php =====
     1	<?php
     2	if ( ! defined('ABSPATH') ) { exit; }
     3	
     4	/**
     5	 * Bootstrap Groups v2 (REST + flag + enqueue)
     6	 * Se invoca desde el mu-plugin loader.
     7	 */
     8	function str_groups_v2_bootstrap( $plugin_dir ) {
     9	    // Guardamos ruta en constante local si no existe
    10	    if ( ! defined('STR_GROUPS_V2_DIR') ) {
    11	        define('STR_GROUPS_V2_DIR', trailingslashit($plugin_dir) . 'includes/features/groups_v2/');
    12	    }
    13	    if ( ! defined('STR_GROUPS_V2_URL') ) {
    14	        $base_url = trailingslashit( plugin_dir_url( $plugin_dir . '/saas-torneos-de-raqueta.php' ) ); // fallback genérico
    15	        // Mejor: derivar desde el path real del plugin
    16	        $base_url = trailingslashit( plugin_dir_url( $plugin_dir . '/' ) . 'saas-torneos-de-raqueta' );
    17	        define('STR_GROUPS_V2_URL', $base_url . 'includes/features/groups_v2/');
    18	    }
    19	
    20	    require_once STR_GROUPS_V2_DIR . 'rest.php';
    21	
    22	    add_action('rest_api_init', function() {
    23	        (new STR_Groups_V2_REST())->register_routes();
    24	    });
    25	
    26	    // Flag v2
    27	    if ( ! function_exists('str_groups_v2_is_enabled') ) {
    28	        function str_groups_v2_is_enabled() {
    29	            // GET tiene preferencia para pruebas: ?groups_engine=v2
    30	            if ( isset($_GET['groups_engine']) && $_GET['groups_engine'] === 'v2' ) return true;
    31	            $opt = get_option('str_groups_engine');
    32	            if ( is_string($opt) && strtolower($opt) === 'v2' ) return true;
    33	            return false;
    34	        }
    35	    }
    36	
    37	    // Enqueue del JS v2 SOLO si flag activo y estamos en una competición (CPT)
    38	    add_action('wp_enqueue_scripts', function() use ($plugin_dir) {
    39	        if ( ! str_groups_v2_is_enabled() ) return;
    40	        if ( ! is_singular('competicion') ) return;
    41	
    42	        global $post;
    43	        if ( empty($post) ) return;
    44	
    45	        // Puedes afinar por deporte/tipo con ACF si quieres (comentado):
    46	        // $deporte = function_exists('get_field') ? get_field('deporte', $post->ID) : '';
    47	        // $tipo    = function_exists('get_field') ? get_field('tipo_competicion', $post->ID) : '';
    48	        // if ( strtolower($deporte) !== 'padel' || strtolower($tipo) !== 'torneo' ) return;
    49	
    50	        // Encolar JS v2
    51	        $assets_js_rel  = 'assets/js/torneo-grupos-v2.js';
    52	        $assets_js_abs  = trailingslashit($plugin_dir) . $assets_js_rel;
    53	        $assets_js_url  = trailingslashit( plugin_dir_url($plugin_dir) ) . 'saas-torneos-de-raqueta/' . $assets_js_rel;
    54	
    55	        $ver = file_exists($assets_js_abs) ? @filemtime($assets_js_abs) : '1.0.0';
    56	        wp_enqueue_script( 'str-groups-v2-js', $assets_js_url, ['jquery'], $ver, true );
    57	
    58	        // Datos para el JS
    59	        wp_localize_script( 'str-groups-v2-js', 'strTorneoV2', [
    60	            'restBase'       => esc_url_raw( rest_url('saas/v1') ),
    61	            'restNonce'      => wp_create_nonce('wp_rest'),
    62	            'competicionId'  => (int) $post->ID,
    63	            'reqId'          => function_exists('str_req_id') ? str_req_id() : substr(uniqid('r', true), 0, 12),
    64	        ]);
    65	
    66	        if ( function_exists('str_log') ) {
    67	            str_log('GROUPS_V2/ENQUEUE', 'JS encolado', ['post_id'=>$post->ID, 'ver'=>$ver]);
    68	        }
    69	    }, 25);
    70	}
===== END includes/features/groups_v2/bootstrap.php =====

===== BEGIN includes/features/groups_v2/rest.php =====
     1	<?php
     2	if ( ! defined('ABSPATH') ) { exit; }
     3	
     4	class STR_Groups_V2_REST {
     5	
     6	    public function register_routes() {
     7	        register_rest_route('saas/v1', '/groups', [
     8	            [
     9	                'methods'             => WP_REST_Server::READABLE, // GET
    10	                'callback'            => [$this, 'get_groups'],
    11	                'permission_callback' => '__return_true',          // lectura pública
    12	                'args'                => [
    13	                    'competicion_id' => ['type'=>'integer','required'=>true],
    14	                ],
    15	            ],
    16	        ]);
    17	
    18	        register_rest_route('saas/v1', '/groups/standings', [
    19	            [
    20	                'methods'             => WP_REST_Server::READABLE, // GET
    21	                'callback'            => [$this, 'get_standings'],
    22	                'permission_callback' => '__return_true',
    23	                'args'                => [
    24	                    'competicion_id'     => ['type'=>'integer','required'=>true],
    25	                    'incluir_propuestos' => ['type'=>'boolean','required'=>false],
    26	                    'ppv'                => ['type'=>'integer','required'=>false],
    27	                ],
    28	            ],
    29	        ]);
    30	
    31	        register_rest_route('saas/v1', '/groups/auto-assign', [
    32	            [
    33	                'methods'             => WP_REST_Server::CREATABLE, // POST
    34	                'callback'            => [$this, 'post_auto_assign'],
    35	                'permission_callback' => [$this, 'can_manage'],
    36	                'args'                => [
    37	                    'competicion_id' => ['type'=>'integer','required'=>true],
    38	                ],
    39	            ],
    40	        ]);
    41	
    42	        register_rest_route('saas/v1', '/group/(?P<grupo_id>\d+)/assign', [
    43	            [
    44	                'methods'             => WP_REST_Server::CREATABLE, // POST
    45	                'callback'            => [$this, 'post_assign_pair'],
    46	                'permission_callback' => [$this, 'can_manage'],
    47	                'args'                => [
    48	                    'grupo_id'      => ['type'=>'integer','required'=>true],
    49	                    'competicion_id'=> ['type'=>'integer','required'=>true],
    50	                    'pareja_id'     => ['type'=>'integer','required'=>true],
    51	                    'placeholder_id'=> ['type'=>'integer','required'=>false],
    52	                ],
    53	            ],
    54	        ]);
    55	
    56	        register_rest_route('saas/v1', '/bracket/volcar', [
    57	            [
    58	                'methods'             => WP_REST_Server::CREATABLE, // POST
    59	                'callback'            => [$this, 'post_bracket_volcar'],
    60	                'permission_callback' => [$this, 'can_manage'],
    61	                'args'                => [
    62	                    'competicion_id'     => ['type'=>'integer','required'=>true],
    63	                    'incluir_propuestos' => ['type'=>'boolean','required'=>false],
    64	                ],
    65	            ],
    66	        ]);
    67	    }
    68	
    69	    /* ===========================
    70	     *  Permissions
    71	     * =========================== */
    72	    public function can_manage( WP_REST_Request $req ) {
    73	        // Requerimos login + rol cliente o admin
    74	        if ( ! is_user_logged_in() ) return false;
    75	        if ( current_user_can('administrator') || current_user_can('cliente') ) return true;
    76	        return false;
    77	    }
    78	
    79	    /* ===========================
    80	     *  GET /groups
    81	     * =========================== */
    82	    public function get_groups( WP_REST_Request $req ) {
    83	        $cid = (int) $req->get_param('competicion_id');
    84	        if ( $cid <= 0 ) { return new WP_Error('bad_request', 'competicion_id inválido', ['status'=>400]); }
    85	
    86	        $meta = [
    87	            'n_grupos'   => (int) get_post_meta($cid, 'str_n_grupos', true),
    88	            'n_parejas'  => (int) get_post_meta($cid, 'str_n_parejas', true),
    89	            'fase_final' => (string) get_post_meta($cid, 'str_fase_final', true),
    90	            'modo_final' => (string) get_post_meta($cid, 'str_modo_final', true),
    91	        ];
    92	
    93	        $grupos = $this->listar_grupos_competicion($cid);
    94	        $todas  = $this->listar_parejas_competicion($cid);
    95	        $libres = $this->calcular_parejas_libres($todas, $grupos);
    96	
    97	        if ( function_exists('str_log') ) {
    98	            str_log('GROUPS_V2/GET_GROUPS', 'OK', [
    99	                'comp'=>$cid,'grupos'=>count($grupos),'parejas_total'=>count($todas),'libres'=>count($libres)
   100	            ]);
   101	        }
   102	
   103	        return new WP_REST_Response([
   104	            'competicion_id' => $cid,
   105	            'meta'           => $meta,
   106	            'grupos'         => $grupos,
   107	            'parejas_libres' => $libres,
   108	        ], 200);
   109	    }
   110	
   111	    /* ===========================
   112	     *  GET /groups/standings
   113	     * =========================== */
   114	    public function get_standings( WP_REST_Request $req ) {
   115	        $cid  = (int) $req->get_param('competicion_id');
   116	        $prop = (bool) $req->get_param('incluir_propuestos');
   117	        $ppv  = (int) ($req->get_param('ppv') ?: 3);
   118	        if ( $cid <= 0 ) { return new WP_Error('bad_request', 'competicion_id inválido', ['status'=>400]); }
   119	
   120	        $out_groups = [];
   121	        $count_matches = 0;
   122	
   123	        $grupos_ids = $this->listar_grupos_ids($cid);
   124	        foreach ($grupos_ids as $gid) {
   125	            // seguridad de pertenencia
   126	            $comp_g = (int) get_post_meta($gid, 'competicion_id', true);
   127	            if ( $comp_g !== $cid ) continue;
   128	
   129	            $ginfo = $this->grupo_info($gid);
   130	
   131	            // Inicial stats
   132	            $stats = [];
   133	            foreach ($ginfo['participantes'] as $p) {
   134	                $stats[ (int)$p['id'] ] = ['pj'=>0,'pg'=>0,'pp'=>0,'pts'=>0,'sets_f'=>0,'sets_c'=>0,'juegos_f'=>0,'juegos_c'=>0];
   135	            }
   136	
   137	            $partidos = $this->listar_partidos_de_grupo($gid);
   138	            foreach ($partidos as $pid) {
   139	                if ( ! $this->contar_partido($pid, $prop) ) continue;
   140	
   141	                $p1 = (int) get_post_meta($pid, 'pareja_1', true);
   142	                $p2 = (int) get_post_meta($pid, 'pareja_2', true);
   143	                if ( $p1 <= 0 || $p2 <= 0 ) continue;
   144	
   145	                // ambos del grupo
   146	                if ( ! $this->pareja_en_grupo($p1, $ginfo) || ! $this->pareja_en_grupo($p2, $ginfo) ) continue;
   147	
   148	                $rows = $this->leer_resultado($pid);
   149	                if ( $this->aplicar_resultado($stats, $p1, $p2, $rows, $ppv) ) { $count_matches++; }
   150	            }
   151	
   152	            // map + orden
   153	            $items = [];
   154	            foreach ($ginfo['participantes'] as $p) {
   155	                $pid = (int) $p['id'];
   156	                $st = $stats[$pid] ?? ['pj'=>0,'pg'=>0,'pp'=>0,'pts'=>0,'sets_f'=>0,'sets_c'=>0,'juegos_f'=>0,'juegos_c'=>0];
   157	                $items[] = [
   158	                    'pareja_id'   => $pid,
   159	                    'title'       => $p['title'],
   160	                    'placeholder' => (bool) $p['placeholder'],
   161	                    'pj'          => $st['pj'],
   162	                    'pg'          => $st['pg'],
   163	                    'pp'          => $st['pp'],
   164	                    'pts'         => $st['pts'],
   165	                    'sets_f'      => $st['sets_f'],
   166	                    'sets_c'      => $st['sets_c'],
   167	                    'dif_sets'    => $st['sets_f'] - $st['sets_c'],
   168	                    'juegos_f'    => $st['juegos_f'],
   169	                    'juegos_c'    => $st['juegos_c'],
   170	                    'dif_juegos'  => $st['juegos_f'] - $st['juegos_c'],
   171	                ];
   172	            }
   173	            usort($items, [$this,'ordenar_items']);
   174	
   175	            $out_groups[] = [
   176	                'grupo_id' => $ginfo['id'],
   177	                'letra'    => $ginfo['letra'],
   178	                'items'    => $items,
   179	            ];
   180	        }
   181	
   182	        if ( function_exists('str_log') ) {
   183	            str_log('GROUPS_V2/STANDINGS', 'OK', ['comp'=>$cid,'grupos'=>count($out_groups),'partidos'=>$count_matches,'ppv'=>$ppv,'prop'=>$prop]);
   184	        }
   185	
   186	        return new WP_REST_Response([
   187	            'competicion_id' => $cid,
   188	            'grupos'         => $out_groups,
   189	            'resumen'        => [
   190	                'grupos_calculados' => count($out_groups),
   191	                'partidos_contados' => $count_matches,
   192	                'criterio_puntos'   => "victoria={$ppv}, derrota=0",
   193	                'incluye_propuestos'=> $prop ? true : false
   194	            ]
   195	        ], 200);
   196	    }
   197	
   198	    /* ===========================
   199	     *  POST /groups/auto-assign
   200	     * =========================== */
   201	    public function post_auto_assign( WP_REST_Request $req ) {
   202	        $cid = (int) $req->get_param('competicion_id');
   203	        if ( $cid <= 0 ) { return new WP_Error('bad_request', 'competicion_id inválido', ['status'=>400]); }
   204	
   205	        $all_pairs = $this->listar_parejas_competicion($cid);
   206	        $free      = $this->calcular_parejas_libres($all_pairs, $this->listar_grupos_competicion($cid));
   207	        if ( ! empty($free) ) shuffle($free);
   208	
   209	        $reemplazos = 0; $asignadas = 0;
   210	        $grupos_ids = $this->listar_grupos_ids($cid);
   211	
   212	        foreach ($grupos_ids as $gid) {
   213	            if ( empty($free) ) break;
   214	
   215	            $ginfo = $this->grupo_info($gid);
   216	
   217	            $placeholders = array_values( array_map(
   218	                fn($p) => (int)$p['id'],
   219	                array_filter($ginfo['participantes'], fn($p) => !empty($p['placeholder']))
   220	            ));
   221	            if ( empty($placeholders) ) continue;
   222	
   223	            foreach ($placeholders as $phid) {
   224	                if ( empty($free) ) break;
   225	                $par    = array_pop($free);
   226	                $pidNew = (int) $par['id'];
   227	
   228	                // Garantiza vínculo
   229	                $meta_comp = (int) get_post_meta($pidNew, 'competicion_id', true);
   230	                if ( $meta_comp !== $cid ) update_post_meta($pidNew, 'competicion_id', $cid);
   231	
   232	                if ( $this->grupo_reemplazar_participante($gid, $phid, $pidNew) ) {
   233	                    $this->partidos_reemplazar_en_grupo($gid, $phid, $pidNew);
   234	                    $reemplazos++; $asignadas++;
   235	                }
   236	            }
   237	        }
   238	
   239	        if ( function_exists('str_log') ) {
   240	            str_log('GROUPS_V2/AUTOASSIGN', 'OK', ['comp'=>$cid,'reemplazos'=>$reemplazos,'asignadas'=>$asignadas]);
   241	        }
   242	
   243	        return new WP_REST_Response([
   244	            'resumen' => [
   245	                'grupos_procesados'         => count($grupos_ids),
   246	                'placeholders_reemplazados' => $reemplazos,
   247	                'parejas_asignadas'         => $asignadas,
   248	            ]
   249	        ], 200);
   250	    }
   251	
   252	    /* ===========================
   253	     *  POST /group/{id}/assign
   254	     * =========================== */
   255	    public function post_assign_pair( WP_REST_Request $req ) {
   256	        $cid  = (int) $req->get_param('competicion_id');
   257	        $gid  = (int) $req->get_param('grupo_id');
   258	        $pid  = (int) $req->get_param('pareja_id');
   259	        $ph   = (int) $req->get_param('placeholder_id');
   260	
   261	        if ( $cid<=0 || $gid<=0 || $pid<=0 ) { return new WP_Error('bad_request', 'Parámetros inválidos', ['status'=>400]); }
   262	
   263	        $grupo_comp = (int) get_post_meta($gid, 'competicion_id', true);
   264	        if ( $grupo_comp !== $cid ) { return new WP_Error('bad_request','El grupo no pertenece a la competición',['status'=>400]); }
   265	
   266	        // Evitar duplicados: si ya está en otro grupo…
   267	        $gid_actual = $this->pareja_grupo_actual($cid, $pid);
   268	        if ( $gid_actual > 0 && $gid_actual !== $gid ) {
   269	            return new WP_Error('already_assigned', 'Pareja ya asignada a otro grupo', ['status'=>409, 'grupo_id'=>$gid_actual] );
   270	        }
   271	
   272	        $ginfo = $this->grupo_info($gid);
   273	
   274	        if ( $ph <= 0 ) {
   275	            foreach ($ginfo['participantes'] as $p) {
   276	                if ( ! empty($p['placeholder']) ) { $ph = (int) $p['id']; break; }
   277	            }
   278	        }
   279	        if ( $ph <= 0 ) { return new WP_Error('group_full','No hay placeholders en el grupo',['status'=>409]); }
   280	
   281	        $es_ph = (bool) get_post_meta($ph, 'placeholder', true);
   282	        $esta  = false;
   283	        foreach ($ginfo['participantes'] as $p) { if ( (int)$p['id'] === $ph ) { $esta = true; break; } }
   284	        if ( ! $es_ph || ! $esta ) { return new WP_Error('bad_request','placeholder_id no válido',['status'=>400]); }
   285	
   286	        // Vincular pareja a comp
   287	        if ( (int)get_post_meta($pid,'competicion_id',true) !== $cid ) update_post_meta($pid,'competicion_id',$cid);
   288	
   289	        if ( ! $this->grupo_reemplazar_participante($gid, $ph, $pid) ) {
   290	            return new WP_Error('server_error','No se pudo reemplazar',['status'=>500]);
   291	        }
   292	        $mod = $this->partidos_reemplazar_en_grupo($gid, $ph, $pid);
   293	
   294	        if ( function_exists('str_log') ) {
   295	            str_log('GROUPS_V2/ASSIGN', 'OK', ['comp'=>$cid,'gid'=>$gid,'pid'=>$pid,'ph'=>$ph,'partidos_mod'=>$mod]);
   296	        }
   297	
   298	        return new WP_REST_Response([
   299	            'grupo' => $this->grupo_info($gid),
   300	            'reemplazos' => ['placeholder_id'=>$ph,'pareja_id'=>$pid],
   301	            'partidos_actualizados' => $mod,
   302	        ], 200);
   303	    }
   304	
   305	    /* ===========================
   306	     *  POST /bracket/volcar
   307	     *  (mínimo viable; puedes ampliar después)
   308	     * =========================== */
   309	    public function post_bracket_volcar( WP_REST_Request $req ) {
   310	        $cid  = (int) $req->get_param('competicion_id');
   311	        $prop = (bool) $req->get_param('incluir_propuestos');
   312	
   313	        if ( $cid <= 0 ) { return new WP_Error('bad_request', 'competicion_id inválido', ['status'=>400]); }
   314	
   315	        // Buscar partidos de fase final
   316	        $rondas = ['Octavos','Cuartos','Semifinal','Final','octavos','cuartos','semifinal','final'];
   317	        $q = new WP_Query([
   318	            'post_type'      => 'partido',
   319	            'post_status'    => 'publish',
   320	            'posts_per_page' => -1,
   321	            'fields'         => 'ids',
   322	            'meta_query'     => [
   323	                'relation'=>'AND',
   324	                ['key'=>'competicion_padel','value'=>$cid,'compare'=>'='],
   325	                ['key'=>'ronda','value'=>$rondas,'compare'=>'IN'],
   326	            ],
   327	        ]);
   328	        if ( ! $q->have_posts() ) {
   329	            return new WP_REST_Response([
   330	                'partidos_procesados'=>0,'slots_resueltos'=>0,'partidos_actualizados'=>0,'detalles'=>[]
   331	            ], 200);
   332	        }
   333	
   334	        $procesados=0; $slots=0; $actualizados=0; $detalles=[];
   335	
   336	        foreach ($q->posts as $match_id) {
   337	            $procesados++;
   338	            $slot_a = get_post_meta($match_id,'slot_a',true);
   339	            $slot_b = get_post_meta($match_id,'slot_b',true);
   340	            $p1     = (int) get_post_meta($match_id,'pareja_1',true);
   341	            $p2     = (int) get_post_meta($match_id,'pareja_2',true);
   342	
   343	            $asig1=false; $asig2=false;
   344	
   345	            if ( $p1<=0 && $slot_a ) {
   346	                $pid = $this->resolver_slot_posicional($slot_a, $cid, $prop);
   347	                if ( $pid > 0 ) { update_post_meta($match_id,'pareja_1',$pid); $p1=$pid; $asig1=true; $slots++; }
   348	            }
   349	            if ( $p2<=0 && $slot_b ) {
   350	                $pid = $this->resolver_slot_posicional($slot_b, $cid, $prop);
   351	                if ( $pid > 0 ) { update_post_meta($match_id,'pareja_2',$pid); $p2=$pid; $asig2=true; $slots++; }
   352	            }
   353	            if ( $asig1 || $asig2 ) { $this->refrescar_titulo_partido($match_id); $actualizados++; }
   354	
   355	            $detalles[] = [
   356	                'partido_id'=>$match_id,
   357	                'pareja_1_asignada'=>$asig1 ? $p1 : null,
   358	                'pareja_2_asignada'=>$asig2 ? $p2 : null,
   359	            ];
   360	        }
   361	
   362	        if ( function_exists('str_log') ) {
   363	            str_log('GROUPS_V2/BRACKET', 'OK', ['comp'=>$cid,'procesados'=>$procesados,'slots'=>$slots,'actualizados'=>$actualizados]);
   364	        }
   365	
   366	        return new WP_REST_Response([
   367	            'partidos_procesados'=>$procesados,
   368	            'slots_resueltos'=>$slots,
   369	            'partidos_actualizados'=>$actualizados,
   370	            'detalles'=>$detalles,
   371	        ], 200);
   372	    }
   373	
   374	    /* ===========================
   375	     *  Helpers (consultas / cálculos)
   376	     * =========================== */
   377	
   378	    private function listar_grupos_ids($cid) {
   379	        $q = new WP_Query([
   380	            'post_type'      => 'grupo',
   381	            'post_status'    => 'publish',
   382	            'posts_per_page' => -1,
   383	            'fields'         => 'ids',
   384	            'meta_key'       => 'orden',
   385	            'orderby'        => 'meta_value_num',
   386	            'order'          => 'ASC',
   387	            'meta_query'     => [
   388	                ['key'=>'competicion_id','value'=>$cid,'compare'=>'=']
   389	            ]
   390	        ]);
   391	        return $q->have_posts() ? array_map('intval', $q->posts) : [];
   392	    }
   393	
   394	    private function listar_grupos_competicion($cid) {
   395	        $out = [];
   396	        foreach ( $this->listar_grupos_ids($cid) as $gid ) {
   397	            $out[] = $this->grupo_info($gid);
   398	        }
   399	        return $out;
   400	    }
   401	
   402	    private function grupo_info($gid) {
   403	        $letra = get_post_meta($gid,'letra',true);
   404	        $tam   = (int) get_post_meta($gid,'tam',true);
   405	        $part_ids = get_post_meta($gid,'participantes',true);
   406	        if ( ! is_array($part_ids) ) $part_ids = [];
   407	        $participantes = [];
   408	        foreach ($part_ids as $pid) {
   409	            $pid = (int) $pid; if ( ! $pid ) continue;
   410	            $participantes[] = [
   411	                'id'          => $pid,
   412	                'title'       => get_the_title($pid),
   413	                'placeholder' => (bool) get_post_meta($pid,'placeholder',true),
   414	            ];
   415	        }
   416	        return [
   417	            'id'            => (int) $gid,
   418	            'letra'         => $letra ?: '',
   419	            'tam'           => $tam ?: count($participantes),
   420	            'participantes' => $participantes,
   421	        ];
   422	    }
   423	
   424	    private function listar_parejas_competicion($cid) {
   425	        $ids = [];
   426	
   427	        // Meta directa
   428	        $q1 = new WP_Query([
   429	            'post_type'=>'pareja','post_status'=>'publish','posts_per_page'=>-1,'fields'=>'ids',
   430	            'meta_query'=>[
   431	                ['key'=>'competicion_id','value'=>$cid,'compare'=>'=']
   432	            ]
   433	        ]);
   434	        if ( $q1->have_posts() ) $ids = array_merge($ids, $q1->posts);
   435	
   436	        // Compatibilidad ACF relación serializada
   437	        $q2 = new WP_Query([
   438	            'post_type'=>'pareja','post_status'=>'publish','posts_per_page'=>-1,'fields'=>'ids',
   439	            'meta_query'=>[
   440	                'relation'=>'OR',
   441	                ['key'=>'torneo_asociado','value'=>'"'.$cid.'"','compare'=>'LIKE'],
   442	                ['key'=>'competicion_padel','value'=>$cid,'compare'=>'='],
   443	            ]
   444	        ]);
   445	        if ( $q2->have_posts() ) $ids = array_merge($ids, $q2->posts);
   446	
   447	        $ids = array_values( array_unique( array_map('intval', $ids) ) );
   448	        $out = [];
   449	        foreach ($ids as $pid) {
   450	            $out[] = [
   451	                'id'          => $pid,
   452	                'title'       => get_the_title($pid),
   453	                'placeholder' => (bool) get_post_meta($pid,'placeholder',true),
   454	            ];
   455	        }
   456	        return $out;
   457	    }
   458	
   459	    private function calcular_parejas_libres($todas, $grupos) {
   460	        $asignadas = [];
   461	        foreach ($grupos as $g) {
   462	            foreach ( $g['participantes'] as $p ) {
   463	                $asignadas[ (int)$p['id'] ] = true;
   464	            }
   465	        }
   466	        $libres = [];
   467	        foreach ($todas as $p) {
   468	            if ( empty( $asignadas[ (int)$p['id'] ] ) ) { $libres[] = $p; }
   469	        }
   470	        return $libres;
   471	    }
   472	
   473	    private function grupo_reemplazar_participante($gid, $ph, $nuevo) {
   474	        $part_ids = get_post_meta($gid, 'participantes', true);
   475	        if ( ! is_array($part_ids) ) $part_ids = [];
   476	        $ok = false;
   477	        foreach ($part_ids as $i => $val) {
   478	            if ( (int)$val === (int)$ph ) { $part_ids[$i] = (int)$nuevo; $ok = true; break; }
   479	        }
   480	        if ( $ok ) update_post_meta($gid, 'participantes', array_map('intval', $part_ids) );
   481	        return $ok;
   482	    }
   483	
   484	    private function listar_partidos_de_grupo($gid) {
   485	        $q = new WP_Query([
   486	            'post_type'=>'partido','post_status'=>'publish','posts_per_page'=>-1,'fields'=>'ids',
   487	            'meta_query'=>[
   488	                ['key'=>'grupo_id','value'=>$gid,'compare'=>'=']
   489	            ],
   490	        ]);
   491	        return $q->have_posts() ? array_map('intval', $q->posts) : [];
   492	    }
   493	
   494	    private function contar_partido($pid, $incluir_prop=false) {
   495	        $estado = strtolower( (string) get_post_meta($pid,'estado',true) );
   496	        if ( $estado === 'confirmado' ) return true;
   497	        if ( $incluir_prop && in_array($estado, ['resultado propuesto','pendiente de validación','pendiente de validacion'], true) ) return true;
   498	        return false;
   499	    }
   500	
   501	    private function leer_resultado($pid) {
   502	        if ( function_exists('get_field') ) {
   503	            $rows = get_field('resultado_padel', $pid);
   504	            if ( is_array($rows) ) return $rows;
   505	        }
   506	        $meta = get_post_meta($pid,'resultado_padel',true);
   507	        if ( is_array($meta) ) return $meta;
   508	        if ( is_string($meta) && $meta!=='' ) {
   509	            $try = json_decode($meta, true);
   510	            if ( json_last_error()===JSON_ERROR_NONE && is_array($try) ) return $try;
   511	            $maybe = @unserialize($meta);
   512	            if ( $maybe !== false && is_array($maybe) ) return $maybe;
   513	        }
   514	        return [];
   515	    }
   516	
   517	    private function aplicar_resultado( array &$stats, $p1, $p2, $rows, $ppv=3 ) {
   518	        foreach ( [$p1,$p2] as $pid ) {
   519	            if ( ! isset($stats[$pid]) ) $stats[$pid] = ['pj'=>0,'pg'=>0,'pp'=>0,'pts'=>0,'sets_f'=>0,'sets_c'=>0,'juegos_f'=>0,'juegos_c'=>0];
   520	        }
   521	        $s1=0;$s2=0;$g1=0;$g2=0;
   522	        if ( is_array($rows) ) {
   523	            foreach ($rows as $r) {
   524	                $j1 = isset($r['juegos_equipo_1']) ? (int)$r['juegos_equipo_1'] : 0;
   525	                $j2 = isset($r['juegos_equipo_2']) ? (int)$r['juegos_equipo_2'] : 0;
   526	                if ( $j1===0 && $j2===0 ) continue;
   527	                $g1 += $j1; $g2 += $j2;
   528	                if ( $j1>$j2 ) $s1++; elseif ( $j2>$j1 ) $s2++;
   529	            }
   530	        }
   531	        if ( $s1===0 && $s2===0 ) return false;
   532	
   533	        $stats[$p1]['pj']++; $stats[$p2]['pj']++;
   534	        $stats[$p1]['sets_f'] += $s1; $stats[$p1]['sets_c'] += $s2;
   535	        $stats[$p2]['sets_f'] += $s2; $stats[$p2]['sets_c'] += $s1;
   536	        $stats[$p1]['juegos_f']+= $g1; $stats[$p1]['juegos_c']+= $g2;
   537	        $stats[$p2]['juegos_f']+= $g2; $stats[$p2]['juegos_c']+= $g1;
   538	
   539	        if ( $s1>$s2 ) { $stats[$p1]['pg']++; $stats[$p2]['pp']++; $stats[$p1]['pts'] += $ppv; }
   540	        elseif ( $s2>$s1 ) { $stats[$p2]['pg']++; $stats[$p1]['pp']++; $stats[$p2]['pts'] += $ppv; }
   541	
   542	        return true;
   543	    }
   544	
   545	    public function ordenar_items($a,$b) {
   546	        if ( $a['pts'] !== $b['pts'] ) return ($a['pts'] > $b['pts']) ? -1 : 1;
   547	        $ad = $a['dif_sets']; $bd = $b['dif_sets']; if ( $ad !== $bd ) return ($ad>$bd)?-1:1;
   548	        $aj = $a['dif_juegos']; $bj = $b['dif_juegos']; if ( $aj !== $bj ) return ($aj>$bj)?-1:1;
   549	        if ( $a['pg'] !== $b['pg'] ) return ($a['pg'] > $b['pg']) ? -1 : 1;
   550	        return 0;
   551	    }
   552	
   553	    private function pareja_en_grupo($pid, $ginfo) {
   554	        foreach ($ginfo['participantes'] as $p) { if ( (int)$p['id'] === (int)$pid ) return true; }
   555	        return false;
   556	    }
   557	
   558	    private function partidos_reemplazar_en_grupo($gid, $ph, $nuevo) {
   559	        $q = new WP_Query([
   560	            'post_type'=>'partido','post_status'=>'publish','posts_per_page'=>-1,'fields'=>'ids',
   561	            'meta_query'=>[
   562	                ['key'=>'grupo_id','value'=>$gid,'compare'=>'=']
   563	            ],
   564	        ]);
   565	        if ( ! $q->have_posts() ) return 0;
   566	        $count=0;
   567	        foreach ($q->posts as $match_id) {
   568	            $p1 = (int) get_post_meta($match_id,'pareja_1',true);
   569	            $p2 = (int) get_post_meta($match_id,'pareja_2',true);
   570	            $upd=false;
   571	            if ( $p1 === (int)$ph ) { update_post_meta($match_id,'pareja_1',(int)$nuevo); $upd=true; }
   572	            if ( $p2 === (int)$ph ) { update_post_meta($match_id,'pareja_2',(int)$nuevo); $upd=true; }
   573	            if ( $upd ) { $this->refrescar_titulo_partido($match_id); $count++; }
   574	        }
   575	        return $count;
   576	    }
   577	
   578	    private function pareja_grupo_actual($cid, $pid) {
   579	        foreach ( $this->listar_grupos_ids($cid) as $gid ) {
   580	            $ids = get_post_meta($gid,'participantes',true);
   581	            if ( ! is_array($ids) ) continue;
   582	            foreach ($ids as $x) { if ( (int)$x === (int)$pid ) return (int)$gid; }
   583	        }
   584	        return 0;
   585	    }
   586	
   587	    private function resolver_slot_posicional($slot, $cid, $prop=false) {
   588	        $slot = trim((string)$slot);
   589	        if ( $slot === '' ) return 0;
   590	        if ( ! preg_match('/^\s*(\d+)\s*º\s*(?:Grupo\s*)?([A-Z])\s*$/u', $slot, $m) ) return 0;
   591	        $pos = (int) $m[1]; $letra = strtoupper($m[2]);
   592	
   593	        $gid_obj = 0;
   594	        foreach ( $this->listar_grupos_ids($cid) as $gid ) {
   595	            $l = strtoupper( (string) get_post_meta($gid,'letra',true) );
   596	            if ( $l === $letra ) { $gid_obj = $gid; break; }
   597	        }
   598	        if ( $gid_obj <= 0 ) return 0;
   599	
   600	        // Standings de ese grupo
   601	        $std = $this->get_standings( new WP_REST_Request('GET','/saas/v1/groups/standings?competicion_id='.$cid) );
   602	        if ( $std instanceof WP_REST_Response ) {
   603	            $data = $std->get_data();
   604	            foreach ($data['grupos'] as $g) {
   605	                if ( (int)$g['grupo_id'] === (int)$gid_obj ) {
   606	                    if ( $pos >=1 && $pos <= count($g['items']) ) {
   607	                        $item = $g['items'][$pos-1];
   608	                        return !empty($item['placeholder']) ? 0 : (int)$item['pareja_id'];
   609	                    }
   610	                }
   611	            }
   612	        }
   613	        return 0;
   614	    }
   615	
   616	    private function refrescar_titulo_partido($match_id) {
   617	        $p1 = (int) get_post_meta($match_id,'pareja_1',true);
   618	        $p2 = (int) get_post_meta($match_id,'pareja_2',true);
   619	        $r  = (string) get_post_meta($match_id,'ronda',true);
   620	
   621	        $t1 = $p1 ? get_the_title($p1) : '—';
   622	        $t2 = $p2 ? get_the_title($p2) : '—';
   623	        $title = ( $r ? $r . ': ' : '' ) . $t1 . ' vs ' . $t2;
   624	
   625	        wp_update_post(['ID'=>$match_id,'post_title'=>$title]);
   626	        return true;
   627	    }
   628	
   629	}
===== END includes/features/groups_v2/rest.php =====

===== BEGIN includes/features/matches/calculo.php =====
===== END includes/features/matches/calculo.php =====

===== BEGIN includes/features/matches/index.css =====
===== END includes/features/matches/index.css =====

===== BEGIN includes/features/matches/index.js =====
===== END includes/features/matches/index.js =====

===== BEGIN includes/features/matches/index.php =====
===== END includes/features/matches/index.php =====

===== BEGIN includes/features/matches/model.php =====
     1	<?php
     2	/**
     3	 * Matches Model (skeleton)
     4	 *
     5	 * @package SaaS_Torneos_Raqueta
     6	 */
     7	
     8	if ( ! defined( 'ABSPATH' ) ) { exit; }
     9	
    10	if ( ! function_exists( 'str_matches_log' ) ) {
    11		/**
    12		 * Logger central del módulo de partidos.
    13		 */
    14		function str_matches_log( $tag, $data = null ) {
    15			$prefix = '[MATCHES:' . strtoupper( $tag ) . '] ';
    16			if ( is_array( $data ) || is_object( $data ) ) {
    17				$data = wp_json_encode( $data );
    18			}
    19			@error_log( $prefix . ( $data ?? '' ) );
    20		}
    21	}
    22	
    23	/**
    24	 * Normaliza un partido a la forma “UI-friendly”.
    25	 * Por ahora devuelve un mock estable para probar el contrato REST.
    26	 *
    27	 * @param int   $post_id
    28	 * @param array $meta_overrides (opcional) para forzar valores en tests.
    29	 * @return array
    30	 */
    31	function str_matches_normalize_match( $post_id, $meta_overrides = array() ) {
    32		$now_iso = gmdate( 'c' );
    33	
    34		$mock = array(
    35			'id'                   => (int) $post_id,
    36			'competicion_id'       => (int) ( $meta_overrides['competicion_id'] ?? 0 ),
    37			'fase'                 => (string) ( $meta_overrides['fase'] ?? 'grupos' ),
    38			'grupo_id'             => isset( $meta_overrides['grupo_id'] ) ? (int) $meta_overrides['grupo_id'] : null,
    39			'pareja_a_id'          => (int) ( $meta_overrides['pareja_a_id'] ?? 0 ),
    40			'pareja_b_id'          => (int) ( $meta_overrides['pareja_b_id'] ?? 0 ),
    41			'pareja_a_nombre'      => (string) ( $meta_overrides['pareja_a_nombre'] ?? 'Pareja A' ),
    42			'pareja_b_nombre'      => (string) ( $meta_overrides['pareja_b_nombre'] ?? 'Pareja B' ),
    43			'fecha'                => (string) ( $meta_overrides['fecha'] ?? '' ),
    44			'hora'                 => (string) ( $meta_overrides['hora'] ?? '' ),
    45			'pista'                => isset( $meta_overrides['pista'] ) ? (string) $meta_overrides['pista'] : null,
    46			'estado'               => (string) ( $meta_overrides['estado'] ?? 'programado' ),
    47			'sets'                 => (array)  ( $meta_overrides['sets'] ?? array() ),
    48			'ganador_pareja_id'    => isset( $meta_overrides['ganador_pareja_id'] ) ? (int) $meta_overrides['ganador_pareja_id'] : null,
    49			'resultado_confirmado' => (bool)   ( $meta_overrides['resultado_confirmado'] ?? false ),
    50			'resumen'              => 'Pareja A vs Pareja B — ' . ( $meta_overrides['fecha'] ?? 'TBD' ) . ' ' . ( $meta_overrides['hora'] ?? '' ),
    51			'created_at'           => $now_iso,
    52			'updated_at'           => $now_iso,
    53		);
    54	
    55		return $mock;
    56	}
    57	
    58	/**
    59	 * Verifica permisos mínimos por rol/ownership.
    60	 * Skeleton: admin siempre OK; resto: lectura pública y escritura denegada (se ampliará en FASE A.3).
    61	 *
    62	 * @param WP_User $user
    63	 * @param string  $scope 'read'|'write'
    64	 * @param int     $competicion_id
    65	 * @return bool
    66	 */
    67	function str_matches_user_can( $user, $scope, $competicion_id = 0 ) {
    68		if ( user_can( $user, 'manage_options' ) ) {
    69			return true; // Admin total
    70		}
    71		// TODO: organizador (owner de la competición) y jugadores implicados (FASE A.3).
    72		if ( 'read' === $scope ) {
    73			return true;
    74		}
    75		return false;
    76	}
    77	
    78	/**
    79	 * Validación básica del payload de creación/edición (skeleton).
    80	 * Devuelve array( 'ok' => bool, 'error' => array|null ).
    81	 */
    82	function str_matches_validate_payload( $data, $context = 'create' ) {
    83		$required = array( 'competicion_id', 'fase', 'pareja_a_id', 'pareja_b_id' );
    84		if ( 'grupos' === ( $data['fase'] ?? '' ) ) {
    85			$required[] = 'grupo_id';
    86		}
    87		foreach ( $required as $key ) {
    88			if ( empty( $data[ $key ] ) && 0 !== $data[ $key ] ) {
    89				return array(
    90					'ok'    => false,
    91					'error' => array( 'code' => 'missing_' . $key, 'message' => 'Falta ' . $key, 'status' => 400 ),
    92				);
    93			}
    94		}
    95		// TODO: pertenencia (parejas/grupo/competición), duplicados, etc.
    96		return array( 'ok' => true, 'error' => null );
    97	}
===== END includes/features/matches/model.php =====

===== BEGIN includes/features/matches/rest.php =====
     1	<?php
     2	/**
     3	 * Matches REST API (skeleton)
     4	 *
     5	 * @package SaaS_Torneos_Raqueta
     6	 */
     7	
     8	if ( ! defined( 'ABSPATH' ) ) { exit; }
     9	
    10	require_once __DIR__ . '/model.php';
    11	
    12	add_action( 'rest_api_init', function () {
    13	
    14		$ns = 'saas/v1';
    15	
    16		/**
    17		 * GET /matches
    18		 */
    19		register_rest_route( $ns, '/matches', array(
    20			'methods'             => WP_REST_Server::READABLE,
    21			'permission_callback' => function( $request ) {
    22				$user = wp_get_current_user();
    23				$cid  = (int) $request->get_param( 'competicion_id' );
    24				$ok   = str_matches_user_can( $user, 'read', $cid );
    25				if ( ! $ok ) {
    26					return new WP_Error( 'forbidden', 'No autorizado para ver estos partidos', array( 'status' => 403 ) );
    27				}
    28				return true;
    29			},
    30			'callback'            => function( WP_REST_Request $request ) {
    31				$params = $request->get_params();
    32				str_matches_log( 'API', array( 'op' => 'GET /matches', 'params' => $params ) );
    33	
    34				$page     = max( 1, (int) ( $params['page'] ?? 1 ) );
    35				$per_page = min( 200, max( 1, (int) ( $params['per_page'] ?? 50 ) ) );
    36	
    37				// Skeleton: lista vacía con paginación
    38				$response = array(
    39					'items'      => array(),
    40					'pagination' => array(
    41						'page'     => $page,
    42						'per_page' => $per_page,
    43						'total'    => 0,
    44					),
    45				);
    46	
    47				return rest_ensure_response( $response );
    48			},
    49		) );
    50	
    51		/**
    52		 * POST /matches
    53		 */
    54		register_rest_route( $ns, '/matches', array(
    55			'methods'             => WP_REST_Server::CREATABLE,
    56			'permission_callback' => function( $request ) {
    57				$user = wp_get_current_user();
    58				$cid  = (int) $request->get_param( 'competicion_id' );
    59				$ok   = str_matches_user_can( $user, 'write', $cid );
    60				if ( ! $ok ) {
    61					return new WP_Error( 'forbidden', 'No autorizado para crear partidos', array( 'status' => 403 ) );
    62				}
    63				return true;
    64			},
    65			'callback'            => function( WP_REST_Request $request ) {
    66				$body = $request->get_json_params();
    67				str_matches_log( 'API', array( 'op' => 'POST /matches', 'body' => $body ) );
    68	
    69				$val = str_matches_validate_payload( $body, 'create' );
    70				if ( ! $val['ok'] ) {
    71					return new WP_Error( $val['error']['code'], $val['error']['message'], array( 'status' => $val['error']['status'] ) );
    72				}
    73	
    74				// Skeleton: no insertamos aún; devolvemos mock normalizado.
    75				$mock = str_matches_normalize_match( rand( 1000, 9999 ), $body );
    76				return new WP_REST_Response( $mock, 201 );
    77			},
    78		) );
    79	
    80		/**
    81		 * PATCH /matches/{id}
    82		 */
    83		register_rest_route( $ns, '/matches/(?P<id>\d+)', array(
    84			'methods'             => WP_REST_Server::EDITABLE,
    85			'permission_callback' => function( $request ) {
    86				$user = wp_get_current_user();
    87				// En skeleton no resolvemos el match real; tomamos competicion_id si viene en body para permisos.
    88				$body = $request->get_json_params();
    89				$cid  = (int) ( $body['competicion_id'] ?? 0 );
    90				$ok   = str_matches_user_can( $user, 'write', $cid );
    91				if ( ! $ok ) {
    92					return new WP_Error( 'forbidden', 'No autorizado para editar partidos', array( 'status' => 403 ) );
    93				}
    94				return true;
    95			},
    96			'callback'            => function( WP_REST_Request $request ) {
    97				$id   = (int) $request['id'];
    98				$body = $request->get_json_params();
    99				str_matches_log( 'API', array( 'op' => 'PATCH /matches/{id}', 'id' => $id, 'body' => $body ) );
   100	
   101				// Skeleton: validación superficial
   102				$mock = str_matches_normalize_match( $id, $body );
   103				return rest_ensure_response( $mock );
   104			},
   105		) );
   106	
   107		/**
   108		 * PATCH /matches/{id}/result
   109		 */
   110		register_rest_route( $ns, '/matches/(?P<id>\d+)/result', array(
   111			'methods'             => WP_REST_Server::EDITABLE,
   112			'permission_callback' => function( $request ) {
   113				$user = wp_get_current_user();
   114				$body = $request->get_json_params();
   115				$cid  = (int) ( $body['competicion_id'] ?? 0 );
   116				$ok   = str_matches_user_can( $user, 'write', $cid ); // en FASE C afinaremos (jugadores implicados)
   117				if ( ! $ok ) {
   118					return new WP_Error( 'forbidden', 'No autorizado para reportar resultados', array( 'status' => 403 ) );
   119				}
   120				return true;
   121			},
   122			'callback'            => function( WP_REST_Request $request ) {
   123				$id   = (int) $request['id'];
   124				$body = $request->get_json_params();
   125				str_matches_log( 'API', array( 'op' => 'PATCH /matches/{id}/result', 'id' => $id, 'body' => $body ) );
   126	
   127				// Skeleton: marcamos estado mock “pendiente_confirmacion”.
   128				$body['estado']               = 'pendiente_confirmacion';
   129				$body['resultado_confirmado'] = false;
   130	
   131				$mock = str_matches_normalize_match( $id, $body );
   132				return rest_ensure_response( $mock );
   133			},
   134		) );
   135	
   136		/**
   137		 * POST /matches/{id}/confirm
   138		 */
   139		register_rest_route( $ns, '/matches/(?P<id>\d+)/confirm', array(
   140			'methods'             => WP_REST_Server::CREATABLE,
   141			'permission_callback' => function( $request ) {
   142				$user = wp_get_current_user();
   143				$cid  = (int) $request->get_param( 'competicion_id' ); // puede llegar por query o body
   144				if ( ! $cid ) {
   145					$body = $request->get_json_params();
   146					$cid  = (int) ( $body['competicion_id'] ?? 0 );
   147				}
   148				$ok = str_matches_user_can( $user, 'write', $cid ); // en FASE C afinaremos (oponente/organizador/admin)
   149				if ( ! $ok ) {
   150					return new WP_Error( 'forbidden', 'No autorizado para confirmar resultados', array( 'status' => 403 ) );
   151				}
   152				return true;
   153			},
   154			'callback'            => function( WP_REST_Request $request ) {
   155				$id     = (int) $request['id'];
   156				$params = $request->get_params();
   157				str_matches_log( 'API', array( 'op' => 'POST /matches/{id}/confirm', 'id' => $id, 'params' => $params ) );
   158	
   159				// Skeleton: devolvemos estado confirmado y flag de recálculo de standings.
   160				$mock = str_matches_normalize_match( $id, array(
   161					'estado'               => 'confirmado',
   162					'resultado_confirmado' => true,
   163				) );
   164	
   165				$mock['_side_effects'] = array(
   166					'standings' => 'recalculate_requested',
   167				);
   168	
   169				return rest_ensure_response( $mock );
   170			},
   171		) );
   172	
   173		/**
   174		 * DELETE /matches/{id}
   175		 */
   176		register_rest_route( $ns, '/matches/(?P<id>\d+)', array(
   177			'methods'             => WP_REST_Server::DELETABLE,
   178			'permission_callback' => function( $request ) {
   179				$user = wp_get_current_user();
   180				$cid  = (int) $request->get_param( 'competicion_id' );
   181				$ok   = str_matches_user_can( $user, 'write', $cid );
   182				if ( ! $ok ) {
   183					return new WP_Error( 'forbidden', 'No autorizado para eliminar partidos', array( 'status' => 403 ) );
   184				}
   185				return true;
   186			},
   187			'callback'            => function( WP_REST_Request $request ) {
   188				$id     = (int) $request['id'];
   189				$params = $request->get_params();
   190				str_matches_log( 'API', array( 'op' => 'DELETE /matches/{id}', 'id' => $id, 'params' => $params ) );
   191	
   192				// Skeleton: no eliminamos aún; reportamos resultado mock.
   193				return rest_ensure_response( array(
   194					'deleted'        => false,
   195					'id'             => $id,
   196					'note'           => 'Skeleton: eliminación sin efectos (FASE B/C implementará persistencia).',
   197					'_side_effects'  => array( 'standings' => 'invalidate_if_confirmed' ),
   198				) );
   199			},
   200		) );
   201	
   202	} );
===== END includes/features/matches/rest.php =====

===== BEGIN includes/features/pairs/ajax/buscar-jugadores.php =====
     1	<?php
     2	// antiguo includes/ajax/ajax-buscar-jugadores.php
     3	
     4	add_action('wp_ajax_str_buscar_jugadores', 'str_ajax_buscar_jugadores');
     5	function str_ajax_buscar_jugadores() {
     6	    // Seguridad
     7	    check_ajax_referer('str_parejas_multiseleccion_nonce', 'nonce');
     8	
     9	    $torneo_id = intval($_POST['torneo_id']);
    10	    $nombre    = sanitize_text_field($_POST['nombre'] ?? '');
    11	    $apellido  = sanitize_text_field($_POST['apellido'] ?? '');
    12	    $email     = sanitize_text_field($_POST['email'] ?? '');
    13	
    14	    // --- LOG DATOS RECIBIDOS ---
    15	    if (function_exists('str_escribir_log')) str_escribir_log("[AJAX buscar_jugadores] INICIO", 'AJAX');
    16	    if (function_exists('str_escribir_log')) str_escribir_log("POST: " . print_r($_POST, true), 'AJAX');
    17	
    18	    // 1. Construcción de la query principal de jugadores del torneo
    19	    $args = array(
    20	        'post_type'      => 'jugador_deportes',
    21	        'posts_per_page' => -1,
    22	        'post_status'    => 'publish',
    23	        'meta_query'     => array(
    24	            'relation' => 'AND',
    25	            array(
    26	                'key'     => 'torneos_asociados',
    27	                'value'   => '"' . $torneo_id . '"',
    28	                'compare' => 'LIKE'
    29	            )
    30	        ),
    31	    );
    32	    if ($nombre) {
    33	        $args['meta_query'][] = array(
    34	            'key'     => 'nombre',
    35	            'value'   => $nombre,
    36	            'compare' => 'LIKE'
    37	        );
    38	    }
    39	    if ($apellido) {
    40	        $args['meta_query'][] = array(
    41	            'key'     => 'apellido',
    42	            'value'   => $apellido,
    43	            'compare' => 'LIKE'
    44	        );
    45	    }
    46	    if ($email) {
    47	        $args['meta_query'][] = array(
    48	            'key'     => 'email',
    49	            'value'   => $email,
    50	            'compare' => 'LIKE'
    51	        );
    52	    }
    53	    if (function_exists('str_escribir_log')) str_escribir_log("ARGS JUGADORES: " . print_r($args, true), 'AJAX');
    54	
    55	    // 2. Recopilar IDs de jugadores ya emparejados en este torneo
    56	    $jugadores_ocupados = array();
    57	    $parejas_args = array(
    58	        'post_type'      => 'pareja',
    59	        'posts_per_page' => -1,
    60	        'post_status'    => 'publish',
    61	        'meta_query'     => array(
    62	            array(
    63	                'key'     => 'torneo_asociado',
    64	                'value'   => '"' . $torneo_id . '"',
    65	                'compare' => 'LIKE'
    66	            )
    67	        ),
    68	    );
    69	    $parejas = get_posts($parejas_args);
    70	
    71	    if (function_exists('str_escribir_log')) str_escribir_log("[AJAX buscar_jugadores] Parejas encontradas: " . count($parejas), 'AJAX');
    72	
    73	    foreach ($parejas as $pareja) {
    74	        $titulo_pareja = $pareja->post_title;
    75	        $pareja_id = $pareja->ID;
    76	
    77	        // --- LOG valores raw ACF de la pareja
    78	        $j1_raw = get_field('jugador_1', $pareja_id);
    79	        $j2_raw = get_field('jugador_2', $pareja_id);
    80	        $torneo_raw = get_field('torneo_asociado', $pareja_id);
    81	
    82	        if (function_exists('str_escribir_log')) {
    83	            str_escribir_log("PAREJA: ID=$pareja_id, TITULO=$titulo_pareja", 'AJAX');
    84	            str_escribir_log("jugador_1 (raw): " . print_r($j1_raw, true), 'AJAX');
    85	            str_escribir_log("jugador_2 (raw): " . print_r($j2_raw, true), 'AJAX');
    86	            str_escribir_log("torneo_asociado (raw): " . print_r($torneo_raw, true), 'AJAX');
    87	        }
    88	
    89	        // Normalizar jugador_1 y jugador_2 (soportar ID simple, array de IDs, array de objetos, objeto WP_Post, array de WP_Post)
    90	        foreach (['jugador_1' => $j1_raw, 'jugador_2' => $j2_raw] as $campo => $val) {
    91	            if (empty($val)) continue;
    92	            if (is_array($val)) {
    93	                foreach ($val as $item) {
    94	                    if (is_numeric($item)) {
    95	                        $jugadores_ocupados[] = intval($item);
    96	                    } elseif (is_object($item) && isset($item->ID)) {
    97	                        $jugadores_ocupados[] = intval($item->ID);
    98	                    } elseif (is_array($item) && isset($item['ID'])) {
    99	                        $jugadores_ocupados[] = intval($item['ID']);
   100	                    }
   101	                }
   102	            } elseif (is_numeric($val)) {
   103	                $jugadores_ocupados[] = intval($val);
   104	            } elseif (is_object($val) && isset($val->ID)) {
   105	                $jugadores_ocupados[] = intval($val->ID);
   106	            }
   107	        }
   108	    }
   109	
   110	    // Limpiar duplicados y valores vacíos
   111	    $jugadores_ocupados = array_unique(array_filter($jugadores_ocupados));
   112	    if (function_exists('str_escribir_log')) str_escribir_log("JUGADORES OCUPADOS FINAL (IDs): " . print_r($jugadores_ocupados, true), 'AJAX');
   113	
   114	    // 3. Query principal de jugadores
   115	    $jugadores_query = new WP_Query($args);
   116	    $jugadores = array();
   117	
   118	    if (function_exists('str_escribir_log')) str_escribir_log("Nº jugadores encontrados: " . $jugadores_query->found_posts, 'AJAX');
   119	
   120	    if ($jugadores_query->have_posts()) {
   121	        while ($jugadores_query->have_posts()) {
   122	            $jugadores_query->the_post();
   123	            $id = get_the_ID();
   124	            $nombre = get_field('nombre');
   125	            $apellido = get_field('apellido');
   126	            $email = get_field('email');
   127	
   128	            if (in_array($id, $jugadores_ocupados)) {
   129	                if (function_exists('str_escribir_log')) {
   130	                    str_escribir_log("EXCLUIDO por estar ocupado: $id - $nombre $apellido", 'AJAX');
   131	                }
   132	                continue;
   133	            }
   134	            $jugadores[] = array(
   135	                'ID'      => $id,
   136	                'nombre'  => $nombre,
   137	                'apellido'=> $apellido,
   138	                'email'   => $email
   139	            );
   140	        }
   141	        wp_reset_postdata();
   142	    }
   143	
   144	    if (function_exists('str_escribir_log')) {
   145	        str_escribir_log("JUGADORES DISPONIBLES PARA FRONTEND: " . print_r($jugadores, true), 'AJAX');
   146	    }
   147	
   148	    wp_send_json_success(array(
   149	        'jugadores' => $jugadores
   150	    ));
   151	}
===== END includes/features/pairs/ajax/buscar-jugadores.php =====

===== BEGIN includes/features/pairs/ajax/guardar-pareja.php =====
     1	<?php
     2	/**
     3	 * Ruta: wp-content/plugins/saas-torneos-de-raqueta/includes/features/pairs/ajax/guardar-pareja.php
     4	 * Endpoint: guardar pareja (multiselección)
     5	 *
     6	 * Frontend esperado:
     7	 *   action: 'str_guardar_pareja_multiseleccion'  (o alias 'saas_guardar_pareja_multiseleccion')
     8	 *   nonce:  wp_create_nonce('str_parejas_multiseleccion_nonce')  // mismo que LISTAR / BUSCAR
     9	 *   torneo_id, jugador_1, jugador_2
    10	 */
    11	
    12	defined('ABSPATH') || exit;
    13	
    14	/** Logger simple (usa el global si existe) */
    15	if (!function_exists('str_pairs_log')) {
    16	    function str_pairs_log($mensaje, $tag = 'PAIRS:GUARDAR') {
    17	        $line = '[' . date('Y-m-d H:i:s') . "] [$tag] ";
    18	        if (!is_string($mensaje)) $mensaje = print_r($mensaje, true);
    19	        $line .= $mensaje . PHP_EOL;
    20	
    21	        if (function_exists('str_escribir_log')) {
    22	            str_escribir_log($line, $tag);
    23	            return;
    24	        }
    25	        $base = defined('STR_PLUGIN_PATH') ? STR_PLUGIN_PATH : plugin_dir_path(__FILE__);
    26	        @file_put_contents(trailingslashit($base) . 'debug-saas-torneos.log', $line, FILE_APPEND | LOCK_EX);
    27	    }
    28	}
    29	
    30	/** Hooks AJAX (acción principal + alias legacy) */
    31	add_action('wp_ajax_str_guardar_pareja_multiseleccion', 'str_guardar_pareja_multiseleccion');
    32	add_action('wp_ajax_saas_guardar_pareja_multiseleccion', 'str_guardar_pareja_multiseleccion'); // alias por si el front aún manda 'saas_*'
    33	// Nota: NO exponemos nopriv para guardar.
    34	
    35	/** Handler principal */
    36	function str_guardar_pareja_multiseleccion() {
    37	    $t0     = microtime(true);
    38	    $req_id = function_exists('wp_generate_uuid4') ? wp_generate_uuid4() : uniqid('req_', true);
    39	
    40	    // Evitar cualquier salida antes del JSON
    41	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
    42	    @ob_start();
    43	
    44	    // ─────────────────────────────────────────────────────────────────────
    45	    // 1) Seguridad: aceptar el MISMO nonce que LISTAR/BUSCAR
    46	    //    (primario) 'str_parejas_multiseleccion_nonce'
    47	    //    (fallback temporal) 'str_nonce'
    48	    // ─────────────────────────────────────────────────────────────────────
    49	    $nonce = isset($_POST['nonce']) ? sanitize_text_field($_POST['nonce'])
    50	           : (isset($_POST['_ajax_nonce']) ? sanitize_text_field($_POST['_ajax_nonce']) : '');
    51	
    52	    $nonce_ok = false;
    53	    if ($nonce) {
    54	        if (wp_verify_nonce($nonce, 'str_parejas_multiseleccion_nonce')) {
    55	            $nonce_ok = true;
    56	        } elseif (wp_verify_nonce($nonce, 'str_nonce')) {
    57	            // Fallback temporal por compatibilidad
    58	            $nonce_ok = true;
    59	        }
    60	    }
    61	    if (!$nonce_ok) {
    62	        str_pairs_log("[DENY] Nonce inválido o ausente | req_id={$req_id}");
    63	        return _str_pairs_json_error(['msg' => 'Nonce inválido.']);
    64	    }
    65	
    66	    if (!is_user_logged_in() || (!current_user_can('administrator') && !current_user_can('cliente'))) {
    67	        str_pairs_log("[DENY] Permisos insuficientes | req_id={$req_id}");
    68	        return _str_pairs_json_error(['msg' => 'Permisos insuficientes.']);
    69	    }
    70	
    71	    // ─────────────────────────────────────────────────────────────────────
    72	    // 2) Datos
    73	    // ─────────────────────────────────────────────────────────────────────
    74	    $torneo_id = isset($_POST['torneo_id']) ? intval($_POST['torneo_id']) : 0;
    75	    $jugador_1 = isset($_POST['jugador_1']) ? intval($_POST['jugador_1']) : 0;
    76	    $jugador_2 = isset($_POST['jugador_2']) ? intval($_POST['jugador_2']) : 0;
    77	
    78	    str_pairs_log("[START] POST=" . print_r($_POST, true) . " | req_id={$req_id}");
    79	
    80	    if ($torneo_id <= 0 || $jugador_1 <= 0 || $jugador_2 <= 0) {
    81	        str_pairs_log("[ERROR] Datos incompletos | req_id={$req_id}");
    82	        return _str_pairs_json_error(['msg' => 'Datos incompletos.']);
    83	    }
    84	
    85	    if ($jugador_1 === $jugador_2) {
    86	        str_pairs_log("[ERROR] Jugadores idénticos | req_id={$req_id}");
    87	        return _str_pairs_json_error(['msg' => 'Debes elegir dos jugadores distintos.']);
    88	    }
    89	
    90	    // ─────────────────────────────────────────────────────────────────────
    91	    // 3) Evitar duplicados dentro del mismo torneo
    92	    //    (ACF guarda arrays/serializado → LIKE con comillas)
    93	    // ─────────────────────────────────────────────────────────────────────
    94	    $duplicada = new WP_Query([
    95	        'post_type'      => 'pareja',
    96	        'post_status'    => 'publish',
    97	        'posts_per_page' => 1,
    98	        'fields'         => 'ids',
    99	        'meta_query'     => [
   100	            'relation' => 'AND',
   101	            [
   102	                'key'     => 'torneo_asociado',
   103	                'value'   => '"' . $torneo_id . '"',
   104	                'compare' => 'LIKE',
   105	            ],
   106	            [
   107	                'key'     => 'jugador_1',
   108	                'value'   => '"' . $jugador_1 . '"',
   109	                'compare' => 'LIKE',
   110	            ],
   111	            [
   112	                'key'     => 'jugador_2',
   113	                'value'   => '"' . $jugador_2 . '"',
   114	                'compare' => 'LIKE',
   115	            ],
   116	        ],
   117	    ]);
   118	
   119	    if ($duplicada && $duplicada->have_posts()) {
   120	        str_pairs_log("[DENY] Duplicada detectada | torneo={$torneo_id} | j1={$jugador_1} | j2={$jugador_2} | req_id={$req_id}");
   121	        return _str_pairs_json_error(['msg' => 'Esta pareja ya está registrada en el torneo.']);
   122	    }
   123	
   124	    // ─────────────────────────────────────────────────────────────────────
   125	    // 4) Crear post 'pareja'
   126	    // ─────────────────────────────────────────────────────────────────────
   127	    $nombre_1      = get_the_title($jugador_1);
   128	    $nombre_2      = get_the_title($jugador_2);
   129	    $titulo_pareja = trim(($nombre_1 ?: 'Jugador 1') . ' + ' . ($nombre_2 ?: 'Jugador 2'));
   130	
   131	    $post_id = wp_insert_post([
   132	        'post_type'   => 'pareja',
   133	        'post_status' => 'publish',
   134	        'post_title'  => $titulo_pareja ?: 'Pareja',
   135	        'post_author' => get_current_user_id(),
   136	    ], true);
   137	
   138	    if (is_wp_error($post_id) || !$post_id) {
   139	        $err = is_wp_error($post_id) ? $post_id->get_error_message() : 'ID=0';
   140	        str_pairs_log("[ERROR] Fallo creando post pareja: {$err} | req_id={$req_id}");
   141	        return _str_pairs_json_error(['msg' => 'No se pudo crear la pareja.']);
   142	    }
   143	
   144	    // ─────────────────────────────────────────────────────────────────────
   145	    // 5) Guardar ACF (o meta) con el MISMO esquema que LISTAR/BUSCAR
   146	    // ─────────────────────────────────────────────────────────────────────
   147	    if (function_exists('update_field')) {
   148	        update_field('jugador_1',      [$jugador_1], $post_id);
   149	        update_field('jugador_2',      [$jugador_2], $post_id);
   150	        update_field('torneo_asociado',[$torneo_id], $post_id);
   151	    } else {
   152	        update_post_meta($post_id, 'jugador_1',       [$jugador_1]);
   153	        update_post_meta($post_id, 'jugador_2',       [$jugador_2]);
   154	        update_post_meta($post_id, 'torneo_asociado', [$torneo_id]);
   155	    }
   156	
   157	    // ─────────────────────────────────────────────────────────────────────
   158	    // 6) OK
   159	    // ─────────────────────────────────────────────────────────────────────
   160	    $dur = round((microtime(true) - $t0) * 1000);
   161	    str_pairs_log("[END] OK | post_id={$post_id} | torneo={$torneo_id} | j1={$jugador_1} | j2={$jugador_2} | dur_ms={$dur} | req_id={$req_id}");
   162	
   163	    return _str_pairs_json_ok([
   164	        'msg'        => 'Pareja guardada correctamente',
   165	        'post_id'    => $post_id,
   166	        'jugador_1'  => $jugador_1,
   167	        'jugador_2'  => $jugador_2,
   168	        'torneo_id'  => $torneo_id,
   169	        'titulo'     => $titulo_pareja,
   170	    ]);
   171	}
   172	
   173	/** Helpers JSON (limpian buffers antes de responder) */
   174	function _str_pairs_json_ok(array $payload) {
   175	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
   176	    wp_send_json_success($payload);
   177	}
   178	function _str_pairs_json_error(array $payload) {
   179	    if (function_exists('ob_get_length') && ob_get_length()) { @ob_end_clean(); }
   180	    wp_send_json_error($payload, 400);
   181	}
===== END includes/features/pairs/ajax/guardar-pareja.php =====

===== BEGIN includes/features/pairs/ajax/listar-parejas.php =====
     1	<?php
     2	// Antiguo /includes/ajax/ajax-listar-parejas-multiseleccion.php
     3	// ===========================
     4	// AJAX: Listar parejas confirmadas (multiselección)
     5	// ===========================
     6	
     7	if (!defined('ABSPATH')) { exit; }
     8	
     9	/** Logger central (opcional) */
    10	if (!function_exists('str_saas_log')) {
    11	    function str_saas_log($message, $context = []) {
    12	        $payload = is_string($message) ? $message : wp_json_encode($message, JSON_UNESCAPED_UNICODE);
    13	        if (!empty($context)) { $payload .= ' | ' . wp_json_encode($context, JSON_UNESCAPED_UNICODE); }
    14	        if (function_exists('str_escribir_log')) {
    15	            str_escribir_log($payload, 'PAIRS:LISTAR');
    16	            return;
    17	        }
    18	        $log_path = (defined('STR_PLUGIN_PATH') ? STR_PLUGIN_PATH : plugin_dir_path(__FILE__));
    19	        $log_file = trailingslashit($log_path) . 'debug-saas-torneos.log';
    20	        $line = '[' . date('Y-m-d H:i:s') . '] [PAIRS:LISTAR] ' . $payload . PHP_EOL;
    21	        @file_put_contents($log_file, $line, FILE_APPEND | LOCK_EX);
    22	    }
    23	}
    24	
    25	add_action('wp_ajax_str_listar_parejas_multiseleccion', 'str_ajax_listar_parejas_multiseleccion');
    26	add_action('wp_ajax_nopriv_str_listar_parejas_multiseleccion', 'str_ajax_listar_parejas_multiseleccion');
    27	
    28	function str_ajax_listar_parejas_multiseleccion() {
    29	    $t0 = microtime(true);
    30	    $req_id = function_exists('wp_generate_uuid4') ? wp_generate_uuid4() : uniqid('req_', true);
    31	
    32	    // Nota: este endpoint históricamente permite nopriv; se mantiene tal cual.
    33	    try {
    34	        check_ajax_referer('str_parejas_multiseleccion_nonce', 'nonce');
    35	    } catch (Throwable $e) {
    36	        str_saas_log('[DENY] Nonce inválido', ['req_id'=>$req_id, 'err'=>$e->getMessage()]);
    37	        wp_send_json_error(['message' => 'Nonce inválido.']);
    38	    }
    39	
    40	    $torneo_id = isset($_POST['torneo_id']) ? intval($_POST['torneo_id']) : 0;
    41	    $resultado = array();
    42	
    43	    str_saas_log('[START] Listar parejas', ['req_id'=>$req_id, 'torneo_id'=>$torneo_id]);
    44	
    45	    // Obtener TODAS las parejas publicadas
    46	    $parejas_args = array(
    47	        'post_type'      => 'pareja',
    48	        'posts_per_page' => -1,
    49	        'post_status'    => 'publish'
    50	    );
    51	    $parejas = get_posts($parejas_args);
    52	
    53	    foreach ($parejas as $pareja) {
    54	        // 1. Leer campo 'torneo_asociado'
    55	        $torneo_asociado = get_field('torneo_asociado', $pareja->ID);
    56	
    57	        // Normalizar: Puede ser ID, array de IDs, objeto WP_Post o array de WP_Post
    58	        $torneos_ids = array();
    59	
    60	        if (empty($torneo_asociado)) continue;
    61	
    62	        if (is_array($torneo_asociado)) {
    63	            foreach ($torneo_asociado as $item) {
    64	                if (is_object($item) && isset($item->ID)) {
    65	                    $torneos_ids[] = intval($item->ID);
    66	                } else {
    67	                    $torneos_ids[] = intval($item);
    68	                }
    69	            }
    70	        } elseif (is_object($torneo_asociado) && isset($torneo_asociado->ID)) {
    71	            $torneos_ids[] = intval($torneo_asociado->ID);
    72	        } else {
    73	            $torneos_ids[] = intval($torneo_asociado);
    74	        }
    75	
    76	        // Si esta pareja NO está asociada a este torneo, saltar
    77	        if (!in_array($torneo_id, $torneos_ids)) continue;
    78	
    79	        // 2. Jugador 1 y 2 (normalizar: ID, array, objeto)
    80	        $j1 = get_field('jugador_1', $pareja->ID);
    81	        $j2 = get_field('jugador_2', $pareja->ID);
    82	
    83	        $j1_id = null;
    84	        $j2_id = null;
    85	
    86	        if (is_array($j1)) {
    87	            $j1_id = is_object($j1[0]) && isset($j1[0]->ID) ? $j1[0]->ID : $j1[0];
    88	        } elseif (is_object($j1) && isset($j1->ID)) {
    89	            $j1_id = $j1->ID;
    90	        } else {
    91	            $j1_id = $j1;
    92	        }
    93	
    94	        if (is_array($j2)) {
    95	            $j2_id = is_object($j2[0]) && isset($j2[0]->ID) ? $j2[0]->ID : $j2[0];
    96	        } elseif (is_object($j2) && isset($j2->ID)) {
    97	            $j2_id = $j2->ID;
    98	        } else {
    99	            $j2_id = $j2;
   100	        }
   101	
   102	        // 3. Recoger nombre y apellido de cada jugador
   103	        $nombre_1 = $j1_id ? get_field('nombre', $j1_id) : '';
   104	        $apellido_1 = $j1_id ? get_field('apellido', $j1_id) : '';
   105	        $nombre_2 = $j2_id ? get_field('nombre', $j2_id) : '';
   106	        $apellido_2 = $j2_id ? get_field('apellido', $j2_id) : '';
   107	
   108	        $resultado[] = array(
   109	            'jugador_1_nombre' => trim($nombre_1 . ' ' . $apellido_1),
   110	            'jugador_2_nombre' => trim($nombre_2 . ' ' . $apellido_2),
   111	        );
   112	    }
   113	
   114	    str_saas_log('[END] Listado parejas OK', [
   115	        'req_id'=>$req_id,
   116	        'torneo_id'=>$torneo_id,
   117	        'total'=>count($resultado),
   118	        'dur_ms'=>round((microtime(true)-$t0)*1000)
   119	    ]);
   120	
   121	    wp_send_json_success(array('parejas' => $resultado));
   122	}
===== END includes/features/pairs/ajax/listar-parejas.php =====

===== BEGIN includes/features/pairs/index.css =====
     1	/* ======================================================================
     2	   PAREJAS · Modal multiselección + ficha
     3	   - Mantiene colores actuales (azul primario)
     4	   - Mejora jerarquía, espaciado y legibilidad
     5	   - Sin tocar HTML/JS existentes
     6	   ====================================================================== */
     7	
     8	/* ===== Variables (fallbacks si el tema no tiene) ===================== */
     9	:root{
    10	  --str-primary: #2152ff;        /* azul primario */
    11	  --str-primary-600: #1e46e6;
    12	  --str-neutral-50: #f8fafc;
    13	  --str-neutral-75: #f5f7fb;
    14	  --str-neutral-100: #eef3fb;
    15	  --str-neutral-200: #e6ebf5;
    16	  --str-neutral-300: #d9e2ef;
    17	  --str-neutral-500: #667085;
    18	  --str-text: #1a1f36;
    19	  --str-muted: #6b7280;
    20	  --str-success: #10b981;
    21	  --str-error: #ef4444;
    22	  --str-radius-lg: 16px;
    23	  --str-radius-md: 10px;
    24	  --str-radius-sm: 8px;
    25	}
    26	
    27	/* ===== Bloquear scroll cuando hay modal ============================== */
    28	html.saas-tr-modal-open,
    29	body.saas-tr-modal-open { overflow: hidden !important; }
    30	
    31	/* ===== Overlay del modal ============================================ */
    32	.saas-tr-modal{
    33	  position: fixed; inset: 0;
    34	  display: none;                 /* cerrado por defecto */
    35	  place-items: center;
    36	  padding: clamp(12px, 3vw, 24px);
    37	  background: rgba(17, 24, 39, .60);
    38	  z-index: 999999;
    39	  pointer-events: auto;
    40	}
    41	.saas-tr-modal.is-open{ display: grid; }
    42	
    43	/* ===== Diálogo ======================================================= */
    44	.saas-tr-modal__dialog,
    45	.saas-tr-modal_dialog{
    46	  position: relative;
    47	  width: min(1000px, 96vw);
    48	  max-height: 92vh;
    49	  overflow: auto;
    50	  background: #fff;
    51	  border-radius: var(--str-radius-lg);
    52	  box-shadow: 0 18px 48px rgba(22, 28, 45, .25);
    53	  padding: 22px 24px;
    54	  color: var(--str-text);
    55	}
    56	
    57	/* ===== Botón cerrar ================================================== */
    58	.saas-tr-modal__close,
    59	.saas-tr-modal_close,
    60	#modal-parejas-multiseleccion .js-close-modal{
    61	  position: absolute; top: 12px; right: 12px;
    62	  width: 38px; height: 38px;
    63	  display: inline-flex; align-items: center; justify-content: center;
    64	  border-radius: var(--str-radius-sm);
    65	  border: 1px solid var(--str-neutral-200);
    66	  background: #fff; color: var(--str-text);
    67	  font-size: 18px; line-height: 1; cursor: pointer; z-index: 2;
    68	}
    69	.saas-tr-modal__close:hover,
    70	.saas-tr-modal_close:hover,
    71	#modal-parejas-multiseleccion .js-close-modal:hover{
    72	  background: var(--str-neutral-75);
    73	}
    74	
    75	/* ===== Backdrop interno opcional ==================================== */
    76	.saas-tr-modal__backdrop,
    77	.saas-tr-modal_backdrop{
    78	  position: absolute; inset: 0; pointer-events: none;
    79	}
    80	
    81	/* Oculta cierres legacy redundantes si vinieran en el template */
    82	#modal-parejas-multiseleccion .modal-cerrar,
    83	#modal-parejas-multiseleccion .btn-cerrar,
    84	#modal-parejas-multiseleccion .close,
    85	#modal-parejas-multiseleccion .cerrar { display: none !important; }
    86	
    87	/* ===== Activación accesible por aria-hidden ========================== */
    88	#modal-parejas-multiseleccion{ position: fixed; inset: 0; display: none; align-items: center; justify-content: center; z-index: 9999; }
    89	#modal-parejas-multiseleccion[aria-hidden="false"]{ display: flex; }
    90	
    91	/* ===== Caja de diálogo concreta del modal =========================== */
    92	#modal-parejas-multiseleccion .saas-tr-modal_dialog,
    93	#modal-parejas-multiseleccion .saas-tr-modal__dialog{
    94	  width: min(1100px, 96vw);
    95	  max-height: 90vh;
    96	  box-shadow: 0 10px 40px rgba(18,24,40,.2);
    97	}
    98	
    99	/* ===== Secciones internas: títulos y separación ===================== */
   100	#modal-parejas-multiseleccion h2{ 
   101	  font-size: 1.3rem; margin: 0 0 8px; font-weight: 700; color: var(--str-text);
   102	}
   103	#modal-parejas-multiseleccion h3{
   104	  font-size: 1.05rem; margin: 18px 0 10px; font-weight: 700; color: var(--str-text);
   105	}
   106	
   107	/* ===== Formulario de búsqueda ======================================= */
   108	#form-buscar-jugadores{
   109	  display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 10px;
   110	  margin-bottom: 14px;
   111	}
   112	#form-buscar-jugadores input[type="text"],
   113	#form-buscar-jugadores input[type="email"]{
   114	  height: 40px; border: 1px solid var(--str-neutral-200);
   115	  border-radius: var(--str-radius-sm);
   116	  padding: 8px 10px; outline: none; background: #fff; color: var(--str-text);
   117	}
   118	#form-buscar-jugadores input:focus{
   119	  border-color: var(--str-primary);
   120	  box-shadow: 0 0 0 3px rgba(33,82,255,.12);
   121	}
   122	#form-buscar-jugadores button[type="submit"]{
   123	  height: 40px; padding: 0 14px; border-radius: var(--str-radius-sm);
   124	  border: 1px solid var(--str-primary); background: var(--str-primary); color:#fff; font-weight:600; cursor:pointer;
   125	}
   126	#form-buscar-jugadores button[type="submit"]:hover{
   127	  background: var(--str-primary-600); border-color: var(--str-primary-600);
   128	}
   129	
   130	@media (max-width: 900px){
   131	  #form-buscar-jugadores{ grid-template-columns: 1fr 1fr; }
   132	  #form-buscar-jugadores button[type="submit"]{ grid-column: 1 / -1; }
   133	}
   134	
   135	/* ===== Pareja en preparación ======================================== */
   136	#jugadores-seleccionados{
   137	  background: var(--str-neutral-50);
   138	  border: 1px solid var(--str-neutral-200);
   139	  border-radius: var(--str-radius-md);
   140	  padding: 10px 12px; min-height: 44px;
   141	  display: flex; flex-wrap: wrap; gap: 8px; align-items: center;
   142	}
   143	.jugador-seleccionado{
   144	  display: inline-flex; align-items: center; gap: 6px;
   145	  border: 1px solid var(--str-neutral-200);
   146	  background: #fff; color: var(--str-text);
   147	  padding: 6px 10px; border-radius: 999px; font-size: .92rem;
   148	  box-shadow: 0 1px 0 rgba(0,0,0,.02);
   149	}
   150	.jugador-seleccionado strong{ font-weight: 700; }
   151	.jugador-seleccionado .btn-quitar-jugador{
   152	  width: 22px; height: 22px; line-height: 1;
   153	  display: inline-flex; align-items: center; justify-content: center;
   154	  border-radius: 999px; border: 1px solid var(--str-neutral-300);
   155	  background: var(--str-neutral-75); color: #243b53; cursor: pointer;
   156	  font-size: 14px; padding: 0;
   157	}
   158	.jugador-seleccionado .btn-quitar-jugador:hover{
   159	  background: #e9eef9;
   160	}
   161	
   162	/* Botón Confirmar */
   163	#btn-confirmar-pareja{
   164	  margin-top: 10px;
   165	  height: 40px; padding: 0 16px; border-radius: var(--str-radius-sm);
   166	  border: 1px solid var(--str-primary); background: var(--str-primary);
   167	  color:#fff; font-weight: 700; cursor: pointer;
   168	}
   169	#btn-confirmar-pareja:disabled{
   170	  opacity:.6; cursor:not-allowed;
   171	}
   172	#btn-confirmar-pareja:hover:not(:disabled){
   173	  background: var(--str-primary-600); border-color: var(--str-primary-600);
   174	}
   175	
   176	/* Mensajes de feedback */
   177	#mensaje-parejas{ margin-top: 8px; font-size: .92rem; display:none; }
   178	#mensaje-parejas.success{ color: var(--str-success); }
   179	#mensaje-parejas.error{ color: var(--str-error); }
   180	
   181	/* ===== Tablas (jugadores y parejas confirmadas) ====================== */
   182	.tabla-jugadores-disponibles,
   183	.tabla-parejas-confirmadas{
   184	  width: 100%;
   185	  border-collapse: collapse;
   186	  background: #fff;
   187	  border: 1px solid var(--str-neutral-200);
   188	  border-radius: var(--str-radius-md);
   189	  overflow: hidden;                /* para que el radius afecte al thead */
   190	  font-size: .95rem;
   191	}
   192	.tabla-jugadores-disponibles thead th,
   193	.tabla-parejas-confirmadas thead th{
   194	  background: var(--str-neutral-75);
   195	  color: #1b2f6b; font-weight: 700;
   196	  text-align: left; padding: 10px 12px;
   197	  border-bottom: 1px solid var(--str-neutral-200);
   198	}
   199	.tabla-jugadores-disponibles tbody td,
   200	.tabla-parejas-confirmadas tbody td{
   201	  padding: 10px 12px;
   202	  border-bottom: 1px solid var(--str-neutral-100);
   203	  color: var(--str-text);
   204	}
   205	.tabla-jugadores-disponibles tbody tr:hover,
   206	.tabla-parejas-confirmadas tbody tr:hover{
   207	  background: #fafcff;
   208	}
   209	
   210	/* Checkbox columna estrecha */
   211	.tabla-jugadores-disponibles tbody td:first-child,
   212	.tabla-jugadores-disponibles thead th:first-child{
   213	  width: 44px;
   214	}
   215	
   216	/* ===== Distribución en el modal: listas una debajo de otra en móvil == */
   217	@media (max-width: 768px){
   218	  #modal-parejas-multiseleccion .saas-tr-modal_dialog,
   219	  #modal-parejas-multiseleccion .saas-tr-modal__dialog{
   220	    padding: 16px; max-height: 94vh;
   221	  }
   222	}
   223	
   224	/* ===== Estética general del bloque en ficha ========================== */
   225	#tabla-parejas{ border: 1px solid var(--str-neutral-200); border-radius: var(--str-radius-md); overflow: hidden; }
   226	#tabla-parejas th{ background: var(--str-neutral-75); color:#1b2f6b; }
   227	#tabla-parejas td, #tabla-parejas th{ padding: 10px 12px; }
   228	
   229	/* ===== Botones azules consistentes (por si se usan en el modal) ===== */
   230	.saas-btn-primary{
   231	  border: 1px solid var(--str-primary);
   232	  background: var(--str-primary);
   233	  color: #fff; border-radius: var(--str-radius-sm);
   234	  padding: 8px 14px; font-weight: 700; cursor: pointer;
   235	}
   236	.saas-btn-primary:hover{ background: var(--str-primary-600); border-color: var(--str-primary-600); }
   237	
   238	/* ===== Ajustes menores ================================================== */
   239	#modal-parejas-multiseleccion .saas-tr-modal_content,
   240	#modal-parejas-multiseleccion .saas-tr-modal__content{ position: relative; }
   241	
===== END includes/features/pairs/index.css =====

===== BEGIN includes/features/pairs/index.js =====
     1	// Pairs (multi-selección) – compatible con legacy y nueva plantilla
     2	// - Engancha tanto #btn-abrir-modal-pareja como .js-add-pareja
     3	// - Usa acciones desde str_parejas_ajax_obj.actions con fallback a saas_*
     4	// - Soporta str_parejas_ajax_obj.torneo_id o .post_id
     5	// - Pinta parejas en: 
     6	//     • Ficha de torneo → #tabla-parejas tbody
     7	//     • Modal (si existe) → #tabla-parejas-confirmadas
     8	// - Logs detallados para depuración
     9	
    10	(function ($, w) {
    11	  'use strict';
    12	
    13	  if (typeof $ === 'undefined') {
    14	    console.error('[PAIRS] jQuery no disponible');
    15	    return;
    16	  }
    17	
    18	  // Helpers de supresión (cooperan con /groups/)
    19	  function __isPairsSuppressed() {
    20	    try { return window.__STR_SUPPRESS_PAIRS_MODAL__ && Date.now() < window.__STR_SUPPRESS_PAIRS_MODAL__; } catch(_) { return false; }
    21	  }
    22	  function __insideGroups(el) {
    23	    try { return !!(el && el.closest && el.closest('#str-gestion-grupos')); } catch(_) { return false; }
    24	  }
    25	
    26	  $(function () {
    27	    // --- CONFIG -------------------------------------------------------------
    28	    var cfg   = w.str_parejas_ajax_obj || {};
    29	    var AJAX  = cfg.ajax_url || (w.str_ajax_obj && w.str_ajax_obj.ajax_url) || '';
    30	    var NONCE = cfg.nonce    || (w.str_ajax_obj && w.str_ajax_obj.nonce)    || '';
    31	    var TORNEO_ID = parseInt(cfg.torneo_id || cfg.post_id || 0, 10) || 0;
    32	
    33	    // Acciones (usar las que vinieron localizadas; si no, fallback a saas_*)
    34	    var ACT = (cfg.actions || {});
    35	    var ACTIONS = {
    36	      BUSCAR:  ACT.buscar  || 'saas_buscar_jugadores',
    37	      LISTAR:  ACT.listar  || 'saas_listar_parejas_multiseleccion',
    38	      GUARDAR: ACT.guardar || 'saas_guardar_pareja_multiseleccion'
    39	    };
    40	
    41	    console.log('[PAIRS][BOOT]', { AJAX, NONCE, TORNEO_ID, ACTIONS, cfg });
    42	
    43	    // --- SELECTORES (legacy + nuevos) --------------------------------------
    44	    var $btnAbrir     = $('#btn-abrir-modal-pareja');        // legacy
    45	    var $btnAbrirAlt  = $('.js-add-pareja');                 // nuevo
    46	    var $modal        = $('#modal-parejas-multiseleccion');  // modal (si existe)
    47	    var $cerrar       = $('.cerrar-modal-parejas, .saas-tr-modal__close, .saas-tr-modal_close, .js-close-modal');
    48	
    49	    // Slots usados en el MODAL (si existe):
    50	    var $tablaJugadores = $('#tabla-jugadores-disponibles');
    51	    var $tablaParejasModal = $('#tabla-parejas-confirmadas');
    52	
    53	    // Slot de la FICHA (siempre):
    54	    var $tablaParejasMainBody = $('#tabla-parejas tbody');
    55	
    56	    var $selWrap      = $('#jugadores-seleccionados');
    57	    var $btnConfirmar = $('#btn-confirmar-pareja');
    58	    var $formBuscar   = $('#form-buscar-jugadores');
    59	    var $msgParejas   = $('#mensaje-parejas');
    60	
    61	    var seleccionados = [];
    62	    var jugadoresCache = {};
    63	
    64	    // --- UTIL ---------------------------------------------------------------
    65	    function showModal() {
    66	      // No abrir si suprimido por flujo de grupos
    67	      if (__isPairsSuppressed()) {
    68	        console.warn('[PAIRS] Apertura del modal SUPRIMIDA por flujo de grupos.');
    69	        return;
    70	      }
    71	
    72	      if (!$modal.length) {
    73	        console.warn('[PAIRS] Modal #modal-parejas-multiseleccion no está en el DOM. (Solo ficha)');
    74	        return;
    75	      }
    76	      // Normaliza estado abierto + aria
    77	      $modal.css('display', 'flex').attr('aria-modal', 'true').attr('aria-hidden', 'false');
    78	      $('body').addClass('saas-tr-modal-open');
    79	    }
    80	    function hideModal() {
    81	      if ($modal.length) {
    82	        $modal.attr('aria-hidden', 'true').css('display', 'none');
    83	        $('body').removeClass('saas-tr-modal-open');
    84	      }
    85	      limpiarSeleccion();
    86	    }
    87	    function setMsg(msg, type) {
    88	      if (!$msgParejas.length) return;
    89	      $msgParejas.removeClass().addClass(type || '').html(msg).fadeIn();
    90	      setTimeout(function () { $msgParejas.fadeOut(); }, 2200);
    91	    }
    92	    function getNombreJugador(id) {
    93	      return jugadoresCache[id] ? (jugadoresCache[id].nombre + ' ' + jugadoresCache[id].apellido) : '';
    94	    }
    95	    function actualizarCheckboxes() {
    96	      $('.chk-jugador').each(function () {
    97	        var id = parseInt($(this).data('id'), 10);
    98	        if (seleccionados.includes(id)) {
    99	          $(this).prop('checked', true).prop('disabled', false);
   100	        } else if (seleccionados.length >= 2) {
   101	          $(this).prop('disabled', true);
   102	        } else {
   103	          $(this).prop('disabled', false);
   104	        }
   105	      });
   106	    }
   107	    function actualizarParejaEnPreparacion() {
   108	      if (!$selWrap.length) return;
   109	      var html = '';
   110	      if (seleccionados.length === 0) {
   111	        html = '<p>Selecciona dos jugadores para formar una pareja.</p>';
   112	      } else {
   113	        seleccionados.forEach(function (id, idx) {
   114	          html += '<span class="jugador-seleccionado">Jugador ' + (idx + 1) + ': <strong>' + getNombreJugador(id) + '</strong> <button class="btn-quitar-jugador" data-id="' + id + '" aria-label="Quitar jugador">&times;</button></span>';
   115	        });
   116	      }
   117	      $selWrap.html(html);
   118	      if ($btnConfirmar.length) $btnConfirmar.prop('disabled', seleccionados.length !== 2);
   119	    }
   120	    function limpiarSeleccion() {
   121	      seleccionados = [];
   122	      actualizarParejaEnPreparacion();
   123	      actualizarCheckboxes();
   124	    }
   125	
   126	    // --- RENDER: Modal ------------------------------------------------------
   127	    function renderParejasModal(parejas) {
   128	      if (!$tablaParejasModal.length) return;
   129	      var html = '<table class="tabla-parejas-confirmadas"><thead><tr><th>#</th><th>Jugador 1</th><th>Jugador 2</th></tr></thead><tbody>';
   130	      if (!parejas || !parejas.length) {
   131	        html += '<tr><td colspan="3" style="color:#888;text-align:center;">Aún no hay parejas confirmadas.</td></tr>';
   132	      } else {
   133	        parejas.forEach(function (p, idx) {
   134	          // Tolerante a claves distintas
   135	          var j1 = p.jugador_1_nombre || p.jugador1 || p.jugador_1 || '';
   136	          var j2 = p.jugador_2_nombre || p.jugador2 || p.jugador_2 || '';
   137	          html += '<tr><td>' + (idx + 1) + '</td><td>' + j1 + '</td><td>' + j2 + '</td></tr>';
   138	        });
   139	      }
   140	      html += '</tbody></table>';
   141	      $tablaParejasModal.html(html);
   142	    }
   143	
   144	    // --- RENDER: Ficha Torneo ----------------------------------------------
   145	    function renderParejasMain(parejas) {
   146	      if (!$tablaParejasMainBody.length) return;
   147	      var html = '';
   148	
   149	      if (!parejas || !parejas.length) {
   150	        html += '<tr><td colspan="4" style="color:#8aa0c4;text-align:center;padding:14px 8px;">Aún no hay parejas confirmadas.</td></tr>';
   151	      } else {
   152	        parejas.forEach(function (p, idx) {
   153	          var j1 = p.jugador_1_nombre || p.jugador1 || p.jugador_1 || '';
   154	          var j2 = p.jugador_2_nombre || p.jugador2 || p.jugador_2 || '';
   155	          html += '<tr>' +
   156	                    '<td>' + (idx + 1) + '</td>' +
   157	                    '<td>' + j1 + '</td>' +
   158	                    '<td>' + j2 + '</td>' +
   159	                    '<td>—</td>' +
   160	                  '</tr>';
   161	        });
   162	      }
   163	
   164	      $tablaParejasMainBody.html(html);
   165	    }
   166	
   167	    // --- RENDER: Jugadores disponibles (Modal) ------------------------------
   168	    function renderJugadores(lista) {
   169	      if (!$tablaJugadores.length) return;
   170	
   171	      jugadoresCache = {};
   172	      var html = '<table class="tabla-jugadores-disponibles"><thead>' +
   173	        '<tr><th></th><th>Nombre</th><th>Apellido</th><th>Email</th></tr></thead><tbody>';
   174	
   175	      if (!lista || !lista.length) {
   176	        html += '<tr><td colspan="4" style="color:#888;text-align:center;">No hay jugadores disponibles.</td></tr>';
   177	      } else {
   178	        lista.forEach(function (jug) {
   179	          jugadoresCache[jug.ID] = jug;
   180	          var checked  = seleccionados.includes(jug.ID) ? 'checked disabled' : '';
   181	          var disabled = (seleccionados.length >= 2 && !seleccionados.includes(jug.ID)) ? 'disabled' : '';
   182	          html += '<tr>' +
   183	                    '<td><input type="checkbox" class="chk-jugador" data-id="' + jug.ID + '" ' + checked + ' ' + disabled + '></td>' +
   184	                    '<td>' + jug.nombre + '</td>' +
   185	                    '<td>' + jug.apellido + '</td>' +
   186	                    '<td>' + jug.email + '</td>' +
   187	                  '</tr>';
   188	        });
   189	      }
   190	
   191	      html += '</tbody></table>';
   192	      $tablaJugadores.html(html);
   193	    }
   194	
   195	    // --- AJAX ---------------------------------------------------------------
   196	    function cargarParejasConfirmadas() {
   197	      // Si no tenemos ningún destino, no disparamos petición
   198	      if (!$tablaParejasMainBody.length && !$tablaParejasModal.length) return;
   199	
   200	      $.ajax({
   201	        url: AJAX,
   202	        method: 'POST',
   203	        data: {
   204	          action: ACTIONS.LISTAR,
   205	          nonce: NONCE,
   206	          torneo_id: TORNEO_ID
   207	        }
   208	      }).done(function (res) {
   209	        var parejas = (res && res.success && res.data && res.data.parejas) ? res.data.parejas : [];
   210	        renderParejasMain(parejas);
   211	        renderParejasModal(parejas);
   212	      }).fail(function () {
   213	        // Mensaje amable en la ficha (si existe)
   214	        if ($tablaParejasMainBody.length) {
   215	          $tablaParejasMainBody.html('<tr><td colspan="4" style="color:#b00;text-align:center;padding:14px 8px;">Error al cargar parejas.</td></tr>');
   216	        }
   217	        if ($tablaParejasModal.length) {
   218	          $tablaParejasModal.html('<p style="color:#b00;">Error al cargar parejas.</p>');
   219	        }
   220	      });
   221	    }
   222	
   223	    function cargarJugadoresDisponibles(nombre, apellido, email) {
   224	      if (!$tablaJugadores.length) return;
   225	      $tablaJugadores.html('<p>Cargando jugadores...</p>');
   226	
   227	      $.ajax({
   228	        url: AJAX,
   229	        method: 'POST',
   230	        data: {
   231	          action: ACTIONS.BUSCAR,
   232	          nonce: NONCE,
   233	          torneo_id: TORNEO_ID,
   234	          nombre: nombre || '',
   235	          apellido: apellido || '',
   236	          email: email || ''
   237	        }
   238	      }).done(function (res) {
   239	        if (res && res.success) {
   240	          renderJugadores(res.data && res.data.jugadores ? res.data.jugadores : []);
   241	        } else {
   242	          $tablaJugadores.html('<p style="color:#b00;">' + (res && res.data && res.data.mensaje ? res.data.mensaje : 'No se pudo cargar jugadores') + '</p>');
   243	        }
   244	      }).fail(function () {
   245	        $tablaJugadores.html('<p style="color:#b00;">Error al cargar jugadores.</p>');
   246	      });
   247	    }
   248	
   249	    function guardarPareja() {
   250	      if (seleccionados.length !== 2) return;
   251	      if (!$btnConfirmar.length) return;
   252	
   253	      $btnConfirmar.prop('disabled', true).text('Guardando...');
   254	      $.post(AJAX, {
   255	        action: ACTIONS.GUARDAR,
   256	        nonce: NONCE,
   257	        torneo_id: TORNEO_ID,
   258	        jugador_1: seleccionados[0],
   259	        jugador_2: seleccionados[1]
   260	      }).done(function (res) {
   261	        $btnConfirmar.prop('disabled', false).text('Confirmar pareja');
   262	        if (res && res.success) {
   263	          setMsg('¡Pareja guardada con éxito!', 'success');
   264	          cargarParejasConfirmadas();      // ← refresca ficha + modal
   265	          cargarJugadoresDisponibles();    // ← refresca lista en modal
   266	          limpiarSeleccion();
   267	        } else {
   268	          setMsg((res && res.data && res.data.mensaje) ? res.data.mensaje : 'Error al guardar pareja', 'error');
   269	        }
   270	      }).fail(function () {
   271	        $btnConfirmar.prop('disabled', false).text('Confirmar pareja');
   272	        setMsg('Error de red al guardar pareja', 'error');
   273	      });
   274	    }
   275	
   276	    // --- LISTENERS ----------------------------------------------------------
   277	    // Abrir modal
   278	    $btnAbrir.on('click', function (e) {
   279	      if (__isPairsSuppressed() || __insideGroups(e.target)) {
   280	        e.preventDefault();
   281	        console.warn('[PAIRS] Click ignorado (supresión activa o click dentro de grupos).');
   282	        return;
   283	      }
   284	      e.preventDefault();
   285	      showModal();
   286	      cargarParejasConfirmadas();
   287	      cargarJugadoresDisponibles();
   288	    });
   289	
   290	    $btnAbrirAlt.on('click', function (e) {
   291	      if (__isPairsSuppressed() || __insideGroups(e.target)) {
   292	        e.preventDefault();
   293	        console.warn('[PAIRS] Click ignorado (supresión activa o click dentro de grupos).');
   294	        return;
   295	      }
   296	      e.preventDefault();
   297	      showModal();
   298	      cargarParejasConfirmadas();
   299	      cargarJugadoresDisponibles();
   300	    });
   301	
   302	    // Cerrar modal
   303	    $cerrar.on('click', function (e) { e.preventDefault(); hideModal(); });
   304	    $(document).on('keydown', function (e) {
   305	      if (e.key === 'Escape' && $modal.length && $modal.is(':visible')) hideModal();
   306	    });
   307	    if ($modal.length) {
   308	      $modal.on('click', function (e) {
   309	        if (e.target === this || $(e.target).hasClass('saas-tr-modal_backdrop') || $(e.target).hasClass('saas-tr-modal__backdrop')) {
   310	          hideModal();
   311	        }
   312	      });
   313	    }
   314	
   315	    // Buscar jugadores (modal)
   316	    $formBuscar.on('submit', function (e) {
   317	      e.preventDefault();
   318	      var nombre   = $('#busqueda-nombre').val();
   319	      var apellido = $('#busqueda-apellido').val();
   320	      var email    = $('#busqueda-email').val();
   321	      cargarJugadoresDisponibles(nombre, apellido, email);
   322	    });
   323	
   324	    // Selección de jugadores (modal)
   325	    $(document).on('change', '.chk-jugador', function () {
   326	      var id = parseInt($(this).data('id'), 10);
   327	      if ($(this).is(':checked')) {
   328	        if (seleccionados.length < 2) { seleccionados.push(id); } else { this.checked = false; }
   329	      } else {
   330	        seleccionados = seleccionados.filter(function (x) { return x !== id; });
   331	      }
   332	      actualizarParejaEnPreparacion();
   333	      actualizarCheckboxes();
   334	    });
   335	
   336	    $(document).on('click', '.btn-quitar-jugador', function () {
   337	      var id = parseInt($(this).data('id'), 10);
   338	      seleccionados = seleccionados.filter(function (x) { return x !== id; });
   339	      actualizarParejaEnPreparacion();
   340	      actualizarCheckboxes();
   341	    });
   342	
   343	    $btnConfirmar.on('click', function () { guardarPareja(); });
   344	
   345	    // --- INIT ---------------------------------------------------------------
   346	    actualizarParejaEnPreparacion();
   347	    cargarParejasConfirmadas(); // ← pinta en la ficha al entrar
   348	    console.log('[PAIRS][READY] Listeners activos');
   349	  });
   350	
   351	})(jQuery, window);
===== END includes/features/pairs/index.js =====

===== BEGIN includes/features/pairs/index.php =====
===== END includes/features/pairs/index.php =====

===== BEGIN includes/features/players/ajax/cargar-competiciones.php =====
     1	<?php
     2	// AJAX: Cargar competiciones jugadas por el jugador
     3	// Antiguo: ajax-cargar-competiciones-jugador.php
     4	// Este endpoint servirá para devolver las competiciones jugadas (filtradas por deporte y año).
     5	// Por ahora es un esqueleto base, listo para conectar cuando esté implementada la lógica real.
     6	
     7	add_action('wp_ajax_str_cargar_competiciones_jugador', 'str_cargar_competiciones_jugador');
     8	add_action('wp_ajax_nopriv_str_cargar_competiciones_jugador', 'str_cargar_competiciones_jugador');
     9	
    10	function str_cargar_competiciones_jugador() {
    11	    // Validar parámetros recibidos
    12	    $jugador_id = isset($_POST['jugador_id']) ? intval($_POST['jugador_id']) : 0;
    13	    $deporte    = isset($_POST['deporte']) ? sanitize_text_field($_POST['deporte']) : '';
    14	    $ano        = isset($_POST['ano']) ? sanitize_text_field($_POST['ano']) : '';
    15	
    16	    // TODO: Aquí irá la consulta real a la BD para extraer las competiciones jugadas
    17	    // según el $jugador_id, $deporte y $ano.
    18	
    19	    // Por ahora, devolvemos datos simulados:
    20	    $response = [
    21	        [
    22	            'competicion' => 'Torneo Madrid',
    23	            'posicion'    => '3º grupo',
    24	            'fecha'       => '27/09/25',
    25	        ],
    26	        [
    27	            'competicion' => 'Torneo Barcelona',
    28	            'posicion'    => 'Ganador',
    29	            'fecha'       => '13/10/25',
    30	        ],
    31	    ];
    32	
    33	    wp_send_json_success($response);
    34	    exit;
    35	}
    36	
    37	// NOTA: Cuando la lógica real esté lista, aquí irá la consulta a los posts de tipo competición/torneo.
===== END includes/features/players/ajax/cargar-competiciones.php =====

===== BEGIN includes/features/players/ajax/cargar-estadisticas.php =====
     1	<?php
     2	// AJAX: Cargar estadísticas del jugador para su perfil
     3	// Antiguo: ajax-cargar-estadisticas-jugador.php
     4	// Este endpoint servirá para devolver estadísticas de partidos según jugador y deporte. 
     5	// Por ahora es un esqueleto base, listo para conectar cuando esté implementada la lógica de partidos.
     6	
     7	add_action('wp_ajax_str_cargar_estadisticas_jugador', 'str_cargar_estadisticas_jugador');
     8	add_action('wp_ajax_nopriv_str_cargar_estadisticas_jugador', 'str_cargar_estadisticas_jugador');
     9	
    10	function str_cargar_estadisticas_jugador() {
    11	    // Validar parámetros recibidos (ID de jugador y deporte)
    12	    $jugador_id = isset($_POST['jugador_id']) ? intval($_POST['jugador_id']) : 0;
    13	    $deporte    = isset($_POST['deporte']) ? sanitize_text_field($_POST['deporte']) : '';
    14	
    15	    // TODO: Añadir aquí la lógica real para consultar partidos y calcular estadísticas:
    16	    // partidos jugados, ganados, perdidos, racha, %...
    17	    // Usar el $jugador_id y el $deporte para filtrar los partidos.
    18	
    19	    // Devolver un ejemplo de datos simulados (por ahora):
    20	    $response = [
    21	        'jugados'         => 0,
    22	        'ganados'         => 0,
    23	        'ganados_pct'     => 0,
    24	        'perdidos'        => 0,
    25	        'perdidos_pct'    => 0,
    26	        'racha_ganados'   => 0,
    27	        'racha_ganados_pct' => 0,
    28	        'racha_perdidos'  => 0,
    29	        'racha_perdidos_pct' => 0,
    30	    ];
    31	
    32	    wp_send_json_success($response);
    33	    exit;
    34	}
    35	
    36	// NOTA: Cuando la sección de partidos esté lista, aquí irá toda la consulta real.
===== END includes/features/players/ajax/cargar-estadisticas.php =====

===== BEGIN includes/features/players/ajax/cargar-form-automatica.php =====
     1	<?php
     2	// Antiguo /includes/ajax/ajax-cargar-form-invitacion-automatica.php
     3	
     4	add_action('wp_ajax_str_cargar_form_invitacion_automatica', 'str_cargar_form_invitacion_automatica');
     5	add_action('wp_ajax_nopriv_str_cargar_form_invitacion_automatica', 'str_cargar_form_invitacion_automatica');
     6	
     7	function str_cargar_form_invitacion_automatica() {
     8	    ob_start();
     9	    include STR_PLUGIN_PATH . 'includes/forms/form-invitacion-jugador-automatica.php';
    10	    $html = ob_get_clean();
    11	    wp_send_json_success(['html' => $html]);
    12	    exit;
    13	}
===== END includes/features/players/ajax/cargar-form-automatica.php =====

===== BEGIN includes/features/players/ajax/cargar-form-manual.php =====
     1	<?php
     2	// antiguo /includes/ajax/ajax-cargar-form-invitacion-manual.php
     3	
     4	add_action('wp_ajax_str_cargar_form_invitacion_manual', 'str_ajax_cargar_form_invitacion_manual');
     5	add_action('wp_ajax_nopriv_str_cargar_form_invitacion_manual', 'str_ajax_cargar_form_invitacion_manual');
     6	
     7	function str_ajax_cargar_form_invitacion_manual() {
     8	    // Sanea y recoge el torneo_id enviado por AJAX (si llega)
     9	    $torneo_id = isset($_POST['torneo_id']) ? intval($_POST['torneo_id']) : 0;
    10	
    11	    ob_start();
    12	    ?>
    13	    <!-- Enlaza aquí el CSS personalizado para el formulario manual -->
    14	    <link rel="stylesheet" href="<?php echo esc_url(STR_PLUGIN_URL . 'assets/css/form-invitacion-jugador-manual.css'); ?>">
    15	
    16	    <form id="form-invitacion-jugador-manual" autocomplete="off" class="form-invitacion-jugador-manual">
    17	        <div class="form-group">
    18	            <label>Nombre*</label>
    19	            <input type="text" name="nombre" required>
    20	        </div>
    21	        <div class="form-group">
    22	            <label>Apellidos*</label>
    23	            <input type="text" name="apellidos" required>
    24	        </div>
    25	        <div class="form-group">
    26	            <label>Email*</label>
    27	            <input type="email" name="email" required>
    28	        </div>
    29	        <div class="form-group">
    30	            <label>Teléfono</label>
    31	            <input type="text" name="telefono">
    32	        </div>
    33	        <input type="hidden" name="torneo_id" id="inv-torneo-id-manual" value="<?php echo esc_attr($torneo_id); ?>">
    34	        <button type="submit" id="btn-enviar-invitacion-jugador-manual" class="btn-enviar-invitacion">Guardar jugador</button>
    35	        <div id="mensaje-invitacion-jugador-manual" style="margin-top:8px;"></div>
    36	    </form>
    37	    <?php
    38	
    39	    $html = ob_get_clean();
    40	    wp_send_json_success(['html' => $html]);
    41	    exit;
    42	}
===== END includes/features/players/ajax/cargar-form-manual.php =====

===== BEGIN includes/features/players/ajax/cargar-modal.php =====
     1	<?php
     2	/**
     3	 * AJAX: Cargar modal de invitacin de jugador (players)
     4	 * Ruta: wp-content/plugins/saas-torneos-de-raqueta/includes/features/players/ajax/cargar-modal.php
     5	 */
     6	if ( ! defined('ABSPATH') ) exit;
     7	
     8	// Logger opcional (seguro si no existe)
     9	if ( ! function_exists('str_escribir_log') ) {
    10	    function str_escribir_log( $m, $tag = 'PLAYERS-MODAL' ) { /* noop en prod */ }
    11	}
    12	
    13	/**
    14	 * Handler nico con alias para acciones nuevas (saas_) y legacy (str_)
    15	 */
    16	$__saas_players_modal_handler = function () {
    17	    $nonce   = isset($_POST['nonce'])   ? $_POST['nonce']   : '';
    18	    $post_id = isset($_POST['post_id']) ? intval($_POST['post_id']) : 0;
    19	
    20	    // Verificacin de nonce: debe coincidir con el que localizamos desde PHP (str_nonce)
    21	    if ( ! wp_verify_nonce( $nonce, 'str_nonce' ) ) {
    22	        str_escribir_log('[ERR] Nonce invlido o ausente');
    23	        wp_send_json_error([ 'message' => 'Nonce invlido' ], 403);
    24	    }
    25	
    26	    // Cargamos la vista del modal (feature  legacy fallback)
    27	    ob_start();
    28	
    29	    $view_feature = STR_PLUGIN_PATH . 'includes/features/players/views/modal-invitacion.php';
    30	    $view_legacy  = STR_PLUGIN_PATH . 'includes/forms/form-invitacion-jugador.php';
    31	
    32	    if ( file_exists($view_feature) ) {
    33	        include $view_feature;
    34	    } elseif ( file_exists($view_legacy) ) {
    35	        include $view_legacy;
    36	    } else {
    37	        echo '<div class="saas-tr-hint">Vista de modal no encontrada.</div>';
    38	        str_escribir_log('[ERR] No existe view ni legacy para el modal');
    39	    }
    40	
    41	    $html = ob_get_clean();
    42	
    43	    wp_send_json_success([
    44	        'html'    => $html,
    45	        'post_id' => $post_id,
    46	    ], 200);
    47	};
    48	
    49	// Acciones nuevas (prefijo saas_)
    50	add_action('wp_ajax_saas_cargar_modal_invitacion',        $__saas_players_modal_handler);
    51	add_action('wp_ajax_nopriv_saas_cargar_modal_invitacion', $__saas_players_modal_handler);
    52	
    53	// Alias legacy (prefijo str_), por si algo del cdigo viejo los sigue usando
    54	add_action('wp_ajax_str_cargar_modal_invitacion',         $__saas_players_modal_handler);
    55	add_action('wp_ajax_nopriv_str_cargar_modal_invitacion',  $__saas_players_modal_handler);
===== END includes/features/players/ajax/cargar-modal.php =====

===== BEGIN includes/features/players/ajax/comprobar-jugador.php =====
     1	<?php
     2	/** Antiguo /includes/ajax/ajax-comprobar-jugador.php
     3	 * AJAX: Comprobar si un jugador existe por email o por nombre+apellidos (sin distinguir mayúsculas/minúsculas)
     4	 * Utilizado por el JS del formulario para mostrar aviso en tiempo real
     5	 */
     6	
     7	// Hook AJAX para usuarios logueados y visitantes
     8	add_action('wp_ajax_str_comprobar_jugador', 'str_comprobar_jugador');
     9	add_action('wp_ajax_nopriv_str_comprobar_jugador', 'str_comprobar_jugador');
    10	
    11	function str_comprobar_jugador() {
    12	    // Recoge y sanitiza los parámetros recibidos
    13	    $nombre    = isset($_POST['nombre'])    ? sanitize_text_field($_POST['nombre']) : '';
    14	    $apellidos = isset($_POST['apellidos']) ? sanitize_text_field($_POST['apellidos']) : '';
    15	    $email     = isset($_POST['email'])     ? sanitize_email($_POST['email']) : '';
    16	
    17	    $existe = false;
    18	
    19	    // Si hay email, busca por ese campo (ignora mayúsculas/minúsculas)
    20	    if ($email) {
    21	        $args = [
    22	            'post_type' => 'jugador_deportes',
    23	            'meta_query' => [[
    24	                'key' => 'email',
    25	                'value' => $email,
    26	                'compare' => 'LIKE'
    27	            ]],
    28	            'posts_per_page' => 1,
    29	            'fields' => 'ids',
    30	        ];
    31	        $res = get_posts($args);
    32	        if ($res && count($res) > 0) {
    33	            $existe = true;
    34	        }
    35	    }
    36	    // Si no hay email pero sí nombre y apellidos, busca por combinación
    37	    if (!$existe && $nombre && $apellidos) {
    38	        // Normaliza a minúsculas y quita espacios para comparar
    39	        $nombre_buscar    = strtolower(str_replace(' ', '', $nombre));
    40	        $apellidos_buscar = strtolower(str_replace(' ', '', $apellidos));
    41	
    42	        $args = [
    43	            'post_type' => 'jugador_deportes',
    44	            'posts_per_page' => 50, // Por si hay muchos
    45	            'post_status' => 'publish',
    46	            'fields' => 'ids',
    47	        ];
    48	        $posts = get_posts($args);
    49	        foreach ($posts as $pid) {
    50	            $nom = get_field('nombre', $pid);
    51	            $ape = get_field('apellido', $pid);
    52	            $nom = strtolower(str_replace(' ', '', $nom));
    53	            $ape = strtolower(str_replace(' ', '', $ape));
    54	            if ($nom === $nombre_buscar && $ape === $apellidos_buscar) {
    55	                $existe = true;
    56	                break;
    57	            }
    58	        }
    59	    }
    60	    // Devuelve el resultado al JS del formulario
    61	    wp_send_json(['existe' => $existe]);
    62	}
===== END includes/features/players/ajax/comprobar-jugador.php =====

===== BEGIN includes/features/players/ajax/editar-jugador.php =====
     1	<?php
     2	// *Antiguo: includes/ajax/ajax-editar-jugador.php. AJAX: Cargar y guardar datos de jugador vía modal (sólo clientes/administradores)
     3	
     4	// Obtener datos actuales del jugador (para rellenar el modal)
     5	add_action('wp_ajax_str_get_datos_jugador', 'str_get_datos_jugador');
     6	function str_get_datos_jugador() {
     7	    if (!current_user_can('manage_options') && !current_user_can('cliente')) {
     8	        wp_send_json_error(['mensaje' => 'No tienes permisos.']);
     9	        exit;
    10	    }
    11	
    12	    $jugador_id = isset($_POST['jugador_id']) ? intval($_POST['jugador_id']) : 0;
    13	    if (!$jugador_id) {
    14	        wp_send_json_error(['mensaje' => 'ID de jugador no válido.']);
    15	        exit;
    16	    }
    17	
    18	    // Recuperar campos ACF del jugador
    19	    $response = [
    20	        'nombre'   => get_field('nombre', $jugador_id) ?: '',
    21	        'apellido' => get_field('apellido', $jugador_id) ?: '',
    22	        'email'    => get_field('email', $jugador_id) ?: '',
    23	        'telefono' => get_field('telefono', $jugador_id) ?: '',
    24	    ];
    25	
    26	    wp_send_json_success($response);
    27	    exit;
    28	}
    29	
    30	// Guardar datos editados del jugador (modal)
    31	add_action('wp_ajax_str_guardar_datos_jugador', 'str_guardar_datos_jugador');
    32	function str_guardar_datos_jugador() {
    33	    if (!current_user_can('manage_options') && !current_user_can('cliente')) {
    34	        wp_send_json_error(['mensaje' => 'No tienes permisos para editar.']);
    35	        exit;
    36	    }
    37	
    38	    $jugador_id = isset($_POST['jugador_id']) ? intval($_POST['jugador_id']) : 0;
    39	    if (!$jugador_id) {
    40	        wp_send_json_error(['mensaje' => 'ID de jugador no válido.']);
    41	        exit;
    42	    }
    43	
    44	    // Recoger y sanear los datos recibidos
    45	    $nombre   = isset($_POST['nombre'])   ? sanitize_text_field($_POST['nombre'])     : '';
    46	    $apellido = isset($_POST['apellido']) ? sanitize_text_field($_POST['apellido'])   : '';
    47	    $email    = isset($_POST['email'])    ? sanitize_email($_POST['email'])           : '';
    48	    $telefono = isset($_POST['telefono']) ? sanitize_text_field($_POST['telefono'])   : '';
    49	
    50	    // Validación simple
    51	    if (!$nombre || !$apellido || !$email) {
    52	        wp_send_json_error(['mensaje' => 'Nombre, apellido y email son obligatorios.']);
    53	        exit;
    54	    }
    55	
    56	    // Guardar campos ACF
    57	    update_field('nombre',   $nombre,   $jugador_id);
    58	    update_field('apellido', $apellido, $jugador_id);
    59	    update_field('email',    $email,    $jugador_id);
    60	    update_field('telefono', $telefono, $jugador_id);
    61	
    62	    // Nuevo título (nombre + apellido)
    63	    $nuevo_titulo = $nombre . ' ' . $apellido;
    64	
    65	    // Slug (sanitize_title genera un slug compatible con WP)
    66	    $nuevo_slug = sanitize_title($nuevo_titulo);
    67	
    68	    // Recuperar el post actual antes de actualizarlo para comparar el slug
    69	    $post_actual = get_post($jugador_id);
    70	    $slug_anterior = $post_actual->post_name;
    71	
    72	    // Actualizar el título y el slug
    73	    wp_update_post([
    74	        'ID'         => $jugador_id,
    75	        'post_title' => $nuevo_titulo,
    76	        'post_name'  => $nuevo_slug
    77	    ]);
    78	
    79	    // Comprobar si la URL ha cambiado (el slug es distinto)
    80	    $url_nueva = get_permalink($jugador_id);
    81	    $url_antigua = home_url('/jugador_deportes/' . $slug_anterior . '/'); // Ajusta el CPT/slug si lo cambias
    82	
    83	    $cambio_url = ($nuevo_slug !== $slug_anterior);
    84	
    85	    // Respuesta AJAX
    86	    $respuesta = [
    87	        'mensaje'    => 'Datos actualizados correctamente.',
    88	        'cambio_url' => $cambio_url,
    89	        'url_nueva'  => $url_nueva,
    90	        'url_antigua'=> $url_antigua
    91	    ];
    92	
    93	    wp_send_json_success($respuesta);
    94	    exit;
    95	}
===== END includes/features/players/ajax/editar-jugador.php =====

===== BEGIN includes/features/players/ajax/invitar-jugador-manual.php =====
     1	<?php
     2	// Antiguo /includes/ajax/ajax-invitar-jugador-manual.php
     3	
     4	add_action('wp_ajax_str_invitar_jugador_manual', 'str_ajax_invitar_jugador_manual');
     5	
     6	function str_ajax_invitar_jugador_manual() {
     7	    if ( !current_user_can('administrator') && !current_user_can('cliente') ) {
     8	        wp_send_json_error(['mensaje' => 'No tienes permisos para añadir jugadores.']);
     9	        exit;
    10	    }
    11	
    12	    $nombre    = isset($_POST['nombre'])    ? sanitize_text_field($_POST['nombre'])     : '';
    13	    $apellidos = isset($_POST['apellidos']) ? sanitize_text_field($_POST['apellidos'])  : '';
    14	    $email     = isset($_POST['email'])     ? sanitize_email($_POST['email'])           : '';
    15	    $telefono  = isset($_POST['telefono'])  ? sanitize_text_field($_POST['telefono'])   : '';
    16	    $torneo_id = isset($_POST['torneo_id']) ? intval($_POST['torneo_id'])               : 0;
    17	
    18	    if (!$nombre || !$apellidos || !$email || !$torneo_id) {
    19	        wp_send_json_error(['mensaje' => 'Faltan datos obligatorios.']);
    20	        exit;
    21	    }
    22	
    23	    // Comprobar si ya existe jugador por email en este torneo
    24	    $args = [
    25	        'post_type'  => 'jugador_deportes',
    26	        'meta_query' => [
    27	            [
    28	                'key'     => 'email',
    29	                'value'   => $email,
    30	                'compare' => '='
    31	            ]
    32	        ],
    33	        'posts_per_page' => 1,
    34	    ];
    35	    $query = new WP_Query($args);
    36	
    37	    if ($query->have_posts()) {
    38	        $jugador_post = $query->posts[0];
    39	        // Añadir torneo si no está ya
    40	        $torneos = get_field('torneos_asociados', $jugador_post->ID) ?: [];
    41	        if (!in_array($torneo_id, $torneos)) {
    42	            $torneos[] = $torneo_id;
    43	            update_field('torneos_asociados', $torneos, $jugador_post->ID);
    44	        }
    45	        wp_send_json_success(['mensaje' => 'Jugador ya existía y se ha añadido al torneo.']);
    46	        exit;
    47	    }
    48	
    49	    // Si no existe, creamos el CPT jugador
    50	    $jugador_post_id = wp_insert_post([
    51	        'post_type'   => 'jugador_deportes',
    52	        'post_title'  => $nombre . ' ' . $apellidos,
    53	        'post_status' => 'publish'
    54	    ]);
    55	    update_field('nombre', $nombre, $jugador_post_id);
    56	    update_field('apellido', $apellidos, $jugador_post_id);
    57	    update_field('email', $email, $jugador_post_id);
    58	    update_field('telefono', $telefono, $jugador_post_id);
    59	    update_field('torneos_asociados', [$torneo_id], $jugador_post_id);
    60	
    61	    wp_send_json_success(['mensaje' => 'Jugador guardado correctamente.']);
    62	    exit;
    63	}
===== END includes/features/players/ajax/invitar-jugador-manual.php =====

===== BEGIN includes/features/players/ajax/invitar-jugador.php =====
     1	<?php
     2	// Antiguo /includes/ajax/ajax-invitar-jugador.php
     3	
     4	// Hook para usuarios logueados (administrador o cliente)
     5	add_action('wp_ajax_str_invitar_jugador', 'str_ajax_invitar_jugador');
     6	
     7	function str_ajax_invitar_jugador() {
     8	    if ( !current_user_can('administrator') && !current_user_can('cliente') ) {
     9	        wp_send_json_error(['mensaje' => 'No tienes permisos para invitar jugadores.']);
    10	        exit;
    11	    }
    12	
    13	    // Recoger y sanear datos del POST
    14	    $nombre    = isset($_POST['nombre'])    ? sanitize_text_field($_POST['nombre'])     : '';
    15	    $apellidos = isset($_POST['apellidos']) ? sanitize_text_field($_POST['apellidos'])  : '';
    16	    $email     = isset($_POST['email'])     ? sanitize_email($_POST['email'])           : '';
    17	    $telefono  = isset($_POST['telefono'])  ? sanitize_text_field($_POST['telefono'])   : '';
    18	    $asunto    = isset($_POST['asunto'])    ? sanitize_text_field($_POST['asunto'])     : 'Invitación a un torneo';
    19	    $mensaje   = isset($_POST['mensaje'])   ? sanitize_textarea_field($_POST['mensaje']): '';
    20	    $torneo_id = isset($_POST['torneo_id']) ? intval($_POST['torneo_id'])               : 0;
    21	
    22	    // Validación básica
    23	    if (!$nombre || !$apellidos || !$email || !$torneo_id || !$asunto) {
    24	        wp_send_json_error(['mensaje' => 'Faltan datos obligatorios.']);
    25	        exit;
    26	    }
    27	
    28	    // Comprobamos si el email ya existe como usuario
    29	    $user = get_user_by('email', $email);
    30	
    31	    if ($user) {
    32	        $cpt_query = new WP_Query([
    33	            'post_type'  => 'jugador_deportes',
    34	            'meta_query' => [
    35	                [
    36	                    'key'   => 'user_id',
    37	                    'value' => $user->ID,
    38	                    'compare' => '='
    39	                ]
    40	            ],
    41	            'posts_per_page' => 1,
    42	        ]);
    43	        if ($cpt_query->have_posts()) {
    44	            $jugador_post = $cpt_query->posts[0];
    45	            $torneos = get_field('torneos_asociados', $jugador_post->ID) ?: [];
    46	            if (!in_array($torneo_id, $torneos)) {
    47	                $torneos[] = $torneo_id;
    48	                update_field('torneos_asociados', $torneos, $jugador_post->ID);
    49	            }
    50	            wp_send_json_success(['mensaje' => 'El jugador ya está registrado. Se ha añadido al torneo.']);
    51	            exit;
    52	        }
    53	        // Si existe usuario pero no CPT, creamos el CPT y lo vinculamos
    54	        $jugador_post_id = wp_insert_post([
    55	            'post_type'   => 'jugador_deportes',
    56	            'post_title'  => $nombre . ' ' . $apellidos,
    57	            'post_status' => 'publish'
    58	        ]);
    59	        update_field('nombre', $nombre, $jugador_post_id);
    60	        update_field('apellido', $apellidos, $jugador_post_id);
    61	        update_field('email', $email, $jugador_post_id);
    62	        update_field('telefono', $telefono, $jugador_post_id);
    63	        update_field('user_id', $user->ID, $jugador_post_id);
    64	        update_field('torneos_asociados', [$torneo_id], $jugador_post_id);
    65	        update_field('estado_invitacion', 'aceptado', $jugador_post_id);
    66	        wp_send_json_success(['mensaje' => 'Usuario ya registrado. CPT jugador creado y añadido al torneo.']);
    67	        exit;
    68	    }
    69	
    70	    // Buscar si existe ya como CPT (sin usuario asociado)
    71	    $args = [
    72	        'post_type'  => 'jugador_deportes',
    73	        'meta_query' => [
    74	            [
    75	                'key'     => 'email',
    76	                'value'   => $email,
    77	                'compare' => '='
    78	            ]
    79	        ],
    80	        'posts_per_page' => 1,
    81	    ];
    82	    $query = new WP_Query($args);
    83	
    84	    if ($query->have_posts()) {
    85	        $jugador_post = $query->posts[0];
    86	
    87	        // 1. --- Genera SIEMPRE un nuevo token único para la invitación de este torneo ---
    88	        $token = wp_generate_password(24, false, false);
    89	        update_field('token_invitacion', $token, $jugador_post->ID);
    90	        update_field('fecha_envio_invitacion', current_time('Y-m-d H:i:s'), $jugador_post->ID);
    91	
    92	        // Añadir torneo si no está ya
    93	        $torneos = get_field('torneos_asociados', $jugador_post->ID) ?: [];
    94	        if (!in_array($torneo_id, $torneos)) {
    95	            $torneos[] = $torneo_id;
    96	            update_field('torneos_asociados', $torneos, $jugador_post->ID);
    97	        }
    98	
    99	        // --- Enlace único con parámetros: token, id y torneo
   100	        $enlace_registro = site_url('/registro-jugador/?token=' . urlencode($token) . '&id=' . $jugador_post->ID . '&torneo=' . $torneo_id);
   101	
   102	        $cuerpo_email = $mensaje . "\n\n";
   103	        $cuerpo_email .= "Haz clic aquí para unirte al torneo: " . $enlace_registro . "\n";
   104	        $cuerpo_email .= "\nSi no reconoces este mensaje, ignóralo.";
   105	
   106	        $headers = ['Content-Type: text/plain; charset=UTF-8'];
   107	        $mail_ok = wp_mail($email, $asunto, $cuerpo_email, $headers);
   108	
   109	        if ($mail_ok) {
   110	            update_field('estado_invitacion', 'enviado', $jugador_post->ID);
   111	            wp_send_json_success(['mensaje' => 'El jugador ya existía como CPT. Invitación de registro enviada por email.']);
   112	        } else {
   113	            update_field('estado_invitacion', 'fallo', $jugador_post->ID);
   114	            wp_send_json_error(['mensaje' => 'No se pudo enviar el email de invitación. Comprueba el servidor de correo.']);
   115	        }
   116	        exit;
   117	    }
   118	
   119	    // Si NO existe, creamos el CPT jugador
   120	    $jugador_post_id = wp_insert_post([
   121	        'post_type'   => 'jugador_deportes',
   122	        'post_title'  => $nombre . ' ' . $apellidos,
   123	        'post_status' => 'publish'
   124	    ]);
   125	    update_field('nombre', $nombre, $jugador_post_id);
   126	    update_field('apellido', $apellidos, $jugador_post_id);
   127	    update_field('email', $email, $jugador_post_id);
   128	    update_field('telefono', $telefono, $jugador_post_id);
   129	    update_field('torneos_asociados', [$torneo_id], $jugador_post_id);
   130	
   131	    // --- Token, estado, fecha ---
   132	    $token = wp_generate_password(24, false, false);
   133	    update_field('token_invitacion', $token, $jugador_post_id);
   134	    update_field('fecha_envio_invitacion', current_time('Y-m-d H:i:s'), $jugador_post_id);
   135	
   136	    // --- Enlace único con parámetros: token, id y torneo
   137	    $enlace_registro = site_url('/registro-jugador/?token=' . urlencode($token) . '&id=' . $jugador_post_id . '&torneo=' . $torneo_id);
   138	
   139	    $cuerpo_email = $mensaje . "\n\n";
   140	    $cuerpo_email .= "Haz clic aquí para unirte al torneo: " . $enlace_registro . "\n";
   141	    $cuerpo_email .= "\nSi no reconoces este mensaje, ignóralo.";
   142	
   143	    $headers = ['Content-Type: text/plain; charset=UTF-8'];
   144	    $mail_ok = wp_mail($email, $asunto, $cuerpo_email, $headers);
   145	
   146	    if ($mail_ok) {
   147	        update_field('estado_invitacion', 'enviado', $jugador_post_id);
   148	        wp_send_json_success(['mensaje' => 'Jugador añadido y email de invitación enviado.']);
   149	    } else {
   150	        update_field('estado_invitacion', 'fallo', $jugador_post_id);
   151	        wp_send_json_error(['mensaje' => 'No se pudo enviar el email de invitación. Comprueba el servidor de correo.']);
   152	    }
   153	    exit;
   154	}
===== END includes/features/players/ajax/invitar-jugador.php =====

===== BEGIN includes/features/players/ajax/registro-jugador.php =====
     1	<?php
     2	// Antiguo /includes/ajax/ajax-registro-jugador.php
     3	
     4	add_action('wp_ajax_nopriv_str_registro_jugador', 'str_ajax_registro_jugador');
     5	add_action('wp_ajax_str_registro_jugador', 'str_ajax_registro_jugador');
     6	
     7	function str_ajax_registro_jugador() {
     8	    // 1. Recoger datos POST
     9	    $token      = isset($_POST['token'])      ? sanitize_text_field($_POST['token'])      : '';
    10	    $jugador_id = isset($_POST['jugador_id']) ? intval($_POST['jugador_id'])              : 0;
    11	    $nombre     = isset($_POST['nombre'])     ? sanitize_text_field($_POST['nombre'])     : '';
    12	    $apellidos  = isset($_POST['apellidos'])  ? sanitize_text_field($_POST['apellidos'])  : '';
    13	    $email      = isset($_POST['email'])      ? sanitize_email($_POST['email'])           : '';
    14	    $telefono   = isset($_POST['telefono'])   ? sanitize_text_field($_POST['telefono'])   : '';
    15	    $password   = isset($_POST['password'])   ? $_POST['password']                        : '';
    16	
    17	    // 2. Validaciones mínimas
    18	    if (!$token || !$jugador_id || !$nombre || !$apellidos || !$email || !$password) {
    19	        wp_send_json_error(['mensaje' => 'Faltan datos obligatorios.']);
    20	        exit;
    21	    }
    22	
    23	    // 3. Buscar el post de jugador correspondiente
    24	    $jugador_post = get_post($jugador_id);
    25	    if (!$jugador_post || get_post_type($jugador_id) !== 'jugador_deportes') {
    26	        wp_send_json_error(['mensaje' => 'Token inválido o jugador no encontrado.']);
    27	        exit;
    28	    }
    29	
    30	    // 4. Validar token
    31	    $token_cpt = get_field('token_invitacion', $jugador_id);
    32	    if ($token !== $token_cpt) {
    33	        wp_send_json_error(['mensaje' => 'Token inválido o expirado.']);
    34	        exit;
    35	    }
    36	
    37	    // 5. Comprobar si ya existe usuario por email
    38	    if (email_exists($email)) {
    39	        wp_send_json_error(['mensaje' => 'Ya existe una cuenta con ese email. Si ya te registraste, inicia sesión.']);
    40	        exit;
    41	    }
    42	
    43	    // 6. Crear usuario de WP
    44	    $username = sanitize_user(strtolower(str_replace(' ', '', $nombre . $apellidos)));
    45	    $username = wp_unique_username($username, $email);
    46	
    47	    $user_id = wp_insert_user([
    48	        'user_login'    => $username,
    49	        'user_email'    => $email,
    50	        'user_pass'     => $password,
    51	        'display_name'  => $nombre . ' ' . $apellidos,
    52	        'first_name'    => $nombre,
    53	        'last_name'     => $apellidos,
    54	        'role'          => 'jugador' // Asegúrate de que este rol existe
    55	    ]);
    56	
    57	    if (is_wp_error($user_id)) {
    58	        wp_send_json_error(['mensaje' => 'No se pudo crear el usuario. ' . $user_id->get_error_message()]);
    59	        exit;
    60	    }
    61	
    62	    // 7. Actualizar el CPT jugador
    63	    update_field('nombre', $nombre, $jugador_id);
    64	    update_field('apellido', $apellidos, $jugador_id);
    65	    update_field('email', $email, $jugador_id);
    66	    update_field('telefono', $telefono, $jugador_id);
    67	    update_field('user_id', $user_id, $jugador_id); // Relación con el usuario
    68	    update_field('estado_invitacion', 'aceptado', $jugador_id);
    69	
    70	    // Opcional: Borrar token para que no se pueda reutilizar
    71	    update_field('token_invitacion', '', $jugador_id);
    72	
    73	    // 8. ENVIAR EMAIL DE BIENVENIDA
    74	    // Datos adicionales
    75	    $torneos = get_field('torneos_asociados', $jugador_id);
    76	    $redirect_url = home_url('/');
    77	    $nombre_torneo = '';
    78	    $fecha_torneo = '';
    79	    $hora_torneo = '';
    80	
    81	    if ($torneos && is_array($torneos) && count($torneos)) {
    82	        $torneo_id = $torneos[0];
    83	        $redirect_url = get_permalink($torneo_id);
    84	        $nombre_torneo = get_the_title($torneo_id);
    85	        $grupo_torneo = get_field('tipo_competicion_torneo', $torneo_id);
    86	        if (is_array($grupo_torneo)) {
    87	            $fecha_torneo = isset($grupo_torneo['fecha_torneo']) ? $grupo_torneo['fecha_torneo'] : '';
    88	            $hora_torneo  = isset($grupo_torneo['hora_inicio']) ? $grupo_torneo['hora_inicio'] : '';
    89	        }
    90	    }
    91	
    92	    // Mensaje de bienvenida
    93	    $asunto = 'Bienvenido a padelXperience';
    94	    $cuerpo = "¡Hola $nombre!\n\n";
    95	    $cuerpo .= "Te has registrado en padelXperience para poder jugar la competición \"$nombre_torneo\" el $fecha_torneo";
    96	    if ($hora_torneo) $cuerpo .= " a las $hora_torneo";
    97	    $cuerpo .= ".\n\n";
    98	    $cuerpo .= "Podrás consultar tus estadísticas, partidos e incluso apuntar los resultados. Tus datos no se compartirán con ningún tercero.\n";
    99	    $cuerpo .= "Una vez iniciado sesión con nosotros, podrás participar en otros torneos y deportes, teniendo siempre acceso a estadísticas y posibilidad de apuntar resultados de partidos.\n\n";
   100	    $cuerpo .= "👉 Accede a tu perfil: " . wp_login_url() . "\n";
   101	    if ($redirect_url) {
   102	        $cuerpo .= "👉 Accede al torneo: $redirect_url\n";
   103	    }
   104	    $cuerpo .= "\nGracias por confiar en nosotros.\n\nEquipo padelXperience";
   105	
   106	    $headers = ['Content-Type: text/plain; charset=UTF-8'];
   107	    $mail_ok = wp_mail($email, $asunto, $cuerpo, $headers);
   108	
   109	    // Si quieres, puedes guardar log del envío en el ACF del jugador
   110	    update_field('estado_bienvenida', $mail_ok ? 'enviado' : 'fallo', $jugador_id);
   111	
   112	    // 9. Redirección: Por ahora, redirigimos a la home o a la URL de torneo si tienes la info en el CPT
   113	    wp_send_json_success([
   114	        'mensaje' => '¡Registro completado!',
   115	        'redirect_url' => $redirect_url
   116	    ]);
   117	    exit;
   118	}
   119	
   120	// Utilidad: Generar un username único
   121	if (!function_exists('wp_unique_username')) {
   122	    function wp_unique_username($base, $email) {
   123	        $username = $base;
   124	        $i = 1;
   125	        while (username_exists($username) || email_exists($username)) {
   126	            $username = $base . $i;
   127	            $i++;
   128	        }
   129	        return $username;
   130	    }
   131	}
===== END includes/features/players/ajax/registro-jugador.php =====

===== BEGIN includes/features/players/index.css =====
     1	/* Antiguo /assets/css/form-invitacion-jugador.css */
     2	
     3	.modal-invitacion-jugador-overlay {
     4	    position: fixed;
     5	    top: 0; left: 0; width: 100vw; height: 100vh;
     6	    background: rgba(30,34,66,0.32);
     7	    z-index: 10099;
     8	    display: flex;
     9	    align-items: center;
    10	    justify-content: center;
    11	    transition: background 0.2s;
    12	}
    13	
    14	.modal-invitacion-jugador-contenedor {
    15	    background: #fff;
    16	    border-radius: 18px;
    17	    max-width: 520px;
    18	    width: 96vw;
    19	    padding: 38px 26px 26px 26px;
    20	    box-shadow: 0 6px 40px rgba(22,24,52,0.18);
    21	    position: relative;
    22	    margin: 0 auto;
    23	    animation: modalFadeIn 0.18s;
    24	}
    25	
    26	@keyframes modalFadeIn {
    27	    from { opacity:0; transform: scale(0.96);}
    28	    to { opacity:1; transform: scale(1);}
    29	}
    30	
    31	.cerrar-modal-invitacion-jugador {
    32	    position: absolute;
    33	    top: 14px; right: 14px;
    34	    background: none; border: none;
    35	    font-size: 2rem; color: #233e66;
    36	    font-weight: 700;
    37	    cursor: pointer;
    38	    transition: color 0.18s;
    39	}
    40	
    41	.cerrar-modal-invitacion-jugador:hover {
    42	    color: #1a2156;
    43	}
    44	
    45	.titulo-modal-invitacion {
    46	    font-size: 1.7rem;
    47	    font-weight: 700;
    48	    margin-bottom: 26px;
    49	    text-align: center;
    50	}
    51	
    52	.modal-invitacion-seleccion {
    53	    display: flex;
    54	    gap: 26px;
    55	    justify-content: center;
    56	    margin-bottom: 20px;
    57	}
    58	
    59	.modal-invitacion-bloque {
    60	    flex: 1;
    61	    background: #f6f7fb;
    62	    border-radius: 10px;
    63	    padding: 22px 12px 18px 12px;
    64	    text-align: center;
    65	    box-shadow: 0 1px 8px rgba(80,100,150,0.08);
    66	    position: relative;
    67	    display: flex;
    68	    flex-direction: column;
    69	    align-items: center;
    70	}
    71	
    72	.modal-invitacion-bloque h3 {
    73	    margin-bottom: 10px;
    74	    font-size: 1.2rem;
    75	    font-weight: 700;
    76	    color: #1a2156;
    77	}
    78	
    79	.modal-invitacion-cuadro {
    80	    font-size: 0.98rem;
    81	    color: #273855;
    82	    margin-bottom: 16px;
    83	    padding: 10px;
    84	    min-height: 65px;
    85	}
    86	
    87	.btn-seleccionar-modal-invitacion {
    88	    background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%);
    89	    color: #fff;
    90	    border: none;
    91	    font-weight: 600;
    92	    padding: 11px 22px;
    93	    border-radius: 9px;
    94	    box-shadow: 0 2px 9px rgba(60,60,100,0.08);
    95	    font-size: 1.05rem;
    96	    margin-top: 12px;
    97	    cursor: pointer;
    98	    transition: background 0.16s;
    99	}
   100	
   101	.btn-seleccionar-modal-invitacion:disabled {
   102	    background: #bfc8d7 !important;
   103	    color: #fff !important;
   104	    cursor: not-allowed;
   105	}
   106	
   107	.info-en-construccion {
   108	    display: block;
   109	    margin-top: 8px;
   110	    font-size: 0.93rem;
   111	    color: #b34242;
   112	    font-weight: 600;
   113	    opacity: 0.7;
   114	}
   115	
   116	@media (max-width: 600px) {
   117	    .modal-invitacion-jugador-contenedor { max-width: 97vw; padding: 20px 6vw 12px 6vw; }
   118	    .modal-invitacion-seleccion { flex-direction: column; gap: 14px; }
   119	}
   120	
   121	/* --- Formulario de invitaci贸n autom谩tica de jugadores --- */
   122	.form-invitacion-jugador-automatica {
   123	    padding: 18px 10px 12px 10px;
   124	    background: #f7f9fe;
   125	    border-radius: 11px;
   126	    box-shadow: 0 1px 8px rgba(80,100,150,0.08);
   127	    margin-top: 18px;
   128	    max-width: 410px;
   129	    margin-left: auto;
   130	    margin-right: auto;
   131	}
   132	
   133	.form-invitacion-jugador-automatica h3 {
   134	    font-size: 1.22rem;
   135	    font-weight: 700;
   136	    text-align: center;
   137	    margin-bottom: 16px;
   138	    color: #1a2156;
   139	}
   140	
   141	.form-invitacion-jugador-automatica .form-group {
   142	    margin-bottom: 15px;
   143	}
   144	
   145	.form-invitacion-jugador-automatica label {
   146	    font-size: 1.04rem;
   147	    font-weight: 500;
   148	    color: #1a2156;
   149	    margin-bottom: 3px;
   150	    display: block;
   151	}
   152	
   153	.form-invitacion-jugador-automatica input,
   154	.form-invitacion-jugador-automatica textarea {
   155	    width: 100%;
   156	    padding: 8px 12px;
   157	    border: 1px solid #d7e1ef;
   158	    border-radius: 8px;
   159	    font-size: 1rem;
   160	    font-family: inherit;
   161	    margin-top: 2px;
   162	    margin-bottom: 2px;
   163	    box-sizing: border-box;
   164	    background: #fff;
   165	}
   166	
   167	.form-invitacion-jugador-automatica textarea {
   168	    resize: vertical;
   169	    min-height: 54px;
   170	}
   171	
   172	.btn-enviar-invitacion {
   173	    background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%);
   174	    color: #fff;
   175	    border: none;
   176	    font-weight: 600;
   177	    padding: 11px 22px;
   178	    border-radius: 9px;
   179	    box-shadow: 0 2px 9px rgba(60,60,100,0.10);
   180	    font-size: 1.06rem;
   181	    margin-top: 8px;
   182	    cursor: pointer;
   183	    transition: background 0.17s;
   184	    margin-bottom: 6px;
   185	    width: 100%;
   186	}
   187	
   188	.btn-enviar-invitacion:disabled {
   189	    background: #bfc8d7 !important;
   190	    color: #fff !important;
   191	    cursor: not-allowed;
   192	}
   193	
   194	@media (max-width: 600px) {
   195	    .form-invitacion-jugador-automatica {
   196	        padding: 10px 2vw 8px 2vw;
   197	        max-width: 99vw;
   198	    }
   199	}
   200	
   201	
   202	/* Antiguo /assets/css/form-invitacion-jugador-manual.css */
   203	/* Contenedor principal del formulario manual */
   204	.form-invitacion-jugador-manual {
   205	    padding: 18px 16px 10px 16px;
   206	    background: #f7f9fe;
   207	    border-radius: 12px;
   208	    box-shadow: 0 2px 16px rgba(80,100,150,0.10);
   209	    margin: 0 auto;
   210	    max-width: 380px;
   211	    min-width: 250px;
   212	    font-family: inherit;
   213	}
   214	
   215	.form-invitacion-jugador-manual h3 {
   216	    font-size: 1.23rem;
   217	    font-weight: 700;
   218	    text-align: center;
   219	    margin-bottom: 16px;
   220	    color: #1a2156;
   221	}
   222	
   223	.form-invitacion-jugador-manual .form-group {
   224	    margin-bottom: 16px;
   225	}
   226	
   227	.form-invitacion-jugador-manual label {
   228	    font-size: 1rem;
   229	    font-weight: 500;
   230	    color: #1a2156;
   231	    margin-bottom: 3px;
   232	    display: block;
   233	}
   234	
   235	.form-invitacion-jugador-manual input,
   236	.form-invitacion-jugador-manual textarea {
   237	    width: 100%;
   238	    padding: 8px 12px;
   239	    border: 1px solid #d7e1ef;
   240	    border-radius: 8px;
   241	    font-size: 1rem;
   242	    font-family: inherit;
   243	    margin-top: 2px;
   244	    margin-bottom: 2px;
   245	    box-sizing: border-box;
   246	    background: #fff;
   247	}
   248	
   249	.form-invitacion-jugador-manual textarea {
   250	    resize: vertical;
   251	    min-height: 60px;
   252	}
   253	
   254	.form-invitacion-jugador-manual .btn-guardar-jugador-manual {
   255	    background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%);
   256	    color: #fff;
   257	    border: none;
   258	    font-weight: 600;
   259	    padding: 11px 22px;
   260	    border-radius: 9px;
   261	    box-shadow: 0 2px 9px rgba(60,60,100,0.08);
   262	    font-size: 1.06rem;
   263	    margin-top: 5px;
   264	    cursor: pointer;
   265	    transition: background 0.17s;
   266	}
   267	
   268	.form-invitacion-jugador-manual .btn-guardar-jugador-manual:hover {
   269	    background: #1747d7;
   270	}
   271	
   272	#mensaje-invitacion-jugador-manual {
   273	    margin-top: 12px;
   274	    font-size: 1rem;
   275	    color: #1a2156;
   276	    text-align: center;
   277	    min-height: 24px;
   278	}
   279	
   280	@media (max-width: 600px) {
   281	    .form-invitacion-jugador-manual {
   282	        padding: 12px 4vw 8px 4vw;
   283	        max-width: 98vw;
   284	    }
   285	}
   286	
   287	
===== END includes/features/players/index.css =====

===== BEGIN includes/features/players/index.js =====
     1	// Players (invitación) – compatible con legacy
     2	// (A1) Eliminado el disparador alternativo para evitar colisiones con otros botones.
     3	// Ahora SOLO abre el modal el botón #btn-abrir-modal-invitacion-jugador
     4	
     5	(function (w, d) {
     6	  'use strict';
     7	
     8	  function qs(sel, ctx) { return (ctx || d).querySelector(sel); }
     9	  function qsa(sel, ctx) { return Array.prototype.slice.call((ctx || d).querySelectorAll(sel)); }
    10	
    11	  function boot() {
    12	    var cfg     = w.str_players_ajax_obj || {};
    13	    var AJAX    = (cfg.ajax_url) || (w.str_ajax_obj && w.str_ajax_obj.ajax_url) || '';
    14	    var NONCE   = (cfg.nonce)    || (w.str_ajax_obj && w.str_ajax_obj.nonce)    || '';
    15	    var TORNEO_ID = parseInt(cfg.post_id || cfg.torneo_id || 0, 10) || 0;
    16	
    17	    var ACT = (cfg.actions || {});
    18	    var ACTIONS = {
    19	      CARGAR_MODAL: ACT.cargar_modal || 'saas_cargar_modal_invitacion',
    20	      FORM_AUTO:    ACT.form_auto    || 'saas_invitacion_automatica',
    21	      FORM_MANUAL:  ACT.form_manual  || 'saas_invitacion_manual',
    22	      ENVIAR_AUTO:  ACT.enviar_auto  || 'saas_invitacion_enviar',
    23	      ENVIAR_MAN:   ACT.enviar_manual|| 'saas_invitacion_enviar_manual',
    24	      REGISTRO:     ACT.registro_token || 'saas_registro_jugador'
    25	    };
    26	
    27	    console.log('[PLAYERS][BOOT]', { AJAX, NONCE, TORNEO_ID, ACTIONS, cfg });
    28	
    29	    // ─────────────────────────────────────────────────────────
    30	    // (A1) Solo este disparador: botón legacy del modal
    31	    // ─────────────────────────────────────────────────────────
    32	    var btnLegacy = d.getElementById('btn-abrir-modal-invitacion-jugador'); // único disparador
    33	
    34	    function abrirModalInvitacion(e) {
    35	      if (e) e.preventDefault();
    36	
    37	      var overlay = d.getElementById('modal-invitacion-jugador-overlay');
    38	      if (overlay) {
    39	        overlay.style.display = 'flex';
    40	        d.body.classList.add('modal-abierto-invitacion-jugador');
    41	        return;
    42	      }
    43	
    44	      // Cargar modal por AJAX
    45	      fetch(AJAX, {
    46	        method: 'POST',
    47	        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    48	        body: new URLSearchParams({
    49	          action: ACTIONS.CARGAR_MODAL,
    50	          torneo_id: String(TORNEO_ID || ''),
    51	          nonce: NONCE
    52	        })
    53	      })
    54	      .then(function (res) { return res.json(); })
    55	      .then(function (data) {
    56	        if (data && data.success && data.data && data.data.html) {
    57	          d.body.insertAdjacentHTML('beforeend', data.data.html);
    58	          iniciarEventosModal();
    59	        } else {
    60	          alert('No se pudo cargar el formulario de invitación. Intenta de nuevo.');
    61	          console.warn('[PLAYERS] Respuesta inválida al cargar modal:', data);
    62	        }
    63	      })
    64	      .catch(function (err) {
    65	        alert('Error de red al cargar el modal.');
    66	        console.error('[PLAYERS] Error AJAX cargar modal:', err);
    67	      });
    68	    }
    69	
    70	    function iniciarEventosModal() {
    71	      var overlay = d.getElementById('modal-invitacion-jugador-overlay');
    72	      var btnCerrar = d.getElementById('cerrar-modal-invitacion-jugador');
    73	      var btnAuto = d.getElementById('btn-seleccionar-automatica');
    74	      var btnManual = d.getElementById('btn-seleccionar-manual');
    75	      var contSel = qs('.modal-invitacion-seleccion');
    76	      var contDyn = d.getElementById('modal-invitacion-jugador-dinamico');
    77	
    78	      if (overlay) {
    79	        overlay.style.display = 'flex';
    80	        d.body.classList.add('modal-abierto-invitacion-jugador');
    81	      }
    82	
    83	      if (btnCerrar && overlay) {
    84	        btnCerrar.addEventListener('click', function () {
    85	          overlay.style.display = 'none';
    86	          d.body.classList.remove('modal-abierto-invitacion-jugador');
    87	          if (contSel) contSel.style.display = 'flex';
    88	          if (contDyn) contDyn.innerHTML = '';
    89	        });
    90	      }
    91	
    92	      if (overlay) {
    93	        overlay.addEventListener('click', function (e) {
    94	          if (e.target === overlay) {
    95	            overlay.style.display = 'none';
    96	            d.body.classList.remove('modal-abierto-invitacion-jugador');
    97	            if (contSel) contSel.style.display = 'flex';
    98	            if (contDyn) contDyn.innerHTML = '';
    99	          }
   100	        });
   101	      }
   102	
   103	      if (btnAuto && contSel && contDyn) {
   104	        btnAuto.addEventListener('click', function () {
   105	          contSel.style.display = 'none';
   106	          fetch(AJAX, {
   107	            method: 'POST',
   108	            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
   109	            body: new URLSearchParams({
   110	              action: ACTIONS.FORM_AUTO,
   111	              torneo_id: String(TORNEO_ID || '')
   112	            })
   113	          })
   114	          .then(function (res) { return res.json(); })
   115	          .then(function (data) {
   116	            if (data && data.success && data.data && data.data.html) {
   117	              contDyn.innerHTML = data.data.html;
   118	              var inp = d.getElementById('inv-torneo-id');
   119	              if (inp && TORNEO_ID) inp.value = String(TORNEO_ID);
   120	              if (typeof w.strIniciarFormularioInvitacion === 'function') {
   121	                w.strIniciarFormularioInvitacion(ACTIONS, AJAX, NONCE);
   122	              }
   123	            } else {
   124	              contDyn.innerHTML = '<div style="color:red;text-align:center;">Error al cargar el formulario.</div>';
   125	            }
   126	          })
   127	          .catch(function () {
   128	            contDyn.innerHTML = '<div style="color:red;text-align:center;">Error de red al cargar el formulario.</div>';
   129	          });
   130	        });
   131	      }
   132	
   133	      if (btnManual && contSel && contDyn) {
   134	        btnManual.addEventListener('click', function () {
   135	          contSel.style.display = 'none';
   136	          fetch(AJAX, {
   137	            method: 'POST',
   138	            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
   139	            body: new URLSearchParams({
   140	              action: ACTIONS.FORM_MANUAL,
   141	              torneo_id: String(TORNEO_ID || '')
   142	            })
   143	          })
   144	          .then(function (res) { return res.json(); })
   145	          .then(function (data) {
   146	            if (data && data.success && data.data && data.data.html) {
   147	              contDyn.innerHTML = data.data.html;
   148	              var inp = d.getElementById('inv-torneo-id-manual');
   149	              if (inp && TORNEO_ID) inp.value = String(TORNEO_ID);
   150	              if (typeof w.strIniciarFormularioInvitacionManual === 'function') {
   151	                w.strIniciarFormularioInvitacionManual(ACTIONS, AJAX, NONCE);
   152	              }
   153	            } else {
   154	              contDyn.innerHTML = '<div style="color:red;text-align:center;">Error al cargar el formulario manual.</div>';
   155	            }
   156	          })
   157	          .catch(function () {
   158	            contDyn.innerHTML = '<div style="color:red;text-align:center;">Error de red al cargar el formulario manual.</div>';
   159	          });
   160	        });
   161	      }
   162	    }
   163	
   164	    // Exponer helpers de envío para que usen las acciones correctas
   165	    w.strIniciarFormularioInvitacion = function (ACTIONS_FROM_PARENT, AJAX_URL, NONCE_TOKEN) {
   166	      var ACTIONS2 = ACTIONS_FROM_PARENT || ACTIONS;
   167	      var AJAX2 = AJAX_URL || AJAX;
   168	      var NONCE2 = NONCE_TOKEN || NONCE;
   169	
   170	      var form = d.getElementById('form-invitacion-jugador');
   171	      var mensaje = d.getElementById('mensaje-invitacion-jugador');
   172	      var btnEnviar = d.getElementById('btn-enviar-invitacion-jugador');
   173	
   174	      if (!form) { console.log('[PLAYERS][FORM AUTO] No encontrado'); return; }
   175	
   176	      form.addEventListener('submit', function (e) {
   177	        e.preventDefault();
   178	        if (mensaje) mensaje.textContent = '';
   179	
   180	        var nombre = form.querySelector('[name="nombre"]').value.trim();
   181	        var apellidos = form.querySelector('[name="apellidos"]').value.trim();
   182	        var email = form.querySelector('[name="email"]').value.trim();
   183	        var telefono = form.querySelector('[name="telefono"]').value.trim();
   184	        var mensajeTxt = form.querySelector('[name="mensaje"]').value.trim();
   185	        var asunto = form.querySelector('[name="asunto"]') ? form.querySelector('[name="asunto"]').value.trim() : '';
   186	        var torneo_id = form.querySelector('[name="torneo_id"]').value;
   187	
   188	        if (!nombre || !apellidos || !email || !asunto) {
   189	          if (mensaje) mensaje.textContent = 'Nombre, apellidos, email y asunto son obligatorios.';
   190	          return;
   191	        }
   192	
   193	        btnEnviar.disabled = true;
   194	        btnEnviar.textContent = 'Enviando...';
   195	
   196	        var fd = new FormData();
   197	        fd.append('action', ACTIONS2.ENVIAR_AUTO);
   198	        fd.append('nombre', nombre);
   199	        fd.append('apellidos', apellidos);
   200	        fd.append('email', email);
   201	        fd.append('telefono', telefono);
   202	        fd.append('asunto', asunto);
   203	        fd.append('mensaje', mensajeTxt);
   204	        fd.append('torneo_id', torneo_id);
   205	        fd.append('nonce', NONCE2);
   206	
   207	        fetch(AJAX2, { method: 'POST', body: fd })
   208	        .then(function (res) { return res.json(); })
   209	        .then(function (data) {
   210	          btnEnviar.disabled = false;
   211	          btnEnviar.textContent = 'Enviar invitación';
   212	          if (data && data.success) {
   213	            if (mensaje) mensaje.textContent = 'Invitación enviada correctamente.';
   214	            form.reset();
   215	          } else {
   216	            if (mensaje) mensaje.textContent = (data && data.data && data.data.mensaje) ? data.data.mensaje : 'Error al enviar la invitación.';
   217	          }
   218	        })
   219	        .catch(function (err) {
   220	          btnEnviar.disabled = false;
   221	          btnEnviar.textContent = 'Enviar invitación';
   222	          if (mensaje) mensaje.textContent = 'Error de red. Intenta de nuevo.';
   223	          console.error('[PLAYERS][FORM AUTO] Error:', err);
   224	        });
   225	      });
   226	    };
   227	
   228	    w.strIniciarFormularioInvitacionManual = function (ACTIONS_FROM_PARENT, AJAX_URL, NONCE_TOKEN) {
   229	      var ACTIONS2 = ACTIONS_FROM_PARENT || ACTIONS;
   230	      var AJAX2 = AJAX_URL || AJAX;
   231	      var NONCE2 = NONCE_TOKEN || NONCE;
   232	
   233	      var form = d.getElementById('form-invitacion-jugador-manual');
   234	      var mensaje = d.getElementById('mensaje-invitacion-jugador-manual');
   235	      var btnEnviar = d.getElementById('btn-enviar-invitacion-jugador-manual');
   236	
   237	      if (!form) { console.log('[PLAYERS][FORM MANUAL] No encontrado'); return; }
   238	
   239	      form.addEventListener('submit', function (e) {
   240	        e.preventDefault();
   241	        if (mensaje) mensaje.textContent = '';
   242	
   243	        var nombre = form.querySelector('[name="nombre"]').value.trim();
   244	        var apellidos = form.querySelector('[name="apellidos"]').value.trim();
   245	        var email = form.querySelector('[name="email"]').value.trim();
   246	        var telefono = form.querySelector('[name="telefono"]').value.trim();
   247	        var torneo_id = form.querySelector('[name="torneo_id"]').value;
   248	
   249	        if (!nombre || !apellidos || !email) {
   250	          if (mensaje) mensaje.textContent = 'Nombre, apellidos y email son obligatorios.';
   251	          return;
   252	        }
   253	
   254	        btnEnviar.disabled = true;
   255	        btnEnviar.textContent = 'Guardando...';
   256	
   257	        var fd = new FormData();
   258	        fd.append('action', ACTIONS2.ENVIAR_MAN);
   259	        fd.append('nombre', nombre);
   260	        fd.append('apellidos', apellidos);
   261	        fd.append('email', email);
   262	        fd.append('telefono', telefono);
   263	        fd.append('torneo_id', torneo_id);
   264	        fd.append('nonce', NONCE2);
   265	
   266	        fetch(AJAX2, { method: 'POST', body: fd })
   267	        .then(function (res) { return res.json(); })
   268	        .then(function (data) {
   269	          btnEnviar.disabled = false;
   270	          btnEnviar.textContent = 'Guardar jugador';
   271	          if (data && data.success) {
   272	            if (mensaje) mensaje.textContent = 'Jugador guardado correctamente.';
   273	            form.reset();
   274	          } else {
   275	            if (mensaje) mensaje.textContent = (data && data.data && data.data.mensaje) ? data.data.mensaje : 'Error al guardar el jugador.';
   276	          }
   277	        })
   278	        .catch(function (err) {
   279	          btnEnviar.disabled = false;
   280	          btnEnviar.textContent = 'Guardar jugador';
   281	          if (mensaje) mensaje.textContent = 'Error de red. Intenta de nuevo.';
   282	          console.error('[PLAYERS][FORM MANUAL] Error:', err);
   283	        });
   284	      });
   285	    };
   286	
   287	    // ─────────────────────────────────────────────────────────
   288	    // Listeners (solo el botón legítimo)
   289	    // ─────────────────────────────────────────────────────────
   290	    if (btnLegacy) btnLegacy.addEventListener('click', abrirModalInvitacion);
   291	
   292	    console.log('[PLAYERS][READY] Listener activo (legacy only)');
   293	  }
   294	
   295	  if (d.readyState === 'loading') {
   296	    d.addEventListener('DOMContentLoaded', boot);
   297	  } else {
   298	    boot();
   299	  }
   300	})(window, document);
===== END includes/features/players/index.js =====

===== BEGIN includes/features/players/index.php =====
     1	<?php
     2	// Plantilla Perfil de Jugador - SaaS Torneos de Raqueta
     3	// Antiguo: /templates/jugador/perfil-jugador.php
     4	// NOTA: Maquetado estático inicial. Aquí solo HTML y comentarios. La lógica dinámica vendrá después.
     5	
     6	?>
     7	<!-- CSS exclusivo del perfil de jugador -->
     8	<link rel="stylesheet" href="<?php echo STR_PLUGIN_URL . 'assets/css/perfil-jugador.css'; ?>">
     9	
    10	<div class="perfil-jugador-wrapper">
    11	    <!-- Cabecera con nombre del jugador -->
    12	    <div class="perfil-jugador-header">
    13	        <h2 id="nombre-jugador"><?php the_title(); ?></h2>
    14	    </div>
    15	
    16	    <!-- Tabla de estadísticas generales con selector de deporte -->
    17	    <div class="perfil-jugador-estadisticas">
    18	        <div class="perfil-jugador-filtros">
    19	            <label for="selector-deporte">Deporte</label>
    20	            <select id="selector-deporte" name="deporte">
    21	                <option value="padel">Pádel</option>
    22	                <option value="tenis">Tenis</option>
    23	                <option value="pickleball">Pickleball</option>
    24	                <option value="tenis_playa">Tenis Playa</option>
    25	            </select>
    26	        </div>
    27	        <table class="tabla-estadisticas">
    28	            <tr>
    29	                <td>Partidos jugados</td>
    30	                <td id="estadistica-jugados">x</td>
    31	            </tr>
    32	            <tr>
    33	                <td>Partidos ganados</td>
    34	                <td id="estadistica-ganados">x</td>
    35	                <td id="estadistica-ganados-porcentaje">%</td>
    36	            </tr>
    37	            <tr>
    38	                <td>Partidos perdidos</td>
    39	                <td id="estadistica-perdidos">x</td>
    40	                <td id="estadistica-perdidos-porcentaje">%</td>
    41	            </tr>
    42	            <tr>
    43	                <td>Racha partidos ganados</td>
    44	                <td id="racha-ganados">x</td>
    45	                <td id="racha-ganados-porcentaje">%</td>
    46	            </tr>
    47	            <tr>
    48	                <td>Racha partidos perdidos</td>
    49	                <td id="racha-perdidos">x</td>
    50	                <td id="racha-perdidos-porcentaje">%</td>
    51	            </tr>
    52	        </table>
    53	    </div>
    54	
    55	    <!-- Tabla/listado de competiciones jugadas -->
    56	    <div class="perfil-jugador-competiciones">
    57	        <div class="perfil-jugador-filtros">
    58	            <label for="filtro-deporte-comp">Deporte</label>
    59	            <select id="filtro-deporte-comp" name="deporte_comp">
    60	                <option value="todos">Todos</option>
    61	                <option value="padel">Pádel</option>
    62	                <option value="tenis">Tenis</option>
    63	                <option value="pickleball">Pickleball</option>
    64	                <option value="tenis_playa">Tenis Playa</option>
    65	            </select>
    66	            <label for="filtro-ano-comp">Año</label>
    67	            <select id="filtro-ano-comp" name="ano_comp">
    68	                <option value="todos">Todos</option>
    69	                <option value="2025">2025</option>
    70	                <option value="2024">2024</option>
    71	                <option value="2023">2023</option>
    72	                <!-- Añadir más años dinámicamente en el futuro -->
    73	            </select>
    74	        </div>
    75	        <table class="tabla-competiciones">
    76	            <thead>
    77	                <tr>
    78	                    <th>Competición</th>
    79	                    <th>Posición</th>
    80	                    <th>Fecha</th>
    81	                </tr>
    82	            </thead>
    83	            <tbody>
    84	                <!-- Ejemplo de fila -->
    85	                <tr>
    86	                    <td>Torneo Madrid</td>
    87	                    <td>3º grupo</td>
    88	                    <td>27/09/25</td>
    89	                </tr>
    90	                <tr>
    91	                    <td>Torneo Barcelona</td>
    92	                    <td>Ganador</td>
    93	                    <td>13/10/25</td>
    94	                </tr>
    95	                <!-- Aquí se cargarán dinámicamente las competiciones -->
    96	            </tbody>
    97	        </table>
    98	    </div>
    99	
   100	    <!-- Botón y pop-up de conectar jugador SOLO para administrador/cliente -->
   101	    <?php if ( current_user_can('manage_options') || current_user_can('cliente') ) : ?>
   102	        <button id="btn-conectar-jugador" type="button">Conectar jugador</button>
   103	
   104	        <!-- Modal de edición de jugador (oculto por defecto) -->
   105	        <div id="modal-editar-jugador" class="modal-editar-jugador" style="display:none;">
   106	            <div class="modal-contenido">
   107	                <button id="cerrar-modal-editar-jugador" class="modal-cerrar">&times;</button>
   108	                <h3>Editar datos del jugador</h3>
   109	                <form id="form-editar-jugador" autocomplete="off">
   110	                    <div class="campo-form">
   111	                        <label for="editar-nombre">Nombre</label>
   112	                        <input type="text" id="editar-nombre" name="nombre" required>
   113	                    </div>
   114	                    <div class="campo-form">
   115	                        <label for="editar-apellido">Apellido</label>
   116	                        <input type="text" id="editar-apellido" name="apellido" required>
   117	                    </div>
   118	                    <div class="campo-form">
   119	                        <label for="editar-email">Email</label>
   120	                        <input type="email" id="editar-email" name="email" required>
   121	                    </div>
   122	                    <div class="campo-form">
   123	                        <label for="editar-telefono">Teléfono</label>
   124	                        <input type="text" id="editar-telefono" name="telefono" required>
   125	                    </div>
   126	                    <button type="submit" id="guardar-edicion-jugador">Guardar cambios</button>
   127	                    <div id="mensaje-editar-jugador" style="margin-top:10px;"></div>
   128	                </form>
   129	            </div>
   130	        </div>
   131	    <?php endif; ?>
   132	
   133	    <!-- NOTA: La lógica dinámica, AJAX y JS se integrará en siguientes fases -->
   134	</div>
   135	<!-- Bloque JS y variables globales -->
   136	<script>
   137	window.str_ajax_obj = {
   138	    ajax_url: '<?php echo admin_url('admin-ajax.php'); ?>',
   139	    nonce: '<?php echo wp_create_nonce('str_nonce'); ?>'
   140	};
   141	window.strJugadorId = <?php echo get_the_ID(); ?>;
   142	</script>
   143	<script src="<?php echo STR_PLUGIN_URL . 'assets/js/perfil-jugador.js'; ?>"></script>
   144	
===== END includes/features/players/index.php =====

===== BEGIN includes/features/results/padel/ajax/guardar-resultado.php =====
     1	<?php
     2	// Antiguo /includes/ajax/ajax-guardar-resultado.php
     3	
     4	add_action('wp_ajax_str_guardar_resultado', 'str_guardar_resultado_callback');
     5	add_action('wp_ajax_nopriv_str_guardar_resultado', 'str_guardar_resultado_callback'); // Por si quieres dejarlo abierto a no logueados (NO RECOMENDADO)
     6	
     7	// Función de logs global
     8	if (!function_exists('str_escribir_log')) {
     9	    function str_escribir_log($mensaje, $origen = '') {
    10	        $ruta_log = WP_PLUGIN_DIR . '/saas-torneos-de-raqueta/debug-saas-torneos.log';
    11	        $timestamp = date('[Y-m-d H:i:s]');
    12	        $origen = $origen ? "[$origen]" : '';
    13	        if (is_array($mensaje) || is_object($mensaje)) {
    14	            $mensaje = print_r($mensaje, true);
    15	        }
    16	        $linea = "$timestamp $origen $mensaje" . PHP_EOL;
    17	        file_put_contents($ruta_log, $linea, FILE_APPEND);
    18	    }
    19	}
    20	
    21	function str_guardar_resultado_callback() {
    22	    str_escribir_log($_POST, 'AJAX [Recibido POST]');
    23	
    24	    $partido_id = isset($_POST['partido_id']) ? intval($_POST['partido_id']) : 0;
    25	    $sets = isset($_POST['sets']) ? json_decode(stripslashes($_POST['sets']), true) : [];
    26	    $current_user_id = get_current_user_id();
    27	
    28	    str_escribir_log([
    29	        'partido_id' => $partido_id,
    30	        'sets' => $sets,
    31	        'current_user_id' => $current_user_id
    32	    ], 'AJAX [Parsed POST]');
    33	
    34	    // Validaciones básicas
    35	    if (!$partido_id || !$sets || !is_array($sets)) {
    36	        str_escribir_log([
    37	            'msg' => "Guardado resultado fallido: datos no válidos.",
    38	            'partido_id' => $partido_id,
    39	            'sets' => $sets
    40	        ], 'AJAX [Validación datos]');
    41	        wp_send_json_error('Datos no válidos');
    42	    }
    43	
    44	    // Comprobar que el partido existe
    45	    $partido = get_post($partido_id);
    46	    if (!$partido || $partido->post_type !== 'partido') {
    47	        str_escribir_log("Guardado resultado fallido: partido inexistente. partido_id=$partido_id", 'AJAX [Validación partido]');
    48	        wp_send_json_error('Partido no encontrado');
    49	    }
    50	
    51	    // === DEBUG: MOSTRAR CAMPOS PRINCIPALES DEL PARTIDO ===
    52	    $estado = get_field('estado', $partido_id);
    53	    $tipo_partido = get_field('tipo_partido', $partido_id);
    54	    $competicion_padel = get_field('competicion_padel', $partido_id);
    55	    str_escribir_log([
    56	        'estado' => $estado,
    57	        'tipo_partido' => $tipo_partido,
    58	        'competicion_padel' => $competicion_padel
    59	    ], 'AJAX [Campos principales partido]');
    60	
    61	    // Comprobar permisos: solo jugadores implicados, organizador o admin pueden guardar resultado
    62	    $puede_editar = false;
    63	    if ($current_user_id) {
    64	        if ($tipo_partido === 'parejas') {
    65	            $p1 = get_field('pareja_1', $partido_id);
    66	            $p2 = get_field('pareja_2', $partido_id);
    67	            // Aquí podrías comprobar si el usuario pertenece a alguna pareja (a mejorar)
    68	            $puede_editar = true; // Simplificado para test
    69	        } else {
    70	            $j1 = get_field('jugador_1', $partido_id);
    71	            $j2 = get_field('jugador_2', $partido_id);
    72	            if ($current_user_id == $j1 || $current_user_id == $j2) $puede_editar = true;
    73	        }
    74	        if (current_user_can('administrator') || current_user_can('manage_options')) $puede_editar = true;
    75	    }
    76	    // También permitir al organizador (cliente), añade tu lógica aquí
    77	
    78	    str_escribir_log([
    79	        'partido_id' => $partido_id,
    80	        'puede_editar' => $puede_editar,
    81	        'user_id' => $current_user_id
    82	    ], 'AJAX [Permisos edición]');
    83	
    84	    if (!$puede_editar) {
    85	        str_escribir_log("Guardado resultado fallido: usuario sin permiso. partido_id=$partido_id, user_id=$current_user_id", 'AJAX [Permiso]');
    86	        wp_send_json_error('No tienes permiso para editar este partido');
    87	    }
    88	
    89	    // Validar estado del partido (bajar todo a minúsculas para robustez)
    90	    if (!in_array(strtolower($estado), ['pendiente', 'resultado propuesto', 'pendiente de validación'])) {
    91	        str_escribir_log("Guardado resultado fallido: estado no editable ($estado). partido_id=$partido_id", 'AJAX [Estado no editable]');
    92	        wp_send_json_error('Este partido no se puede editar');
    93	    }
    94	
    95	    // ------------------------
    96	    // VALIDACIÓN DE SETS (LÍMITES)
    97	    // ------------------------
    98	    $min_juegos = 0;
    99	    $max_juegos = 7; // Cambia este valor si necesitas otro límite
   100	
   101	    foreach ($sets as $idx => $set) {
   102	        // Cambios en los nombres de los subcampos para pádel
   103	        $j1 = isset($set['juegos_equipo_1']) ? intval($set['juegos_equipo_1']) : 0;
   104	        $j2 = isset($set['juegos_equipo_2']) ? intval($set['juegos_equipo_2']) : 0;
   105	
   106	        if ($j1 < $min_juegos || $j1 > $max_juegos || $j2 < $min_juegos || $j2 > $max_juegos) {
   107	            str_escribir_log([
   108	                'msg' => "Guardado resultado fallido: juegos fuera de rango en set $idx",
   109	                'j1' => $j1,
   110	                'j2' => $j2,
   111	                'partido_id' => $partido_id
   112	            ], 'AJAX [Límites juegos]');
   113	            wp_send_json_error('El número de juegos por set debe estar entre 0 y 7.');
   114	        }
   115	    }
   116	
   117	    // Log antes de guardar ACF
   118	    str_escribir_log([
   119	        'partido_id' => $partido_id,
   120	        'sets_guardar' => $sets
   121	    ], 'AJAX [Antes de update_field resultado_padel]');
   122	
   123	    // Guardar resultado en ACF (CAMBIO: resultado_padel)
   124	    update_field('resultado_padel', $sets, $partido_id);
   125	
   126	    // Cambiar estado
   127	    $nuevo_estado = 'Resultado propuesto';
   128	    update_field('estado', $nuevo_estado, $partido_id);
   129	
   130	    // Guardar usuario que propone
   131	    update_field('propuesto_por', $current_user_id, $partido_id);
   132	
   133	    // Log final después de guardar
   134	    str_escribir_log([
   135	        'msg' => "Resultado propuesto guardado",
   136	        'partido_id' => $partido_id,
   137	        'user_id' => $current_user_id,
   138	        'sets' => $sets
   139	    ], 'AJAX [Resultado guardado OK]');
   140	
   141	    wp_send_json_success('Resultado guardado. Ahora debe validarlo el rival o el organizador.');
   142	}
===== END includes/features/results/padel/ajax/guardar-resultado.php =====

===== BEGIN includes/features/results/padel/index.css =====
     1	/* Antiguo assets/css/form-resultado-partido.css */
     2	
     3	/* Wrapper principal */
     4	.str-partido-tabla-wrap {
     5	    max-width: 470px;
     6	    margin: 32px auto 24px auto;
     7	    padding: 16px 18px 24px 18px;
     8	    background: #fff;
     9	    border-radius: 18px;
    10	    box-shadow: 0 6px 32px rgba(36,58,94,0.07);
    11	    border: 1px solid #ececec;
    12	}
    13	
    14	.str-partido-resultado {
    15	    width: 100%;
    16	    border-collapse: collapse;
    17	    margin-bottom: 14px;
    18	    font-size: 1.08em;
    19	    background: #fafbfc;
    20	    border-radius: 12px;
    21	    overflow: hidden;
    22	}
    23	
    24	.str-partido-resultado th, .str-partido-resultado td {
    25	    padding: 10px 13px;
    26	    text-align: center;
    27	    border-bottom: 1px solid #eaeaea;
    28	}
    29	
    30	.str-partido-resultado th:first-child,
    31	.str-partido-resultado td:first-child {
    32	    text-align: left;
    33	    background: #f4f6f9;
    34	    font-weight: 600;
    35	    color: #36405a;
    36	    border-right: 1px solid #ececec;
    37	}
    38	
    39	.str-partido-resultado th {
    40	    background: #e7eefb;
    41	    color: #36405a;
    42	    font-weight: 500;
    43	}
    44	
    45	.str-partido-resultado tr:last-child td {
    46	    border-bottom: none;
    47	}
    48	
    49	.str-set-input {
    50	    width: 45px;
    51	    padding: 6px 0 6px 0;
    52	    font-size: 1.1em;
    53	    text-align: center;
    54	    border: 1px solid #bfc7d5;
    55	    border-radius: 7px;
    56	    background: #f7fafd;
    57	    transition: border-color 0.2s;
    58	}
    59	
    60	.str-set-input:focus {
    61	    outline: none;
    62	    border-color: #4d87ee;
    63	    background: #f0f7ff;
    64	}
    65	
    66	/* Estado ganador */
    67	.str-ganador {
    68	    color: #32b23c;
    69	    font-weight: 700;
    70	}
    71	
    72	/* Badge de resultado */
    73	.str-badge-confirmado {
    74	    background: #e6fff3;
    75	    color: #24b376;
    76	    font-weight: 600;
    77	    padding: 6px 18px;
    78	    border-radius: 18px;
    79	    margin-top: 12px;
    80	    display: inline-block;
    81	    font-size: 1.05em;
    82	}
    83	
    84	.str-msg-pendiente-validacion {
    85	    color: #e2ad13;
    86	    background: #fffbe7;
    87	    padding: 7px 16px;
    88	    border-radius: 16px;
    89	    font-weight: 500;
    90	    margin-top: 10px;
    91	    font-size: 1em;
    92	}
    93	
    94	.str-error {
    95	    color: #c24b4b;
    96	    background: #fff0f0;
    97	    padding: 8px 20px;
    98	    border-radius: 14px;
    99	    font-weight: 500;
   100	    margin-top: 14px;
   101	}
   102	
   103	.str-btn-confirmar-resultado {
   104	    background: #2563eb;
   105	    color: #fff;
   106	    border: none;
   107	    padding: 10px 32px;
   108	    border-radius: 18px;
   109	    font-weight: 600;
   110	    font-size: 1.06em;
   111	    cursor: pointer;
   112	    margin-top: 14px;
   113	    box-shadow: 0 3px 12px rgba(36,58,94,0.08);
   114	    transition: background 0.2s, box-shadow 0.2s;
   115	}
   116	.str-btn-confirmar-resultado:hover {
   117	    background: #1744a5;
   118	    box-shadow: 0 6px 24px rgba(36,58,94,0.12);
   119	}
   120	
   121	@media (max-width: 600px) {
   122	    .str-partido-tabla-wrap {
   123	        max-width: 98vw;
   124	        padding: 6vw 1vw 24px 1vw;
   125	    }
   126	    .str-partido-resultado th, .str-partido-resultado td {
   127	        padding: 7px 5px;
   128	        font-size: 0.97em;
   129	    }
   130	    .str-btn-confirmar-resultado {
   131	        width: 100%;
   132	        margin-top: 18px;
   133	    }
   134	}
===== END includes/features/results/padel/index.css =====

===== BEGIN includes/features/results/padel/index.js =====
     1	// Antiguo assets/js/form-resultado-partido.js
     2	document.addEventListener('DOMContentLoaded', function() {
     3	    const tablaWrap = document.querySelector('.str-partido-tabla-wrap');
     4	    if (!tablaWrap) {
     5	        console.log('[JS][form-resultado-partido] No hay tabla de partido en el DOM');
     6	        return;
     7	    }
     8	
     9	    // === Validación min/max para inputs de sets ===
    10	    tablaWrap.querySelectorAll('.str-set-input').forEach(input => {
    11	        input.addEventListener('input', function(e) {
    12	            let val = parseInt(this.value, 10);
    13	            if (isNaN(val)) {
    14	                this.value = '';
    15	                return;
    16	            }
    17	            if (val < 0) this.value = 0;
    18	            if (val > 7) this.value = 7;
    19	        });
    20	    });
    21	
    22	    // Botón de confirmar
    23	    const btnConfirmar = tablaWrap.querySelector('.str-btn-confirmar-resultado');
    24	    if (!btnConfirmar) {
    25	        console.log('[JS][form-resultado-partido] No hay botón de confirmar resultado');
    26	    }
    27	
    28	    if (btnConfirmar) {
    29	        btnConfirmar.addEventListener('click', function(e) {
    30	            e.preventDefault();
    31	
    32	            // Recopilar datos de sets (adaptado a los nombres correctos)
    33	            let sets = [];
    34	            let setsTemp = {};
    35	
    36	            // Recoger los inputs de juegos
    37	            tablaWrap.querySelectorAll('.str-set-input').forEach(input => {
    38	                let setIdx = input.dataset.set;
    39	                let equipo = input.dataset.equipo;
    40	                let valor = input.value;
    41	                if (!setsTemp[setIdx]) setsTemp[setIdx] = {};
    42	                setsTemp[setIdx][`juegos_equipo_${equipo}`] = valor;
    43	            });
    44	
    45	            // Recoger selects de tipo de set si existen
    46	            tablaWrap.querySelectorAll('.str-set-tipo').forEach((select, idx) => {
    47	                if (!setsTemp[idx]) setsTemp[idx] = {};
    48	                setsTemp[idx]['tipo_set'] = select.value;
    49	            });
    50	
    51	            // Convertir a array y filtrar sets vacíos
    52	            for (let i = 0; i < Object.keys(setsTemp).length; i++) {
    53	                let s = setsTemp[i];
    54	                // Solo añadir si hay algún valor
    55	                if (
    56	                    (s.juegos_equipo_1 && s.juegos_equipo_1 !== '') ||
    57	                    (s.juegos_equipo_2 && s.juegos_equipo_2 !== '')
    58	                ) {
    59	                    sets.push({
    60	                        juegos_equipo_1: s.juegos_equipo_1 || '',
    61	                        juegos_equipo_2: s.juegos_equipo_2 || '',
    62	                        tipo_set: s.tipo_set || 'Normal'
    63	                    });
    64	                }
    65	            }
    66	
    67	            console.log('[JS][form-resultado-partido] Sets a enviar:', sets);
    68	
    69	            if (sets.length === 0) {
    70	                alert('Debes introducir al menos un set con resultado.');
    71	                console.log('[JS][form-resultado-partido] No hay sets válidos');
    72	                return;
    73	            }
    74	
    75	            // Deshabilitar botón para evitar doble envío
    76	            btnConfirmar.disabled = true;
    77	            btnConfirmar.textContent = 'Guardando...';
    78	            console.log('[JS][form-resultado-partido] Enviando datos vía AJAX...', {
    79	                partido_id: btnConfirmar.dataset.partido,
    80	                sets: sets
    81	            });
    82	
    83	            // Preparar datos AJAX
    84	            const data = new FormData();
    85	            data.append('action', 'str_guardar_resultado');
    86	            data.append('partido_id', btnConfirmar.dataset.partido);
    87	            data.append('sets', JSON.stringify(sets));
    88	
    89	            // AJAX WordPress
    90	            fetch(str_ajax_obj.ajax_url, {
    91	                method: 'POST',
    92	                credentials: 'same-origin',
    93	                body: data
    94	            })
    95	            .then(response => response.json())
    96	            .then(res => {
    97	                btnConfirmar.disabled = false;
    98	                btnConfirmar.textContent = 'Confirmar resultado';
    99	                if (res.success) {
   100	                    console.log('[JS][form-resultado-partido] Resultado guardado correctamente', res);
   101	                    location.reload();
   102	                } else {
   103	                    console.log('[JS][form-resultado-partido] Error al guardar resultado', res);
   104	                    alert(res.data || 'Error al guardar el resultado');
   105	                }
   106	            })
   107	            .catch(err => {
   108	                btnConfirmar.disabled = false;
   109	                btnConfirmar.textContent = 'Confirmar resultado';
   110	                alert('Error de red al guardar resultado');
   111	                console.error('[JS][form-resultado-partido] Error de red', err);
   112	            });
   113	        });
   114	    }
   115	
   116	    // Puedes añadir aquí logs para eventos de UX dinámicos si vas a implementar sets dinámicos.
   117	});
===== END includes/features/results/padel/index.js =====

===== BEGIN includes/features/results/padel/view.php =====
     1	<?php
     2	/** Antes:  includes/forms/form-resultado-padel.php
     3	 * Formulario visual de introducción y validación de resultados de partido - Pádel
     4	 * SaaS Torneos de Raqueta
     5	 * Ruta: /includes/forms/form-resultado-padel.php
     6	 * 
     7	 * Recibe: $partido_id (ID del partido), $modo (opcional: 'ver' o 'editar')
     8	 */
     9	
    10	// Función para logs profesionales en debug-saas-torneos.log
    11	if (!function_exists('str_escribir_log')) {
    12	    function str_escribir_log($mensaje, $origen = '') {
    13	        $ruta_log = plugin_dir_path(dirname(__FILE__, 2)) . 'debug-saas-torneos.log';
    14	        $timestamp = date('[Y-m-d H:i:s]');
    15	        $origen = $origen ? "[$origen]" : '';
    16	        if (is_array($mensaje) || is_object($mensaje)) {
    17	            $mensaje = print_r($mensaje, true);
    18	        }
    19	        $linea = "$timestamp $origen $mensaje" . PHP_EOL;
    20	        file_put_contents($ruta_log, $linea, FILE_APPEND | LOCK_EX);
    21	    }
    22	}
    23	
    24	// --- LOG DE INICIO (Para saber si se incluye el archivo) ---
    25	str_escribir_log([
    26	    'INICIO_FORM' => true,
    27	    'partido_id' => isset($partido_id) ? $partido_id : 'NO DEFINIDO'
    28	], 'FORM_PADEL');
    29	
    30	// Comprobar seguridad básica
    31	if (!isset($partido_id) || !get_post($partido_id)) {
    32	    str_escribir_log('Partido no válido. $partido_id=' . (isset($partido_id) ? $partido_id : 'NO DEFINIDO'), 'FORM_PADEL');
    33	    echo '<div class="str-error">Partido no válido</div>';
    34	    return;
    35	}
    36	
    37	$partido = get_post($partido_id);
    38	$tipo_partido = get_field('tipo_partido', $partido_id); // 'parejas' o 'individual'
    39	
    40	// *** CAMPOS DEL GRUPO ACF DE PÁDEL ***
    41	$estado         = get_field('estado', $partido_id); // Select: pendiente, resultado_propuesto, etc.
    42	$ronda          = get_field('ronda', $partido_id); // Select: grupos, cuartos, etc.
    43	$ganador_id     = get_field('ganador', $partido_id); // Relationship, ID
    44	$propuesto_por  = get_field('propuesto_por', $partido_id); // User, ID
    45	$observaciones  = get_field('oberservaciones', $partido_id); // Textarea
    46	$resultado      = get_field('resultado_padel', $partido_id); // repeater array
    47	
    48	// Nueva relación para competición de pádel
    49	$competicion_padel = get_field('competicion_padel', $partido_id);
    50	
    51	// LOG después de cargar campos
    52	str_escribir_log([
    53	    'DESPUES_CAMPOS_ACF' => true,
    54	    'partido_id' => $partido_id,
    55	    'estado' => $estado,
    56	    'ronda' => $ronda,
    57	    'ganador_id' => $ganador_id,
    58	    'pareja_1' => get_field('pareja_1', $partido_id),
    59	    'pareja_2' => get_field('pareja_2', $partido_id),
    60	    'competicion_padel' => $competicion_padel,
    61	], 'FORM_PADEL');
    62	
    63	// Opciones de ronda predefinidas
    64	$rondas_disponibles = [
    65	    'Grupos'  => 'Grupos',
    66	    'Cuartos' => 'Cuartos',
    67	    'Semis'   => 'Semis',
    68	    'Final'   => 'Final',
    69	];
    70	
    71	// Obtener nombres de equipos/jugadores y sus IDs reales
    72	if (strtolower($tipo_partido) === 'parejas') {
    73	    $equipo1_id_arr = get_field('pareja_1', $partido_id);
    74	    $equipo1_id = is_array($equipo1_id_arr) ? $equipo1_id_arr[0] : $equipo1_id_arr;
    75	
    76	    $equipo2_id_arr = get_field('pareja_2', $partido_id);
    77	    $equipo2_id = is_array($equipo2_id_arr) ? $equipo2_id_arr[0] : $equipo2_id_arr;
    78	
    79	    $equipo1_nombre = $equipo1_id ? get_the_title($equipo1_id) : 'N/A';
    80	    $equipo2_nombre = $equipo2_id ? get_the_title($equipo2_id) : 'N/A';
    81	} else {
    82	    $equipo1_id = get_field('jugador_1', $partido_id);
    83	    $equipo2_id = get_field('jugador_2', $partido_id);
    84	    $equipo1_nombre = $equipo1_id ? get_the_title($equipo1_id) : 'N/A';
    85	    $equipo2_nombre = $equipo2_id ? get_the_title($equipo2_id) : 'N/A';
    86	}
    87	
    88	// Mostrar SIEMPRE 3 sets para pádel
    89	$max_sets = 3;
    90	// Inicializar sets vacíos
    91	$sets = [
    92	    0 => ['juegos_equipo_1'=>'', 'juegos_equipo_2'=>'', 'tipo_set'=>'Normal'],
    93	    1 => ['juegos_equipo_1'=>'', 'juegos_equipo_2'=>'', 'tipo_set'=>'Normal'],
    94	    2 => ['juegos_equipo_1'=>'', 'juegos_equipo_2'=>'', 'tipo_set'=>'Normal']
    95	];
    96	
    97	if (is_array($resultado)) {
    98	    foreach ($resultado as $idx => $set) {
    99	        if ($idx < $max_sets) {
   100	            $sets[$idx]['juegos_equipo_1'] = isset($set['juegos_equipo_1']) ? $set['juegos_equipo_1'] : '';
   101	            $sets[$idx]['juegos_equipo_2'] = isset($set['juegos_equipo_2']) ? $set['juegos_equipo_2'] : '';
   102	            $sets[$idx]['tipo_set']        = isset($set['tipo_set']) ? $set['tipo_set'] : 'Normal';
   103	        }
   104	    }
   105	}
   106	
   107	// Permisos y modo
   108	$current_user_id = get_current_user_id();
   109	$current_user_roles = function_exists('wp_get_current_user') ? wp_get_current_user()->roles : [];
   110	$puede_editar = true; // Temporalmente a true para pruebas
   111	
   112	// --- LOG PRE-RENDER: Confirmar datos principales antes de pintar la tabla ---
   113	str_escribir_log([
   114	    'RENDER_FORM' => true,
   115	    'partido_id'   => $partido_id,
   116	    'estado'       => $estado,
   117	    'puede_editar' => $puede_editar,
   118	    'equipo1_id'   => $equipo1_id,
   119	    'equipo1_nombre' => $equipo1_nombre,
   120	    'equipo2_id'   => $equipo2_id,
   121	    'equipo2_nombre' => $equipo2_nombre,
   122	    'sets'         => $sets
   123	], 'FORM_PADEL');
   124	
   125	// --- Mostrar el selector o badge de ronda --- //
   126	?>
   127	<div class="str-partido-ronda-select" style="margin-bottom: 16px;">
   128	    <strong>Ronda:</strong>
   129	    <?php if ($puede_editar && (in_array('administrator', $current_user_roles) || in_array('cliente', $current_user_roles))) : ?>
   130	        <form method="post" class="form-editar-ronda" action="">
   131	            <input type="hidden" name="action" value="str_actualizar_ronda">
   132	            <input type="hidden" name="partido_id" value="<?php echo esc_attr($partido_id); ?>">
   133	            <select name="ronda" class="select-ronda" style="padding:3px 6px;">
   134	                <?php foreach ($rondas_disponibles as $val => $label) : ?>
   135	                    <option value="<?php echo esc_attr($val); ?>" <?php selected($ronda, $val); ?>><?php echo esc_html($label); ?></option>
   136	                <?php endforeach; ?>
   137	            </select>
   138	            <button type="submit" style="margin-left:6px;padding:3px 10px;">Guardar</button>
   139	        </form>
   140	        <script>
   141	        document.addEventListener('DOMContentLoaded', function() {
   142	            document.querySelectorAll('.form-editar-ronda').forEach(form => {
   143	                form.addEventListener('submit', function(e){
   144	                    e.preventDefault();
   145	                    const fd = new FormData(form);
   146	                    fetch(str_ajax_obj.ajax_url, {
   147	                        method: 'POST',
   148	                        credentials: 'same-origin',
   149	                        body: fd
   150	                    }).then(res => res.json()).then(resp => {
   151	                        if (resp.success) location.reload();
   152	                        else alert('Error al actualizar la ronda');
   153	                    });
   154	                });
   155	            });
   156	        });
   157	        </script>
   158	    <?php else: ?>
   159	        <span style="margin-left:10px;"><?php echo esc_html($ronda ?: 'Sin definir'); ?></span>
   160	    <?php endif; ?>
   161	</div>
   162	
   163	<div class="str-partido-tabla-wrap">
   164	    <table class="str-partido-resultado">
   165	        <thead>
   166	            <tr>
   167	                <th></th>
   168	                <?php for ($i = 1; $i <= $max_sets; $i++): ?>
   169	                    <th>Set-<?php echo $i; ?></th>
   170	                <?php endfor; ?>
   171	            </tr>
   172	        </thead>
   173	        <tbody>
   174	            <tr>
   175	                <td class="<?php echo ($ganador_id == $equipo1_id) ? 'str-ganador' : ''; ?>">
   176	                    <?php echo esc_html($equipo1_nombre); ?>
   177	                </td>
   178	                <?php foreach ($sets as $k => $set): ?>
   179	                    <td>
   180	                        <?php if ($puede_editar && in_array(strtolower($estado), ['pendiente', 'resultado propuesto'])): ?>
   181	                            <input type="number"
   182	                                   class="str-set-input"
   183	                                   name="sets[<?php echo $k; ?>][juegos_equipo_1]"
   184	                                   value="<?php echo esc_attr($set['juegos_equipo_1']); ?>"
   185	                                   min="0" max="7"
   186	                                   <?php echo (strtolower($estado) == 'confirmado') ? 'readonly' : ''; ?>
   187	                                   data-set="<?php echo $k; ?>" data-equipo="1">
   188	                            <select name="sets[<?php echo $k; ?>][tipo_set]" class="str-set-tipo" style="margin-left:5px;">
   189	                                <option value="Normal" <?php selected($set['tipo_set'], 'Normal'); ?>>Normal</option>
   190	                                <option value="Tie-Break" <?php selected($set['tipo_set'], 'Tie-Break'); ?>>Tie-Break</option>
   191	                                <option value="Super Tie-Break" <?php selected($set['tipo_set'], 'Super Tie-Break'); ?>>Super Tie-Break</option>
   192	                            </select>
   193	                        <?php else: ?>
   194	                            <?php echo ($set['juegos_equipo_1'] !== '') ? esc_html($set['juegos_equipo_1']) : '-'; ?>
   195	                            <?php if ($set['tipo_set']) : ?>
   196	                                <span class="str-tipo-set-label">(<?php echo esc_html($set['tipo_set']); ?>)</span>
   197	                            <?php endif; ?>
   198	                        <?php endif; ?>
   199	                    </td>
   200	                <?php endforeach; ?>
   201	            </tr>
   202	            <tr>
   203	                <td class="<?php echo ($ganador_id == $equipo2_id) ? 'str-ganador' : ''; ?>">
   204	                    <?php echo esc_html($equipo2_nombre); ?>
   205	                </td>
   206	                <?php foreach ($sets as $k => $set): ?>
   207	                    <td>
   208	                        <?php if ($puede_editar && in_array(strtolower($estado), ['pendiente', 'resultado propuesto'])): ?>
   209	                            <input type="number"
   210	                                   class="str-set-input"
   211	                                   name="sets[<?php echo $k; ?>][juegos_equipo_2]"
   212	                                   value="<?php echo esc_attr($set['juegos_equipo_2']); ?>"
   213	                                   min="0" max="7"
   214	                                   <?php echo (strtolower($estado) == 'confirmado') ? 'readonly' : ''; ?>
   215	                                   data-set="<?php echo $k; ?>" data-equipo="2">
   216	                        <?php else: ?>
   217	                            <?php echo ($set['juegos_equipo_2'] !== '') ? esc_html($set['juegos_equipo_2']) : '-'; ?>
   218	                        <?php endif; ?>
   219	                    </td>
   220	                <?php endforeach; ?>
   221	            </tr>
   222	        </tbody>
   223	    </table>
   224	    <?php if ($puede_editar && in_array(strtolower($estado), ['pendiente', 'resultado propuesto'])): ?>
   225	        <button class="str-btn-confirmar-resultado" data-partido="<?php echo esc_attr($partido_id); ?>">
   226	            Confirmar resultado
   227	        </button>
   228	    <?php elseif (strtolower($estado) === 'pendiente de validación'): ?>
   229	        <div class="str-msg-pendiente-validacion">
   230	            Resultado pendiente de validación por el rival.
   231	        </div>
   232	    <?php elseif (strtolower($estado) === 'confirmado'): ?>
   233	        <div class="str-badge-confirmado">Resultado confirmado</div>
   234	    <?php endif; ?>
   235	</div>
   236	
   237	<!-- Puedes incluir aquí el campo observaciones si lo deseas -->
   238	<?php if ($observaciones): ?>
   239	    <div class="str-observaciones-partido">
   240	        <strong>Observaciones:</strong> <?php echo esc_html($observaciones); ?>
   241	    </div>
   242	<?php endif; ?>
   243	
   244	<?php
   245	// Incluir aquí scripts JS solo si hace falta (o bien encolarlo globalmente)
   246	?>
===== END includes/features/results/padel/view.php =====

===== BEGIN includes/features/simulator/ajax/guardar-simulacion.php =====
     1	<?php
     2	/**
     3	 * AJAX: Guardar snapshot de simulación (temporal)
     4	 * Ruta: includes/features/simulator/ajax/guardar-simulacion.php
     5	 */
     6	
     7	if (!defined('ABSPATH')) { exit; }
     8	
     9	/**
    10	 * Logger básico al archivo debug-saas-torneos.log del plugin.
    11	 * (Reutilizamos misma firma)
    12	 */
    13	if (!function_exists('str_saas_log')) {
    14	    function str_saas_log($message, $context = []) {
    15	        $upload_dir = wp_upload_dir();
    16	        $base = dirname(dirname(__DIR__)); // .../includes -> base del plugin
    17	        $log_path = trailingslashit($base) . 'debug-saas-torneos.log';
    18	        if (!is_writable($base)) {
    19	            $log_path = trailingslashit($upload_dir['basedir']) . 'debug-saas-torneos.log';
    20	        }
    21	        $line = '[' . date('Y-m-d H:i:s') . '] ' . (is_string($message) ? $message : wp_json_encode($message, JSON_UNESCAPED_UNICODE));
    22	        if (!empty($context)) {
    23	            $line .= ' | ' . wp_json_encode($context, JSON_UNESCAPED_UNICODE);
    24	        }
    25	        $line .= PHP_EOL;
    26	        @file_put_contents($log_path, $line, FILE_APPEND);
    27	    }
    28	}
    29	
    30	/**
    31	 * Helpers (solo si no existen ya)
    32	 */
    33	if (!function_exists('str_coste_para_grupos')) {
    34	    function str_coste_para_grupos($P, $G, $target_size, $es_premios_por_grupo, $fase_final, $plazas_por_fase) {
    35	        if ($G < 1) return PHP_INT_MAX;
    36	        $base  = intdiv($P, $G);
    37	        $resto = $P % $G;
    38	
    39	        $min_size = $base;
    40	        $max_size = $base + ($resto > 0 ? 1 : 0);
    41	
    42	        $dev_min = ($min_size - $target_size);
    43	        $dev_max = ($max_size - $target_size);
    44	        $cost_tamano = ($G - $resto) * ($dev_min * $dev_min) + $resto * ($dev_max * $dev_max);
    45	
    46	        $cost_fase = 0;
    47	        if ($es_premios_por_grupo) {
    48	            $plazas_req = isset($plazas_por_fase[$fase_final]) ? $plazas_por_fase[$fase_final] : 2;
    49	            if ($min_size < $plazas_req) {
    50	                $cost_fase = 100000 * ($plazas_req - $min_size);
    51	            }
    52	        }
    53	
    54	        $cost_tiny = 0;
    55	        if ($min_size < 3) {
    56	            $cost_tiny = 200 * (3 - $min_size);
    57	        }
    58	
    59	        $pref_g = 4;
    60	        $cost_pref_g = 2 * (($G - $pref_g) * ($G - $pref_g));
    61	
    62	        return $cost_tamano + $cost_fase + $cost_tiny + $cost_pref_g;
    63	    }
    64	}
    65	if (!function_exists('str_elegir_num_grupos_optimo')) {
    66	    function str_elegir_num_grupos_optimo($P, $es_premios_por_grupo, $fase_final, $plazas_por_fase) {
    67	        $target_size = 4;
    68	        $max_candidatos = max(1, min(12, $P));
    69	        $mejorG = 1;
    70	        $mejorCoste = PHP_INT_MAX;
    71	
    72	        for ($G = 1; $G <= $max_candidatos; $G++) {
    73	            $coste = str_coste_para_grupos($P, $G, $target_size, $es_premios_por_grupo, $fase_final, $plazas_por_fase);
    74	            if ($coste < $mejorCoste) {
    75	                $mejorCoste = $coste;
    76	                $mejorG = $G;
    77	            }
    78	        }
    79	        return max(1, (int) $mejorG);
    80	    }
    81	}
    82	
    83	/**
    84	 * Hooks AJAX
    85	 */
    86	add_action('wp_ajax_str_guardar_simulacion', 'str_guardar_simulacion');
    87	// add_action('wp_ajax_nopriv_str_guardar_simulacion', 'str_guardar_simulacion'); // si lo quieres público
    88	
    89	/**
    90	 * Handler: guarda snapshot de la simulación en un transient (48h)
    91	 */
    92	if (!function_exists('str_guardar_simulacion')) {
    93	function str_guardar_simulacion() {
    94	    try {
    95	        // Seguridad básica
    96	        if (!is_user_logged_in()) {
    97	            wp_send_json_error(['msg' => 'Permisos insuficientes (login requerido).'], 403);
    98	        }
    99	        if (!isset($_POST['_ajax_nonce']) || !wp_verify_nonce(sanitize_text_field($_POST['_ajax_nonce']), 'str_nonce')) {
   100	            wp_send_json_error(['msg' => 'Nonce inválido. Recarga la página.'], 400);
   101	        }
   102	        if (!current_user_can('read')) {
   103	            wp_send_json_error(['msg' => 'Permisos insuficientes.'], 403);
   104	        }
   105	
   106	        // Entradas mínimas
   107	        $n_jugadores     = isset($_POST['n_jugadores']) ? absint($_POST['n_jugadores']) : 0;
   108	        $n_grupos_input  = isset($_POST['n_grupos'])    ? absint($_POST['n_grupos'])    : 0;
   109	        $fase_final_raw  = isset($_POST['fase_final'])  ? sanitize_text_field($_POST['fase_final']) : 'final';
   110	        $organizar_final = isset($_POST['organizar_final']) ? sanitize_text_field($_POST['organizar_final']) : 'premios_grupo';
   111	
   112	        if ($n_jugadores < 2) {
   113	            wp_send_json_error(['msg' => 'Introduce un número de jugadores válido (mínimo 2).'], 400);
   114	        }
   115	
   116	        // Siempre por parejas
   117	        $P = (int) floor($n_jugadores / 2);
   118	        if ($P < 2) {
   119	            wp_send_json_error(['msg' => 'No hay suficientes parejas para guardar la simulación.'], 400);
   120	        }
   121	
   122	        // Normalizar fase y modo
   123	        $fase_final = strtolower($fase_final_raw); // 'final' | 'semifinal' | 'cuartos' | 'octavos'
   124	        $org_val    = strtolower($organizar_final);
   125	        $es_premios_por_grupo = (strpos($org_val, 'grupo') !== false || $org_val === 'premios' || $org_val === 'premios_grupo');
   126	
   127	        // Plazas por fase
   128	        $plazas_por_fase = [
   129	            'final'     => 2,
   130	            'semifinal' => 4,
   131	            'cuartos'   => 8,
   132	            'octavos'   => 16,
   133	        ];
   134	
   135	        // Elegir nº de grupos efectivo
   136	        if ($n_grupos_input > 0) {
   137	            $n_grupos = max(1, $n_grupos_input);
   138	            $modo_grupos = 'fijo_cliente';
   139	        } else {
   140	            $n_grupos = str_elegir_num_grupos_optimo($P, $es_premios_por_grupo, $fase_final, $plazas_por_fase);
   141	            $modo_grupos = 'auto_optimo';
   142	        }
   143	
   144	        // Generar grupos equilibrados con placeholders
   145	        $base   = intdiv($P, $n_grupos);
   146	        $resto  = $P % $n_grupos;
   147	        $letras = range('A', 'Z');
   148	        $grupos = [];
   149	        $indice = 1;
   150	
   151	        for ($i = 0; $i < $n_grupos; $i++) {
   152	            $tam = $base + ($i < $resto ? 1 : 0);
   153	            $nombre = isset($letras[$i]) ? $letras[$i] : 'G' . ($i + 1);
   154	            $participantes = [];
   155	            for ($p = 0; $p < $tam; $p++) {
   156	                $participantes[] = "Pareja {$indice}";
   157	                $indice++;
   158	            }
   159	            $grupos[] = [
   160	                'nombre' => $nombre,
   161	                'tam' => $tam,
   162	                'participantes' => $participantes,
   163	            ];
   164	        }
   165	
   166	        // Metadatos útiles
   167	        $tam_min_grupo = min(array_map(function($g){ return (int)$g['tam']; }, $grupos));
   168	        $partidos_garantizados_min = max(0, $tam_min_grupo - 1);
   169	
   170	        // Semilla simple reproducible
   171	        $semilla = wp_generate_uuid4();
   172	
   173	        // Snapshot
   174	        $snapshot = [
   175	            'tipo_torneo'          => 'parejas',
   176	            'n_jugadores'          => $n_jugadores,
   177	            'n_parejas_calc'       => $P,
   178	            'n_grupos'             => $n_grupos,
   179	            'fase_final'           => $fase_final,
   180	            'cuadro_opcion'        => $es_premios_por_grupo ? 'premios_grupo' : 'mezclar',
   181	            'grupos'               => $grupos,
   182	            'partidos_garantizados_min' => $partidos_garantizados_min,
   183	            'semilla'              => $semilla,
   184	            'modo_grupos'          => $modo_grupos,
   185	            'user_id'              => get_current_user_id(),
   186	            'created_at'           => current_time('mysql'),
   187	            'status'               => 'draft',
   188	        ];
   189	
   190	        // Guardar snapshot en transient (48 horas)
   191	        $sim_id = 's' . wp_generate_password(10, false, false);
   192	        $transient_key = 'str_simulacion_' . $sim_id;
   193	
   194	        $json = wp_json_encode($snapshot, JSON_UNESCAPED_UNICODE);
   195	        $ok = set_transient($transient_key, $json, 48 * HOUR_IN_SECONDS);
   196	
   197	        if (!$ok) {
   198	            // Fallback: opción autoload=no
   199	            $ok_option = update_option($transient_key, $json, false);
   200	            if (!$ok_option) {
   201	                wp_send_json_error(['msg' => 'No se pudo guardar la simulación (almacenamiento temporal).'], 500);
   202	            }
   203	        }
   204	
   205	        str_saas_log('SIMULACION guardada (transient)', [
   206	            'simulacion_id' => $sim_id,
   207	            'user_id'       => get_current_user_id(),
   208	            'n_jugadores'   => $n_jugadores,
   209	            'P'             => $P,
   210	            'n_grupos'      => $n_grupos,
   211	            'fase_final'    => $fase_final,
   212	            'modo'          => $snapshot['cuadro_opcion'],
   213	            'tam_min'       => $tam_min_grupo,
   214	        ]);
   215	
   216	        wp_send_json_success([
   217	            'simulacion_id' => $sim_id,
   218	            'prefill' => [
   219	                'deporte'         => 'padel',
   220	                'tipo_competicion'=> 'grupos_fase_final',
   221	                'formato'         => 'round_robin',
   222	                'n_jugadores'     => $n_jugadores,
   223	                'n_parejas'       => $P,
   224	                'n_grupos'        => $n_grupos,
   225	                'fase_final'      => $fase_final,
   226	                'modo_final'      => $snapshot['cuadro_opcion'],
   227	            ],
   228	        ]);
   229	
   230	    } catch (\Throwable $e) {
   231	        str_saas_log('SIMULACION excepcion', ['error' => $e->getMessage(), 'trace' => $e->getTraceAsString()]);
   232	        wp_send_json_error(['msg' => 'Error interno al guardar la simulación.'], 500);
   233	    }
   234	}}
===== END includes/features/simulator/ajax/guardar-simulacion.php =====

===== BEGIN includes/features/simulator/ajax/simular-torneo.php =====
     1	<?php
     2	/**
     3	 * AJAX: Simular Torneo (SIEMPRE por parejas)
     4	 * Ruta: includes/features/simulator/ajax/simular-torneo.php
     5	 */
     6	
     7	if (!defined('ABSPATH')) { exit; }
     8	
     9	/**
    10	 * Logger básico al archivo debug-saas-torneos.log del plugin.
    11	 */
    12	if (!function_exists('str_saas_log')) {
    13	    function str_saas_log($message, $context = []) {
    14	        $upload_dir = wp_upload_dir();
    15	        $base = dirname(dirname(__DIR__)); // .../includes -> base del plugin
    16	        $log_path = trailingslashit($base) . 'debug-saas-torneos.log';
    17	        if (!is_writable($base)) {
    18	            $log_path = trailingslashit($upload_dir['basedir']) . 'debug-saas-torneos.log';
    19	        }
    20	        $line = '[' . date('Y-m-d H:i:s') . '] ' . (is_string($message) ? $message : wp_json_encode($message, JSON_UNESCAPED_UNICODE));
    21	        if (!empty($context)) {
    22	            $line .= ' | ' . wp_json_encode($context, JSON_UNESCAPED_UNICODE);
    23	        }
    24	        $line .= PHP_EOL;
    25	        @file_put_contents($log_path, $line, FILE_APPEND);
    26	    }
    27	}
    28	
    29	/**
    30	 * Helpers compartidos (protegidos contra redeclare)
    31	 */
    32	if (!function_exists('str_coste_para_grupos')) {
    33	    /**
    34	     * Coste para un nº de grupos dado (heurística)
    35	     */
    36	    function str_coste_para_grupos($P, $G, $target_size, $es_premios_por_grupo, $fase_final, $plazas_por_fase) {
    37	        if ($G < 1) return PHP_INT_MAX;
    38	
    39	        $base  = intdiv($P, $G);
    40	        $resto = $P % $G;
    41	
    42	        $min_size = $base;
    43	        $max_size = $base + ($resto > 0 ? 1 : 0);
    44	
    45	        // Desviación respecto al objetivo
    46	        $dev_min = ($min_size - $target_size);
    47	        $dev_max = ($max_size - $target_size);
    48	        $cost_tamano = ($G - $resto) * ($dev_min * $dev_min) + $resto * ($dev_max * $dev_max);
    49	
    50	        // Penalización por incompatibilidad de fase (solo premios por grupo)
    51	        $cost_fase = 0;
    52	        if ($es_premios_por_grupo) {
    53	            $plazas_req = isset($plazas_por_fase[$fase_final]) ? $plazas_por_fase[$fase_final] : 2;
    54	            if ($min_size < $plazas_req) {
    55	                $cost_fase = 100000 * ($plazas_req - $min_size);
    56	            }
    57	        }
    58	
    59	        // Penalización por grupos demasiado pequeños
    60	        $cost_tiny = 0;
    61	        if ($min_size < 3) {
    62	            $cost_tiny = 200 * (3 - $min_size);
    63	        }
    64	
    65	        // Preferencia ligera por nº de grupos cercanos a 4
    66	        $pref_g = 4;
    67	        $cost_pref_g = 2 * (($G - $pref_g) * ($G - $pref_g));
    68	
    69	        return $cost_tamano + $cost_fase + $cost_tiny + $cost_pref_g;
    70	    }
    71	}
    72	
    73	if (!function_exists('str_elegir_num_grupos_optimo')) {
    74	    /**
    75	     * Elección del nº de grupos óptimo cuando el cliente no lo fija.
    76	     */
    77	    function str_elegir_num_grupos_optimo($P, $es_premios_por_grupo, $fase_final, $plazas_por_fase) {
    78	        $target_size = 4; // preferencia general
    79	        $max_candidatos = max(1, min(12, $P));
    80	        $mejorG = 1;
    81	        $mejorCoste = PHP_INT_MAX;
    82	
    83	        for ($G = 1; $G <= $max_candidatos; $G++) {
    84	            $coste = str_coste_para_grupos($P, $G, $target_size, $es_premios_por_grupo, $fase_final, $plazas_por_fase);
    85	            if ($coste < $mejorCoste) {
    86	                $mejorCoste = $coste;
    87	                $mejorG = $G;
    88	            }
    89	        }
    90	        return max(1, (int) $mejorG);
    91	    }
    92	}
    93	
    94	if (!function_exists('generar_mensajes_sugerencias')) {
    95	    /**
    96	     * Mensajes educativos / sugerencias informativas
    97	     */
    98	    function generar_mensajes_sugerencias($grupos, $fase_final, $org_val) {
    99	        $total_grupos = count($grupos);
   100	        $k_min = min(array_map(function($g){ return (int)$g['tam']; }, $grupos));
   101	        $partidos_min_por_grupo = max(0, $k_min - 1);
   102	
   103	        $modo = (strpos(strtolower($org_val), 'grupo') !== false) ? 'Premios por grupo' : 'Mezclar grupos';
   104	        $fase_txt = ucfirst($fase_final);
   105	
   106	        $msg  = '<div class="simulador-msg-sugerencias">';
   107	        $msg .= '<div class="msg-ok">Distribución realizada: <b>' . esc_html($total_grupos) . ' grupo(s)</b> de parejas. ';
   108	        $msg .= 'Partidos garantizados por pareja en el grupo más pequeño: <b>' . esc_html($partidos_min_por_grupo) . '</b>.</div>';
   109	        $msg .= '<div class="msg-warning">Modo de cuadro final: <b>' . esc_html($modo) . '</b> | Fase final: <b>' . esc_html($fase_txt) . '</b>.</div>';
   110	        $msg .= '</div>';
   111	
   112	        return $msg;
   113	    }
   114	}
   115	
   116	if (!function_exists('render_cuadro_por_grupo')) {
   117	    /**
   118	     * Render: cuadro por grupo
   119	     */
   120	    function render_cuadro_por_grupo($letra_grupo, $fase_final) {
   121	        $slots = [];
   122	        switch ($fase_final) {
   123	            case 'octavos':
   124	                $slots = [
   125	                    ['1º Grupo ' . $letra_grupo, '16º Grupo ' . $letra_grupo],
   126	                    ['8º Grupo ' . $letra_grupo, '9º Grupo ' . $letra_grupo],
   127	                    ['5º Grupo ' . $letra_grupo, '12º Grupo ' . $letra_grupo],
   128	                    ['4º Grupo ' . $letra_grupo, '13º Grupo ' . $letra_grupo],
   129	                    ['6º Grupo ' . $letra_grupo, '11º Grupo ' . $letra_grupo],
   130	                    ['3º Grupo ' . $letra_grupo, '14º Grupo ' . $letra_grupo],
   131	                    ['7º Grupo ' . $letra_grupo, '10º Grupo ' . $letra_grupo],
   132	                    ['2º Grupo ' . $letra_grupo, '15º Grupo ' . $letra_grupo],
   133	                ];
   134	                break;
   135	            case 'cuartos':
   136	                $slots = [
   137	                    ['1º Grupo ' . $letra_grupo, '8º Grupo ' . $letra_grupo],
   138	                    ['4º Grupo ' . $letra_grupo, '5º Grupo ' . $letra_grupo],
   139	                    ['3º Grupo ' . $letra_grupo, '6º Grupo ' . $letra_grupo],
   140	                    ['2º Grupo ' . $letra_grupo, '7º Grupo ' . $letra_grupo],
   141	                ];
   142	                break;
   143	            case 'semifinal':
   144	                $slots = [
   145	                    ['1º Grupo ' . $letra_grupo, '4º Grupo ' . $letra_grupo],
   146	                    ['2º Grupo ' . $letra_grupo, '3º Grupo ' . $letra_grupo],
   147	                ];
   148	                break;
   149	            default: // final
   150	                $slots = [
   151	                    ['1º Grupo ' . $letra_grupo, '2º Grupo ' . $letra_grupo],
   152	                ];
   153	                break;
   154	        }
   155	
   156	        $html  = '<div class="simulador-cuadro-ronda">';
   157	        $html .= '<div class="simulador-cuadro-titulo">' . esc_html(ucfirst($fase_final)) . '</div>';
   158	        $html .= '<div class="simulador-cuadro-matches">';
   159	        foreach ($slots as $s) {
   160	            $html .= '<div class="simulador-cuadro-match"><span>' . esc_html($s[0]) . '</span> <b>vs</b> <span>' . esc_html($s[1]) . '</span></div>';
   161	        }
   162	        $html .= '</div></div>';
   163	
   164	        if ($fase_final === 'cuartos') {
   165	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Semifinal</div><div class="simulador-cuadro-matches">';
   166	            $html .= '<div class="simulador-cuadro-match"><span>Ganador QF1</span> <b>vs</b> <span>Ganador QF2</span></div>';
   167	            $html .= '<div class="simulador-cuadro-match"><span>Ganador QF3</span> <b>vs</b> <span>Ganador QF4</span></div>';
   168	            $html .= '</div></div>';
   169	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Final</div><div class="simulador-cuadro-matches">';
   170	            $html .= '<div class="simulador-cuadro-match"><span>Ganador SF1</span> <b>vs</b> <span>Ganador SF2</span></div>';
   171	            $html .= '</div></div>';
   172	        } elseif ($fase_final === 'semifinal') {
   173	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Final</div><div class="simulador-cuadro-matches">';
   174	            $html .= '<div class="simulador-cuadro-match"><span>Ganador SF1</span> <b>vs</b> <span>Ganador SF2</span></div>';
   175	            $html .= '</div></div>';
   176	        } elseif ($fase_final === 'octavos') {
   177	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Cuartos</div><div class="simulador-cuadro-matches">';
   178	            $html .= '<div class="simulador-cuadro-match"><span>Ganador R16-1</span> <b>vs</b> <span>Ganador R16-2</span></div>';
   179	            $html .= '<div class="simulador-cuadro-match"><span>Ganador R16-3</span> <b>vs</b> <span>Ganador R16-4</span></div>';
   180	            $html .= '<div class="simulador-cuadro-match"><span>Ganador R16-5</span> <b>vs</b> <span>Ganador R16-6</span></div>';
   181	            $html .= '<div class="simulador-cuadro-match"><span>Ganador R16-7</span> <b>vs</b> <span>Ganador R16-8</span></div>';
   182	            $html .= '</div></div>';
   183	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Semifinal</div><div class="simulador-cuadro-matches">';
   184	            $html .= '<div class="simulador-cuadro-match"><span>Ganador QF1</span> <b>vs</b> <span>Ganador QF2</span></div>';
   185	            $html .= '<div class="simulador-cuadro-match"><span>Ganador QF3</span> <b>vs</b> <span>Ganador QF4</span></div>';
   186	            $html .= '</div></div>';
   187	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Final</div><div class="simulador-cuadro-matches">';
   188	            $html .= '<div class="simulador-cuadro-match"><span>Ganador SF1</span> <b>vs</b> <span>Ganador SF2</span></div>';
   189	            $html .= '</div></div>';
   190	        }
   191	
   192	        return $html;
   193	    }
   194	}
   195	
   196	if (!function_exists('render_cuadro_mezclado')) {
   197	    /**
   198	     * Render: Cuadro mezclado (simplificado)
   199	     */
   200	    function render_cuadro_mezclado($grupos, $fase_final) {
   201	        $slots = [];
   202	        switch ($fase_final) {
   203	            case 'cuartos':
   204	                $slots = [
   205	                    ['1º Grupo A', '2º Grupo B'],
   206	                    ['1º Grupo C', '2º Grupo D'],
   207	                    ['1º Grupo B', '2º Grupo A'],
   208	                    ['1º Grupo D', '2º Grupo C'],
   209	                ];
   210	                break;
   211	            case 'semifinal':
   212	                $slots = [
   213	                    ['1º Grupo A', '2º Grupo B'],
   214	                    ['1º Grupo C', '2º Grupo D'],
   215	                ];
   216	                break;
   217	            default:
   218	                $slots = [
   219	                    ['1º Grupo A', '1º Grupo B'],
   220	                ];
   221	                break;
   222	        }
   223	
   224	        $html  = '<div class="simulador-cuadro-ronda">';
   225	        $html .= '<div class="simulador-cuadro-titulo">' . esc_html(ucfirst($fase_final)) . '</div>';
   226	        $html .= '<div class="simulador-cuadro-matches">';
   227	        foreach ($slots as $s) {
   228	            $html .= '<div class="simulador-cuadro-match"><span>' . esc_html($s[0]) . '</span> <b>vs</b> <span>' . esc_html($s[1]) . '</span></div>';
   229	        }
   230	        $html .= '</div></div>';
   231	
   232	        if ($fase_final === 'cuartos') {
   233	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Semifinal</div><div class="simulador-cuadro-matches">';
   234	            $html .= '<div class="simulador-cuadro-match"><span>Ganador QF1</span> <b>vs</b> <span>Ganador QF2</span></div>';
   235	            $html .= '<div class="simulador-cuadro-match"><span>Ganador QF3</span> <b>vs</b> <span>Ganador QF4</span></div>';
   236	            $html .= '</div></div>';
   237	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Final</div><div class="simulador-cuadro-matches">';
   238	            $html .= '<div class="simulador-cuadro-match"><span>Ganador SF1</span> <b>vs</b> <span>Ganador SF2</span></div>';
   239	            $html .= '</div></div>';
   240	        } elseif ($fase_final === 'semifinal') {
   241	            $html .= '<div class="simulador-cuadro-ronda"><div class="simulador-cuadro-titulo">Final</div><div class="simulador-cuadro-matches">';
   242	            $html .= '<div class="simulador-cuadro-match"><span>Ganador SF1</span> <b>vs</b> <span>Ganador SF2</span></div>';
   243	            $html .= '</div></div>';
   244	        }
   245	
   246	        return $html;
   247	    }
   248	}
   249	
   250	if (!function_exists('generar_resultados_html')) {
   251	    /**
   252	     * Generación de HTML de resultados (grupos + cuadro final)
   253	     */
   254	    function generar_resultados_html($grupos, $fase_final, $org_val) {
   255	        $es_premios_por_grupo = (strpos(strtolower($org_val), 'grupo') !== false);
   256	
   257	        $html = '<div class="simulador-visual-wrap">';
   258	
   259	        // Bloque: Grupos (lista)
   260	        $html .= '<div class="simulador-grupos-lista">';
   261	        foreach ($grupos as $g) {
   262	            $html .= '<div class="simulador-grupo-bloque">';
   263	            $html .= '<div class="simulador-grupo-nombre">Grupo ' . esc_html($g['nombre']) . '</div>';
   264	            $html .= '<ul>';
   265	            $top_n = 0;
   266	            switch ($fase_final) {
   267	                case 'octavos':   $top_n = 16; break;
   268	                case 'cuartos':   $top_n = 8;  break;
   269	                case 'semifinal': $top_n = 4;  break;
   270	                default:          $top_n = 2;  break;
   271	            }
   272	            foreach ($g['participantes'] as $idx => $name) {
   273	                $class = ($idx < $top_n) ? ' class="simulador-clasificado"' : '';
   274	                $html .= '<li' . $class . '>' . esc_html($name) . '</li>';
   275	            }
   276	            $garantizados = max(0, $g['tam'] - 1);
   277	            $html .= '</ul><div class="simulador-grupo-info">Partidos garantizados por pareja: ' . esc_html((string)$garantizados) . '</div>';
   278	            $html .= '</div>';
   279	        }
   280	        $html .= '</div>'; // .simulador-grupos-lista
   281	
   282	        // Bloque: Cuadro(s) final(es)
   283	        $html .= '<div class="simulador-cuadro-final">';
   284	        if ($es_premios_por_grupo) {
   285	            $html .= '<h3>Cuadros finales por grupo</h3>';
   286	            foreach ($grupos as $g) {
   287	                $html .= '<div class="simulador-cuadro-grupo">';
   288	                $html .= '<div class="simulador-cuadro-grupo-titulo">Grupo ' . esc_html($g['nombre']) . '</div>';
   289	                $html .= render_cuadro_por_grupo($g['nombre'], $fase_final);
   290	                $html .= '</div>';
   291	            }
   292	        } else {
   293	            $html .= '<h3>Cuadro final (mezcla de grupos)</h3>';
   294	            $html .= render_cuadro_mezclado($grupos, $fase_final);
   295	        }
   296	        $html .= '</div>'; // .simulador-cuadro-final
   297	
   298	        $html .= '</div>'; // .simulador-visual-wrap
   299	
   300	        return $html;
   301	    }
   302	}
   303	
   304	/**
   305	 * Hooks AJAX
   306	 */
   307	add_action('wp_ajax_str_simular_torneo', 'str_simular_torneo');
   308	// add_action('wp_ajax_nopriv_str_simular_torneo', 'str_simular_torneo'); // si quieres público
   309	
   310	/**
   311	 * Handler principal (SIEMPRE por parejas)
   312	 */
   313	if (!function_exists('str_simular_torneo')) {
   314	function str_simular_torneo() {
   315	    try {
   316	        // Seguridad básica
   317	        if (!is_user_logged_in()) {
   318	            wp_send_json_error(['msg' => 'Permisos insuficientes (login requerido).'], 403);
   319	        }
   320	        if (!isset($_POST['_ajax_nonce']) || !wp_verify_nonce(sanitize_text_field($_POST['_ajax_nonce']), 'str_nonce')) {
   321	            wp_send_json_error(['msg' => 'Nonce inválido. Recarga la página.'], 400);
   322	        }
   323	        if (!current_user_can('read')) {
   324	            wp_send_json_error(['msg' => 'Permisos insuficientes.'], 403);
   325	        }
   326	
   327	        // Entrada (sin tipo_torneo / sin n_pistas)
   328	        $n_jugadores     = isset($_POST['n_jugadores']) ? absint($_POST['n_jugadores']) : 0;
   329	        $n_grupos_input  = isset($_POST['n_grupos'])    ? absint($_POST['n_grupos'])    : 0;
   330	        $fase_final_raw  = isset($_POST['fase_final'])  ? sanitize_text_field($_POST['fase_final']) : 'final';
   331	        $organizar_final = isset($_POST['organizar_final']) ? sanitize_text_field($_POST['organizar_final']) : 'premios_grupo';
   332	
   333	        $fase_final  = strtolower($fase_final_raw);         // 'final' | 'semifinal' | 'cuartos' | 'octavos'
   334	        $org_val     = strtolower($organizar_final);        // 'premios_grupo' | 'mezclar' | ...
   335	
   336	        if ($n_jugadores < 2) {
   337	            wp_send_json_error(['msg' => 'Introduce un número de jugadores válido (mínimo 2).'], 400);
   338	        }
   339	
   340	        // Participantes competitivos (SIEMPRE por parejas)
   341	        $P = (int) floor($n_jugadores / 2);
   342	        if ($P < 2) {
   343	            wp_send_json_error(['msg' => 'No hay suficientes parejas para simular.'], 400);
   344	        }
   345	
   346	        // Plazas por fase
   347	        $plazas_por_fase = [
   348	            'final'     => 2,
   349	            'semifinal' => 4,
   350	            'cuartos'   => 8,
   351	            'octavos'   => 16,
   352	        ];
   353	        $plazas_requeridas = isset($plazas_por_fase[$fase_final]) ? $plazas_por_fase[$fase_final] : 2;
   354	
   355	        // Premios por grupo o mezclar
   356	        $es_premios_por_grupo = (strpos($org_val, 'grupo') !== false || $org_val === 'premios' || $org_val === 'premios_grupo');
   357	
   358	        // Elegir nº de grupos:
   359	        if ($n_grupos_input > 0) {
   360	            $n_grupos = max(1, $n_grupos_input);
   361	            $modo_grupos = 'fijo_cliente';
   362	        } else {
   363	            $n_grupos = str_elegir_num_grupos_optimo($P, $es_premios_por_grupo, $fase_final, $plazas_por_fase);
   364	            $modo_grupos = 'auto_optimo';
   365	        }
   366	
   367	        // Reparto equilibrado base+resto
   368	        $base   = intdiv($P, $n_grupos);
   369	        $resto  = $P % $n_grupos;
   370	        $letras = range('A', 'Z');
   371	        $grupos = [];
   372	        $indice = 1;
   373	
   374	        for ($i = 0; $i < $n_grupos; $i++) {
   375	            $tam = $base + ($i < $resto ? 1 : 0);
   376	            $nombre = isset($letras[$i]) ? $letras[$i] : 'G' . ($i + 1);
   377	            $participantes = [];
   378	            for ($p = 0; $p < $tam; $p++) {
   379	                $participantes[] = "Pareja {$indice}";
   380	                $indice++;
   381	            }
   382	            $grupos[] = [
   383	                'nombre' => $nombre,
   384	                'tam' => $tam,
   385	                'participantes' => $participantes,
   386	            ];
   387	        }
   388	
   389	        // Tamaño mínimo por grupo
   390	        $tam_min_grupo = min(array_map(function($g){ return (int) $g['tam']; }, $grupos));
   391	
   392	        str_saas_log('SIMULADOR entrada/selección G (parejas)', [
   393	            'P' => $P,
   394	            'fase' => $fase_final,
   395	            'organizar_final' => $org_val,
   396	            'n_grupos_input' => $n_grupos_input,
   397	            'n_grupos_usado' => $n_grupos,
   398	            'modo_grupos' => $modo_grupos,
   399	            'tam_min_grupo' => $tam_min_grupo,
   400	        ]);
   401	
   402	        // Si es premios por grupo e incompatible => aviso con CTAs
   403	        if ($es_premios_por_grupo && $plazas_requeridas > $tam_min_grupo) {
   404	            // Fase compatible por tamaño mínimo actual
   405	            $fase_compatible = 'final';
   406	            if ($tam_min_grupo >= 16)      $fase_compatible = 'octavos';
   407	            elseif ($tam_min_grupo >= 8)   $fase_compatible = 'cuartos';
   408	            elseif ($tam_min_grupo >= 4)   $fase_compatible = 'semifinal';
   409	
   410	            // Nº de grupos recomendado que haría compatible la fase elegida
   411	            $n_grupos_recomendado = str_recomendar_grupos_compatibles($P, $fase_final, $plazas_por_fase);
   412	
   413	            // Mensaje
   414	            $titulo = '<div class="simulador-msg-sugerencias"><div class="msg-warning" style="font-weight:700;margin-bottom:6px;">⚠ No hay suficientes parejas por grupo para la fase final seleccionada.</div>';
   415	            $detalle  = '<div style="margin-bottom:8px;">Has elegido <b>Premios por grupo</b> con la fase final <b>' . esc_html(ucfirst($fase_final)) . '</b>. ';
   416	            $detalle .= 'Con <b>' . esc_html($n_grupos) . ' grupo(s)</b> y un mínimo de <b>' . esc_html($tam_min_grupo) . '</b> pareja(s) en el grupo más pequeño, ';
   417	            $detalle .= 'la fase máxima posible por grupo es <b>' . esc_html(ucfirst($fase_compatible)) . '</b>.</div>';
   418	
   419	            $acciones = '<div style="margin-top:10px;">';
   420	            $acciones .= '<div style="margin-bottom:8px;">Para mantener <b>' . esc_html(ucfirst($fase_final)) . '</b> por grupo, cada grupo necesita <b>al menos ' . esc_html($plazas_requeridas) . '</b> parejas.</div>';
   421	            $acciones .= '<div style="display:flex;gap:10px;flex-wrap:wrap;">';
   422	
   423	            // Añadir participantes
   424	            $acciones .= '<button type="button" class="str-btn-ajustar-jugadores" data-min-por-grupo="' . esc_attr($plazas_requeridas) . '" data-g-efectivo="' . esc_attr($n_grupos) . '" style="padding:8px 12px;border:1px solid #2152ff;border-radius:8px;background:#f1f6ff;cursor:pointer;">📈 Añadir participantes y simular de nuevo</button>';
   425	
   426	            // Cambiar a fase compatible
   427	            $acciones .= '<button type="button" class="str-btn-ajustar-fase" data-fase-compatible="' . esc_attr($fase_compatible) . '" style="padding:8px 12px;border:1px solid #15803d;border-radius:8px;background:#ecfdf5;cursor:pointer;">🔄 Cambiar a ' . esc_html(ucfirst($fase_compatible)) . ' y simular</button>';
   428	
   429	            // Ajustar nº de grupos recomendado
   430	            if ($n_grupos_recomendado !== $n_grupos) {
   431	                $acciones .= '<button type="button" class="str-btn-ajustar-grupos" data-grupos-recomendados="' . esc_attr($n_grupos_recomendado) . '" style="padding:8px 12px;border:1px solid #8b5cf6;border-radius:8px;background:#f5f3ff;cursor:pointer;">🧩 Ajustar a ' . esc_html($n_grupos_recomendado) . ' grupo(s) y simular</button>';
   432	            }
   433	
   434	            $acciones .= '</div></div></div>';
   435	
   436	            $sugerencias_html = $titulo . $detalle . $acciones;
   437	
   438	            str_saas_log('SIMULADOR incompatibilidad (premios por grupo)', [
   439	                'fase_elegida' => $fase_final,
   440	                'tam_min_grupo' => $tam_min_grupo,
   441	                'n_grupos_actual' => $n_grupos,
   442	                'n_grupos_recomendado' => $n_grupos_recomendado,
   443	                'fase_compatible' => $fase_compatible,
   444	            ]);
   445	
   446	            wp_send_json_success([
   447	                'sugerencias'      => $sugerencias_html,
   448	                'resultados_html'  => '',
   449	                'n_grupos_actual'      => $n_grupos,
   450	                'n_grupos_recomendado' => $n_grupos_recomendado,
   451	            ]);
   452	        }
   453	
   454	        // Compatible o modo "mezclar grupos": generar resultados
   455	        if (!function_exists('str_recomendar_grupos_compatibles')) {
   456	            // Garantizamos que existe si se llamara por error aquí (no debería, ya que se usa antes)
   457	            function str_recomendar_grupos_compatibles($P, $fase_final, $plazas_por_fase) {
   458	                $plazas_req = isset($plazas_por_fase[$fase_final]) ? $plazas_por_fase[$fase_final] : 2;
   459	                $max_grupos_compatibles = max(1, (int) floor($P / $plazas_req));
   460	                $target_size = 4; $mejorG = 1; $mejorCoste = PHP_INT_MAX;
   461	                for ($G = 1; $G <= $max_grupos_compatibles; $G++) {
   462	                    $base  = intdiv($P, $G);
   463	                    $resto = $P % $G;
   464	                    $min_size = $base;
   465	                    $max_size = $base + ($resto > 0 ? 1 : 0);
   466	                    $dev_min = ($min_size - $target_size);
   467	                    $dev_max = ($max_size - $target_size);
   468	                    $cost_tamano = ($G - $resto) * ($dev_min * $dev_min) + $resto * ($dev_max * $dev_max);
   469	                    $cost_tiny = ($min_size < 3) ? 200 * (3 - $min_size) : 0;
   470	                    $pref_g = 4; $cost_pref_g = 2 * (($G - $pref_g) * ($G - $pref_g));
   471	                    $coste = $cost_tamano + $cost_tiny + $cost_pref_g;
   472	                    if ($coste < $mejorCoste) { $mejorCoste = $coste; $mejorG = $G; }
   473	                }
   474	                return max(1, (int) $mejorG);
   475	            }
   476	        }
   477	
   478	        $sugerencias_html = generar_mensajes_sugerencias($grupos, $fase_final, $org_val);
   479	        $resultados_html  = generar_resultados_html($grupos, $fase_final, $org_val);
   480	
   481	        str_saas_log('SIMULADOR generación completada', [
   482	            'n_grupos' => $n_grupos,
   483	            'len_sugerencias' => strlen($sugerencias_html),
   484	            'len_resultados'  => strlen($resultados_html),
   485	        ]);
   486	
   487	        wp_send_json_success([
   488	            'sugerencias'     => $sugerencias_html,
   489	            'resultados_html' => $resultados_html,
   490	            'n_grupos_actual' => $n_grupos,
   491	        ]);
   492	
   493	    } catch (\Throwable $e) {
   494	        str_saas_log('SIMULADOR excepción', ['error' => $e->getMessage(), 'trace' => $e->getTraceAsString()]);
   495	        wp_send_json_error(['msg' => 'Error interno en la simulación.'], 500);
   496	    }
   497	}}
===== END includes/features/simulator/ajax/simular-torneo.php =====

===== BEGIN includes/features/simulator/index.css =====
     1	/* Antiguo: /assets/css/simulador-torneo.css */
     2	
     3	.str-simulador-torneo {
     4	    max-width: 1100px;
     5	    margin: 30px auto 28px auto;
     6	    background: #fff;
     7	    border-radius: 16px;
     8	    padding: 32px 36px;
     9	    box-shadow: 0 4px 34px rgba(40,65,100,0.13);
    10	    display: flex;
    11	    flex-direction: row;
    12	    gap: 40px;
    13	    min-height: 600px;
    14	}
    15	
    16	.str-simulador-torneo-col {
    17	    flex: 1 1 0;
    18	    min-width: 330px;
    19	    display: flex;
    20	    flex-direction: column;
    21	    justify-content: flex-start;
    22	}
    23	
    24	/* Formulario en la columna izquierda */
    25	.str-simulador-formulario {
    26	    width: 100%;
    27	}
    28	
    29	/* Resultados en la columna derecha */
    30	.str-simulador-visual {
    31	    width: 100%;
    32	    margin-top: 0;
    33	}
    34	
    35	/* Título */
    36	.str-simulador-torneo h1 {
    37	    font-size: 2.15rem;
    38	    font-weight: 700;
    39	    color: #1a2156;
    40	    margin-bottom: 28px;
    41	    text-align: left;
    42	    margin-top: 0;
    43	}
    44	
    45	@media (max-width: 1100px) {
    46	    .str-simulador-torneo {
    47	        max-width: 99vw;
    48	        padding: 20px 4vw 20px 4vw;
    49	        gap: 16px;
    50	    }
    51	    .str-simulador-torneo-col { min-width: 0; }
    52	}
    53	
    54	@media (max-width: 900px) {
    55	    .str-simulador-torneo {
    56	        flex-direction: column;
    57	        padding: 16px 2vw 16px 2vw;
    58	    }
    59	    .str-simulador-visual { margin-top: 18px; }
    60	}
    61	
    62	/* Grupos */
    63	.simulador-grupos-lista {
    64	    display: flex;
    65	    flex-wrap: wrap;
    66	    gap: 28px;
    67	    margin-bottom: 32px;
    68	    justify-content: flex-start;
    69	}
    70	.simulador-grupo-bloque {
    71	    background: #f8fbff;
    72	    border-radius: 13px;
    73	    padding: 20px 22px 16px 22px;
    74	    min-width: 200px;
    75	    flex: 1 1 200px;
    76	    box-shadow: 0 1px 9px rgba(40,65,100,0.07);
    77	    margin-bottom: 10px;
    78	}
    79	.simulador-grupo-nombre {
    80	    font-size: 1.15em;
    81	    color: #183C86;
    82	    font-weight: 700;
    83	    margin-bottom: 7px;
    84	}
    85	.simulador-grupo-bloque ul {
    86	    list-style: disc inside;
    87	    padding-left: 0;
    88	    margin: 0 0 6px 0;
    89	}
    90	.simulador-grupo-bloque li {
    91	    color: #1a2156;
    92	    font-size: 1.01em;
    93	    margin-bottom: 2px;
    94	}
    95	.simulador-grupo-bloque .simulador-clasificado {
    96	    font-weight: bold !important;
    97	}
    98	.simulador-grupo-info {
    99	    color: #5984cc;
   100	    font-style: italic;
   101	    font-size: 1em;
   102	    margin-top: 7px;
   103	}
   104	
   105	/* Cuadro final */
   106	.simulador-cuadro-final {
   107	    background: #fafdff;
   108	    border-radius: 12px;
   109	    padding: 24px 18px 24px 18px;
   110	    margin-top: 18px;
   111	    box-shadow: 0 2px 10px rgba(40,65,100,0.06);
   112	}
   113	.simulador-cuadro-final h3 {
   114	    font-size: 1.28rem;
   115	    font-weight: 700;
   116	    color: #1a2156;
   117	    margin-bottom: 14px;
   118	}
   119	.simulador-cuadro-grupo {
   120	    margin-bottom: 16px;
   121	}
   122	.simulador-cuadro-grupo-titulo {
   123	    font-size: 1.05em;
   124	    font-weight: 700;
   125	    color: #183C86;
   126	    margin-bottom: 7px;
   127	}
   128	.simulador-cuadro-ronda {
   129	    margin-bottom: 12px;
   130	}
   131	.simulador-cuadro-titulo {
   132	    font-weight: 600;
   133	    color: #1a2156;
   134	    margin-bottom: 7px;
   135	}
   136	.simulador-cuadro-matches {
   137	    display: flex;
   138	    flex-wrap: wrap;
   139	    gap: 14px 26px;
   140	}
   141	.simulador-cuadro-match {
   142	    background: #eaf1fb;
   143	    border-radius: 10px;
   144	    padding: 11px 24px;
   145	    font-weight: 500;
   146	    color: #174db9;
   147	    font-size: 1.09em;
   148	    margin-bottom: 5px;
   149	    display: flex;
   150	    align-items: center;
   151	    gap: 11px;
   152	}
   153	.simulador-cuadro-match b {
   154	    color: #2051aa;
   155	    margin: 0 8px;
   156	    font-weight: bold;
   157	}
   158	
   159	/* Mensajes educativos y errores (estilo base) */
   160	.simulador-msg-sugerencias {
   161	    margin-top: 16px;
   162	    margin-bottom: 14px;
   163	    font-size: 1.10em;
   164	    color: #174db9;
   165	    font-weight: 500;
   166	    min-height: 24px;
   167	}
   168	
   169	/* Variantes de color para textos de mensaje */
   170	.simulador-msg-sugerencias .msg-error {
   171	    color: #d9534f;
   172	    font-weight: 500;
   173	}
   174	.simulador-msg-sugerencias .msg-ok {
   175	    color: #15803d;
   176	    font-weight: 500;
   177	}
   178	.simulador-msg-sugerencias .msg-warning {
   179	    color: #e5771a;
   180	    font-weight: 700;
   181	}
   182	
   183	/* Inputs y botones */
   184	.str-simulador-form-group {
   185	    margin-bottom: 22px;
   186	}
   187	.str-simulador-form-group label {
   188	    display: block;
   189	    font-weight: 600;
   190	    margin-bottom: 6px;
   191	    color: #2444a1;
   192	}
   193	.str-simulador-form-group input[type="number"],
   194	.str-simulador-form-group select {
   195	    width: 100%;
   196	    padding: 9px 14px;
   197	    font-size: 1.08em;
   198	    border: 1.5px solid #bed0ee;
   199	    border-radius: 8px;
   200	    outline: none;
   201	    transition: border .16s;
   202	    background: #f9fbfd;
   203	}
   204	.str-simulador-form-group input[type="number"]:focus,
   205	.str-simulador-form-group select:focus {
   206	    border-color: #2152ff;
   207	    background: #f1f6ff;
   208	}
   209	.str-btn-simular {
   210	    display: block;
   211	    width: 100%;
   212	    padding: 12px 0;
   213	    background: linear-gradient(92deg, #2152ff 0%, #3273f8 100%);
   214	    color: #fff;
   215	    border: none;
   216	    border-radius: 9px;
   217	    font-size: 1.12rem;
   218	    font-weight: 700;
   219	    cursor: pointer;
   220	    margin-top: 12px;
   221	    transition: background 0.15s, transform 0.06s ease-in-out;
   222	    box-shadow: 0 2px 8px rgba(90,110,160,0.07);
   223	}
   224	.str-btn-simular:hover {
   225	    background: linear-gradient(92deg, #254a8a 0%, #3576ec 100%);
   226	}
   227	.str-btn-simular:active {
   228	    transform: translateY(1px);
   229	}
   230	
   231	/* Radios */
   232	.simulador-final-opciones label {
   233	    font-weight: 500;
   234	    margin-right: 16px;
   235	    cursor: pointer;
   236	}
   237	.simulador-final-opciones input[type="radio"] {
   238	    margin-right: 4px;
   239	    accent-color: #2051aa;
   240	}
   241	
   242	/* Responsive ajustes de columnas */
   243	@media (max-width: 1100px) {
   244	    .str-simulador-torneo {
   245	        flex-direction: column;
   246	        gap: 24px;
   247	        min-height: unset;
   248	    }
   249	}
   250	
   251	/* Responsive grupos y matches */
   252	@media (max-width: 900px) {
   253	    .simulador-grupos-lista { gap: 16px; }
   254	    .simulador-grupo-bloque { padding: 14px 8px 12px 8px; min-width: 140px; }
   255	    .simulador-cuadro-final { padding: 14px 4vw; }
   256	    .str-simulador-torneo { padding: 12px 2vw 12px 2vw; }
   257	}
   258	@media (max-width: 600px) {
   259	    .simulador-grupos-lista { flex-direction: column; gap: 12px; }
   260	    .simulador-cuadro-matches { flex-direction: column; gap: 9px; }
   261	    .simulador-cuadro-final { padding: 10px 2vw; }
   262	}
   263	
   264	/* ────────────────────────────────────────────────────────────── */
   265	/* NUEVO: Estilos mínimos para avisos y CTAs (no altera estética) */
   266	/* ────────────────────────────────────────────────────────────── */
   267	
   268	/* Solo añadimos un “card” sutil al bloque de sugerencias */
   269	.simulador-msg-sugerencias {
   270	    background: #f7fbff;
   271	    border: 1px solid #e0ecff;
   272	    border-radius: 10px;
   273	    padding: 12px 14px;
   274	}
   275	
   276	/* Afinar jerarquía de mensajes dentro del aviso (espaciado) */
   277	.simulador-msg-sugerencias .msg-warning,
   278	.simulador-msg-sugerencias .msg-error,
   279	.simulador-msg-sugerencias .msg-ok {
   280	    display: block;
   281	    margin-bottom: 6px;
   282	}
   283	
   284	/* Botones de acción rápida (inyectados por backend/JS) */
   285	.str-btn-ajustar-jugadores,
   286	.str-btn-ajustar-fase,
   287	.str-btn-ajustar-grupos {
   288	    display: inline-flex;
   289	    align-items: center;
   290	    gap: 8px;
   291	    padding: 9px 14px;
   292	    border-radius: 8px;
   293	    font-size: 0.98rem;
   294	    font-weight: 600;
   295	    cursor: pointer;
   296	    transition: transform .06s ease-in-out, box-shadow .15s;
   297	    user-select: none;
   298	    text-decoration: none;
   299	}
   300	
   301	/* Estilos por defecto por si el backend no aporta inline styles */
   302	.str-btn-ajustar-jugadores {
   303	    border: 1px solid #2152ff;
   304	    background: #f1f6ff;
   305	    color: #1a2156;
   306	    box-shadow: 0 1px 4px rgba(33,82,255,0.08);
   307	}
   308	.str-btn-ajustar-jugadores:hover { box-shadow: 0 2px 8px rgba(33,82,255,0.14); }
   309	.str-btn-ajustar-jugadores:active { transform: translateY(1px); }
   310	
   311	.str-btn-ajustar-fase {
   312	    border: 1px solid #15803d;
   313	    background: #ecfdf5;
   314	    color: #0d5132;
   315	    box-shadow: 0 1px 4px rgba(21,128,61,0.08);
   316	}
   317	.str-btn-ajustar-fase:hover { box-shadow: 0 2px 8px rgba(21,128,61,0.14); }
   318	.str-btn-ajustar-fase:active { transform: translateY(1px); }
   319	
   320	/* Tercer CTA: Ajustar a N grupos (tono violeta por defecto) */
   321	.str-btn-ajustar-grupos {
   322	    border: 1px solid #8b5cf6;
   323	    background: #f5f3ff;
   324	    color: #3f3cbb;
   325	    box-shadow: 0 1px 4px rgba(139,92,246,0.10);
   326	}
   327	.str-btn-ajustar-grupos:hover { box-shadow: 0 2px 8px rgba(139,92,246,0.18); }
   328	.str-btn-ajustar-grupos:active { transform: translateY(1px); }
   329	
   330	/* Botones a ancho completo en móvil */
   331	@media (max-width: 600px) {
   332	    .str-btn-ajustar-jugadores,
   333	    .str-btn-ajustar-fase,
   334	    .str-btn-ajustar-grupos {
   335	        width: 100%;
   336	        justify-content: center;
   337	    }
   338	}
   339	
   340	/* ============================================================= */
   341	/* ===  Modal “Editar torneo” — centrado robusto (único fix) === */
   342	/* ============================================================= */
   343	
   344	/* 1) Respetar el cierre si viene con display:none inline */
   345	#modal-editar-torneo[style*="display: none"] {
   346	  display: none !important;
   347	}
   348	
   349	/* 2) jQuery .fadeIn() suele poner display:block: lo forzamos a flex */
   350	#modal-editar-torneo[style*="display:block"],
   351	#modal-editar-torneo {
   352	  display: flex !important;
   353	}
   354	
   355	/* 3) Overlay a pantalla completa y centrado seguro */
   356	#modal-editar-torneo {
   357	  position: fixed !important;
   358	  inset: 0 !important;
   359	  z-index: 99999 !important;
   360	  padding: 16px;
   361	  background: rgba(0,0,0,.5);
   362	  align-items: center;
   363	  justify-content: center;
   364	  box-sizing: border-box;
   365	}
   366	
   367	/* 4) Normalizar el contenedor del formulario (primer hijo) */
   368	#modal-editar-torneo > .saas-tr-modal__dialog,
   369	#modal-editar-torneo > div {
   370	  margin: 0 !important;
   371	  max-width: 720px;
   372	  width: min(96vw, 720px);
   373	  box-sizing: border-box;
   374	}
===== END includes/features/simulator/index.css =====

===== BEGIN includes/features/simulator/index.js =====
     1	// /assets/js/simulador-torneo.js
     2	// Versión: siempre "por parejas" (sin selector de tipo) y sin campo de pistas.
     3	// Añadido: botón "Crear competición" -> guarda snapshot y redirige a /crear-competicion/?simulacion_id=ID
     4	
     5	jQuery(document).ready(function($) {
     6	    var $form = $('#form-simulador-torneo');
     7	    var $msg  = $('#simulador-msg-sugerencias');
     8	    var $res  = $('#simulador-resultados');
     9	    var $acciones = $('#simulador-acciones');
    10	    var $btnCrear = $('#btn-crear-competicion');
    11	
    12	    // Estado local de la última simulación (para guardar snapshot con coherencia)
    13	    var lastSimParams = null;   // { n_jugadores, n_grupos, fase_final, organizar_final }
    14	    var lastSimOK = false;      // si hubo resultados HTML válidos
    15	
    16	    function limpiarUI() {
    17	        $msg.html('');
    18	        $res.html('');
    19	        $acciones.hide();
    20	        lastSimOK = false;
    21	        lastSimParams = null;
    22	    }
    23	
    24	    function ponerLoader() {
    25	        $res.html('<div style="color:#3273f8;font-weight:500;margin:24px 0;">Calculando simulación...</div>');
    26	    }
    27	
    28	    function scrollToMensajes() {
    29	        var top = $msg.offset() ? $msg.offset().top - 70 : 0;
    30	        if (top > 0) {
    31	            window.scrollTo({ top: top, behavior: 'smooth' });
    32	        }
    33	    }
    34	
    35	    // Envío principal del simulador
    36	    $form.on('submit', function(e) {
    37	        e.preventDefault();
    38	
    39	        limpiarUI();
    40	
    41	        // Recoger datos del formulario
    42	        var n_jugadores_raw = $('#simulador_n_jugadores').val();
    43	        var n_jugadores     = parseInt(n_jugadores_raw, 10);
    44	        var n_grupos_val    = $('#simulador_n_grupos').val();
    45	        var n_grupos        = parseInt(n_grupos_val, 10) || ''; // puede venir vacío
    46	        var fase_final      = $('#simulador_fase_final').val(); // 'final' | 'semifinal' | 'cuartos' | 'octavos'
    47	        var organizar_final = $('input[name="simulador_organizar_final"]:checked').val(); // 'premios_grupo' | 'mezclar'
    48	
    49	        // Validación frontend básica
    50	        if (!n_jugadores || n_jugadores < 2) {
    51	            $msg.html('<span class="msg-error" style="color:#d9534f;">Introduce un número de jugadores válido (mínimo 2).</span>');
    52	            scrollToMensajes();
    53	            return;
    54	        }
    55	
    56	        ponerLoader();
    57	
    58	        var $submitBtn = $form.find('button[type="submit"]');
    59	        var oldText = $submitBtn.text();
    60	        $submitBtn.prop('disabled', true).text('Simulando...');
    61	
    62	        // Llamada AJAX a WP (ya no enviamos tipo_torneo ni n_pistas)
    63	        $.ajax({
    64	            url: (typeof str_ajax_obj !== 'undefined') ? str_ajax_obj.ajax_url : '',
    65	            type: 'POST',
    66	            dataType: 'json',
    67	            data: {
    68	                action: 'str_simular_torneo',
    69	                n_jugadores: n_jugadores,
    70	                n_grupos: n_grupos,
    71	                fase_final: fase_final,
    72	                organizar_final: organizar_final,
    73	                _ajax_nonce: (typeof str_ajax_obj !== 'undefined') ? str_ajax_obj.nonce : ''
    74	            }
    75	        })
    76	        .done(function(resp) {
    77	            if (resp && resp.success && resp.data) {
    78	                // Mensajes educativos / advertencias
    79	                if (resp.data.sugerencias) {
    80	                    $msg.html(resp.data.sugerencias);
    81	                    scrollToMensajes();
    82	                } else {
    83	                    $msg.html('');
    84	                }
    85	
    86	                // Resultados (si hay incompatibilidad vendrá vacío)
    87	                if (resp.data.resultados_html) {
    88	                    $res.html(resp.data.resultados_html);
    89	                    // Guardamos estado de la última simulación (para crear competición)
    90	                    lastSimParams = {
    91	                        n_jugadores: n_jugadores,
    92	                        n_grupos: (resp.data.n_grupos_actual || n_grupos || ''),
    93	                        fase_final: fase_final,
    94	                        organizar_final: organizar_final
    95	                    };
    96	                    lastSimOK = true;
    97	                    $acciones.show(); // habilitamos barra con "Crear competición"
    98	                } else {
    99	                    lastSimOK = false;
   100	                    lastSimParams = {
   101	                        n_jugadores: n_jugadores,
   102	                        n_grupos: (resp.data && resp.data.n_grupos_actual) ? resp.data.n_grupos_actual : (n_grupos || ''),
   103	                        fase_final: fase_final,
   104	                        organizar_final: organizar_final
   105	                    };
   106	                    // Si no hay resultados, ocultamos el CTA de crear competición
   107	                    $acciones.hide();
   108	                    if (!resp.data.sugerencias) {
   109	                        $res.html('<div style="color:#d9534f;">No se pudieron calcular resultados.</div>');
   110	                    } else {
   111	                        $res.html(''); // dejamos libre para leer el aviso
   112	                    }
   113	                }
   114	            } else {
   115	                var msg = (resp && resp.data && resp.data.msg) ? resp.data.msg : 'Error inesperado.';
   116	                $res.html('<div style="color:#d9534f;">' + msg + '</div>');
   117	                $acciones.hide();
   118	                lastSimOK = false;
   119	                lastSimParams = null;
   120	            }
   121	        })
   122	        .fail(function() {
   123	            $res.html('<div style="color:#d9534f;">Error de conexión AJAX.</div>');
   124	            $acciones.hide();
   125	            lastSimOK = false;
   126	            lastSimParams = null;
   127	        })
   128	        .always(function() {
   129	            $submitBtn.prop('disabled', false).text(oldText);
   130	        });
   131	    });
   132	
   133	    // ─────────────────────────────────────────────────────────────────────────
   134	    // Utilidades
   135	    // ─────────────────────────────────────────────────────────────────────────
   136	
   137	    /**
   138	     * Participantes competitivos actuales (SIEMPRE por parejas):
   139	     * total_competitivos = floor(n_jugadores / 2)
   140	     */
   141	    function participantesCompetitivos(n_jugadores) {
   142	        return Math.floor((parseInt(n_jugadores, 10) || 0) / 2);
   143	    }
   144	
   145	    // Si no hay nº de grupos, estimamos como hace el backend (objetivo 4 por grupo)
   146	    function estimarNumGruposSiVacio(n_grupos, total_participantes) {
   147	        if (n_grupos && parseInt(n_grupos, 10) > 0) return parseInt(n_grupos, 10);
   148	        return Math.max(1, Math.ceil(total_participantes / 4));
   149	    }
   150	
   151	    // ─────────────────────────────────────────────────────────────────────────
   152	    // CTAs dinámicos en el aviso (incompatibilidades)
   153	    // ─────────────────────────────────────────────────────────────────────────
   154	
   155	    // 1) 📈 Añadir participantes y re-simular (manteniendo fijo el nº de grupos efectivo)
   156	    $(document).on('click', '.str-btn-ajustar-jugadores', function() {
   157	        var $btn = $(this);
   158	
   159	        // Requisitos mínimos por grupo para la fase elegida (del backend)
   160	        var minPorGrupo = parseInt($btn.data('min-por-grupo'), 10) || 0;
   161	        // Nº de grupos efectivo usado en la simulación (para fijarlo y evitar el bucle)
   162	        var gEfectivo   = parseInt($btn.data('g-efectivo'), 10) || 0;
   163	
   164	        // Leer estado actual del formulario
   165	        var n_jugadores  = parseInt($('#simulador_n_jugadores').val(), 10) || 0;
   166	        var n_grupos_raw = $('#simulador_n_grupos').val();
   167	        var n_grupos     = parseInt(n_grupos_raw, 10) || 0;
   168	
   169	        // Determinar "G fijo" a usar:
   170	        var total_competitivos = participantesCompetitivos(n_jugadores);
   171	        var grupos_efectivos = gEfectivo || n_grupos || estimarNumGruposSiVacio(n_grupos, total_competitivos);
   172	
   173	        // Fijamos el nº de grupos en el formulario
   174	        $('#simulador_n_grupos').val(grupos_efectivos);
   175	
   176	        // Participantes competitivos totales requeridos
   177	        var total_competitivos_requeridos = minPorGrupo * grupos_efectivos;
   178	        var n_jugadores_requeridos = total_competitivos_requeridos * 2;
   179	
   180	        var nuevo_valor = Math.max(n_jugadores, n_jugadores_requeridos);
   181	        if (!nuevo_valor || nuevo_valor < 2) nuevo_valor = 2;
   182	
   183	        $('#simulador_n_jugadores').val(nuevo_valor);
   184	
   185	        // Re-simular automáticamente
   186	        $form.trigger('submit');
   187	    });
   188	
   189	    // 2) 🔄 Cambiar a fase compatible y re-simular
   190	    $(document).on('click', '.str-btn-ajustar-fase', function() {
   191	        var faseCompatible = $(this).data('fase-compatible'); // 'final' | 'semifinal' | 'cuartos' | 'octavos'
   192	        if (faseCompatible) {
   193	            $('#simulador_fase_final').val(String(faseCompatible));
   194	        }
   195	        // Re-simular automáticamente
   196	        $form.trigger('submit');
   197	    });
   198	
   199	    // 3) 🧩 Ajustar a N grupos y re-simular
   200	    $(document).on('click', '.str-btn-ajustar-grupos', function() {
   201	        var gruposRecomendados = parseInt($(this).data('grupos-recomendados'), 10) || 0;
   202	        if (gruposRecomendados > 0) {
   203	            $('#simulador_n_grupos').val(gruposRecomendados);
   204	        }
   205	        // Re-simular automáticamente
   206	        $form.trigger('submit');
   207	    });
   208	
   209	    // ─────────────────────────────────────────────────────────────────────────
   210	    // NUEVO: Crear competición desde la simulación
   211	    // ─────────────────────────────────────────────────────────────────────────
   212	    $btnCrear.on('click', function(e) {
   213	        e.preventDefault();
   214	
   215	        // Comprobamos que existe una simulación válida previa
   216	        if (!lastSimParams || !lastSimParams.n_jugadores) {
   217	            $msg.html('<span class="msg-error" style="color:#d9534f;">Primero simula el torneo para poder crear la competición.</span>');
   218	            scrollToMensajes();
   219	            return;
   220	        }
   221	
   222	        // Opcional: si no hay resultados válidos, avisamos (permitimos continuar si así lo decides)
   223	        if (!lastSimOK) {
   224	            $msg.append('<div class="msg-warning" style="color:#e5771a;margin-top:6px;">⚠ Estás creando la competición sin resultados visualizados. Continuará con la última configuración introducida.</div>');
   225	            scrollToMensajes();
   226	        }
   227	
   228	        // Botón en estado cargando
   229	        var oldText = $btnCrear.text();
   230	        $btnCrear.prop('disabled', true).text('Preparando…');
   231	
   232	        // Enviamos al backend para que guarde SNAPSHOT coherente y devuelva simulacion_id
   233	        $.ajax({
   234	            url: (typeof str_ajax_obj !== 'undefined') ? str_ajax_obj.ajax_url : '',
   235	            type: 'POST',
   236	            dataType: 'json',
   237	            data: {
   238	                action: 'str_guardar_simulacion',
   239	                n_jugadores: lastSimParams.n_jugadores,
   240	                n_grupos: lastSimParams.n_grupos || '',
   241	                fase_final: lastSimParams.fase_final,
   242	                organizar_final: lastSimParams.organizar_final,
   243	                _ajax_nonce: (typeof str_ajax_obj !== 'undefined') ? str_ajax_obj.nonce : ''
   244	            }
   245	        })
   246	        .done(function(resp) {
   247	            if (resp && resp.success && resp.data && resp.data.simulacion_id) {
   248	                // Redirigimos a la página de creación con simulacion_id
   249	                var baseURL = (typeof str_ajax_obj !== 'undefined' && str_ajax_obj.crear_competicion_url) ? str_ajax_obj.crear_competicion_url : '/crear-competicion/';
   250	                // Pasamos flags para prefill (si los necesitas en tu shortcode)
   251	                var url = baseURL + (baseURL.indexOf('?') === -1 ? '?' : '&') +
   252	                          'simulacion_id=' + encodeURIComponent(resp.data.simulacion_id) +
   253	                          '&prefill=1';
   254	                window.location.href = url;
   255	            } else {
   256	                var msg = (resp && resp.data && resp.data.msg) ? resp.data.msg : 'No se pudo guardar la simulación.';
   257	                $msg.html('<span class="msg-error" style="color:#d9534f;">' + msg + '</span>');
   258	                scrollToMensajes();
   259	                $btnCrear.prop('disabled', false).text(oldText);
   260	            }
   261	        })
   262	        .fail(function() {
   263	            $msg.html('<span class="msg-error" style="color:#d9534f;">Error de conexión al guardar la simulación.</span>');
   264	            scrollToMensajes();
   265	            $btnCrear.prop('disabled', false).text(oldText);
   266	        });
   267	    });
   268	});
===== END includes/features/simulator/index.js =====

===== BEGIN includes/features/simulator/index.php =====
     1	<?php
     2	/**
     3	 * Plantilla: Simulador de Torneo (por parejas)
     4	 * Antiguo: /saas-torneos-de-raqueta/templates/torneos/simulador-torneo.php
     5	 */
     6	
     7	if (!defined('ABSPATH')) { exit; }
     8	
     9	// Solo usuarios logueados
    10	if (!is_user_logged_in()) {
    11	    wp_redirect( wp_login_url() );
    12	    exit;
    13	}
    14	
    15	/**
    16	 * Encolar assets del simulador
    17	 */
    18	wp_enqueue_style(
    19	    'str-simulador-torneo',
    20	    plugin_dir_url(__DIR__ . '/../../') . 'assets/css/simulador-torneo.css',
    21	    [],
    22	    '1.0.0'
    23	);
    24	
    25	wp_enqueue_script(
    26	    'str-simulador-torneo',
    27	    plugin_dir_url(__DIR__ . '/../../') . 'assets/js/simulador-torneo.js',
    28	    ['jquery'],
    29	    '1.0.0',
    30	    true
    31	);
    32	
    33	// Localizar AJAX URL y nonce para el JS
    34	wp_localize_script('str-simulador-torneo', 'str_ajax_obj', [
    35	    'ajax_url' => admin_url('admin-ajax.php'),
    36	    'nonce'    => wp_create_nonce('str_nonce'),
    37	    // URL de la página de creación (fallback). Si tu slug es distinto, cámbialo en el handler.
    38	    'crear_competicion_url' => site_url('/crear-competicion/'),
    39	]);
    40	
    41	get_header();
    42	?>
    43	
    44	<div class="str-simulador-torneo">
    45	    <!-- Columna izquierda: Formulario -->
    46	    <div class="str-simulador-torneo-col">
    47	        <h1>Simulador de Torneo</h1>
    48	
    49	        <form id="form-simulador-torneo" class="str-simulador-formulario">
    50	            <!-- Fijo por parejas: sin selector de tipo -->
    51	
    52	            <div class="str-simulador-form-group">
    53	                <label for="simulador_n_jugadores">Número total de jugadores</label>
    54	                <input type="number" id="simulador_n_jugadores" name="simulador_n_jugadores" min="2" required>
    55	            </div>
    56	
    57	            <!-- Sin nº de pistas -->
    58	
    59	            <div class="str-simulador-form-group">
    60	                <label for="simulador_n_grupos">Número de grupos (opcional)</label>
    61	                <input type="number" id="simulador_n_grupos" name="simulador_n_grupos" min="0" placeholder="Déjalo vacío para sugerencia automática">
    62	            </div>
    63	
    64	            <div class="str-simulador-form-group">
    65	                <label for="simulador_fase_final">Fase final</label>
    66	                <select id="simulador_fase_final" name="simulador_fase_final">
    67	                    <option value="final">Final</option>
    68	                    <option value="semifinal">Semifinal y Final</option>
    69	                    <option value="cuartos">Cuartos, Semifinal y Final</option>
    70	                    <option value="octavos">Octavos, Cuartos, Semifinal y Final</option>
    71	                </select>
    72	            </div>
    73	
    74	            <div class="str-simulador-form-group">
    75	                <label>Organizar cuadro final</label>
    76	                <div class="simulador-final-opciones">
    77	                    <label style="display:block;margin-bottom:6px;">
    78	                        <input type="radio" name="simulador_organizar_final" value="premios_grupo" checked>
    79	                        Premios por grupo
    80	                        <div class="simulador-final-help" style="font-size:.9em;color:#61708f;margin:4px 0 0 26px;">
    81	                            Cada grupo tiene su propio cuadro final (no se mezclan entre grupos).
    82	                        </div>
    83	                    </label>
    84	                    <label style="display:block;">
    85	                        <input type="radio" name="simulador_organizar_final" value="mezclar">
    86	                        Mezclar grupos
    87	                        <div class="simulador-final-help" style="font-size:.9em;color:#61708f;margin:4px 0 0 26px;">
    88	                            Los clasificados de todos los grupos compiten en un único cuadro final.
    89	                        </div>
    90	                    </label>
    91	                </div>
    92	            </div>
    93	
    94	            <button type="submit" class="str-btn-simular">Simular torneo</button>
    95	        </form>
    96	    </div>
    97	
    98	    <!-- Columna derecha: Resultados -->
    99	    <div class="str-simulador-torneo-col str-simulador-visual">
   100	        <!-- Mensajes educativos o de advertencia -->
   101	        <div id="simulador-msg-sugerencias" class="simulador-msg-sugerencias"></div>
   102	
   103	        <!-- Resultados de grupos y cuadro final -->
   104	        <div id="simulador-resultados"></div>
   105	
   106	        <!-- NUEVO: Barra de acciones posterior a la simulación -->
   107	        <div id="simulador-acciones" style="margin-top:16px;display:none;">
   108	            <button id="btn-crear-competicion" class="str-btn-simular" style="max-width:280px;">
   109	                Crear competición
   110	            </button>
   111	            <div style="font-size:.92em;color:#61708f;margin-top:6px;">
   112	                Se abrirá el formulario de creación con los datos de esta simulación.
   113	            </div>
   114	        </div>
   115	    </div>
   116	</div>
   117	
   118	<?php
   119	get_footer();
===== END includes/features/simulator/index.php =====

===== BEGIN includes/features/tournaments/ajax/guardar-torneo.php =====
     1	<?php
     2	// includes/features/tournaments/ajax/guardar-torneo.php
     3	if ( ! defined('ABSPATH') ) exit;
     4	
     5	/** Helpers */
     6	if ( ! function_exists('saas_tr_first') ) {
     7	  function saas_tr_first(array $keys, $default = '') {
     8	    foreach ($keys as $k) {
     9	      if (isset($_POST[$k]) && $_POST[$k] !== '') return wp_unslash($_POST[$k]);
    10	      if (isset($_REQUEST[$k]) && $_REQUEST[$k] !== '') return wp_unslash($_REQUEST[$k]);
    11	    }
    12	    return $default;
    13	  }
    14	}
    15	
    16	/** Registra el mismo callback bajo varios nombres (compatibilidad) */
    17	$__saas_tr_actions = [
    18	  'str_guardar_torneo_editado', // existente
    19	  'saas_tr_torneo_guardar',     // el que envía el front actual
    20	  'saas_guardar_torneo',
    21	  'guardar_torneo',
    22	];
    23	
    24	foreach ($__saas_tr_actions as $__a) {
    25	  add_action("wp_ajax_${__a}",        'str_guardar_torneo_editado_cb');
    26	  add_action("wp_ajax_nopriv_${__a}", 'str_guardar_torneo_editado_cb');
    27	}
    28	
    29	/** Callback unificado */
    30	function str_guardar_torneo_editado_cb() {
    31	  if ( ! function_exists('wp_send_json_error') ) {
    32	    header('Content-Type: application/json; charset=utf-8');
    33	    echo json_encode(['success'=>false,'data'=>['code'=>'wp_missing']]);
    34	    exit;
    35	  }
    36	
    37	  // 1) Requiere usuario autenticado
    38	  if ( ! is_user_logged_in() ) {
    39	    wp_send_json_error([
    40	      'code'    => 'auth_required',
    41	      'message' => 'Permisos insuficientes. Debes iniciar sesión.',
    42	    ], 403);
    43	  }
    44	
    45	  // 2) Nonce tolerante (si viene)
    46	  $nonce = saas_tr_first(['nonce','security','_wpnonce','saas_nonce'], '');
    47	  $nonce_ok = false;
    48	  if ($nonce !== '') {
    49	    $salts = ['str_nonce','saas_tr_nonce','saas_nonce','wp_rest'];
    50	    foreach ($salts as $salt) {
    51	      if (wp_verify_nonce($nonce, $salt)) { $nonce_ok = true; break; }
    52	    }
    53	    if ( ! $nonce_ok ) {
    54	      wp_send_json_error([
    55	        'code'       => 'nonce_invalid',
    56	        'message'    => 'Nonce inválido o caducado.',
    57	        'new_nonce'  => wp_create_nonce('str_nonce'),
    58	      ], 403);
    59	    }
    60	  }
    61	
    62	  // 3) ID del torneo
    63	  $torneo_id = intval( saas_tr_first(['torneo_id','post_id','id'], 0) );
    64	  if ( ! $torneo_id || get_post_type($torneo_id) !== 'competicion' ) {
    65	    wp_send_json_error([
    66	      'code'    => 'bad_request',
    67	      'message' => 'ID de torneo inválido.',
    68	    ], 400);
    69	  }
    70	
    71	  // 4) Capacidades cuando no hay nonce válido
    72	  if ( ! $nonce_ok && ! current_user_can('edit_post', $torneo_id) ) {
    73	    wp_send_json_error([
    74	      'code'    => 'cap_required',
    75	      'message' => 'Permisos insuficientes para editar este torneo.',
    76	    ], 403);
    77	  }
    78	
    79	  // 5) Campos (compatibles con varias UIs)
    80	  $titulo      = saas_tr_first(['titulo','post_title','nombre_torneo'], '');
    81	  $descripcion = saas_tr_first(['descripcion','content','descripcion_competicion','desc'], '');
    82	  $fecha       = saas_tr_first(['fecha_torneo','fecha'], '');
    83	  $hora_inicio = saas_tr_first(['hora_inicio','inicio','horaIni'], '');
    84	  $hora_fin    = saas_tr_first(['hora_fin','fin','horaFin'], '');
    85	
    86	  // 6) Guardado
    87	  if ( $titulo !== '' ) {
    88	    wp_update_post(['ID'=>$torneo_id, 'post_title'=>wp_strip_all_tags($titulo)]);
    89	  }
    90	
    91	  if ( function_exists('update_field') ) {
    92	    update_field('descripcion_competicion', wp_kses_post($descripcion), $torneo_id);
    93	  } else {
    94	    update_post_meta($torneo_id, 'descripcion_competicion', wp_kses_post($descripcion));
    95	  }
    96	
    97	  $grupo = [
    98	    'fecha_torneo' => sanitize_text_field($fecha),
    99	    'hora_inicio'  => sanitize_text_field($hora_inicio),
   100	    'hora_fin'     => sanitize_text_field($hora_fin),
   101	  ];
   102	
   103	  if ( function_exists('update_field') ) {
   104	    update_field('tipo_competicion_torneo', $grupo, $torneo_id); // ACF group
   105	  } else {
   106	    update_post_meta($torneo_id, 'fecha',       $grupo['fecha_torneo']);
   107	    update_post_meta($torneo_id, 'hora_inicio', $grupo['hora_inicio']);
   108	    update_post_meta($torneo_id, 'hora_fin',    $grupo['hora_fin']);
   109	  }
   110	
   111	  do_action('saas_tr/torneo_editado', $torneo_id, $grupo);
   112	
   113	  wp_send_json_success([
   114	    'message' => 'Torneo actualizado',
   115	    'post_id' => $torneo_id,
   116	    'data'    => $grupo,
   117	  ]);
   118	}
===== END includes/features/tournaments/ajax/guardar-torneo.php =====

===== BEGIN includes/features/tournaments/index.css =====
     1	/* === Estilos específicos del modal Editar Torneo === */
     2	#modal-editar-torneo {
     3	  position: fixed;
     4	  inset: 0;
     5	  z-index: 99999;
     6	  display: flex;                /* se inicia oculto por inline display:none; */
     7	  align-items: center;
     8	  justify-content: center;
     9	  padding: 16px;
    10	}
    11	
    12	/* Fondo oscurecido (clic cierra) */
    13	#modal-editar-torneo .saas-tr-modal__backdrop {
    14	  position: absolute;
    15	  inset: 0;
    16	  background: rgba(0,0,0,.5);
    17	}
    18	
    19	/* Caja del diálogo */
    20	#modal-editar-torneo .saas-tr-modal__dialog {
    21	  position: relative;
    22	  background: #fff;
    23	  border-radius: 12px;
    24	  width: 100%;
    25	  max-width: 680px;
    26	  max-height: 90vh;
    27	  overflow: auto;
    28	  box-shadow: 0 18px 48px rgba(22,28,45,.25);
    29	  padding: 20px;
    30	  box-sizing: border-box;
    31	  z-index: 1;
    32	}
    33	
    34	/* Botón cerrar (✕) */
    35	#modal-editar-torneo .saas-tr-modal__close {
    36	  position: absolute;
    37	  top: 12px;
    38	  right: 12px;
    39	  width: 36px;
    40	  height: 36px;
    41	  border: 1px solid #e7e9f1;
    42	  border-radius: 10px;
    43	  background: #fff;
    44	  cursor: pointer;
    45	  font-size: 18px;
    46	  line-height: 1;
    47	  display: inline-flex;
    48	  align-items: center;
    49	  justify-content: center;
    50	  color: #222;                 /* visible en blanco */
    51	}
    52	
    53	/* Título */
    54	#modal-editar-torneo .saas-tr-modal__title {
    55	  margin: 0 0 12px 0;
    56	  font-weight: 700;
    57	}
    58	
    59	/* Grid de formulario */
    60	#modal-editar-torneo .saas-tr-form-grid {
    61	  display: grid;
    62	  grid-template-columns: 1fr 1fr;
    63	  gap: 12px;
    64	}
    65	
    66	#modal-editar-torneo .saas-tr-form-row { grid-column: span 1; }
    67	#modal-editar-torneo .saas-tr-form-row--full { grid-column: 1 / -1; }
    68	
    69	#modal-editar-torneo .saas-tr-label {
    70	  display: block;
    71	  margin-bottom: 6px;
    72	  font-weight: 600;
    73	}
    74	
    75	#modal-editar-torneo .saas-tr-input,
    76	#modal-editar-torneo .saas-tr-textarea {
    77	  width: 100%;
    78	  padding: 10px;
    79	  border: 1px solid #dfe3ea;
    80	  border-radius: 8px;
    81	  font: inherit;
    82	  box-sizing: border-box;
    83	}
    84	
    85	/* Acciones */
    86	#modal-editar-torneo .saas-tr-modal__actions {
    87	  display: flex;
    88	  gap: 8px;
    89	  margin-top: 16px;
    90	}
    91	
    92	/* Botones (apoyándonos en tus clases base) */
    93	#modal-editar-torneo .saas-tr-btn { cursor: pointer; border-radius: 8px; padding: 10px 14px; }
    94	
    95	#modal-editar-torneo .saas-tr-btn--primary {
    96	  background: #1e88e5;
    97	  color: #fff;
    98	  border: none;
    99	}
   100	
   101	#modal-editar-torneo .saas-tr-btn--light {
   102	  background: #f6f7fb;
   103	  border: 1px solid #e7e9f1;
   104	  color: #111;
   105	}
   106	
   107	/* Opcional: ocultar por clase en vez de inline si lo prefieres
   108	#modal-editar-torneo.is-hidden { display: none; }
   109	*/
===== END includes/features/tournaments/index.css =====

===== BEGIN includes/features/tournaments/index.js =====
     1	/**
     2	 * includes/features/tournaments/index.js
     3	 * Guardado "Editar torneo" con cookies + anti-cach + retry si el nonce est caducado.
     4	 */
     5	(function () {
     6	  'use strict';
     7	
     8	  // --------- Utilidades ----------
     9	  const DBG = (...a) => console.log('[TOURNAMENTS]', ...a);
    10	
    11	  function getAjaxConfig() {
    12	    const cfg = window.STR_TOURNAMENTS_AJAX || {};
    13	    if (!cfg.ajax_url || !cfg.nonce) {
    14	      DBG('74 Config AJAX ausente/incompleta', cfg);
    15	    } else {
    16	      DBG('73 Config AJAX', cfg);
    17	    }
    18	    return cfg;
    19	  }
    20	
    21	  // Crea (si no existe) un input hidden con el nonce dentro del modal.
    22	  function ensureNonceInput(defaultNonce) {
    23	    const modal = document.getElementById('modal-editar-torneo');
    24	    if (!modal) return null;
    25	
    26	    let input = modal.querySelector('#str-nonce');
    27	    if (!input) {
    28	      input = document.createElement('input');
    29	      input.type = 'hidden';
    30	      input.id = 'str-nonce';
    31	      input.name = 'str_nonce';
    32	      modal.appendChild(input);
    33	    }
    34	    if (!input.value && defaultNonce) input.value = defaultNonce;
    35	    return input;
    36	  }
    37	
    38	  // Normaliza HH:mm (admite "H:m")
    39	  function fixTime(t) {
    40	    if (!t) return '';
    41	    const p = (t + '').split(':');
    42	    if (p.length >= 2) return `${p[0].padStart(2,'0')}:${p[1].padStart(2,'0')}`;
    43	    return '';
    44	  }
    45	
    46	  // --------- UI ----------
    47	  function openModal() {
    48	    const m = document.getElementById('modal-editar-torneo');
    49	    if (m) m.style.display = 'flex';
    50	  }
    51	  function closeModal() {
    52	    const m = document.getElementById('modal-editar-torneo');
    53	    if (m) m.style.display = 'none';
    54	  }
    55	
    56	  // --------- AJAX helper ----------
    57	  async function postAjax(url, fd) {
    58	    // Anti-cach SW + envo cookies forzado
    59	    const cacheBuster = (url.includes('?') ? '&' : '?') + `_=${Date.now()}`;
    60	    const res = await fetch(url + cacheBuster, {
    61	      method: 'POST',
    62	      body: fd,
    63	      credentials: 'include', // <- cookies SIEMPRE
    64	      cache: 'no-store',
    65	      headers: {
    66	        'X-Requested-With': 'XMLHttpRequest',
    67	        'Cache-Control': 'no-store'
    68	      }
    69	    });
    70	    const raw = await res.text();
    71	    let data = null;
    72	    try { data = JSON.parse(raw); } catch (_) {}
    73	    DBG(' RESP', res.status, raw);
    74	    return { res, data, raw };
    75	  }
    76	
    77	  async function handleSave(clickBtn) {
    78	    const cfg = getAjaxConfig();
    79	    if (!cfg.ajax_url) {
    80	      alert('No se pudo guardar (config AJAX ausente).');
    81	      return;
    82	    }
    83	
    84	    // Aseguramos nonce visible en el modal
    85	    const nonceInput = ensureNonceInput(cfg.nonce);
    86	
    87	    // Datos del modal
    88	    const torneoId    = clickBtn.getAttribute('data-torneo-id') || '';
    89	    const titulo      = document.querySelector('#modal-editar-torneo input[name="titulo"]')?.value || '';
    90	    const descripcion = document.querySelector('#modal-editar-torneo textarea[name="descripcion"]')?.value || '';
    91	    const fecha       = document.querySelector('#modal-editar-torneo input[name="fecha_torneo"]')?.value || '';
    92	    const hora_inicio = fixTime(document.querySelector('#modal-editar-torneo input[name="hora_inicio"]')?.value || '');
    93	    const hora_fin    = fixTime(document.querySelector('#modal-editar-torneo input[name="hora_fin"]')?.value || '');
    94	
    95	    // Construye payload
    96	    const buildFD = (nonce) => {
    97	      const fd = new FormData();
    98	      fd.append('action',       'str_guardar_torneo_editado');
    99	      fd.append('nonce',        nonce || '');
   100	      fd.append('torneo_id',    torneoId);
   101	      fd.append('titulo',       titulo);
   102	      fd.append('descripcion',  descripcion);
   103	      fd.append('fecha_torneo', fecha);
   104	      fd.append('hora_inicio',  hora_inicio);
   105	      fd.append('hora_fin',     hora_fin);
   106	      return fd;
   107	    };
   108	
   109	    let currentNonce = nonceInput?.value || cfg.nonce || '';
   110	    DBG(' POST (primer intento)', { torneoId, titulo, fecha, hora_inicio, hora_fin, nonce: currentNonce });
   111	
   112	    // 102 intento
   113	    let { res, data } = await postAjax(cfg.ajax_url, buildFD(currentNonce));
   114	
   115	    // 07Nonce invlido? reintenta UNA vez con el que devuelva el servidor
   116	    if (res.status === 403 && data && data.success === false && data.data && data.data.code === 'nonce_invalid' && data.data.new_nonce) {
   117	      currentNonce = data.data.new_nonce;
   118	      if (nonceInput) nonceInput.value = currentNonce;
   119	      DBG('67 Reintentando con nonce fresco', currentNonce);
   120	      ({ res, data } = await postAjax(cfg.ajax_url, buildFD(currentNonce)));
   121	    }
   122	
   123	    // Resultado final
   124	    if (!res.ok) {
   125	      // Mensajes ms claros si vienen de nuestro callback
   126	      if (data && data.data && data.data.code === 'auth_required') {
   127	        alert('Tu sesin no est activa. Inicia sesin de nuevo y prueba de nuevo.');
   128	        return;
   129	      }
   130	      if (data && data.data && data.data.message) {
   131	        alert('No se pudo guardar: ' + data.data.message);
   132	        return;
   133	      }
   134	      alert('No se pudo guardar. Status: ' + res.status);
   135	      return;
   136	    }
   137	
   138	    if (data && data.success) {
   139	      alert('Torneo actualizado correctamente.');
   140	      closeModal();
   141	      location.reload();
   142	    } else {
   143	      const msg = (data && (data.data?.message || data.message)) || 'Error desconocido';
   144	      alert('No se pudo guardar: ' + msg);
   145	    }
   146	  }
   147	
   148	  function bindUI() {
   149	    const btnOpen   = document.getElementById('btn-editar-torneo');
   150	    const btnSave   = document.getElementById('guardar-torneo');
   151	    const btnCancel = document.getElementById('cancelar-editar-torneo');
   152	    const btnX      = document.getElementById('cerrar-modal-editar');
   153	
   154	    if (btnOpen)   btnOpen.addEventListener('click', openModal);
   155	    if (btnCancel) btnCancel.addEventListener('click', closeModal);
   156	    if (btnX)      btnX.addEventListener('click', closeModal);
   157	    if (btnSave)   btnSave.addEventListener('click', () => handleSave(btnSave));
   158	  }
   159	
   160	  document.addEventListener('DOMContentLoaded', bindUI);
   161	})();
===== END includes/features/tournaments/index.js =====

===== BEGIN includes/forms/form-invitacion-jugador-automatica.php =====
     1	<?php
     2	// /includes/forms/form-invitacion-jugador-automatica.php
     3	?>
     4	
     5	<form id="form-invitacion-jugador" class="form-invitacion-jugador-automatica" autocomplete="off">
     6	    <h3>Invitar jugador al torneo</h3>
     7	    <div class="form-group">
     8	        <label for="inv-nombre">Nombre*</label>
     9	        <input type="text" name="nombre" id="inv-nombre" required>
    10	    </div>
    11	    <div class="form-group">
    12	        <label for="inv-apellidos">Apellidos*</label>
    13	        <input type="text" name="apellidos" id="inv-apellidos" required>
    14	    </div>
    15	    <div class="form-group">
    16	        <label for="inv-email">Email*</label>
    17	        <input type="email" name="email" id="inv-email" required>
    18	    </div>
    19	    <div class="form-group">
    20	        <label for="inv-telefono">Teléfono</label>
    21	        <input type="text" name="telefono" id="inv-telefono">
    22	    </div>
    23	    <div class="form-group">
    24	        <label for="inv-asunto">Asunto del correo*</label>
    25	        <input type="text" name="asunto" id="inv-asunto" placeholder="Únete al torneo..." required>
    26	    </div>
    27	    <div class="form-group">
    28	        <label for="inv-mensaje">Mensaje para el jugador</label>
    29	        <textarea name="mensaje" id="inv-mensaje" placeholder="Escribe el mensaje que recibirá el jugador"></textarea>
    30	    </div>
    31	    <input type="hidden" name="torneo_id" id="inv-torneo-id" value="">
    32	    <button type="submit" id="btn-enviar-invitacion-jugador" class="btn-enviar-invitacion">Enviar invitación</button>
    33	    <div id="mensaje-invitacion-jugador" style="margin-top:8px;"></div>
    34	</form>
===== END includes/forms/form-invitacion-jugador-automatica.php =====

===== BEGIN includes/forms/form-invitacion-jugador-manual.php =====
     1	<?php
     2	// /includes/forms/form-invitacion-jugador-manual.php
     3	?>
     4	
     5	<form id="form-invitacion-jugador-manual" autocomplete="off" style="padding: 10px;">
     6	    <div>
     7	        <label>Nombre*</label>
     8	        <input type="text" name="nombre" required>
     9	    </div>
    10	    <div>
    11	        <label>Apellidos*</label>
    12	        <input type="text" name="apellidos" required>
    13	    </div>
    14	    <div>
    15	        <label>Email*</label>
    16	        <input type="email" name="email" required>
    17	    </div>
    18	    <div>
    19	        <label>Teléfono</label>
    20	        <input type="text" name="telefono">
    21	    </div>
    22	    <input type="hidden" name="torneo_id" id="inv-torneo-id-manual" value="">
    23	    <button type="submit" id="btn-enviar-invitacion-jugador-manual">Guardar jugador</button>
    24	    <div id="mensaje-invitacion-jugador-manual" style="margin-top:8px;"></div>
    25	</form>
===== END includes/forms/form-invitacion-jugador-manual.php =====

===== BEGIN includes/forms/form-invitacion-jugador.php =====
     1	<?php
     2	// /includes/forms/form-invitacion-jugador.php
     3	// Modal para añadir jugadores: selección manual o automática.
     4	?>
     5	
     6	<!-- Overlay para el fondo oscuro del modal -->
     7	<div id="modal-invitacion-jugador-overlay" class="modal-invitacion-jugador-overlay" style="display:none;">
     8	    <div class="modal-invitacion-jugador-contenedor">
     9	        <button id="cerrar-modal-invitacion-jugador" class="cerrar-modal-invitacion-jugador" type="button">&times;</button>
    10	        <h2 class="titulo-modal-invitacion">Añadir Jugadores</h2>
    11	        <div class="modal-invitacion-seleccion">
    12	            <!-- Opción manual -->
    13	            <div class="modal-invitacion-bloque">
    14	                <h3>Manualmente</h3>
    15	                <div class="modal-invitacion-cuadro">
    16	                    Añadirás los jugadores y parejas manualmente.<br>
    17	                    No podrán subir resultados ni consultar su posición.<br>
    18	                    Ideal para competiciones de un día sin interacción del jugador.
    19	                </div>
    20	                <button class="btn-seleccionar-modal-invitacion" id="btn-seleccionar-manual">
    21	                    Seleccionar
    22	                </button>
    23	            </div>
    24	            <!-- Opción automática -->
    25	            <div class="modal-invitacion-bloque">
    26	                <h3>Automáticamente</h3>
    27	                <div class="modal-invitacion-cuadro">
    28	                    Los jugadores se podrán registrar y añadir resultados,<br>
    29	                    consultar estadísticas y posiciones.<br>
    30	                    Ideal para competiciones donde el jugador interactúa.
    31	                </div>
    32	                <button class="btn-seleccionar-modal-invitacion" id="btn-seleccionar-automatica" type="button">
    33	                    Seleccionar
    34	                </button>
    35	            </div>
    36	        </div>
    37	        <!-- Aquí debajo, JS insertará el formulario real cuando pulses "Automáticamente" -->
    38	        <div id="modal-invitacion-jugador-dinamico"></div>
    39	    </div>
    40	</div>
===== END includes/forms/form-invitacion-jugador.php =====

===== BEGIN includes/forms/form-parejas-multiseleccion.php =====
     1	<?php
     2	// Este archivo debe cargarse con require/include en la plantilla de torneo
     3	// SOLO debe incluir el contenido INTERNO del modal (sin el div principal ni display:none)
     4	?>
     5	<!-- Bloque de gestión de parejas (contenido interno del modal) -->
     6	
     7	<h2>Crear parejas para la competición</h2>
     8	<!-- El botón de cerrar ya está en torneo.php, no hace falta repetirlo -->
     9	
    10	<!-- Búsqueda de jugadores -->
    11	<div class="bloque-busqueda-jugadores">
    12	    <h3>Buscar jugadores disponibles</h3>
    13	    <form id="form-buscar-jugadores">
    14	        <input type="text" id="busqueda-nombre" name="busqueda_nombre" placeholder="Nombre">
    15	        <input type="text" id="busqueda-apellido" name="busqueda_apellido" placeholder="Apellido">
    16	        <input type="text" id="busqueda-email" name="busqueda_email" placeholder="Email">
    17	        <button type="submit" id="btn-buscar-jugadores">Buscar</button>
    18	    </form>
    19	
    20	    <!-- Resultados (AJAX) -->
    21	    <div id="tabla-jugadores-disponibles">
    22	        <!-- Aquí se cargará la tabla de jugadores con checkboxes (por AJAX) -->
    23	    </div>
    24	</div>
    25	
    26	<!-- Selección actual (pareja en preparación) -->
    27	<div class="bloque-pareja-preparacion">
    28	    <h3>Pareja en preparación</h3>
    29	    <div id="jugadores-seleccionados">
    30	        <!-- Aquí aparecerán los nombres de los dos jugadores seleccionados -->
    31	    </div>
    32	    <button id="btn-confirmar-pareja" disabled>Confirmar pareja</button>
    33	</div>
    34	
    35	<!-- Tabla de parejas ya confirmadas -->
    36	<div class="bloque-parejas-confirmadas">
    37	    <h3>Parejas confirmadas en este torneo</h3>
    38	    <div id="tabla-parejas-confirmadas">
    39	        <!-- Aquí se cargará por AJAX la lista de parejas guardadas -->
    40	    </div>
    41	</div>
    42	
    43	<div class="mensaje-parejas" id="mensaje-parejas" style="display:none;">
    44	    <!-- Aquí se mostrarán los mensajes de éxito/error -->
    45	</div>
===== END includes/forms/form-parejas-multiseleccion.php =====

===== BEGIN includes/forms/form-resultado-padel.php =====
     1	<?php
     2	/**
     3	 * Formulario visual de introducción y validación de resultados de partido - Pádel
     4	 * SaaS Torneos de Raqueta
     5	 * Ruta: /includes/forms/form-resultado-padel.php
     6	 * 
     7	 * Recibe: $partido_id (ID del partido), $modo (opcional: 'ver' o 'editar')
     8	 */
     9	
    10	// Función para logs profesionales en debug-saas-torneos.log
    11	if (!function_exists('str_escribir_log')) {
    12	    function str_escribir_log($mensaje, $origen = '') {
    13	        $ruta_log = plugin_dir_path(dirname(__FILE__, 2)) . 'debug-saas-torneos.log';
    14	        $timestamp = date('[Y-m-d H:i:s]');
    15	        $origen = $origen ? "[$origen]" : '';
    16	        if (is_array($mensaje) || is_object($mensaje)) {
    17	            $mensaje = print_r($mensaje, true);
    18	        }
    19	        $linea = "$timestamp $origen $mensaje" . PHP_EOL;
    20	        file_put_contents($ruta_log, $linea, FILE_APPEND | LOCK_EX);
    21	    }
    22	}
    23	
    24	// --- LOG DE INICIO (Para saber si se incluye el archivo) ---
    25	str_escribir_log([
    26	    'INICIO_FORM' => true,
    27	    'partido_id' => isset($partido_id) ? $partido_id : 'NO DEFINIDO'
    28	], 'FORM_PADEL');
    29	
    30	// Comprobar seguridad básica
    31	if (!isset($partido_id) || !get_post($partido_id)) {
    32	    str_escribir_log('Partido no válido. $partido_id=' . (isset($partido_id) ? $partido_id : 'NO DEFINIDO'), 'FORM_PADEL');
    33	    echo '<div class="str-error">Partido no válido</div>';
    34	    return;
    35	}
    36	
    37	$partido = get_post($partido_id);
    38	$tipo_partido = get_field('tipo_partido', $partido_id); // 'parejas' o 'individual'
    39	
    40	// *** CAMPOS DEL GRUPO ACF DE PÁDEL ***
    41	$estado         = get_field('estado', $partido_id); // Select: pendiente, resultado_propuesto, etc.
    42	$ronda          = get_field('ronda', $partido_id); // Select: grupos, cuartos, etc.
    43	$ganador_id     = get_field('ganador', $partido_id); // Relationship, ID
    44	$propuesto_por  = get_field('propuesto_por', $partido_id); // User, ID
    45	$observaciones  = get_field('oberservaciones', $partido_id); // Textarea
    46	$resultado      = get_field('resultado_padel', $partido_id); // repeater array
    47	
    48	// Nueva relación para competición de pádel
    49	$competicion_padel = get_field('competicion_padel', $partido_id);
    50	
    51	// LOG después de cargar campos
    52	str_escribir_log([
    53	    'DESPUES_CAMPOS_ACF' => true,
    54	    'partido_id' => $partido_id,
    55	    'estado' => $estado,
    56	    'ronda' => $ronda,
    57	    'ganador_id' => $ganador_id,
    58	    'pareja_1' => get_field('pareja_1', $partido_id),
    59	    'pareja_2' => get_field('pareja_2', $partido_id),
    60	    'competicion_padel' => $competicion_padel,
    61	], 'FORM_PADEL');
    62	
    63	// Opciones de ronda predefinidas
    64	$rondas_disponibles = [
    65	    'Grupos'  => 'Grupos',
    66	    'Cuartos' => 'Cuartos',
    67	    'Semis'   => 'Semis',
    68	    'Final'   => 'Final',
    69	];
    70	
    71	// Obtener nombres de equipos/jugadores y sus IDs reales
    72	if (strtolower($tipo_partido) === 'parejas') {
    73	    $equipo1_id_arr = get_field('pareja_1', $partido_id);
    74	    $equipo1_id = is_array($equipo1_id_arr) ? $equipo1_id_arr[0] : $equipo1_id_arr;
    75	
    76	    $equipo2_id_arr = get_field('pareja_2', $partido_id);
    77	    $equipo2_id = is_array($equipo2_id_arr) ? $equipo2_id_arr[0] : $equipo2_id_arr;
    78	
    79	    $equipo1_nombre = $equipo1_id ? get_the_title($equipo1_id) : 'N/A';
    80	    $equipo2_nombre = $equipo2_id ? get_the_title($equipo2_id) : 'N/A';
    81	} else {
    82	    $equipo1_id = get_field('jugador_1', $partido_id);
    83	    $equipo2_id = get_field('jugador_2', $partido_id);
    84	    $equipo1_nombre = $equipo1_id ? get_the_title($equipo1_id) : 'N/A';
    85	    $equipo2_nombre = $equipo2_id ? get_the_title($equipo2_id) : 'N/A';
    86	}
    87	
    88	// Mostrar SIEMPRE 3 sets para pádel
    89	$max_sets = 3;
    90	// Inicializar sets vacíos
    91	$sets = [
    92	    0 => ['juegos_equipo_1'=>'', 'juegos_equipo_2'=>'', 'tipo_set'=>'Normal'],
    93	    1 => ['juegos_equipo_1'=>'', 'juegos_equipo_2'=>'', 'tipo_set'=>'Normal'],
    94	    2 => ['juegos_equipo_1'=>'', 'juegos_equipo_2'=>'', 'tipo_set'=>'Normal']
    95	];
    96	
    97	if (is_array($resultado)) {
    98	    foreach ($resultado as $idx => $set) {
    99	        if ($idx < $max_sets) {
   100	            $sets[$idx]['juegos_equipo_1'] = isset($set['juegos_equipo_1']) ? $set['juegos_equipo_1'] : '';
   101	            $sets[$idx]['juegos_equipo_2'] = isset($set['juegos_equipo_2']) ? $set['juegos_equipo_2'] : '';
   102	            $sets[$idx]['tipo_set']        = isset($set['tipo_set']) ? $set['tipo_set'] : 'Normal';
   103	        }
   104	    }
   105	}
   106	
   107	// Permisos y modo
   108	$current_user_id = get_current_user_id();
   109	$current_user_roles = function_exists('wp_get_current_user') ? wp_get_current_user()->roles : [];
   110	$puede_editar = true; // Temporalmente a true para pruebas
   111	
   112	// --- LOG PRE-RENDER: Confirmar datos principales antes de pintar la tabla ---
   113	str_escribir_log([
   114	    'RENDER_FORM' => true,
   115	    'partido_id'   => $partido_id,
   116	    'estado'       => $estado,
   117	    'puede_editar' => $puede_editar,
   118	    'equipo1_id'   => $equipo1_id,
   119	    'equipo1_nombre' => $equipo1_nombre,
   120	    'equipo2_id'   => $equipo2_id,
   121	    'equipo2_nombre' => $equipo2_nombre,
   122	    'sets'         => $sets
   123	], 'FORM_PADEL');
   124	
   125	// --- Mostrar el selector o badge de ronda --- //
   126	?>
   127	<div class="str-partido-ronda-select" style="margin-bottom: 16px;">
   128	    <strong>Ronda:</strong>
   129	    <?php if ($puede_editar && (in_array('administrator', $current_user_roles) || in_array('cliente', $current_user_roles))) : ?>
   130	        <form method="post" class="form-editar-ronda" action="">
   131	            <input type="hidden" name="action" value="str_actualizar_ronda">
   132	            <input type="hidden" name="partido_id" value="<?php echo esc_attr($partido_id); ?>">
   133	            <select name="ronda" class="select-ronda" style="padding:3px 6px;">
   134	                <?php foreach ($rondas_disponibles as $val => $label) : ?>
   135	                    <option value="<?php echo esc_attr($val); ?>" <?php selected($ronda, $val); ?>><?php echo esc_html($label); ?></option>
   136	                <?php endforeach; ?>
   137	            </select>
   138	            <button type="submit" style="margin-left:6px;padding:3px 10px;">Guardar</button>
   139	        </form>
   140	        <script>
   141	        document.addEventListener('DOMContentLoaded', function() {
   142	            document.querySelectorAll('.form-editar-ronda').forEach(form => {
   143	                form.addEventListener('submit', function(e){
   144	                    e.preventDefault();
   145	                    const fd = new FormData(form);
   146	                    fetch(str_ajax_obj.ajax_url, {
   147	                        method: 'POST',
   148	                        credentials: 'same-origin',
   149	                        body: fd
   150	                    }).then(res => res.json()).then(resp => {
   151	                        if (resp.success) location.reload();
   152	                        else alert('Error al actualizar la ronda');
   153	                    });
   154	                });
   155	            });
   156	        });
   157	        </script>
   158	    <?php else: ?>
   159	        <span style="margin-left:10px;"><?php echo esc_html($ronda ?: 'Sin definir'); ?></span>
   160	    <?php endif; ?>
   161	</div>
   162	
   163	<div class="str-partido-tabla-wrap">
   164	    <table class="str-partido-resultado">
   165	        <thead>
   166	            <tr>
   167	                <th></th>
   168	                <?php for ($i = 1; $i <= $max_sets; $i++): ?>
   169	                    <th>Set-<?php echo $i; ?></th>
   170	                <?php endfor; ?>
   171	            </tr>
   172	        </thead>
   173	        <tbody>
   174	            <tr>
   175	                <td class="<?php echo ($ganador_id == $equipo1_id) ? 'str-ganador' : ''; ?>">
   176	                    <?php echo esc_html($equipo1_nombre); ?>
   177	                </td>
   178	                <?php foreach ($sets as $k => $set): ?>
   179	                    <td>
   180	                        <?php if ($puede_editar && in_array(strtolower($estado), ['pendiente', 'resultado propuesto'])): ?>
   181	                            <input type="number"
   182	                                   class="str-set-input"
   183	                                   name="sets[<?php echo $k; ?>][juegos_equipo_1]"
   184	                                   value="<?php echo esc_attr($set['juegos_equipo_1']); ?>"
   185	                                   min="0" max="7"
   186	                                   <?php echo (strtolower($estado) == 'confirmado') ? 'readonly' : ''; ?>
   187	                                   data-set="<?php echo $k; ?>" data-equipo="1">
   188	                            <select name="sets[<?php echo $k; ?>][tipo_set]" class="str-set-tipo" style="margin-left:5px;">
   189	                                <option value="Normal" <?php selected($set['tipo_set'], 'Normal'); ?>>Normal</option>
   190	                                <option value="Tie-Break" <?php selected($set['tipo_set'], 'Tie-Break'); ?>>Tie-Break</option>
   191	                                <option value="Super Tie-Break" <?php selected($set['tipo_set'], 'Super Tie-Break'); ?>>Super Tie-Break</option>
   192	                            </select>
   193	                        <?php else: ?>
   194	                            <?php echo ($set['juegos_equipo_1'] !== '') ? esc_html($set['juegos_equipo_1']) : '-'; ?>
   195	                            <?php if ($set['tipo_set']) : ?>
   196	                                <span class="str-tipo-set-label">(<?php echo esc_html($set['tipo_set']); ?>)</span>
   197	                            <?php endif; ?>
   198	                        <?php endif; ?>
   199	                    </td>
   200	                <?php endforeach; ?>
   201	            </tr>
   202	            <tr>
   203	                <td class="<?php echo ($ganador_id == $equipo2_id) ? 'str-ganador' : ''; ?>">
   204	                    <?php echo esc_html($equipo2_nombre); ?>
   205	                </td>
   206	                <?php foreach ($sets as $k => $set): ?>
   207	                    <td>
   208	                        <?php if ($puede_editar && in_array(strtolower($estado), ['pendiente', 'resultado propuesto'])): ?>
   209	                            <input type="number"
   210	                                   class="str-set-input"
   211	                                   name="sets[<?php echo $k; ?>][juegos_equipo_2]"
   212	                                   value="<?php echo esc_attr($set['juegos_equipo_2']); ?>"
   213	                                   min="0" max="7"
   214	                                   <?php echo (strtolower($estado) == 'confirmado') ? 'readonly' : ''; ?>
   215	                                   data-set="<?php echo $k; ?>" data-equipo="2">
   216	                        <?php else: ?>
   217	                            <?php echo ($set['juegos_equipo_2'] !== '') ? esc_html($set['juegos_equipo_2']) : '-'; ?>
   218	                        <?php endif; ?>
   219	                    </td>
   220	                <?php endforeach; ?>
   221	            </tr>
   222	        </tbody>
   223	    </table>
   224	    <?php if ($puede_editar && in_array(strtolower($estado), ['pendiente', 'resultado propuesto'])): ?>
   225	        <button class="str-btn-confirmar-resultado" data-partido="<?php echo esc_attr($partido_id); ?>">
   226	            Confirmar resultado
   227	        </button>
   228	    <?php elseif (strtolower($estado) === 'pendiente de validación'): ?>
   229	        <div class="str-msg-pendiente-validacion">
   230	            Resultado pendiente de validación por el rival.
   231	        </div>
   232	    <?php elseif (strtolower($estado) === 'confirmado'): ?>
   233	        <div class="str-badge-confirmado">Resultado confirmado</div>
   234	    <?php endif; ?>
   235	</div>
   236	
   237	<!-- Puedes incluir aquí el campo observaciones si lo deseas -->
   238	<?php if ($observaciones): ?>
   239	    <div class="str-observaciones-partido">
   240	        <strong>Observaciones:</strong> <?php echo esc_html($observaciones); ?>
   241	    </div>
   242	<?php endif; ?>
   243	
   244	<?php
   245	// Incluir aquí scripts JS solo si hace falta (o bien encolarlo globalmente)
   246	?>
===== END includes/forms/form-resultado-padel.php =====

===== BEGIN includes/functions/auth.php =====
     1	<?php
     2	/**
     3	 * Lógica personalizada de login frontend
     4	 */
     5	
     6	function str_procesar_login_frontend() {
     7	    if (!isset($_POST['str_login_frontend'])) return;
     8	
     9	    $creds = [
    10	        'user_login'    => sanitize_user($_POST['log']),
    11	        'user_password' => $_POST['pwd'],
    12	        'remember'      => true
    13	    ];
    14	
    15	    $user = wp_signon($creds, false);
    16	
    17	    if (is_wp_error($user)) {
    18	        wp_redirect(add_query_arg('login', 'failed', wp_get_referer()));
    19	        exit;
    20	    }
    21	
    22	    // Redirección según rol
    23	    if (in_array('cliente', $user->roles)) {
    24	        wp_redirect(home_url('/mis-competiciones'));
    25	    } elseif (in_array('jugador', $user->roles)) {
    26	        wp_redirect(home_url('/zona-jugador'));
    27	    } else {
    28	        wp_redirect(admin_url()); // Admin
    29	    }
    30	
    31	    exit;
    32	}
    33	add_action('init', 'str_procesar_login_frontend');
    34	
    35	function str_procesar_registro_cliente() {
    36	    if (!isset($_POST['str_registro_cliente'])) return;
    37	
    38	    $username = sanitize_user($_POST['str_username']);
    39	    $email    = sanitize_email($_POST['str_email']);
    40	    $password = $_POST['str_password'];
    41	
    42	    if (username_exists($username) || email_exists($email)) {
    43	        wp_redirect(add_query_arg('registro', 'fallido', wp_get_referer()));
    44	        exit;
    45	    }
    46	
    47	    $user_id = wp_create_user($username, $password, $email);
    48	
    49	    if (is_wp_error($user_id)) {
    50	        wp_redirect(add_query_arg('registro', 'fallido', wp_get_referer()));
    51	        exit;
    52	    }
    53	
    54	    // Asignar rol cliente
    55	    wp_update_user([
    56	        'ID' => $user_id,
    57	        'role' => 'cliente'
    58	    ]);
    59	
    60	    // Loguear y redirigir
    61	    wp_set_current_user($user_id);
    62	    wp_set_auth_cookie($user_id);
    63	
    64	    wp_redirect(home_url('/mis-competiciones'));
    65	    exit;
    66	}
    67	add_action('init', 'str_procesar_registro_cliente');
===== END includes/functions/auth.php =====

===== BEGIN includes/functions/competicion-generador.php =====
     1	<?php
     2	/**
     3	 * Ruta: /saas-torneos-de-raqueta/includes/functions/competicion-generador.php
     4	 * Lógica de generación de estructura de competición desde snapshot.
     5	 */
     6	
     7	if (!defined('ABSPATH')) { exit; }
     8	
     9	/** Logger básico (usa el mismo que en otros archivos si ya existe) */
    10	if (!function_exists('str_saas_log')) {
    11	    function str_saas_log($message, $context = []) {
    12	        $base = dirname(dirname(__DIR__));
    13	        $log_path = trailingslashit($base) . 'debug-saas-torneos.log';
    14	        $line = '[' . date('Y-m-d H:i:s') . '] ' . (is_string($message) ? $message : wp_json_encode($message, JSON_UNESCAPED_UNICODE));
    15	        if (!empty($context)) { $line .= ' | ' . wp_json_encode($context, JSON_UNESCAPED_UNICODE); }
    16	        $line .= PHP_EOL;
    17	        @file_put_contents($log_path, $line, FILE_APPEND);
    18	    }
    19	}
    20	
    21	/** Carga snapshot desde transient/option por simulacion_id */
    22	function str_cargar_snapshot_por_id($simulacion_id) {
    23	    $key = 'str_simulacion_' . $simulacion_id;
    24	    $json = get_transient($key);
    25	    if (!$json) { $json = get_option($key, ''); }
    26	    if (!$json) { return null; }
    27	    $data = json_decode($json, true);
    28	    return (json_last_error() === JSON_ERROR_NONE) ? $data : null;
    29	}
    30	
    31	/** Crea parejas placeholder ligadas a una competición y devuelve array de IDs */
    32	function str_crear_parejas_placeholder($competicion_id, $total_parejas) {
    33	    $ids = [];
    34	    for ($i = 1; $i <= $total_parejas; $i++) {
    35	        $title = 'Pareja ' . $i;
    36	        $post_id = wp_insert_post([
    37	            'post_type'   => 'pareja',
    38	            'post_title'  => $title,
    39	            'post_status' => 'publish',
    40	            'post_author' => get_current_user_id()
    41	        ]);
    42	        if (is_wp_error($post_id)) {
    43	            str_saas_log('ERROR creando pareja placeholder', ['error' => $post_id->get_error_message(), 'i' => $i]);
    44	            continue;
    45	        }
    46	        update_post_meta($post_id, 'placeholder', 1);
    47	        update_post_meta($post_id, 'competicion_id', $competicion_id);
    48	        $ids[] = $post_id;
    49	    }
    50	    return $ids;
    51	}
    52	
    53	/** Crea un post de grupo y devuelve su ID */
    54	function str_crear_grupo($competicion_id, $letra, $orden, $tamano) {
    55	    $post_id = wp_insert_post([
    56	        'post_type'   => 'grupo',
    57	        'post_title'  => 'Grupo ' . $letra,
    58	        'post_status' => 'publish',
    59	        'post_author' => get_current_user_id()
    60	    ]);
    61	    if (is_wp_error($post_id)) {
    62	        str_saas_log('ERROR creando grupo', ['letra' => $letra, 'error' => $post_id->get_error_message()]);
    63	        return 0;
    64	    }
    65	    update_post_meta($post_id, 'competicion_id', $competicion_id);
    66	    update_post_meta($post_id, 'letra', $letra);
    67	    update_post_meta($post_id, 'orden', $orden);
    68	    update_post_meta($post_id, 'tam', $tamano);
    69	    return $post_id;
    70	}
    71	
    72	/** Genera todos los partidos round-robin dentro de un grupo (con parejas asignadas) */
    73	function str_generar_partidos_grupo($competicion_id, $grupo_id, $parejas_ids) {
    74	    $n = count($parejas_ids);
    75	    for ($i = 0; $i < $n; $i++) {
    76	        for ($j = $i + 1; $j < $n; $j++) {
    77	            $p1 = $parejas_ids[$i];
    78	            $p2 = $parejas_ids[$j];
    79	            $pid = wp_insert_post([
    80	                'post_type'   => 'partido',
    81	                'post_title'  => 'Grupo ' . get_post_meta($grupo_id, 'letra', true) . ': ' . get_the_title($p1) . ' vs ' . get_the_title($p2),
    82	                'post_status' => 'publish',
    83	                'post_author' => get_current_user_id()
    84	            ]);
    85	            if (is_wp_error($pid)) {
    86	                str_saas_log('ERROR creando partido grupo', ['grupo_id' => $grupo_id, 'error' => $pid->get_error_message()]);
    87	                continue;
    88	            }
    89	            // Meta: enlazamos correctamente
    90	            update_post_meta($pid, 'competicion_padel', $competicion_id); // ACF relación a competición
    91	            update_post_meta($pid, 'grupo_id', $grupo_id);
    92	            update_post_meta($pid, 'ronda', 'Grupos'); // coincide con tu ACF "Ronda"
    93	            update_post_meta($pid, 'estado', 'Pendiente');
    94	            // Relaciones a parejas (ACF espera IDs)
    95	            update_post_meta($pid, 'pareja_1', $p1);
    96	            update_post_meta($pid, 'pareja_2', $p2);
    97	        }
    98	    }
    99	}
   100	
   101	/** Crea un partido del cuadro con slots (pareja_a/b vacías hasta que se conozcan). Devuelve ID */
   102	function str_crear_partido_bracket($competicion_id, $ronda_label, $slot_a, $slot_b, $orden = 1, $grupo_letra = '') {
   103	    $title = ($grupo_letra ? "Grupo $grupo_letra – " : '') . "$ronda_label: $slot_a vs $slot_b";
   104	    $pid = wp_insert_post([
   105	        'post_type'   => 'partido',
   106	        'post_title'  => $title,
   107	        'post_status' => 'publish',
   108	        'post_author' => get_current_user_id()
   109	    ]);
   110	    if (is_wp_error($pid)) {
   111	        str_saas_log('ERROR creando partido bracket', ['slot_a' => $slot_a, 'slot_b' => $slot_b, 'error' => $pid->get_error_message()]);
   112	        return 0;
   113	    }
   114	    update_post_meta($pid, 'competicion_padel', $competicion_id);
   115	    update_post_meta($pid, 'ronda', $ronda_label); // 'Cuartos' | 'Semis' | 'Final'
   116	    update_post_meta($pid, 'estado', 'Pendiente');
   117	    update_post_meta($pid, 'slot_a', $slot_a);
   118	    update_post_meta($pid, 'slot_b', $slot_b);
   119	    update_post_meta($pid, 'orden', intval($orden));
   120	    if ($grupo_letra) { update_post_meta($pid, 'grupo_bracket', $grupo_letra); }
   121	    // Sin pareja_1/pareja_2 todavía (se rellenarán cuando haya clasificación)
   122	    return $pid;
   123	}
   124	
   125	/** Genera el bracket (premios por grupo o mezclar) en función de la fase final */
   126	function str_generar_bracket($competicion_id, $modo_final, $fase_final, $grupos_info) {
   127	    // $grupos_info: array [['letra'=>'A','tam'=>4,...], ...]
   128	    $fase_final = strtolower($fase_final); // final|semifinal|cuartos|octavos
   129	    $modo_final = strtolower($modo_final); // premios_grupo|mezclar
   130	
   131	    if ($modo_final === 'premios_grupo') {
   132	        // Minibrackets independientes por grupo
   133	        foreach ($grupos_info as $g) {
   134	            $L = $g['letra'];
   135	            switch ($fase_final) {
   136	                case 'final':
   137	                    str_crear_partido_bracket($competicion_id, 'Final', "1º $L", "2º $L", 1, $L);
   138	                    break;
   139	                case 'semifinal':
   140	                    str_crear_partido_bracket($competicion_id, 'Semis', "1º $L", "4º $L", 1, $L);
   141	                    str_crear_partido_bracket($competicion_id, 'Semis', "2º $L", "3º $L", 2, $L);
   142	                    str_crear_partido_bracket($competicion_id, 'Final', "Ganador S1 ($L)", "Ganador S2 ($L)", 3, $L);
   143	                    break;
   144	                case 'cuartos':
   145	                    // Cuartos: 1º vs 4º y 2º vs 3º (dos cruces)
   146	                    str_crear_partido_bracket($competicion_id, 'Cuartos', "1º $L", "4º $L", 1, $L);
   147	                    str_crear_partido_bracket($competicion_id, 'Cuartos', "2º $L", "3º $L", 2, $L);
   148	                    // Semis con Ganadores de Cuartos
   149	                    str_crear_partido_bracket($competicion_id, 'Semis', "Ganador Q1 ($L)", "Ganador Q2 ($L)", 3, $L);
   150	                    // Final
   151	                    str_crear_partido_bracket($competicion_id, 'Final', "Ganador S1 ($L)", "Ganador S2 ($L)", 4, $L);
   152	                    break;
   153	                case 'octavos':
   154	                    // Demasiado grande por grupo en la práctica; dejamos estructura indicativa:
   155	                    for ($i=1; $i<=4; $i++) {
   156	                        str_crear_partido_bracket($competicion_id, 'Octavos', "Seed ".(2*$i-1)." $L", "Seed ".(2*$i)." $L", $i, $L);
   157	                    }
   158	                    // Cuartos, Semis, Final como progresión
   159	                    for ($i=1; $i<=2; $i++) {
   160	                        str_crear_partido_bracket($competicion_id, 'Cuartos', "Ganador O".(2*$i-1)." ($L)", "Ganador O".(2*$i)." ($L)", $i, $L);
   161	                    }
   162	                    str_crear_partido_bracket($competicion_id, 'Semis', "Ganador C1 ($L)", "Ganador C2 ($L)", 1, $L);
   163	                    str_crear_partido_bracket($competicion_id, 'Final', "Ganador S1 ($L)", "Ganador S2 ($L)", 1, $L);
   164	                    break;
   165	            }
   166	        }
   167	        return;
   168	    }
   169	
   170	    // MODO: MEZCLAR GRUPOS (bracket único)
   171	    $letras = array_map(function($g){ return $g['letra']; }, $grupos_info);
   172	    $G = count($letras);
   173	
   174	    switch ($fase_final) {
   175	        case 'final':
   176	            // Suponiendo 2 plazas totales: 1º de los dos mejores grupos o del ranking general
   177	            // Estructura de slots: genérica
   178	            str_crear_partido_bracket($competicion_id, 'Final', "1º A", (isset($letras[1]) ? "1º " . $letras[1] : "1º B"), 1);
   179	            break;
   180	
   181	        case 'semifinal':
   182	            // 4 plazas: cruce 1ºA vs 2ºB y 1ºB vs 2ºA (si G>=2). Con más grupos, el mapeo puede ser A-B y C-D etc.
   183	            if ($G >= 2) {
   184	                str_crear_partido_bracket($competicion_id, 'Semis', "1º {$letras[0]}", "2º {$letras[1]}", 1);
   185	                str_crear_partido_bracket($competicion_id, 'Semis', "1º {$letras[1]}", "2º {$letras[0]}", 2);
   186	            } else {
   187	                // Si sólo hay 1 grupo: 1º vs 2º
   188	                str_crear_partido_bracket($competicion_id, 'Semis', "1º {$letras[0]}", "2º {$letras[0]}", 1);
   189	                str_crear_partido_bracket($competicion_id, 'Semis', "3º {$letras[0]}", "4º {$letras[0]}", 2);
   190	            }
   191	            str_crear_partido_bracket($competicion_id, 'Final', "Ganador S1", "Ganador S2", 3);
   192	            break;
   193	
   194	        case 'cuartos':
   195	            // 8 plazas. Con G pares: A vs B, C vs D, etc. Slots típicos:
   196	            // QF1: 1ºA vs 2ºB, QF2: 1ºB vs 2ºA, QF3: 1ºC vs 2ºD, QF4: 1ºD vs 2ºC, ...
   197	            $orden = 1;
   198	            for ($i = 0; $i < $G; $i += 2) {
   199	                $L1 = $letras[$i];
   200	                $L2 = isset($letras[$i+1]) ? $letras[$i+1] : $L1;
   201	                str_crear_partido_bracket($competicion_id, 'Cuartos', "1º $L1", "2º $L2", $orden++);
   202	                str_crear_partido_bracket($competicion_id, 'Cuartos', "1º $L2", "2º $L1", $orden++);
   203	            }
   204	            // Semis y Final (con ganadores ordenados)
   205	            str_crear_partido_bracket($competicion_id, 'Semis', "Ganador Q1", "Ganador Q2", 1);
   206	            str_crear_partido_bracket($competicion_id, 'Semis', "Ganador Q3", "Ganador Q4", 2);
   207	            str_crear_partido_bracket($competicion_id, 'Final', "Ganador S1", "Ganador S2", 3);
   208	            break;
   209	
   210	        case 'octavos':
   211	            // 16 plazas, mapeo similar en bloques de 4 grupos. Por brevedad, estructura indicativa:
   212	            for ($i=1; $i<=8; $i++) {
   213	                str_crear_partido_bracket($competicion_id, 'Octavos', "Seed ".(2*$i-1), "Seed ".(2*$i), $i);
   214	            }
   215	            for ($i=1; $i<=4; $i++) {
   216	                str_crear_partido_bracket($competicion_id, 'Cuartos', "Ganador O".(2*$i-1), "Ganador O".(2*$i), $i);
   217	            }
   218	            str_crear_partido_bracket($competicion_id, 'Semis', "Ganador C1", "Ganador C2", 1);
   219	            str_crear_partido_bracket($competicion_id, 'Semis', "Ganador C3", "Ganador C4", 2);
   220	            str_crear_partido_bracket($competicion_id, 'Final', "Ganador S1", "Ganador S2", 3);
   221	            break;
   222	    }
   223	}
   224	
   225	/**
   226	 * FUNCIÓN PRINCIPAL: Generar estructura completa desde simulación
   227	 * - Crea parejas placeholder
   228	 * - Crea grupos y asigna parejas por orden
   229	 * - Crea partidos round-robin
   230	 * - Crea bracket por slots (sin asignar parejas aún)
   231	 */
   232	function str_generar_competicion_desde_snapshot($competicion_id, $simulacion_id) {
   233	    $snapshot = str_cargar_snapshot_por_id($simulacion_id);
   234	    if (!is_array($snapshot)) {
   235	        str_saas_log('SNAPSHOT no encontrado', ['simulacion_id' => $simulacion_id]);
   236	        return new WP_Error('snapshot_not_found', 'No se pudo cargar el snapshot de simulación.');
   237	    }
   238	
   239	    $P           = intval($snapshot['n_parejas_calc']);
   240	    $n_grupos    = intval($snapshot['n_grupos']);
   241	    $fase_final  = $snapshot['fase_final'];
   242	    $modo_final  = $snapshot['cuadro_opcion']; // 'premios_grupo' | 'mezclar'
   243	    $grupos_snap = $snapshot['grupos'];        // [['nombre'=>'A','tam'=>X,'participantes'=>[...] ]...]
   244	
   245	    if ($P < 2 || $n_grupos < 1 || empty($grupos_snap)) {
   246	        return new WP_Error('snapshot_invalido', 'Snapshot de simulación incompleto.');
   247	    }
   248	
   249	    // 1) Parejas placeholder
   250	    $parejas_ids = str_crear_parejas_placeholder($competicion_id, $P);
   251	    if (count($parejas_ids) < $P) {
   252	        str_saas_log('WARNING parejas placeholder incompletas', ['esperadas' => $P, 'creadas' => count($parejas_ids)]);
   253	    }
   254	
   255	    // 2) Crear grupos y asignar parejas por orden
   256	    $letras = range('A', 'Z');
   257	    $offset = 0;
   258	    $grupos_creados = []; // para bracket
   259	    foreach ($grupos_snap as $idx => $g) {
   260	        $letra = isset($g['nombre']) ? $g['nombre'] : ( $letras[$idx] ?? 'G'.($idx+1) );
   261	        $tam   = isset($g['tam']) ? intval($g['tam']) : 0;
   262	
   263	        $grupo_id = str_crear_grupo($competicion_id, $letra, $idx+1, $tam);
   264	        if ($grupo_id <= 0) { continue; }
   265	
   266	        // Asignar parejas al grupo (por índice)
   267	        $asignadas = array_slice($parejas_ids, $offset, $tam);
   268	        $offset += $tam;
   269	
   270	        // Guardar lista en meta (IDs de parejas en el grupo)
   271	        update_post_meta($grupo_id, 'participantes', $asignadas);
   272	
   273	        // 3) Fixtures round-robin de este grupo
   274	        if (count($asignadas) >= 2) {
   275	            str_generar_partidos_grupo($competicion_id, $grupo_id, $asignadas);
   276	        }
   277	
   278	        $grupos_creados[] = ['letra' => $letra, 'id' => $grupo_id, 'tam' => $tam];
   279	    }
   280	
   281	    // 4) Bracket (slots)
   282	    str_generar_bracket($competicion_id, $modo_final, $fase_final, $grupos_creados);
   283	
   284	    // 5) Guardar algunos metas globales para referencia
   285	    update_post_meta($competicion_id, 'str_estructura_generada', 1);
   286	    update_post_meta($competicion_id, 'str_mapa_slots_bracket', wp_json_encode([
   287	        'modo'  => $modo_final,
   288	        'fase'  => $fase_final,
   289	        'grupos'=> array_map(function($g){ return $g['letra']; }, $grupos_creados)
   290	    ], JSON_UNESCAPED_UNICODE));
   291	
   292	    str_saas_log('ESTRUCTURA generada', [
   293	        'competicion_id' => $competicion_id,
   294	        'simulacion_id'  => $simulacion_id,
   295	        'parejas'        => count($parejas_ids),
   296	        'grupos'         => count($grupos_creados),
   297	        'fase'           => $fase_final,
   298	        'modo'           => $modo_final
   299	    ]);
   300	
   301	    return true;
   302	}
===== END includes/functions/competicion-generador.php =====

===== BEGIN includes/functions/crear-competicion.php =====
     1	<?php
     2	/**
     3	 * Guardado de competiciones (frontend cliente)
     4	 * - Lee los campos del formulario estándar.
     5	 * - (Nuevo) Si llega un snapshot del SIMULADOR, lo persiste en metas
     6	 *   y crea automáticamente los posts "grupo" hijos de la competición.
     7	 */
     8	
     9	if ( ! defined('ABSPATH') ) { exit; }
    10	
    11	/**
    12	 * Logger de apoyo (escritura en debug-saas-torneos.log)
    13	 */
    14	if (!function_exists('str_escribir_log')) {
    15	    function str_escribir_log($mensaje, $origen = '') {
    16	        $ruta_log = plugin_dir_path(dirname(__FILE__, 2)) . 'debug-saas-torneos.log';
    17	        $timestamp = date('[Y-m-d H:i:s]');
    18	        $origen = $origen ? "[$origen]" : '';
    19	        if (is_array($mensaje) || is_object($mensaje)) {
    20	            $mensaje = print_r($mensaje, true);
    21	        }
    22	        @file_put_contents($ruta_log, $timestamp . " $origen " . $mensaje . PHP_EOL, FILE_APPEND | LOCK_EX);
    23	    }
    24	}
    25	
    26	/**
    27	 * Acción de guardado
    28	 *
    29	 * Importante: este handler se invoca desde admin-post.php con action=str_guardar_competicion
    30	 */
    31	function str_guardar_competicion_cliente() {
    32	
    33	    // Seguridad y permisos
    34	    if ( !is_user_logged_in() || ( !current_user_can('cliente') && !current_user_can('administrator') ) ) {
    35	        wp_die('No autorizado');
    36	    }
    37	
    38	    if ( !isset($_POST['str_crear_competicion']) ) {
    39	        wp_redirect( home_url('/panel-del-cliente') );
    40	        exit;
    41	    }
    42	
    43	    // Sanitizar campos base del formulario
    44	    $titulo      = isset($_POST['titulo']) ? sanitize_text_field($_POST['titulo']) : '';
    45	    $deporte     = isset($_POST['deporte']) ? sanitize_text_field($_POST['deporte']) : '';
    46	    $tipo        = isset($_POST['tipo_competicion']) ? sanitize_text_field($_POST['tipo_competicion']) : 'Torneo';
    47	    $categoria   = isset($_POST['categoria']) ? sanitize_text_field($_POST['categoria']) : '';
    48	    $formato     = isset($_POST['formato_competicion']) ? sanitize_text_field($_POST['formato_competicion']) : '';
    49	    $sistema     = isset($_POST['sistema_puntuacion']) ? sanitize_text_field($_POST['sistema_puntuacion']) : '';
    50	    $n_jugadores = isset($_POST['n_jugadores']) ? intval($_POST['n_jugadores']) : 0;
    51	    $descripcion = isset($_POST['descripcion_competicion']) ? sanitize_textarea_field($_POST['descripcion_competicion']) : '';
    52	
    53	    // Crear post de competición
    54	    $post_id = wp_insert_post([
    55	        'post_type'   => 'competicion',
    56	        'post_title'  => $titulo ? $titulo : 'Nueva competición',
    57	        'post_status' => 'publish',
    58	        'post_author' => get_current_user_id()
    59	    ]);
    60	
    61	    if ( ! $post_id ) {
    62	        wp_die('Error al crear la competición.');
    63	    }
    64	
    65	    // Guardado ACF "base"
    66	    if ( function_exists('update_field') ) {
    67	        update_field('deporte', $deporte, $post_id);
    68	        update_field('tipo_competicion', $tipo, $post_id);
    69	        update_field('categoria', $categoria, $post_id);
    70	        update_field('formato_competicion', $formato, $post_id);
    71	        update_field('sistema_puntuacion', $sistema, $post_id);
    72	        update_field('n_jugadores', $n_jugadores, $post_id);
    73	        update_field('descripcion_competicion', $descripcion, $post_id);
    74	    } else {
    75	        // Fallback a metas normales si ACF no estuviera cargado
    76	        update_post_meta($post_id, 'deporte', $deporte);
    77	        update_post_meta($post_id, 'tipo_competicion', $tipo);
    78	        update_post_meta($post_id, 'categoria', $categoria);
    79	        update_post_meta($post_id, 'formato_competicion', $formato);
    80	        update_post_meta($post_id, 'sistema_puntuacion', $sistema);
    81	        update_post_meta($post_id, 'n_jugadores', $n_jugadores);
    82	        update_post_meta($post_id, 'descripcion_competicion', $descripcion);
    83	    }
    84	
    85	    // Guardar campos condicionales de Torneo / Ranking (ACF)
    86	    if ( $tipo === 'Torneo' ) {
    87	        $fecha_torneo = isset($_POST['fecha_torneo']) ? sanitize_text_field($_POST['fecha_torneo']) : '';
    88	        $hora_inicio  = isset($_POST['hora_inicio'])  ? sanitize_text_field($_POST['hora_inicio'])  : '';
    89	        $hora_fin     = isset($_POST['hora_fin'])     ? sanitize_text_field($_POST['hora_fin'])     : '';
    90	
    91	        if ( function_exists('update_field') ) {
    92	            update_field('tipo_competicion_torneo', [
    93	                'fecha_torneo' => $fecha_torneo,
    94	                'hora_inicio'  => $hora_inicio,
    95	                'hora_fin'     => $hora_fin
    96	            ], $post_id);
    97	        } else {
    98	            update_post_meta($post_id, 'fecha_torneo', $fecha_torneo);
    99	            update_post_meta($post_id, 'hora_inicio', $hora_inicio);
   100	            update_post_meta($post_id, 'hora_fin', $hora_fin);
   101	        }
   102	    }
   103	
   104	    if ( $tipo === 'Ranking' ) {
   105	        $fecha_inicio = isset($_POST['fecha_inicio']) ? sanitize_text_field($_POST['fecha_inicio']) : '';
   106	        $fecha_fin    = isset($_POST['fecha_fin'])    ? sanitize_text_field($_POST['fecha_fin'])    : '';
   107	
   108	        if ( function_exists('update_field') ) {
   109	            update_field('tipo_competicion_ranking', [
   110	                'fecha_inicio' => $fecha_inicio,
   111	                'fecha_fin'    => $fecha_fin
   112	            ], $post_id);
   113	        } else {
   114	            update_post_meta($post_id, 'fecha_inicio', $fecha_inicio);
   115	            update_post_meta($post_id, 'fecha_fin', $fecha_fin);
   116	        }
   117	    }
   118	
   119	    /**
   120	     * ─────────────────────────────────────────────────────────
   121	     * NUEVO: Lectura del snapshot del SIMULADOR y bootstrap
   122	     *        de metas + creación de grupos
   123	     * ─────────────────────────────────────────────────────────
   124	     */
   125	    $snapshot_json = null;
   126	
   127	    // Aceptamos varias claves por robustez
   128	    if ( !empty($_POST['sim_snapshot_b64']) ) {
   129	        $decoded = base64_decode( sanitize_text_field($_POST['sim_snapshot_b64']) );
   130	        if ($decoded) { $snapshot_json = $decoded; }
   131	    } elseif ( !empty($_POST['sim_snapshot']) ) {
   132	        $snapshot_json = wp_unslash($_POST['sim_snapshot']); // puede venir JSON puro
   133	    } elseif ( !empty($_POST['sim']) ) {
   134	        // por si llega bajo el mismo nombre que en query
   135	        $tmp = wp_unslash($_POST['sim']);
   136	        // si parece base64, intentamos decodificar
   137	        if ( preg_match('~^[A-Za-z0-9+/=_-]+$~', $tmp) ) {
   138	            $maybe = base64_decode(strtr($tmp, '-_', '+/'));
   139	            $snapshot_json = $maybe ? $maybe : $tmp;
   140	        } else {
   141	            $snapshot_json = $tmp;
   142	        }
   143	    }
   144	
   145	    $snapshot = null;
   146	    if ( $snapshot_json ) {
   147	        $snapshot = json_decode($snapshot_json, true);
   148	    }
   149	
   150	    // Valores por defecto (por si no llega snapshot)
   151	    $fase_final_slug     = 'final';
   152	    $modo_final          = 'premios_grupo'; // o 'mezclar'
   153	    $n_grupos_sugeridos  = 0;
   154	    $n_parejas_aprox     = ($n_jugadores > 0) ? max(1, intval($n_jugadores / 2)) : 0;
   155	
   156	    if ( is_array($snapshot) ) {
   157	        // Intentar mapear claves comunes del simulador
   158	        if ( isset($snapshot['fase_final']) ) {
   159	            $fase_final_slug = sanitize_key($snapshot['fase_final']); // final|semifinal|cuartos|octavos
   160	        } elseif ( isset($snapshot['fase_final_slug']) ) {
   161	            $fase_final_slug = sanitize_key($snapshot['fase_final_slug']);
   162	        }
   163	
   164	        if ( isset($snapshot['modo_final']) ) {
   165	            // premios_grupo | mezclar
   166	            $modo_final = ($snapshot['modo_final'] === 'mezclar') ? 'mezclar' : 'premios_grupo';
   167	        } elseif ( isset($snapshot['cuadro_opcion']) ) {
   168	            $modo_final = ($snapshot['cuadro_opcion'] === 'mezclar') ? 'mezclar' : 'premios_grupo';
   169	        }
   170	
   171	        if ( isset($snapshot['n_grupos']) ) {
   172	            $n_grupos_sugeridos = intval($snapshot['n_grupos']);
   173	        } elseif ( isset($snapshot['n_grupos_sugeridos']) ) {
   174	            $n_grupos_sugeridos = intval($snapshot['n_grupos_sugeridos']);
   175	        } elseif ( isset($snapshot['grupos']) && is_array($snapshot['grupos']) ) {
   176	            $n_grupos_sugeridos = count($snapshot['grupos']);
   177	        }
   178	
   179	        if ( isset($snapshot['n_parejas_calc']) ) {
   180	            $n_parejas_aprox = intval($snapshot['n_parejas_calc']);
   181	        }
   182	
   183	        // Guardar snapshot crudo para trazabilidad
   184	        update_post_meta($post_id, 'str_snapshot_sim', wp_json_encode($snapshot, JSON_UNESCAPED_UNICODE));
   185	    }
   186	
   187	    // Persistimos metas que la plantilla torneo.php mostrará en el resumen
   188	    update_post_meta($post_id, 'str_fase_final_slug',    $fase_final_slug);
   189	    update_post_meta($post_id, 'str_modo_final',         $modo_final);
   190	    update_post_meta($post_id, 'str_n_grupos_sugeridos', $n_grupos_sugeridos);
   191	    update_post_meta($post_id, 'str_n_parejas_aprox',    $n_parejas_aprox);
   192	
   193	    // Crear posts "grupo" si tenemos un número sugerido > 0 y aún no existen
   194	    if ( $n_grupos_sugeridos > 0 ) {
   195	
   196	        // ¿Ya hay grupos creados para esta competición?
   197	        $ya_existen = get_posts([
   198	            'post_type'      => 'grupo',
   199	            'posts_per_page' => 1,
   200	            'post_status'    => 'any',
   201	            'post_parent'    => $post_id,
   202	            'fields'         => 'ids',
   203	        ]);
   204	
   205	        if ( empty($ya_existen) ) {
   206	            $letras = range('A','Z');
   207	            for ($i = 0; $i < $n_grupos_sugeridos; $i++) {
   208	                $letra = isset($letras[$i]) ? $letras[$i] : (string)($i+1);
   209	
   210	                $grupo_id = wp_insert_post([
   211	                    'post_type'   => 'grupo',
   212	                    'post_title'  => 'Grupo ' . $letra,
   213	                    'post_status' => 'publish',
   214	                    'post_parent' => $post_id,
   215	                    'post_author' => get_current_user_id(),
   216	                ]);
   217	
   218	                if ( $grupo_id ) {
   219	                    // Metas mínimas que usa el JS/AJAX de grupos
   220	                    update_post_meta($grupo_id, 'letra', $letra);
   221	                    update_post_meta($grupo_id, 'orden', ($i + 1));
   222	                    update_post_meta($grupo_id, 'competicion_id', $post_id); // por si algún endpoint usa meta en vez de post_parent
   223	                }
   224	            }
   225	            str_escribir_log("Creación automática de {$n_grupos_sugeridos} grupos para competicion {$post_id}", 'CREAR-COMPETICION');
   226	        } else {
   227	            str_escribir_log("Ya existían grupos; no se crean duplicados para competicion {$post_id}", 'CREAR-COMPETICION');
   228	        }
   229	    } else {
   230	        str_escribir_log("No se creó ningún grupo (n_grupos_sugeridos={$n_grupos_sugeridos}) para competicion {$post_id}", 'CREAR-COMPETICION');
   231	    }
   232	
   233	    // Redirección final a la ficha de la competición
   234	    wp_redirect( get_permalink($post_id) );
   235	    exit;
   236	}
   237	add_action('admin_post_str_guardar_competicion', 'str_guardar_competicion_cliente');
===== END includes/functions/crear-competicion.php =====

===== BEGIN includes/functions/login-redirect.php =====
     1	<?php
     2	// /includes/functions/login-redirect.php
     3	
     4	add_filter('login_redirect', 'str_login_redirect_jugador_individual', 20, 3);
     5	
     6	function str_login_redirect_jugador_individual($redirect_to, $request, $user) {
     7	    if (!isset($user->roles) || !is_array($user->roles)) {
     8	        return $redirect_to;
     9	    }
    10	
    11	    if (in_array('jugador', $user->roles)) {
    12	        // Buscar el CPT "jugador_deportes" con el campo user_id = $user->ID
    13	        $jugador_query = new WP_Query([
    14	            'post_type'      => 'jugador_deportes',
    15	            'posts_per_page' => 1,
    16	            'meta_query'     => [
    17	                [
    18	                    'key'   => 'user_id',
    19	                    'value' => $user->ID,
    20	                    'compare' => '='
    21	                ]
    22	            ]
    23	        ]);
    24	
    25	        if ($jugador_query->have_posts()) {
    26	            $jugador_post = $jugador_query->posts[0];
    27	            $url_jugador = get_permalink($jugador_post->ID);
    28	            if ($url_jugador) {
    29	                return $url_jugador;
    30	            }
    31	        }
    32	
    33	        // Si no tiene CPT, fallback a página de jugadores general
    34	        return 'https://www.torneospadelxperience.es/jugador/';
    35	    }
    36	
    37	    // Otros roles: redirección por defecto
    38	    return $redirect_to;
    39	}
===== END includes/functions/login-redirect.php =====

===== BEGIN includes/functions/registro-pareja.php =====
     1	<?php
     2	/**
     3	 * Procesa el registro de una pareja (dos jugadores) en una competición.
     4	 * Ruta: /includes/functions/registro-pareja.php
     5	 */
     6	
     7	// Hooks para AJAX de WordPress (logueado y visitante)
     8	add_action('wp_ajax_str_registrar_pareja', 'str_registrar_pareja');
     9	add_action('wp_ajax_nopriv_str_registrar_pareja', 'str_registrar_pareja');
    10	
    11	function str_registrar_pareja() {
    12	    // --- LOG: Registra el payload recibido en el debug.log para depuración ---
    13	    error_log('Payload recibido en str_registrar_pareja: ' . print_r($_POST, true));
    14	
    15	    // --- Recoger y sanitizar los datos del formulario ---
    16	    // Si se ha seleccionado un jugador existente, recibimos el ID, si es nuevo recibimos los datos completos
    17	    $jugador1_id = isset($_POST['jugador_1_id']) && is_numeric($_POST['jugador_1_id']) ? intval($_POST['jugador_1_id']) : null;
    18	    $jugador2_id = isset($_POST['jugador_2_id']) && is_numeric($_POST['jugador_2_id']) ? intval($_POST['jugador_2_id']) : null;
    19	
    20	    $nombre_1    = sanitize_text_field($_POST['nombre_jugador_1'] ?? '');
    21	    $apellido_1  = sanitize_text_field($_POST['apellidos_jugador_1'] ?? '');
    22	    $email_1     = sanitize_email($_POST['email_jugador_1'] ?? '');
    23	    $telefono_1  = sanitize_text_field($_POST['telefono_jugador_1'] ?? '');
    24	    $nombre_2    = sanitize_text_field($_POST['nombre_jugador_2'] ?? '');
    25	    $apellido_2  = sanitize_text_field($_POST['apellidos_jugador_2'] ?? '');
    26	    $email_2     = sanitize_email($_POST['email_jugador_2'] ?? '');
    27	    $telefono_2  = sanitize_text_field($_POST['telefono_jugador_2'] ?? '');
    28	    $deporte     = sanitize_text_field($_POST['deporte'] ?? '');
    29	    $torneo_id   = absint($_POST['torneo_id'] ?? 0);
    30	
    31	    // --- Validación básica de campos obligatorios ---
    32	    if (!$deporte || !$torneo_id) {
    33	        wp_send_json_error(['mensaje' => 'Faltan datos obligatorios.']);
    34	    }
    35	
    36	    // --- Validación: emails de los dos jugadores no pueden coincidir ---
    37	    if ($email_1 && $email_2 && $email_1 === $email_2) {
    38	        wp_send_json_error(['mensaje' => 'Los dos jugadores deben tener emails distintos.']);
    39	    }
    40	
    41	    // --- Lógica para obtener/crear los posts de jugador ---
    42	    // Auxiliar para buscar/crear un jugador solo si no existe
    43	    function str_get_or_create_jugador($nombre, $apellido, $email, $telefono, $deporte) {
    44	        // Busca jugador por email (clave única)
    45	        $args = [
    46	            'post_type' => 'jugador_deportes',
    47	            'meta_query' => [[
    48	                'key' => 'email',
    49	                'value' => $email,
    50	                'compare' => '=',
    51	            ]],
    52	            'posts_per_page' => 1,
    53	            'fields' => 'ids',
    54	        ];
    55	        $q = get_posts($args);
    56	        if ($q && count($q) > 0) {
    57	            // Jugador existente: no se actualiza, solo se recupera el ID
    58	            return $q[0];
    59	        } else {
    60	            // Crear jugador nuevo si no existe ese email
    61	            $jugador_id = wp_insert_post([
    62	                'post_type' => 'jugador_deportes',
    63	                'post_title' => $nombre . ' ' . $apellido,
    64	                'post_status' => 'publish',
    65	            ]);
    66	            if ($jugador_id && !is_wp_error($jugador_id)) {
    67	                update_field('nombre', $nombre, $jugador_id);
    68	                update_field('apellido', $apellido, $jugador_id);
    69	                update_field('email', $email, $jugador_id);
    70	                update_field('telefono', $telefono, $jugador_id);
    71	                update_field('deporte', $deporte, $jugador_id);
    72	                return $jugador_id;
    73	            }
    74	        }
    75	        return false;
    76	    }
    77	
    78	    // --- Comprobación/creación de los dos jugadores ---
    79	    // Si se seleccionó un jugador existente (ID numérico), se usa ese ID.
    80	    // Si no, se crea uno nuevo con los datos rellenados
    81	    if (!$jugador1_id) {
    82	        // No se seleccionó existente, crear nuevo
    83	        if (!$nombre_1 || !$apellido_1 || !$email_1) {
    84	            wp_send_json_error(['mensaje' => 'Faltan datos del Jugador 1.']);
    85	        }
    86	        $jugador1_id = str_get_or_create_jugador($nombre_1, $apellido_1, $email_1, $telefono_1, $deporte);
    87	    }
    88	    if (!$jugador2_id) {
    89	        if (!$nombre_2 || !$apellido_2 || !$email_2) {
    90	            wp_send_json_error(['mensaje' => 'Faltan datos del Jugador 2.']);
    91	        }
    92	        $jugador2_id = str_get_or_create_jugador($nombre_2, $apellido_2, $email_2, $telefono_2, $deporte);
    93	    }
    94	
    95	    if (!$jugador1_id || !$jugador2_id) {
    96	        wp_send_json_error(['mensaje' => 'No se pudo crear o encontrar a los jugadores.']);
    97	    }
    98	    if ($jugador1_id === $jugador2_id) {
    99	        wp_send_json_error(['mensaje' => 'Debes elegir dos jugadores distintos.']);
   100	    }
   101	
   102	    // --- Comprobar si ya existe la pareja para ese torneo (en cualquier orden) ---
   103	    // Esto previene duplicados. Busca una pareja donde:
   104	    // - Ambos jugadores coincidan (jugador1/jugador2 o jugador2/jugador1)
   105	    // - El torneo asociado sea el actual
   106	    $pareja_args = [
   107	        'post_type' => 'pareja',
   108	        'posts_per_page' => 1,
   109	        'meta_query' => [
   110	            'relation' => 'AND',
   111	            [ // Coincidencia de los dos jugadores, sin importar el orden
   112	                'relation' => 'OR',
   113	                [ // Jugador1 en jugador_1 Y jugador2 en jugador_2
   114	                    'relation' => 'AND',
   115	                    [ 'key' => 'jugador_1', 'value' => $jugador1_id, 'compare' => '=' ],
   116	                    [ 'key' => 'jugador_2', 'value' => $jugador2_id, 'compare' => '=' ],
   117	                ],
   118	                [ // Jugador2 en jugador_1 Y jugador1 en jugador_2 (pareja invertida)
   119	                    'relation' => 'AND',
   120	                    [ 'key' => 'jugador_1', 'value' => $jugador2_id, 'compare' => '=' ],
   121	                    [ 'key' => 'jugador_2', 'value' => $jugador1_id, 'compare' => '=' ],
   122	                ],
   123	            ],
   124	            [ // El mismo torneo asociado (comparación exacta, ID puro)
   125	                'key' => 'torneo_asociado',
   126	                'value' => $torneo_id,
   127	                'compare' => '='
   128	            ],
   129	        ],
   130	        'fields' => 'ids',
   131	    ];
   132	    $parejas = get_posts($pareja_args);
   133	    if ($parejas && count($parejas) > 0) {
   134	        // Ya existe una pareja igual para este torneo, devolvemos error
   135	        wp_send_json_error(['mensaje' => 'Ya existe una pareja con estos jugadores en este torneo.']);
   136	    }
   137	
   138	    // --- Crear la pareja si todo es correcto ---
   139	    $titulo_pareja = get_the_title($jugador1_id) . ' + ' . get_the_title($jugador2_id);
   140	    $pareja_id = wp_insert_post([
   141	        'post_type' => 'pareja',
   142	        'post_title' => $titulo_pareja,
   143	        'post_status' => 'publish',
   144	    ]);
   145	    if ($pareja_id && !is_wp_error($pareja_id)) {
   146	        // Asociamos campos ACF
   147	        update_field('jugador_1', $jugador1_id, $pareja_id);
   148	        update_field('jugador_2', $jugador2_id, $pareja_id);
   149	        update_field('deporte', $deporte, $pareja_id);
   150	        update_field('torneo_asociado', $torneo_id, $pareja_id);
   151	        wp_send_json_success(['mensaje' => 'Pareja registrada correctamente.']);
   152	    } else {
   153	        wp_send_json_error(['mensaje' => 'No se pudo crear la pareja.']);
   154	    }
   155	}
===== END includes/functions/registro-pareja.php =====

===== BEGIN includes/functions/roles.php =====
     1	<?php
     2	/**
     3	 * Registro de roles personalizados para el plugin SaaS Torneos de Raqueta
     4	 */
     5	
     6	// Crear roles personalizados si no existen
     7	function str_add_custom_roles() {
     8	
     9	    // Rol: Cliente
    10	    if (!get_role('cliente')) {
    11	        add_role(
    12	            'cliente',
    13	            __('Cliente', 'saas-torneos'),
    14	            [
    15	                'read' => true,        // Puede ver contenido
    16	                'edit_posts' => false, // No puede editar entradas
    17	            ]
    18	        );
    19	    }
    20	
    21	    // Rol: Jugador
    22	    if (!get_role('jugador')) {
    23	        add_role(
    24	            'jugador',
    25	            __('Jugador', 'saas-torneos'),
    26	            [
    27	                'read' => true,        // Puede ver contenido
    28	                'edit_posts' => false,
    29	            ]
    30	        );
    31	    }
    32	}
    33	add_action('init', 'str_add_custom_roles');
===== END includes/functions/roles.php =====

===== BEGIN includes/functions/shortcodes.php =====
     1	<?php
     2	/**
     3	 * Archivo de shortcodes del plugin SaaS Torneos de Raqueta
     4	 */
     5	
     6	// Shortcode: [str_login_form]
     7	function str_shortcode_login_form() {
     8	    ob_start();
     9	    include STR_PLUGIN_PATH . 'templates/login/login-form.php';
    10	    return ob_get_clean();
    11	}
    12	add_shortcode('str_login_form', 'str_shortcode_login_form');
===== END includes/functions/shortcodes.php =====

===== BEGIN includes/shortcodes/ajustes.php =====
     1	<?php
     2	// Shortcode: [ajustes_cliente]
     3	function str_shortcode_ajustes_cliente() {
     4	    if (!is_user_logged_in() || (!current_user_can('cliente') && !current_user_can('administrator'))) {
     5	        return '<p>Acceso restringido. Debes iniciar sesión como cliente.</p>';
     6	    }
     7	
     8	    ob_start();
     9	
    10	    $current_user = wp_get_current_user();
    11	    ?>
    12	
    13	    <div class="str-dashboard-container">
    14	        <h2 class="str-bienvenida">Ajustes de cuenta</h2>
    15	
    16	        <ul style="list-style: none; padding: 0; font-size: 16px;">
    17	            <li><strong>Usuario:</strong> <?php echo esc_html($current_user->user_login); ?></li>
    18	            <li><strong>Email:</strong> <?php echo esc_html($current_user->user_email); ?></li>
    19	            <li><strong>Nombre mostrado:</strong> <?php echo esc_html($current_user->display_name); ?></li>
    20	        </ul>
    21	
    22	        <p>En futuras versiones podrás cambiar el logo del torneo, personalizar el texto de los correos, y ajustar tu panel.</p>
    23	    </div>
    24	
    25	    <?php
    26	    return ob_get_clean();
    27	}
    28	add_shortcode('ajustes_cliente', 'str_shortcode_ajustes_cliente');
===== END includes/shortcodes/ajustes.php =====

===== BEGIN includes/shortcodes/crear-competicion.php =====
     1	<?php
     2	/**
     3	 * Shortcode: [formulario_crear_competicion]
     4	 * Renderiza el formulario de creación de competición en una página pública
     5	 */
     6	
     7	function str_shortcode_formulario_crear_competicion() {
     8	    if (!is_user_logged_in() || (!current_user_can('cliente') && !current_user_can('administrator'))) {
     9	        return '<p>Acceso restringido. Debes iniciar sesión como cliente.</p>';
    10	    }
    11	
    12	    ob_start();
    13	
    14	    // Log visual para depuración
    15	    echo '<!-- [STR] Shortcode formulario_crear_competicion ejecutado correctamente -->';
    16	    ?>
    17	
    18	    <div class="str-dashboard-form">
    19	        <button class="str-btn-cerrar" onclick="window.history.back();">✖</button>
    20	
    21	        <h2>Crear nueva competición</h2>
    22	        <form action="<?php echo esc_url(admin_url('admin-post.php')); ?>" method="POST">
    23	            <input type="hidden" name="action" value="str_guardar_competicion">
    24	            <input type="hidden" name="str_crear_competicion" value="1">
    25	
    26	            <label>Título del torneo</label>
    27	            <input type="text" name="titulo" required>
    28	
    29	            <label>Deporte</label>
    30	            <select name="deporte" required>
    31	                <option value="">Selecciona...</option>
    32	                <option value="Padel">Pádel</option>
    33	                <option value="Tenis">Tenis</option>
    34	                <option value="Pickleball">Pickleball</option>
    35	                <option value="Tenis Playa">Tenis Playa</option>
    36	            </select>
    37	
    38	            <label>Tipo de competición</label>
    39	            <select name="tipo_competicion" required>
    40	                <option value="">Selecciona...</option>
    41	                <option value="Torneo">Torneo</option>
    42	                <option value="Ranking">Ranking</option>
    43	            </select>
    44	
    45	            <label>Categoría</label>
    46	            <select name="categoria" required>
    47	                <option value="">Selecciona...</option>
    48	                <option value="Masculina">Masculina</option>
    49	                <option value="Femenina">Femenina</option>
    50	                <option value="Mixta">Mixta</option>
    51	            </select>
    52	
    53	            <label>Formato</label>
    54	            <select name="formato_competicion" required>
    55	                <option value="">Selecciona...</option>
    56	                <option value="Grupos">Grupos</option>
    57	                <option value="Grupos + Bracket Final">Grupos + Bracket Final</option>
    58	            </select>
    59	
    60	            <label>Sistema de puntuación</label>
    61	            <select name="sistema_puntuacion" required>
    62	                <option value="">Selecciona...</option>
    63	                <option value="3v-1d">Victoria 3 pts / Derrota 1 pt</option>
    64	                <option value="3v-0d">Victoria 3 pts / Derrota 0 pts</option>
    65	            </select>
    66	
    67	            <label>Nº de jugadores/parejas</label>
    68	            <input type="number" name="n_jugadores" min="2" required>
    69	
    70	            <label>Descripción</label>
    71	            <textarea name="descripcion_competicion" rows="3"></textarea>
    72	
    73	            <div class="tipo_torneo">
    74	                <label>Fecha del torneo</label>
    75	                <input type="date" name="fecha_torneo">
    76	
    77	                <label>Hora inicio</label>
    78	                <input type="time" name="hora_inicio">
    79	
    80	                <label>Hora fin</label>
    81	                <input type="time" name="hora_fin">
    82	            </div>
    83	
    84	            <div class="tipo_ranking">
    85	                <label>Fecha de inicio</label>
    86	                <input type="date" name="fecha_inicio">
    87	
    88	                <label>Fecha de fin</label>
    89	                <input type="date" name="fecha_fin">
    90	            </div>
    91	
    92	            <button type="submit" class="str-btn">Crear competición</button>
    93	        </form>
    94	    </div>
    95	
    96	    <?php
    97	    return ob_get_clean();
    98	}
    99	add_shortcode('formulario_crear_competicion', 'str_shortcode_formulario_crear_competicion');
===== END includes/shortcodes/crear-competicion.php =====

===== BEGIN includes/shortcodes/init.php =====
     1	<?php
     2	/**
     3	 * Registro centralizado de todos los shortcodes largos del plugin
     4	 */
     5	
     6	require_once __DIR__ . '/panel-cliente.php';
     7	require_once __DIR__ . '/mis-competiciones.php';
     8	require_once __DIR__ . '/jugadores.php';
     9	require_once __DIR__ . '/ajustes.php';
    10	require_once __DIR__ . '/crear-competicion.php';
    11	require_once __DIR__ . '/registro-jugador.php';
    12	
    13	
    14	add_action('wp_enqueue_scripts', 'str_enqueue_css_nueva_competicion');
    15	function str_enqueue_css_nueva_competicion() {
    16	    if (is_page('crear-competicion')) {
    17	        wp_enqueue_style(
    18	            'str-nueva-competicion-css',
    19	            STR_PLUGIN_URL . 'assets/css/nueva-competicion.css',
    20	            [],
    21	            '1.1'
    22	        );
    23	    }
    24	}
===== END includes/shortcodes/init.php =====

===== BEGIN includes/shortcodes/jugadores.php =====
     1	<?php
     2	// Shortcode: [mis_jugadores]
     3	function str_shortcode_mis_jugadores() {
     4	    if (!is_user_logged_in() || (!current_user_can('cliente') && !current_user_can('administrator'))) {
     5	        return '<p>Acceso restringido. Debes iniciar sesión como cliente.</p>';
     6	    }
     7	
     8	    ob_start();
     9	
    10	    $current_user_id = get_current_user_id();
    11	
    12	    $args = [
    13	        'post_type'      => 'jugador_deportes',
    14	        'post_status'    => 'publish',
    15	        'author'         => $current_user_id,
    16	        'posts_per_page' => -1,
    17	        'orderby'        => 'title',
    18	        'order'          => 'ASC'
    19	    ];
    20	
    21	    $jugadores = new WP_Query($args);
    22	    ?>
    23	
    24	    <div class="str-dashboard-container">
    25	        <h2 class="str-bienvenida">Mis jugadores</h2>
    26	        <p class="str-tabla-intro">Aquí puedes consultar y gestionar todos los jugadores que tienes registrados en tus competiciones. Usa el buscador o haz clic en el encabezado para ordenar la lista por nombre.
    27	        </p>
    28	
    29	        <?php if ($jugadores->have_posts()): ?>
    30	            <div class="str-tabla-header-controls">
    31	                <div class="str-table-search-wrapper">
    32	                    <input type="text" id="str-table-search" class="str-table-search" placeholder="Buscar jugador..." autocomplete="off">
    33	                </div>
    34	            </div>
    35	            <div class="str-tabla-wrapper">
    36	                <table class="str-tabla" id="str-tabla-jugadores">
    37	                    <thead>
    38	                        <tr>
    39	                            <th data-sort="nombre" class="str-table-sortable">
    40	                                Nombre
    41	                                <span class="str-table-sort-icon" data-dir="desc"><i class="fas fa-sort"></i></span>
    42	                            </th>
    43	                            <th>Email</th>
    44	                            <th>Teléfono</th>
    45	                            <th>Perfil</th>
    46	                        </tr>
    47	                    </thead>
    48	                    <tbody>
    49	                        <?php while ($jugadores->have_posts()): $jugadores->the_post();
    50	                            $email    = get_field('email');
    51	                            $telefono = get_field('telefono');
    52	                            $perfil_url = get_permalink(); ?>
    53	                            <tr>
    54	                                <td><?php the_title(); ?></td>
    55	                                <td><?php echo esc_html($email); ?></td>
    56	                                <td><?php echo esc_html($telefono); ?></td>
    57	                                <td>
    58	                                    <a href="<?php echo esc_url($perfil_url); ?>" class="str-dashboard-btn str-btn-ver">Ver perfil</a>
    59	                                </td>
    60	                            </tr>
    61	                        <?php endwhile; ?>
    62	                    </tbody>
    63	                </table>
    64	            </div>
    65	        <?php else: ?>
    66	            <p>No tienes jugadores registrados aún.</p>
    67	        <?php endif; ?>
    68	
    69	        <?php wp_reset_postdata(); ?>
    70	    </div>
    71	
    72	    <script>
    73	    // === Filtro en vivo por nombre de jugador ===
    74	    document.addEventListener('DOMContentLoaded', function() {
    75	        var input = document.getElementById('str-table-search');
    76	        var table = document.getElementById('str-tabla-jugadores');
    77	        if (!table) return;
    78	        // FILTRO EN VIVO
    79	        if(input){
    80	            input.addEventListener('keyup', function() {
    81	                var filter = input.value.toLowerCase();
    82	                var trs = table.querySelectorAll("tbody tr");
    83	                trs.forEach(function(row) {
    84	                    var cell = row.querySelector("td");
    85	                    if (!cell) return;
    86	                    row.style.display = cell.textContent.toLowerCase().indexOf(filter) > -1 ? "" : "none";
    87	                });
    88	            });
    89	        }
    90	
    91	        // ORDENACION SOLO EN NOMBRE
    92	        let sortDirection = {};
    93	        var header = table.querySelector('th.str-table-sortable');
    94	        if (header) {
    95	            header.addEventListener('click', function() {
    96	                var rows = Array.from(table.tBodies[0].rows);
    97	                var colIdx = 0; // Nombre está en la primera columna
    98	                var dataType = 'nombre';
    99	                sortDirection[dataType] = !sortDirection[dataType];
   100	                var direction = sortDirection[dataType] ? 1 : -1;
   101	
   102	                // Cambia el icono de la cabecera
   103	                var icon = header.querySelector('.str-table-sort-icon i');
   104	                if (icon) {
   105	                    icon.className = direction === 1 ? "fas fa-sort-up" : "fas fa-sort-down";
   106	                }
   107	
   108	                rows.sort(function(a, b) {
   109	                    var cellA = a.cells[colIdx].textContent.trim().toLowerCase();
   110	                    var cellB = b.cells[colIdx].textContent.trim().toLowerCase();
   111	                    return direction * cellA.localeCompare(cellB);
   112	                });
   113	                rows.forEach(function(row) { table.tBodies[0].appendChild(row); });
   114	            });
   115	        }
   116	    });
   117	    </script>
   118	
   119	    <?php
   120	    return ob_get_clean();
   121	}
   122	add_shortcode('mis_jugadores', 'str_shortcode_mis_jugadores');
===== END includes/shortcodes/jugadores.php =====

===== BEGIN includes/shortcodes/mis-competiciones.php =====
     1	<?php
     2	// Shortcode: [mis_competiciones]
     3	function str_shortcode_mis_competiciones() {
     4	    if (!is_user_logged_in() || (!current_user_can('cliente') && !current_user_can('administrator'))) {
     5	        return '<p>Acceso restringido. Debes iniciar sesión como cliente.</p>';
     6	    }
     7	
     8	    ob_start();
     9	
    10	    $current_user_id = get_current_user_id();
    11	
    12	    $args = [
    13	        'post_type'      => 'competicion',
    14	        'post_status'    => 'publish',
    15	        'author'         => $current_user_id,
    16	        'posts_per_page' => -1,
    17	        'orderby'        => 'date',
    18	        'order'          => 'DESC'
    19	    ];
    20	
    21	    $competencias = new WP_Query($args);
    22	    ?>
    23	
    24	    <div class="str-dashboard-container">
    25	        <h2 class="str-bienvenida">Mis competiciones</h2>
    26	        <p class="str-tabla-intro">
    27	            Aquí puedes gestionar y consultar todas las competiciones que has creado. Usa el buscador o haz clic en los encabezados para ordenar la tabla.
    28	        </p>
    29	
    30	        <?php if ($competencias->have_posts()): ?>
    31	            <div class="str-tabla-header-controls">
    32	                <div class="str-table-search-wrapper">
    33	                    <input type="text" id="str-table-search" class="str-table-search" placeholder="Buscar competición..." autocomplete="off">
    34	                </div>
    35	            </div>
    36	            <div class="str-tabla-wrapper">
    37	                <table class="str-tabla" id="str-tabla-competicion">
    38	                    <thead>
    39	                        <tr>
    40	                            <th data-sort="competicion" class="str-table-sortable">
    41	                                Competición
    42	                                <span class="str-table-sort-icon" data-dir="desc"><i class="fas fa-sort"></i></span>
    43	                            </th>
    44	                            <th data-sort="fecha" class="str-table-sortable">
    45	                                Fecha
    46	                                <span class="str-table-sort-icon" data-dir="desc"><i class="fas fa-sort"></i></span>
    47	                            </th>
    48	                            <th data-sort="jugadores" class="str-table-sortable">
    49	                                Jugadores
    50	                                <span class="str-table-sort-icon" data-dir="desc"><i class="fas fa-sort"></i></span>
    51	                            </th>
    52	                            <th>Enlace</th>
    53	                        </tr>
    54	                    </thead>
    55	                    <tbody>
    56	                        <?php while ($competencias->have_posts()): $competencias->the_post();
    57	                            $fecha     = get_field('fecha');
    58	                            $jugadores = get_field('numero_jugadores');
    59	                            ?>
    60	                            <tr>
    61	                                <td><?php the_title(); ?></td>
    62	                                <td><?php echo esc_html($fecha); ?></td>
    63	                                <td><?php echo esc_html($jugadores); ?></td>
    64	                                <td>
    65	                                    <a href="<?php the_permalink(); ?>" class="str-dashboard-btn str-btn-ver">Ver competición</a>
    66	                                </td>
    67	                            </tr>
    68	                        <?php endwhile; ?>
    69	                    </tbody>
    70	                </table>
    71	            </div>
    72	        <?php else: ?>
    73	            <p>Aún no has creado ninguna competición.</p>
    74	        <?php endif; ?>
    75	
    76	        <?php wp_reset_postdata(); ?>
    77	    </div>
    78	
    79	    <script>
    80	    document.addEventListener('DOMContentLoaded', function() {
    81	        var input = document.getElementById('str-table-search');
    82	        var table = document.getElementById('str-tabla-competicion');
    83	        if (!table) return;
    84	
    85	        // Filtro en vivo
    86	        if(input){
    87	            input.addEventListener('keyup', function() {
    88	                var filter = input.value.toLowerCase();
    89	                var trs = table.querySelectorAll("tbody tr");
    90	                trs.forEach(function(row) {
    91	                    var cell = row.querySelector("td");
    92	                    if (!cell) return;
    93	                    row.style.display = cell.textContent.toLowerCase().indexOf(filter) > -1 ? "" : "none";
    94	                });
    95	            });
    96	        }
    97	
    98	        // Ordenar columnas
    99	        let sortDirection = {};
   100	        table.querySelectorAll('th.str-table-sortable').forEach(function(header, idx) {
   101	            header.addEventListener('click', function() {
   102	                var rows = Array.from(table.tBodies[0].rows);
   103	                var colIdx = idx;
   104	                var dataType = header.dataset.sort;
   105	                sortDirection[dataType] = !sortDirection[dataType];
   106	                var direction = sortDirection[dataType] ? 1 : -1;
   107	
   108	                // Cambia el icono de todas las cabeceras
   109	                table.querySelectorAll('th .str-table-sort-icon i').forEach(function(icon) {
   110	                    icon.className = "fas fa-sort";
   111	                });
   112	                let currentIcon = header.querySelector('.str-table-sort-icon i');
   113	                if (direction === 1) {
   114	                    currentIcon.className = "fas fa-sort-up";
   115	                } else {
   116	                    currentIcon.className = "fas fa-sort-down";
   117	                }
   118	
   119	                rows.sort(function(a, b) {
   120	                    var cellA = a.cells[colIdx].textContent.trim().toLowerCase();
   121	                    var cellB = b.cells[colIdx].textContent.trim().toLowerCase();
   122	                    if (dataType === "jugadores") {
   123	                        cellA = parseInt(cellA) || 0; cellB = parseInt(cellB) || 0;
   124	                        return direction * (cellA - cellB);
   125	                    } else if (dataType === "fecha") {
   126	                        var dA = cellA.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1');
   127	                        var dB = cellB.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$2-$1');
   128	                        return direction * (dA.localeCompare(dB));
   129	                    } else {
   130	                        return direction * cellA.localeCompare(cellB);
   131	                    }
   132	                });
   133	                rows.forEach(function(row) { table.tBodies[0].appendChild(row); });
   134	            });
   135	        });
   136	    });
   137	    </script>
   138	
   139	    <?php
   140	    return ob_get_clean();
   141	}
   142	add_shortcode('mis_competiciones', 'str_shortcode_mis_competiciones');
===== END includes/shortcodes/mis-competiciones.php =====

===== BEGIN includes/shortcodes/panel-cliente.php =====
     1	<?php
     2	/**
     3	 * Shortcode: Panel del Cliente
     4	 * Archivo: /includes/shortcodes/panel-cliente.php
     5	 */
     6	
     7	if ( ! defined( 'ABSPATH' ) ) exit; // Evitar acceso directo
     8	
     9	// Shortcode principal del panel del cliente
    10	function str_shortcode_panel_cliente() {
    11	    if ( ! is_user_logged_in() || ( ! current_user_can('cliente') && ! current_user_can('administrator') ) ) {
    12	        return '<p>Acceso restringido. Debes iniciar sesión como cliente.</p>';
    13	    }
    14	
    15	    ob_start();
    16	
    17	    ?>
    18	    <div class="str-dashboard-container">
    19	        <h2 class="str-dashboard-title">Panel del Cliente</h2>
    20	
    21	        <div class="str-dashboard-menu">
    22	            <ul>
    23	                <li><a href="<?php echo esc_url(add_query_arg('seccion', 'mis-competiciones')); ?>">Mis competiciones</a></li>
    24	                <li><a href="<?php echo esc_url(add_query_arg('seccion', 'jugadores')); ?>">Jugadores</a></li>
    25	                <li><a href="<?php echo esc_url(add_query_arg('seccion', 'ajustes')); ?>">Ajustes</a></li>
    26	                <li><a href="<?php echo esc_url(add_query_arg('seccion', 'nueva-competicion')); ?>">Crear nueva competición</a></li>
    27	            </ul>
    28	        </div>
    29	
    30	        <div class="str-dashboard-content">
    31	            <?php
    32	            $seccion = isset($_GET['seccion']) ? sanitize_text_field($_GET['seccion']) : 'mis-competiciones';
    33	
    34	            switch ($seccion) {
    35	                case 'mis-competiciones':
    36	                    $file = STR_PLUGIN_PATH . 'templates/dashboard/mis-competiciones.php';
    37	                    if ( file_exists($file) ) {
    38	                        include $file;
    39	                    } else {
    40	                        echo '<p>No se encontró la plantilla de competiciones.</p>';
    41	                    }
    42	                    break;
    43	
    44	                case 'jugadores':
    45	                    $file = STR_PLUGIN_PATH . 'templates/dashboard/jugadores.php';
    46	                    if ( file_exists($file) ) {
    47	                        include $file;
    48	                    } else {
    49	                        echo '<p>No se encontró la plantilla de jugadores.</p>';
    50	                    }
    51	                    break;
    52	
    53	                case 'ajustes':
    54	                    $file = STR_PLUGIN_PATH . 'templates/dashboard/ajustes.php';
    55	                    if ( file_exists($file) ) {
    56	                        include $file;
    57	                    } else {
    58	                        echo '<p>No se encontró la plantilla de ajustes.</p>';
    59	                    }
    60	                    break;
    61	
    62	                case 'nueva-competicion':
    63	                    $form_nueva_competicion = STR_PLUGIN_PATH . 'templates/dashboard/form-nueva-competicion.php';
    64	                    if ( file_exists($form_nueva_competicion) ) {
    65	                        include $form_nueva_competicion;
    66	                    } else {
    67	                        echo '<p>El formulario de nueva competición no está disponible.</p>';
    68	                        if ( function_exists('str_escribir_log') ) {
    69	                            str_escribir_log('El archivo form-nueva-competicion.php no existe. Include saltado.', 'panel-cliente.php');
    70	                        }
    71	                    }
    72	                    break;
    73	
    74	                default:
    75	                    echo '<p>Selecciona una opción del menú.</p>';
    76	                    break;
    77	            }
    78	            ?>
    79	        </div>
    80	    </div>
    81	    <?php
    82	
    83	    return ob_get_clean();
    84	}
    85	add_shortcode('panel_cliente', 'str_shortcode_panel_cliente');
===== END includes/shortcodes/panel-cliente.php =====

===== BEGIN includes/shortcodes/registro-jugador.php =====
     1	<?php
     2	// /includes/shortcodes/registro-jugador.php
     3	
     4	function str_shortcode_registro_jugador() {
     5	    ob_start();
     6	
     7	    // 1. Obtener token de la URL (?token=xxxxx)
     8	    $token = isset($_GET['token']) ? sanitize_text_field($_GET['token']) : '';
     9	
    10	    $current_user = wp_get_current_user();
    11	    $roles = (array) $current_user->roles;
    12	
    13	    $es_admin = in_array('administrator', $roles);
    14	    $es_cliente = in_array('cliente', $roles);
    15	
    16	    // Si es admin o cliente: NO necesita token y muestra formulario vacío para pruebas
    17	    if ($es_admin || $es_cliente) {
    18	        // Datos de ejemplo (vacíos para que puedan probar)
    19	        $nombre = '';
    20	        $apellidos = '';
    21	        $email = '';
    22	        $telefono = '';
    23	        $jugador_id = '';
    24	    } else {
    25	        // Si no hay token: acceso denegado
    26	        if (!$token) {
    27	            return '<div class="str-aviso-error">Acceso denegado. Token no proporcionado.</div>';
    28	        }
    29	
    30	        // 2. Buscar el jugador correspondiente a ese token
    31	        $jugador = null;
    32	        $query = new WP_Query([
    33	            'post_type' => 'jugador_deportes',
    34	            'posts_per_page' => 1,
    35	            'meta_query' => [
    36	                [
    37	                    'key' => 'token_invitacion',
    38	                    'value' => $token,
    39	                    'compare' => '='
    40	                ]
    41	            ]
    42	        ]);
    43	
    44	        if ($query->have_posts()) {
    45	            $jugador = $query->posts[0];
    46	        } else {
    47	            echo '<div class="str-registro-error">Token inválido o expirado.</div>';
    48	            return ob_get_clean();
    49	        }
    50	
    51	        // 3. Comprobar si ya está aceptado/registrado (campo ACF "estado_invitacion")
    52	        $estado = get_field('estado_invitacion', $jugador->ID);
    53	        if ($estado === 'aceptado') {
    54	            echo '<div class="str-registro-error">Ya estás registrado. <a href="' . wp_login_url() . '">Inicia sesión aquí</a>.</div>';
    55	            return ob_get_clean();
    56	        }
    57	
    58	        // 4. Obtener los datos para rellenar el formulario por defecto
    59	        $nombre = get_field('nombre', $jugador->ID);
    60	        $apellidos = get_field('apellido', $jugador->ID);
    61	        $email = get_field('email', $jugador->ID);
    62	        $telefono = get_field('telefono', $jugador->ID);
    63	        $jugador_id = $jugador->ID;
    64	    }
    65	
    66	    // 5. Cargar CSS y JS (asegúrate de que existan los archivos en /assets/css/ y /assets/js/)
    67	    echo '<link rel="stylesheet" href="' . STR_PLUGIN_URL . 'assets/css/registro-jugador.css">';
    68	    echo '<script src="' . STR_PLUGIN_URL . 'assets/js/registro-jugador.js"></script>';
    69	
    70	    // 6. Renderizar el formulario
    71	    ?>
    72	    <div class="str-registro-jugador-wrapper">
    73	        <h2>Registro de jugador</h2>
    74	        <form id="str-form-registro-jugador" autocomplete="off">
    75	            <input type="hidden" name="token" value="<?php echo esc_attr($token); ?>">
    76	            <input type="hidden" name="jugador_id" value="<?php echo esc_attr($jugador_id); ?>">
    77	            <div>
    78	                <label>Nombre*</label>
    79	                <input type="text" name="nombre" value="<?php echo esc_attr($nombre); ?>" required>
    80	            </div>
    81	            <div>
    82	                <label>Apellidos*</label>
    83	                <input type="text" name="apellidos" value="<?php echo esc_attr($apellidos); ?>" required>
    84	            </div>
    85	            <div>
    86	                <label>Email*</label>
    87	                <input type="email" name="email" value="<?php echo esc_attr($email); ?>" required>
    88	            </div>
    89	            <div>
    90	                <label>Teléfono</label>
    91	                <input type="text" name="telefono" value="<?php echo esc_attr($telefono); ?>">
    92	            </div>
    93	            <div>
    94	                <label>Contraseña*</label>
    95	                <input type="password" name="password" required>
    96	            </div>
    97	            <div>
    98	                <label>Confirmar contraseña*</label>
    99	                <input type="password" name="password2" required>
   100	            </div>
   101	            <button type="submit" id="btn-registro-jugador">Registrarme</button>
   102	            <div id="mensaje-registro-jugador" style="margin-top:10px;"></div>
   103	        </form>
   104	    </div>
   105	    <?php
   106	
   107	    return ob_get_clean();
   108	}
   109	add_shortcode('registro_jugador', 'str_shortcode_registro_jugador');
===== END includes/shortcodes/registro-jugador.php =====

===== BEGIN includes/sports/padel/torneo/index.css =====
     1	/* =========================================
     2	   TORNEO (vista principal)
     3	   Contenedor, tipografías, botones y tablas
     4	   ========================================= */
     5	
     6	/* ---- Paleta / tokens rápidos ---- */
     7	:root {
     8	  --tr-blue: #2f57eb;
     9	  --tr-blue-600: #2649c7;
    10	  --tr-bg: #ffffff;
    11	  --tr-text: #1b2248;
    12	  --tr-muted: #6b7294;
    13	  --tr-line: #e9edf6;
    14	  --tr-card: #ffffff;
    15	  --tr-card-shadow: 0 8px 24px rgba(22, 28, 45, 0.08);
    16	}
    17	
    18	/* ---- Contenedor principal de la vista ---- */
    19	#saas-tr-torneo {
    20	  box-sizing: border-box;
    21	  width: 100%;
    22	  /* Alineado al ancho de contenido del tema (Astra): */
    23	  max-width: 1140px;
    24	  margin: 0 auto 48px;
    25	  padding: 24px 24px 32px;
    26	  background: var(--tr-card);
    27	  border-radius: 14px;
    28	  box-shadow: var(--tr-card-shadow);
    29	  color: var(--tr-text);
    30	}
    31	
    32	/* Título */
    33	#saas-tr-torneo .saas-tr-titulo {
    34	  margin: 4px 0 18px;
    35	  font-size: 2.1rem;
    36	  line-height: 1.2;
    37	}
    38	
    39	/* Lista meta (deporte, tipo, etc.) */
    40	#saas-tr-torneo .saas-tr-meta {
    41	  margin: 0 0 18px;
    42	  padding-left: 20px;
    43	}
    44	#saas-tr-torneo .saas-tr-meta li {
    45	  margin: 6px 0;
    46	  color: var(--tr-text);
    47	}
    48	
    49	/* Descripción */
    50	#saas-tr-torneo .saas-tr-descripcion {
    51	  margin: 14px 0 10px;
    52	  color: var(--tr-muted);
    53	}
    54	
    55	/* ---- Botones reutilizables ---- */
    56	#saas-tr-torneo .saas-tr-btn {
    57	  appearance: none;
    58	  display: inline-flex;
    59	  align-items: center;
    60	  justify-content: center;
    61	  gap: .4rem;
    62	  padding: 10px 16px;
    63	  border-radius: 10px;
    64	  border: 1px solid transparent;
    65	  background: #f3f6ff;
    66	  color: var(--tr-blue);
    67	  font-weight: 600;
    68	  cursor: pointer;
    69	  transition: transform .04s ease, background .18s ease, color .18s ease, border-color .18s ease, box-shadow .18s ease;
    70	}
    71	#saas-tr-torneo .saas-tr-btn:hover {
    72	  background: #e9efff;
    73	}
    74	#saas-tr-torneo .saas-tr-btn:active {
    75	  transform: translateY(1px);
    76	}
    77	
    78	/* Variantes */
    79	#saas-tr-torneo .saas-tr-btn--primary {
    80	  background: var(--tr-blue);
    81	  color: #fff;
    82	  box-shadow: 0 4px 14px rgba(47, 87, 235, .26);
    83	}
    84	#saas-tr-torneo .saas-tr-btn--primary:hover { background: var(--tr-blue-600); }
    85	#saas-tr-torneo .saas-tr-btn--light {
    86	  background: #fff;
    87	  border-color: var(--tr-line);
    88	  color: var(--tr-blue);
    89	}
    90	#saas-tr-torneo .saas-tr-btn--light:hover {
    91	  background: #f8faff;
    92	  border-color: #dfe6fb;
    93	}
    94	
    95	/* Bloque de acciones (parejas: +añadir…) */
    96	#saas-tr-torneo .saas-tr-acciones {
    97	  display: flex;
    98	  gap: 10px;
    99	  margin: 10px 0 14px;
   100	}
   101	
   102	/* ---- “Cards” de secciones ---- */
   103	#saas-tr-torneo .saas-tr-bloque {
   104	  margin: 22px 0 28px;
   105	  padding: 18px 16px 6px;
   106	  border: 1px solid var(--tr-line);
   107	  border-radius: 12px;
   108	  background: #fff;
   109	  box-shadow: 0 2px 10px rgba(22, 28, 45, 0.03);
   110	}
   111	#saas-tr-torneo .saas-tr-bloque > h2 {
   112	  margin: 0 0 12px;
   113	  font-size: 1.5rem;
   114	}
   115	
   116	/* Sub-secciones dentro de “Gestión de grupos” */
   117	#saas-tr-torneo .saas-tr-seccion {
   118	  margin: 16px 0 20px;
   119	  padding: 14px 12px;
   120	  border: 2px dashed var(--tr-line);
   121	  border-radius: 12px;
   122	  background: #fbfcff;
   123	}
   124	#saas-tr-torneo .saas-tr-seccion > h3 {
   125	  margin: 0 0 10px;
   126	}
   127	
   128	/* ---- Tablas (parejas y listas varias) ---- */
   129	#saas-tr-torneo .saas-tr-tabla {
   130	  width: 100%;
   131	  border-collapse: separate;
   132	  border-spacing: 0;
   133	  background: #fff;
   134	  border-radius: 12px;
   135	  overflow: hidden;
   136	  box-shadow: 0 3px 16px rgba(40,60,160,0.08);
   137	  font-family: inherit;
   138	}
   139	
   140	#saas-tr-torneo .saas-tr-tabla thead tr {
   141	  background: #e8f0fe;
   142	}
   143	
   144	#saas-tr-torneo .saas-tr-tabla th,
   145	#saas-tr-torneo .saas-tr-tabla td {
   146	  padding: 12px 16px;
   147	  text-align: left;
   148	}
   149	
   150	#saas-tr-torneo .saas-tr-tabla th {
   151	  color: #1b2248;
   152	  font-weight: 700;
   153	  font-size: 1.02rem;
   154	  letter-spacing: 0.01em;
   155	  border-bottom: 2px solid #dde5f6;
   156	}
   157	
   158	#saas-tr-torneo .saas-tr-tabla tbody tr:nth-child(odd) { background: #f7fafd; }
   159	#saas-tr-torneo .saas-tr-tabla tbody tr:nth-child(even) { background: #f3f6fb; }
   160	#saas-tr-torneo .saas-tr-tabla tbody td {
   161	  color: #293054;
   162	  font-size: .98rem;
   163	  border-bottom: 1px solid #edf2fb;
   164	}
   165	#saas-tr-torneo .saas-tr-tabla tbody tr:last-child td { border-bottom: none; }
   166	#saas-tr-torneo .saas-tr-tabla tbody tr:hover { background: #e1ecfc; transition: background .12s; }
   167	
   168	/* ---- Ajustes finos / utilidades ---- */
   169	#saas-tr-torneo .saas-tr-hint {
   170	  color: var(--tr-muted);
   171	}
   172	
   173	/* Responsive */
   174	@media (max-width: 920px) {
   175	  #saas-tr-torneo { padding: 18px 14px 24px; }
   176	  #saas-tr-torneo .saas-tr-bloque { padding: 14px 12px 2px; }
   177	  #saas-tr-torneo .saas-tr-acciones { flex-wrap: wrap; }
   178	  #saas-tr-torneo .saas-tr-tabla th, 
   179	  #saas-tr-torneo .saas-tr-tabla td { padding: 10px 12px; }
   180	}
   181	/* ===== Ajuste de espaciado del bloque Parejas vs. Gestión de grupos ===== */
   182	.saas-tr-bloque--parejas {
   183	  margin-bottom: 20px; /* corto para no meter aire antes del siguiente bloque */
   184	}
   185	
   186	/* La tabla no añade margen extra por debajo */
   187	#tabla-parejas {
   188	  margin-bottom: 0;
   189	}
===== END includes/sports/padel/torneo/index.css =====

===== BEGIN includes/sports/padel/torneo/index.js =====
     1	/**
     2	 * TORNEOS · Editar (abrir/cerrar y guardar)
     3	 * Depende de que el PHP localice `saas_tr_ajax` con { ajax_url, nonce }
     4	 */
     5	(function () {
     6	  function ready(fn) {
     7	    if (document.readyState === 'loading') {
     8	      document.addEventListener('DOMContentLoaded', fn, { once: true });
     9	    } else {
    10	      fn();
    11	    }
    12	  }
    13	
    14	  ready(function () {
    15	    var btnEditar   = document.getElementById('btn-editar-torneo');
    16	    var modal       = document.getElementById('modal-editar-torneo');
    17	    var btnCerrar   = document.getElementById('cerrar-modal-editar');
    18	    var btnGuardar  = document.getElementById('guardar-torneo');
    19	
    20	    if (!modal || !btnEditar || !btnGuardar) return;
    21	
    22	    var ajax      = (window.saas_tr_ajax || {});                 // <— objeto global LOCALIZADO
    23	    var ajaxUrl   = ajax.ajax_url || window.ajaxurl || '/wp-admin/admin-ajax.php';
    24	    var ajaxNonce = ajax.nonce || '';                            // <— nonce que valida PHP
    25	
    26	    // Abrir
    27	    btnEditar.addEventListener('click', function (e) {
    28	      e.preventDefault();
    29	      modal.style.display = 'flex';
    30	      document.documentElement.classList.add('saas-tr-modal-open');
    31	      document.body.classList.add('saas-tr-modal-open');
    32	    });
    33	
    34	    // Cerrar (X)
    35	    if (btnCerrar) {
    36	      btnCerrar.addEventListener('click', function () {
    37	        modal.style.display = 'none';
    38	        document.documentElement.classList.remove('saas-tr-modal-open');
    39	        document.body.classList.remove('saas-tr-modal-open');
    40	      });
    41	    }
    42	
    43	    // Cerrar al fondo
    44	    modal.addEventListener('click', function (e) {
    45	      if (e.target === modal) {
    46	        modal.style.display = 'none';
    47	        document.documentElement.classList.remove('saas-tr-modal-open');
    48	        document.body.classList.remove('saas-tr-modal-open');
    49	      }
    50	    });
    51	
    52	    // Guardar
    53	    btnGuardar.addEventListener('click', function () {
    54	      var torneoId   = btnGuardar.getAttribute('data-torneo-id');
    55	      if (!torneoId) { alert('ID de torneo no encontrado.'); return; }
    56	
    57	      var titulo      = modal.querySelector('input[name="titulo"]')?.value || '';
    58	      var descripcion = modal.querySelector('textarea[name="descripcion"]')?.value || '';
    59	      var fecha       = modal.querySelector('input[name="fecha_torneo"]')?.value || '';
    60	      var horaInicio  = modal.querySelector('input[name="hora_inicio"]')?.value || '';
    61	      var horaFin     = modal.querySelector('input[name="hora_fin"]')?.value || '';
    62	
    63	      var fd = new FormData();
    64	      fd.append('action', 'saas_tr_torneo_guardar'); // <— DEBE coincidir con el add_action wp_ajax_...
    65	      fd.append('_ajax_nonce', ajaxNonce);           // <— DEBE coincidir con el check_ajax_referer del PHP
    66	      fd.append('torneo_id', torneoId);
    67	      fd.append('titulo', titulo);
    68	      fd.append('descripcion', descripcion);
    69	      fd.append('fecha_torneo', fecha);
    70	      fd.append('hora_inicio', horaInicio);
    71	      fd.append('hora_fin', horaFin);
    72	
    73	      btnGuardar.disabled = true;
    74	
    75	      fetch(ajaxUrl, { method: 'POST', body: fd })
    76	        .then(function (r) { return r.json(); })
    77	        .then(function (res) {
    78	          if (res && res.success) {
    79	            window.location.reload();
    80	          } else {
    81	            var msg = (res && res.data) ? res.data : 'No se pudo guardar.';
    82	            alert('❌ ' + msg);
    83	            console.error('[TORNEO][GUARDAR] Error:', res);
    84	          }
    85	        })
    86	        .catch(function (err) {
    87	          alert('❌ Error de red/servidor.');
    88	          console.error('[TORNEO][GUARDAR] Fetch error:', err);
    89	        })
    90	        .finally(function () { btnGuardar.disabled = false; });
    91	    });
    92	  });
    93	})();
===== END includes/sports/padel/torneo/index.js =====

===== BEGIN includes/sports/padel/torneo/index.php =====
     1	<?php
     2	/**
     3	 * Template: Ficha de Torneo (frontend) — PÁDEL (adaptada a tus ACF)
     4	 * Ruta: wp-content/plugins/saas-torneos-de-raqueta/includes/sports/padel/torneo/index.php
     5	 */
     6	if ( ! defined( 'ABSPATH' ) ) { exit; }
     7	
     8	get_header();
     9	
    10	global $post;
    11	$torneo_id = $post ? (int) $post->ID : 0;
    12	
    13	
    14	// URL de edición frontend (permite filtrar desde el plugin/tema)
    15	$edit_url = apply_filters( 'saas_tr/torneo_edit_url', '', $torneo_id );
    16	
    17	/**
    18	 * Helpers
    19	 */
    20	function saas_tr_val($v){ return ($v !== '' && $v !== null) ? $v : ''; }
    21	function saas_tr_text($v){ $v = saas_tr_val($v); return $v !== '' ? esc_html($v) : '—'; }
    22	
    23	/**
    24	 * ACF “planos” de competición
    25	 */
    26	$acf_deporte    = function_exists('get_field') ? get_field('deporte', $torneo_id) : '';
    27	$acf_tipo       = function_exists('get_field') ? get_field('tipo_competicion', $torneo_id) : '';
    28	$acf_categoria  = function_exists('get_field') ? get_field('categoria', $torneo_id) : '';
    29	$acf_formato    = function_exists('get_field') ? get_field('formato_competicion', $torneo_id) : '';
    30	$acf_sistema    = function_exists('get_field') ? get_field('sistema_puntuacion', $torneo_id) : '';
    31	$acf_njug       = function_exists('get_field') ? get_field('n_jugadores', $torneo_id) : '';
    32	$acf_desc       = function_exists('get_field') ? get_field('descripcion_competicion', $torneo_id) : '';
    33	
    34	/**
    35	 * Grupo ACF: tipo_competicion_torneo (fecha/hora)
    36	 */
    37	$grp_torneo     = function_exists('get_field') ? get_field('tipo_competicion_torneo', $torneo_id) : '';
    38	$fecha          = '';
    39	$hora_i         = '';
    40	$hora_f         = '';
    41	
    42	if (is_array($grp_torneo) && !empty($grp_torneo)) {
    43	    $fecha  = saas_tr_val( $grp_torneo['fecha_torneo'] ?? '' );
    44	    $hora_i = saas_tr_val( $grp_torneo['hora_inicio']   ?? '' );
    45	    $hora_f = saas_tr_val( $grp_torneo['hora_fin']      ?? '' );
    46	
    47	    if ($fecha === '') {
    48	        foreach (['fecha','fecha_evento','dia'] as $k) {
    49	            if (!empty($grp_torneo[$k])) { $fecha = $grp_torneo[$k]; break; }
    50	        }
    51	    }
    52	    if ($hora_i === '') {
    53	        foreach (['hora_inicio','hora_incio','inicio','hora_inicio_torneo'] as $k) {
    54	            if (!empty($grp_torneo[$k])) { $hora_i = $grp_torneo[$k]; break; }
    55	        }
    56	    }
    57	    if ($hora_f === '') {
    58	        foreach (['hora_fin','fin','hora_fin_torneo'] as $k) {
    59	            if (!empty($grp_torneo[$k])) { $hora_f = $grp_torneo[$k]; break; }
    60	        }
    61	    }
    62	}
    63	
    64	// Fallback metas planas si no vino del grupo
    65	if ($fecha === '')  { $fecha  = saas_tr_val( get_post_meta($torneo_id, 'fecha', true) ); }
    66	if ($hora_i === '') { $hora_i = saas_tr_val( get_post_meta($torneo_id, 'hora_inicio', true) ); }
    67	if ($hora_f === '') { $hora_f = saas_tr_val( get_post_meta($torneo_id, 'hora_fin', true) ); }
    68	
    69	?>
    70	<div class="saas-tr-contenedor saas-tr-torneo" id="saas-tr-torneo"
    71	     data-torneo-id="<?php echo esc_attr( $torneo_id ); ?>">
    72	
    73	    <h1 class="saas-tr-titulo"><?php echo esc_html( get_the_title() ); ?></h1>
    74	
    75	    <ul class="saas-tr-meta">
    76	        <li><strong><?php esc_html_e( 'Deporte', 'saas-torneos' ); ?>:</strong> <?php echo saas_tr_text($acf_deporte); ?></li>
    77	        <li><strong><?php esc_html_e( 'Tipo de competición', 'saas-torneos' ); ?>:</strong> <?php echo saas_tr_text($acf_tipo); ?></li>
    78	        <li><strong><?php esc_html_e( 'Categoría', 'saas-torneos' ); ?>:</strong> <?php echo saas_tr_text($acf_categoria); ?></li>
    79	        <li><strong><?php esc_html_e( 'Formato', 'saas-torneos' ); ?>:</strong> <?php echo saas_tr_text($acf_formato); ?></li>
    80	        <li><strong><?php esc_html_e( 'Sistema de puntuación', 'saas-torneos' ); ?>:</strong> <?php echo saas_tr_text($acf_sistema); ?></li>
    81	        <li><strong><?php esc_html_e( 'Nº jugadores', 'saas-torneos' ); ?>:</strong> <?php echo saas_tr_text($acf_njug); ?></li>
    82	        <li><strong><?php esc_html_e( 'Fecha', 'saas-torneos' ); ?>:</strong> <?php echo saas_tr_text($fecha); ?></li>
    83	        <li><strong><?php esc_html_e( 'Horario', 'saas-torneos' ); ?>:</strong>
    84	            <?php
    85	            $horario = [];
    86	            if ( $hora_i ) { $horario[] = $hora_i; }
    87	            if ( $hora_f ) { $horario[] = $hora_f; }
    88	            echo $horario ? esc_html( implode( ' — ', $horario ) ) : '—';
    89	            ?>
    90	        </li>
    91	        <li><strong><?php esc_html_e( 'Código del torneo', 'saas-torneos' ); ?>:</strong> <?php echo (int) $torneo_id; ?></li>
    92	    </ul>
    93	
    94	    <?php if ($acf_desc): ?>
    95	        <div class="saas-tr-descripcion">
    96	            <?php echo wp_kses_post( wpautop( $acf_desc ) ); ?>
    97	        </div>
    98	    <?php endif; ?>
    99	
   100	    <p>
   101	        <button type="button"
   102	                id="btn-editar-torneo"
   103	                class="saas-tr-btn saas-tr-btn--light"
   104	                data-torneo-id="<?php echo esc_attr( $torneo_id ); ?>">
   105	            <?php esc_html_e( 'Editar torneo', 'saas-torneos' ); ?>
   106	        </button>
   107	    </p>
   108	
   109	
   110	    <!-- === PAREJAS === -->
   111	    <section class="saas-tr-bloque saas-tr-bloque--parejas" id="saas-tr-parejas">
   112	        <h2><?php esc_html_e( 'Parejas', 'saas-torneos' ); ?></h2>
   113	        <div class="saas-tr-acciones">
   114	            <button type="button" class="saas-tr-btn js-add-pareja"><?php esc_html_e( '+ Añadir pareja', 'saas-torneos' ); ?></button>
   115	            <button type="button" class="saas-tr-btn js-add-jugador"><?php esc_html_e( '+ Añadir jugador', 'saas-torneos' ); ?></button>
   116	        </div>
   117	
   118	        <div class="saas-tr-tabla-wrap">
   119	            <table class="saas-tr-tabla" id="tabla-parejas">
   120	                <thead>
   121	                <tr>
   122	                    <th><?php esc_html_e( 'Nº', 'saas-torneos' ); ?></th>
   123	                    <th><?php esc_html_e( 'Jugador 1', 'saas-torneos' ); ?></th>
   124	                    <th><?php esc_html_e( 'Jugador 2', 'saas-torneos' ); ?></th>
   125	                    <th><?php esc_html_e( 'Acciones', 'saas-torneos' ); ?></th>
   126	                </tr>
   127	                </thead>
   128	                <tbody id="saas-tr-parejas-body"><!-- Relleno por JS (pairs/index.js) --></tbody>
   129	            </table>
   130	        </div>
   131	    </section>
   132	
   133	    <!-- === GESTIÓN DE GRUPOS === -->
   134	    <?php
   135	// 1) incluir el renderer (solo una vez)
   136	require_once WP_PLUGIN_DIR . '/saas-torneos-de-raqueta/includes/features/groups/render-grupos.php';
   137	
   138	// 2) resolver el ID de la competición que estás mostrando en este template
   139	//    adapta esto a tu variable real; a modo de ejemplo:
   140	$comp_id = isset($post) && $post->post_type === 'competicion' ? (int)$post->ID : 0;
   141	// o si ya tienes la variable $torneo_id / $competicion_id úsala directamente.
   142	
   143	// 3) renderizar
   144	echo str_competicion_grupos_render([
   145	  'competicion_id' => $comp_id, // <-- pon aquí tu ID real
   146	  'print_css'      => true       // o false si prefieres usar tus estilos
   147	]);
   148	?>
   149	    <section class="saas-tr-bloque saas-tr-bloque--grupos" id="saas-tr-grupos"
   150	             data-action-cargar="saas_grupos_cargar"
   151	             data-action-recalcular="saas_grupos_standings"
   152	             data-action-asignar-pareja="saas_grupo_asignar_pareja">
   153	        <h2><?php esc_html_e( 'Gestión de grupos', 'saas-torneos' ); ?></h2>
   154	
   155	        <button type="button" class="saas-tr-btn saas-tr-btn--primary js-recalcular-standings">
   156	            <?php esc_html_e( 'Recalcular clasificación', 'saas-torneos' ); ?>
   157	        </button>
   158	
   159	        <div id="saas-tr-grupos-libres" class="saas-tr-seccion">
   160	            <h3><?php esc_html_e( 'Grupos y Parejas libres', 'saas-torneos' ); ?></h3>
   161	            <div class="saas-tr-hint"><?php esc_html_e( 'Cargando grupos y parejas libres…', 'saas-torneos' ); ?></div>
   162	            <div class="saas-tr-grid" data-slot="grupos"><!-- JS (módulo groups) --></div>
   163	            <div class="saas-tr-grid" data-slot="parejas-libres"><!-- JS (módulo groups) --></div>
   164	        </div>
   165	
   166	        <div id="saas-tr-standings" class="saas-tr-seccion">
   167	            <h3><?php esc_html_e( 'Clasificación', 'saas-torneos' ); ?></h3>
   168	            <div class="saas-tr-hint"><?php esc_html_e( 'Calculando standings…', 'saas-torneos' ); ?></div>
   169	            <div class="saas-tr-grid" data-slot="standings"><!-- JS (módulo groups) --></div>
   170	        </div>
   171	
   172	        <div id="saas-tr-bracket" class="saas-tr-seccion">
   173	            <h3><?php esc_html_e( 'Fase final (Bracket)', 'saas-torneos' ); ?></h3>
   174	            <div class="saas-tr-hint"><?php esc_html_e( 'Acciones para volcar la fase final con los clasificados actuales.', 'saas-torneos' ); ?></div>
   175	            <div class="saas-tr-grid" data-slot="bracket"><!-- JS (módulo groups) --></div>
   176	        </div>
   177	    </section>
   178	
   179	    <!-- === PARTIDOS & RESULTADOS (vista co-localizada) === -->
   180	    <section class="saas-tr-bloque saas-tr-bloque--partidos" id="saas-tr-partidos">
   181	        <h2><?php esc_html_e( 'Partidos del torneo', 'saas-torneos' ); ?></h2>
   182	
   183	        <?php
   184	        // Consulta de partidos asociados a este torneo
   185	        // ACF del CPT partido: meta_key 'competicion_padel' con ID del torneo
   186	        $args = [
   187	            'post_type'      => 'partido',
   188	            'posts_per_page' => -1,
   189	            'post_status'    => ['publish','pending','draft'],
   190	            'meta_query'     => [
   191	                [
   192	                    'key'     => 'competicion_padel',
   193	                    'value'   => $torneo_id,
   194	                    'compare' => '='
   195	                ]
   196	            ],
   197	            'orderby' => 'date',
   198	            'order'   => 'DESC',
   199	        ];
   200	        $q_partidos = new WP_Query($args);
   201	
   202	        if ($q_partidos->have_posts()):
   203	            ?>
   204	            <div class="saas-tr-lista-partidos">
   205	                <?php
   206	                while ($q_partidos->have_posts()): $q_partidos->the_post();
   207	                    $partido_id = (int) get_the_ID();
   208	
   209	                    // Incluimos la vista co-localizada del módulo de resultados (Pádel).
   210	                    $view_resultado = STR_PLUGIN_PATH . 'includes/features/results/padel/view.php';
   211	                    if (file_exists($view_resultado)) {
   212	                        $GLOBALS['saas_tr_partido_id'] = $partido_id;
   213	                        include $view_resultado;
   214	                        unset($GLOBALS['saas_tr_partido_id']);
   215	                    } else {
   216	                        echo '<div class="saas-tr-hint">'.esc_html__('Vista de resultado no encontrada.', 'saas-torneos').'</div>';
   217	                    }
   218	                endwhile;
   219	                wp_reset_postdata();
   220	                ?>
   221	            </div>
   222	        <?php else: ?>
   223	            <div class="saas-tr-hint">
   224	                <?php esc_html_e( 'No hay partidos creados para este torneo.', 'saas-torneos' ); ?>
   225	            </div>
   226	        <?php endif; ?>
   227	    </section>
   228	
   229	    <!-- ====== MODALES (WRAPPERS) ====== -->
   230	
   231	    <!-- Modal: PAREJAS MULTISELECCIÓN (contenido incrustado) -->
   232	    <div id="modal-parejas-multiseleccion" class="saas-tr-modal" aria-hidden="true" style="display:none;">
   233	        <div class="saas-tr-modal__backdrop js-close-modal" data-close="overlay"></div>
   234	
   235	        <div class="saas-tr-modal__dialog" role="dialog" aria-modal="true" aria-label="<?php esc_attr_e('Crear parejas para la competición', 'saas-torneos'); ?>">
   236	            <button type="button" class="saas-tr-modal__close js-close-modal" aria-label="<?php esc_attr_e('Cerrar', 'saas-torneos'); ?>">×</button>
   237	
   238	            <div class="saas-tr-modal__content" id="modal-parejas-multiseleccion-content">
   239	                <?php
   240	                // El JS de pairs NO descarga por AJAX: necesita el HTML aquí dentro.
   241	                $form_parejas = STR_PLUGIN_PATH . 'includes/forms/form-parejas-multiseleccion.php';
   242	                if ( file_exists($form_parejas) ) {
   243	                    include $form_parejas;
   244	                } else {
   245	                    echo '<div class="saas-tr-hint">'.esc_html__('No se encontró el formulario de parejas.', 'saas-torneos').'</div>';
   246	                }
   247	                ?>
   248	            </div>
   249	        </div>
   250	    </div>
   251	
   252	    <!-- Modal: INVITACIÓN JUGADOR (el contenido lo inyecta players por AJAX) -->
   253	    <div id="modal-invitacion-jugador" class="saas-tr-modal" aria-hidden="true" style="display:none;">
   254	        <div class="saas-tr-modal__backdrop js-close-modal" data-close="overlay"></div>
   255	
   256	        <div class="saas-tr-modal__dialog" role="dialog" aria-modal="true" aria-label="<?php esc_attr_e('Añadir jugadores', 'saas-torneos'); ?>">
   257	            <button type="button" class="saas-tr-modal__close js-close-modal" aria-label="<?php esc_attr_e('Cerrar', 'saas-torneos'); ?>">×</button>
   258	
   259	            <div class="saas-tr-modal__content" id="modal-invitacion-jugador-content"><!-- AJAX (players) --></div>
   260	        </div>
   261	    </div>
   262	
   263	</div>
   264	
   265	<!-- Modal Editar Torneo (sin estilos inline; lo estiliza tournaments/index.css) -->
   266	<div id="modal-editar-torneo" class="saas-tr-modal saas-tr-modal--editar" style="display:none;">
   267	  <div class="saas-tr-modal__backdrop js-close-modal" data-close="overlay"></div>
   268	
   269	  <div class="saas-tr-modal__dialog" role="dialog" aria-modal="true" aria-label="<?php esc_attr_e('Editar torneo', 'saas-torneos'); ?>">
   270	    <button type="button" id="cerrar-modal-editar" class="saas-tr-modal__close js-close-modal" aria-label="<?php esc_attr_e('Cerrar', 'saas-torneos'); ?>">×</button>
   271	
   272	    <h3 class="saas-tr-modal__title"><?php esc_html_e('Editar torneo', 'saas-torneos'); ?></h3>
   273	
   274	    <div class="saas-tr-form-grid">
   275	      <div class="saas-tr-form-row saas-tr-form-row--full">
   276	        <label class="saas-tr-label"><?php esc_html_e('Título', 'saas-torneos'); ?></label>
   277	        <input type="text" name="titulo" value="<?php echo esc_attr(get_the_title($torneo_id)); ?>" class="saas-tr-input">
   278	      </div>
   279	
   280	      <div class="saas-tr-form-row saas-tr-form-row--full">
   281	        <label class="saas-tr-label"><?php esc_html_e('Descripción', 'saas-torneos'); ?></label>
   282	        <textarea name="descripcion" rows="4" class="saas-tr-textarea"><?php
   283	            echo esc_textarea( $acf_desc ?: '' );
   284	        ?></textarea>
   285	      </div>
   286	
   287	      <div class="saas-tr-form-row">
   288	        <label class="saas-tr-label"><?php esc_html_e('Fecha', 'saas-torneos'); ?></label>
   289	        <input type="date" name="fecha_torneo" value="<?php echo esc_attr($fecha); ?>" class="saas-tr-input">
   290	      </div>
   291	
   292	      <div class="saas-tr-form-row">
   293	        <label class="saas-tr-label"><?php esc_html_e('Hora inicio', 'saas-torneos'); ?></label>
   294	        <input type="time" name="hora_inicio" value="<?php echo esc_attr($hora_i); ?>" class="saas-tr-input">
   295	      </div>
   296	
   297	      <div class="saas-tr-form-row">
   298	        <label class="saas-tr-label"><?php esc_html_e('Hora fin', 'saas-torneos'); ?></label>
   299	        <input type="time" name="hora_fin" value="<?php echo esc_attr($hora_f); ?>" class="saas-tr-input">
   300	      </div>
   301	    </div>
   302	
   303	    <div class="saas-tr-modal__actions">
   304	      <button type="button" id="guardar-torneo"
   305	              data-torneo-id="<?php echo esc_attr( $torneo_id ); ?>"
   306	              class="saas-tr-btn saas-tr-btn--primary">
   307	        <?php esc_html_e('Guardar cambios', 'saas-torneos'); ?>
   308	      </button>
   309	      <button type="button" id="cancelar-editar-torneo" class="saas-tr-btn saas-tr-btn--light js-close-modal">
   310	        <?php esc_html_e('Cancelar', 'saas-torneos'); ?>
   311	      </button>
   312	    </div>
   313	  </div>
   314	</div>
   315	
   316	<?php
   317	get_footer();
===== END includes/sports/padel/torneo/index.php =====

===== BEGIN saas-torneos-de-raqueta.php =====
     1	<?php
     2	/**
     3	 * Plugin Name: SaaS Torneos de Raqueta
     4	 * Description: Plugin para la gestión de competiciones de pádel, tenis, pickleball y tenis playa.
     5	 * Version: 1.0.0
     6	 * Author: Tu Nombre
     7	 * Text Domain: saas-torneos
     8	 * Domain Path: /languages
     9	 */
    10	
    11	if ( ! defined( 'ABSPATH' ) ) exit; // Evitar acceso directo
    12	
    13	if ( ! defined( 'STR_PLUGIN_VERSION' ) ) {
    14	    define( 'STR_PLUGIN_VERSION', '0.2.0' ); // pon aquí tu versión actual para probar
    15	}
    16	
    17	/**
    18	 * Registrar el shortcode [str_version]
    19	 * Devuelve la versión del plugin.
    20	 */
    21	add_action( 'init', function () {
    22	    add_shortcode( 'str_version', function () {
    23	        return 'SaaS Torneos versión: ' . esc_html( STR_PLUGIN_VERSION );
    24	    } );
    25	} );
    26	
    27	// ======================================================
    28	// Constantes
    29	// ======================================================
    30	define( 'STR_PLUGIN_PATH', plugin_dir_path( __FILE__ ) );
    31	define( 'STR_PLUGIN_URL',  plugin_dir_url( __FILE__ ) );
    32	
    33	// ======================================================
    34	// Guardián de errores críticos (solo LOG, sin alterar lógica)
    35	// ======================================================
    36	if ( ! function_exists('str_trap_php_errors_init') ) {
    37	
    38	    // Fallback local por si str_escribir_log aún no existe cuando disparemos
    39	    if ( ! function_exists('str__safe_write_log') ) {
    40	        function str__safe_write_log( $msg, $tag = 'FATAL-GUARD' ) {
    41	            $base = defined('STR_PLUGIN_PATH') ? STR_PLUGIN_PATH : plugin_dir_path(__FILE__);
    42	            $ruta = rtrim($base, '/\\') . '/debug-saas-torneos.log';
    43	            $ts   = date('[Y-m-d H:i:s]');
    44	            if (is_array($msg) || is_object($msg)) { $msg = print_r($msg, true); }
    45	            @file_put_contents($ruta, $ts . " [$tag] " . $msg . PHP_EOL, FILE_APPEND | LOCK_EX);
    46	        }
    47	    }
    48	
    49	    function str_trap_php_errors_init() {
    50	        set_error_handler(function($errno, $errstr, $errfile, $errline){
    51	            if (!(error_reporting() & $errno)) { return false; }
    52	            $m = "[PHP-ERROR:$errno] $errstr | $errfile:$errline";
    53	            if (function_exists('str_escribir_log')) { str_escribir_log($m, 'FATAL-GUARD'); }
    54	            else { str__safe_write_log($m, 'FATAL-GUARD'); }
    55	            return false;
    56	        });
    57	
    58	        set_exception_handler(function($ex){
    59	            $m = get_class($ex) . ': ' . $ex->getMessage() . ' | ' . $ex->getFile() . ':' . $ex->getLine();
    60	            if (function_exists('str_escribir_log')) { str_escribir_log($m, 'FATAL-GUARD-EX'); }
    61	            else { str__safe_write_log($m, 'FATAL-GUARD-EX'); }
    62	        });
    63	
    64	        register_shutdown_function(function(){
    65	            $e = error_get_last();
    66	            if ($e && in_array($e['type'], [E_ERROR, E_PARSE, E_CORE_ERROR, E_COMPILE_ERROR, E_USER_ERROR])) {
    67	                $m = "[{$e['type']}] {$e['message']} | {$e['file']}:{$e['line']}";
    68	                if (function_exists('str_escribir_log')) { str_escribir_log($m, 'FATAL-SHUTDOWN'); }
    69	                else { str__safe_write_log($m, 'FATAL-SHUTDOWN'); }
    70	            }
    71	        });
    72	    }
    73	    str_trap_php_errors_init();
    74	}
    75	
    76	// ======================================================
    77	if ( ! function_exists( 'str_escribir_log' ) ) {
    78	    function str_escribir_log( $mensaje, $origen = '' ) {
    79	        $ruta_log = STR_PLUGIN_PATH . 'debug-saas-torneos.log';
    80	        $timestamp = date('[Y-m-d H:i:s]');
    81	        $origen = $origen ? "[$origen]" : '';
    82	        if ( is_array($mensaje) || is_object($mensaje) ) {
    83	            $mensaje = print_r($mensaje, true);
    84	        }
    85	        $linea = "$timestamp $origen $mensaje" . PHP_EOL;
    86	        @file_put_contents( $ruta_log, $linea, FILE_APPEND | LOCK_EX );
    87	    }
    88	}
    89	
    90	// ======================================================
    91	// Diagnóstico mínimo (mantener arriba)
    92	// ======================================================
    93	require_once STR_PLUGIN_PATH . 'includes/diagnostico.php';
    94	
    95	// ======================================================
    96	// ENDPOINT simulador: /panel/simulador-torneo/
    97	// ======================================================
    98	add_action('init', function() {
    99	    add_rewrite_rule('^panel/simulador-torneo/?$', 'index.php?simulador_torneo=1', 'top');
   100	});
   101	add_filter('query_vars', function($vars){
   102	    $vars[] = 'simulador_torneo';
   103	    return $vars;
   104	});
   105	add_action('template_include', function($template){
   106	    if (intval(get_query_var('simulador_torneo')) === 1) {
   107	        if (is_user_logged_in() && (current_user_can('cliente') || current_user_can('administrator'))) {
   108	            return STR_PLUGIN_PATH . 'includes/features/simulator/index.php';
   109	        } else {
   110	            wp_redirect( home_url('/login/') );
   111	            exit;
   112	        }
   113	    }
   114	    return $template;
   115	});
   116	
   117	// ======================================================
   118	// Font Awesome (global)
   119	// ======================================================
   120	add_action( 'wp_enqueue_scripts', function() {
   121	    wp_enqueue_style( 'font-awesome', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css' );
   122	});
   123	
   124	// ======================================================
   125	require_once STR_PLUGIN_PATH . 'includes/cpt/cpt-competicion.php';
   126	require_once STR_PLUGIN_PATH . 'includes/cpt/cpt-jugadores.php';
   127	require_once STR_PLUGIN_PATH . 'includes/cpt/cpt-parejas.php';
   128	require_once STR_PLUGIN_PATH . 'includes/cpt/cpt-partidos.php';
   129	require_once STR_PLUGIN_PATH . 'includes/cpt/cpt-grupo.php';
   130	
   131	require_once STR_PLUGIN_PATH . 'includes/functions/roles.php';
   132	require_once STR_PLUGIN_PATH . 'includes/functions/shortcodes.php';
   133	require_once STR_PLUGIN_PATH . 'includes/shortcodes/init.php';
   134	require_once STR_PLUGIN_PATH . 'includes/functions/crear-competicion.php';
   135	require_once STR_PLUGIN_PATH . 'includes/functions/login-redirect.php';
   136	
   137	// Admin columns
   138	require_once STR_PLUGIN_PATH . 'includes/admin-columns/columns-competicion.php';
   139	require_once STR_PLUGIN_PATH . 'includes/admin-columns/columns-jugadores.php';
   140	require_once STR_PLUGIN_PATH . 'includes/features/groups/ajax/manage.php';
   141	
   142	// Matches (sistema de partidos) – Skeleton FASE A.2
   143	require_once plugin_dir_path( __FILE__ ) . 'includes/features/matches/model.php';
   144	require_once plugin_dir_path( __FILE__ ) . 'includes/features/matches/rest.php';
   145	
   146	// ======================================================
   147	// AUTOLOAD de AJAX por módulos “features” (sin logs)
   148	// ======================================================
   149	$__STR_AJAX_MAP = (function () {
   150	    return [
   151	
   152	        // PLAYERS
   153	        'saas_cargar_modal_invitacion' => [
   154	            'includes/features/players/ajax/cargar-modal.php',
   155	            'includes/ajax/ajax-cargar-modal-invitacion.php',
   156	        ],
   157	        'saas_invitacion_automatica' => [
   158	            'includes/features/players/ajax/cargar-form-automatica.php',
   159	            'includes/ajax/ajax-cargar-form-invitacion-automatica.php',
   160	        ],
   161	        'saas_invitacion_manual' => [
   162	            'includes/features/players/ajax/cargar-form-manual.php',
   163	            'includes/ajax/ajax-cargar-form-invitacion-manual.php',
   164	        ],
   165	        'saas_invitacion_enviar' => [
   166	            'includes/features/players/ajax/invitar-jugador.php',
   167	            'includes/ajax/ajax-invitar-jugador.php',
   168	        ],
   169	        'saas_invitacion_enviar_manual' => [
   170	            'includes/features/players/ajax/invitar-jugador-manual.php',
   171	            'includes/ajax/ajax-invitar-jugador-manual.php',
   172	        ],
   173	        'saas_registro_jugador' => [
   174	            'includes/features/players/ajax/registro-jugador.php',
   175	            'includes/ajax/ajax-registro-jugador.php',
   176	        ],
   177	        'saas_comprobar_jugador' => [
   178	            'includes/features/players/ajax/comprobar-jugador.php',
   179	            'includes/ajax/ajax-comprobar-jugador.php',
   180	        ],
   181	        'saas_cargar_estadisticas_jugador' => [
   182	            'includes/features/players/ajax/cargar-estadisticas.php',
   183	            'includes/ajax/ajax-cargar-estadisticas-jugador.php',
   184	        ],
   185	        'saas_cargar_competiciones_jugador' => [
   186	            'includes/features/players/ajax/cargar-competiciones.php',
   187	            'includes/ajax/ajax-cargar-competiciones-jugador.php',
   188	        ],
   189	        'saas_editar_jugador' => [
   190	            'includes/features/players/ajax/editar-jugador.php',
   191	            'includes/ajax/ajax-editar-jugador.php',
   192	        ],
   193	
   194	        // PAIRS
   195	        'saas_buscar_jugadores' => [
   196	            'includes/features/pairs/ajax/buscar-jugadores.php',
   197	            'includes/ajax/ajax-buscar-jugadores.php',
   198	        ],
   199	        'saas_guardar_pareja_multiseleccion' => [
   200	            'includes/features/pairs/ajax/guardar-pareja.php',
   201	            'includes/ajax/ajax-guardar-pareja-multiseleccion.php',
   202	        ],
   203	        'saas_listar_parejas_multiseleccion' => [
   204	            'includes/features/pairs/ajax/listar-parejas.php',
   205	            'includes/ajax/ajax-listar-parejas-multiseleccion.php',
   206	        ],
   207	
   208	        // GROUPS
   209	        // (las acciones concretas de crear/asignar/quitar se cargarán
   210	        // desde los archivos si existen — el autoloader los incluye si file_exists)
   211	        'saas_grupo_crear' => [
   212	            'includes/features/groups/ajax/grupo-crear.php',
   213	            'includes/ajax/ajax-grupo-crear.php',
   214	        ],
   215	        'str_grupo_crear' => [
   216	            'includes/features/groups/ajax/grupo-crear.php',
   217	            'includes/ajax/ajax-grupo-crear.php',
   218	        ],
   219	
   220	        'saas_grupos_cargar' => [
   221	            'includes/features/groups/ajax/grupos-cargar.php',
   222	            'includes/ajax/ajax-grupos-cargar.php',
   223	        ],
   224	        'saas_grupos_aleatorio' => [
   225	            'includes/features/groups/ajax/grupos-aleatorio.php',
   226	            'includes/ajax/ajax-grupos-aleatorio.php',
   227	        ],
   228	        'saas_grupo_asignar_pareja' => [
   229	            'includes/features/groups/ajax/grupo-asignar-pareja.php',
   230	            'includes/ajax/ajax-grupo-asignar-pareja.php',
   231	        ],
   232	        'saas_grupos_standings' => [
   233	            'includes/features/groups/ajax/standings-grupo.php',
   234	            'includes/ajax/ajax-standings-grupo.php',
   235	        ],
   236	        'saas_bracket_volcar' => [
   237	            'includes/features/groups/ajax/bracket-volcar.php',
   238	            'includes/ajax/ajax-bracket-volcar.php',
   239	        ],
   240	
   241	        // RESULTS — Pádel
   242	        'str_guardar_resultado' => [
   243	            'includes/features/results/padel/ajax/guardar-resultado.php',
   244	            'includes/ajax/ajax-guardar-resultado.php',
   245	        ],
   246	
   247	        // TORNEO - edición básica (legacy)
   248	        'saas_guardar_torneo' => [
   249	            'includes/ajax/ajax-guardar-torneo.php',
   250	        ],
   251	
   252	        // SIMULADOR (legacy)
   253	        'saas_simular_torneo' => [
   254	            'includes/ajax/ajax-simular-torneo.php',
   255	        ],
   256	        'saas_guardar_simulacion' => [
   257	            'includes/ajax/ajax-guardar-simulacion.php',
   258	        ],
   259	
   260	        // EDITAR TORNEO (guardar por AJAX)
   261	        'str_guardar_torneo_editado' => [
   262	            'includes/features/tournaments/ajax/guardar-torneo.php',
   263	            'includes/ajax/ajax-guardar-torneo-editado.php',
   264	        ],
   265	
   266	    ];
   267	})();
   268	
   269	(function ($ajax_map) {
   270	    foreach ( $ajax_map as $action => $paths ) {
   271	        $found = false;
   272	        foreach ( $paths as $idx => $rel ) {
   273	            $abs = STR_PLUGIN_PATH . $rel;
   274	            if ( file_exists( $abs ) ) {
   275	                require_once $abs;
   276	                $found = true;
   277	                break;
   278	            }
   279	        }
   280	        // Si no se encuentra, se omite silenciosamente (sin logs)
   281	    }
   282	})($__STR_AJAX_MAP);
   283	
   284	
   285	
   286	// ======================================================
   287	// AUDITORÍA F11 (temporal): /wp-admin/?str_audit=1 (sin logs)
   288	// ======================================================
   289	add_action('admin_init', function() use ($__STR_AJAX_MAP) {
   290	    if ( ! current_user_can('administrator') ) return;
   291	    if ( ! isset($_GET['str_audit']) || intval($_GET['str_audit']) !== 1 ) return;
   292	
   293	    $legacy_dir = STR_PLUGIN_PATH . 'includes/ajax/';
   294	    $legacy = [];
   295	    if ( is_dir($legacy_dir) ) {
   296	        foreach ( glob($legacy_dir . '*.php') as $file ) {
   297	            $legacy[] = str_replace(STR_PLUGIN_PATH, '', $file);
   298	        }
   299	    }
   300	
   301	    foreach ($legacy as $relPath) {
   302	        $mapped_action = null;
   303	        $features_path = null;
   304	
   305	        foreach ($__STR_AJAX_MAP as $action => $paths) {
   306	            if ( in_array($relPath, $paths, true) ) {
   307	                $mapped_action = $action;
   308	                $features_path = $paths[0] ?? null;
   309	                break;
   310	            }
   311	        }
   312	        // Sin salida visible; solo auditoría.
   313	    }
   314	});
   315	
   316	// ======================================================
   317	// Filtros de correo (remitente)
   318	// ======================================================
   319	add_filter('wp_mail_from', function($from_email) { return 'info@torneospadelxperience.es'; });
   320	add_filter('wp_mail_from_name', function($from_name) { return 'Torneos Padel Xperience'; });
   321	
   322	// ======================================================
   323	// i18n
   324	// ======================================================
   325	add_action( 'plugins_loaded', function() {
   326	    load_plugin_textdomain( 'saas-torneos', false, dirname( plugin_basename(__FILE__) ) . '/languages' );
   327	});
   328	
   329	// ======================================================
   330	// Enqueue: frontend base
   331	// ======================================================
   332	add_action('wp_enqueue_scripts', function() {
   333	    wp_enqueue_style(
   334	        'str-frontend-css',
   335	        STR_PLUGIN_URL . 'assets/css/frontend.css',
   336	        [],
   337	        '1.0'
   338	    );
   339	
   340	    wp_enqueue_script(
   341	        'str-frontend-js',
   342	        STR_PLUGIN_URL . 'assets/js/frontend.js',
   343	        ['jquery'],
   344	        '1.0',
   345	        true
   346	    );
   347	
   348	    wp_localize_script('str-frontend-js', 'str_ajax_obj', [
   349	        'ajax_url' => admin_url('admin-ajax.php'),
   350	        'nonce'    => wp_create_nonce('str_nonce')
   351	    ]);
   352	});
   353	
   354	// ======================================================
   355	// Enqueue: dashboard cliente (condicional)
   356	// ======================================================
   357	add_action('wp_enqueue_scripts', function() {
   358	    if ( is_page(['panel-del-cliente', 'mis-competiciones', 'jugadores', 'ajustes']) ) {
   359	        wp_enqueue_style(
   360	            'str-dashboard-cliente-css',
   361	            STR_PLUGIN_URL . 'assets/css/dashboard-cliente.css',
   362	            [],
   363	            '1.1'
   364	        );
   365	    }
   366	});
   367	
   368	// ======================================================
   369	// Enqueue: crear competición (shortcode/página)
   370	// ======================================================
   371	add_action('wp_enqueue_scripts', function() {
   372	    wp_enqueue_script(
   373	        'str-frontend-js',
   374	        STR_PLUGIN_URL . 'assets/js/frontend.js',
   375	        ['jquery'],
   376	        '1.0',
   377	        true
   378	    );
   379	
   380	    if ( (is_page('panel-del-cliente') && (isset($_GET['seccion']) && $_GET['seccion'] === 'nueva-competicion')) || is_page('crear-competicion') ) {
   381	        wp_enqueue_script(
   382	            'str-nueva-competicion-js',
   383	            STR_PLUGIN_URL . 'assets/js/nueva-competicion.js',
   384	            ['jquery'],
   385	            '1.0',
   386	            true
   387	        );
   388	    }
   389	});
   390	
   391	// ======================================================
   392	// Enqueue: simulador (solo en /panel/simulador-torneo/)
   393	// ======================================================
   394	add_action('wp_enqueue_scripts', function() {
   395	    global $wp_query;
   396	    if ( isset($wp_query->query_vars['simulador_torneo']) && intval($wp_query->query_vars['simulador_torneo']) === 1 ) {
   397	        wp_enqueue_script( 'jquery' );
   398	
   399	        wp_enqueue_script(
   400	            'str-simulador-torneo-js',
   401	            STR_PLUGIN_URL . 'assets/js/simulador-torneo.js',
   402	            ['jquery'],
   403	            '1.0',
   404	            true
   405	        );
   406	
   407	        wp_enqueue_style(
   408	            'str-simulador-torneo-css',
   409	            STR_PLUGIN_URL . 'assets/css/simulador-torneo.css',
   410	            [],
   411	            '1.0'
   412	        );
   413	
   414	        wp_localize_script('str-simulador-torneo-js', 'str_ajax_obj', [
   415	            'ajax_url' => admin_url('admin-ajax.php'),
   416	            'nonce'    => wp_create_nonce('str_nonce')
   417	        ]);
   418	    }
   419	});
   420	
   421	// ======================================================
   422	// Routing de plantillas personalizadas
   423	// ======================================================
   424	add_filter('template_include', function($template) {
   425	    if ( ! is_singular('competicion') ) return $template;
   426	
   427	    global $post;
   428	    if ( ! isset($post->ID) ) return $template;
   429	
   430	    $deporte = function_exists('get_field') ? get_field('deporte', $post->ID) : '';
   431	    $tipo    = function_exists('get_field') ? get_field('tipo_competicion', $post->ID) : '';
   432	
   433	    if ( strtolower($deporte) === 'padel' && strtolower($tipo) === 'torneo' ) {
   434	        $torneo_template = STR_PLUGIN_PATH . 'includes/sports/padel/torneo/index.php';
   435	        if ( file_exists($torneo_template) ) return $torneo_template;
   436	    }
   437	
   438	    if ( strtolower($deporte) === 'padel' && strtolower($tipo) === 'ranking' ) {
   439	        $ranking_template = STR_PLUGIN_PATH . 'templates/padel/ranking.php';
   440	        if ( file_exists($ranking_template) ) return $ranking_template;
   441	    }
   442	
   443	    return $template;
   444	}, 10);
   445	
   446	// Perfil de jugador
   447	add_filter('template_include', function($template){
   448	    if ( ! is_singular('jugador_deportes') ) return $template;
   449	
   450	    $perfil_template = STR_PLUGIN_PATH . 'templates/jugador/perfil-jugador.php';
   451	    if ( file_exists($perfil_template) ) return $perfil_template;
   452	
   453	    return $template;
   454	}, 20);
   455	
   456	// Enqueue específico de perfil jugador
   457	add_action('wp_enqueue_scripts', function() {
   458	    if ( is_singular('jugador_deportes') ) {
   459	        wp_enqueue_script(
   460	            'str-perfil-jugador-js',
   461	            STR_PLUGIN_URL . 'assets/js/perfil-jugador.js',
   462	            ['jquery'],
   463	            '1.0',
   464	            true
   465	        );
   466	        wp_localize_script('str-perfil-jugador-js', 'str_ajax_obj', [
   467	            'ajax_url' => admin_url('admin-ajax.php'),
   468	            'nonce'    => wp_create_nonce('str_nonce')
   469	        ]);
   470	    }
   471	});
   472	
   473	// ======================================================
   474	// Enqueue por módulo en la ficha de TORNEO (Pádel)
   475	// ======================================================
   476	add_action('wp_enqueue_scripts', function() {
   477	
   478	    if ( ! is_singular('competicion') ) return;
   479	
   480	    global $post;
   481	    if ( empty($post) ) return;
   482	
   483	    $deporte = function_exists('get_field') ? get_field('deporte', $post->ID) : '';
   484	    $tipo    = function_exists('get_field') ? get_field('tipo_competicion', $post->ID) : '';
   485	    if ( strtolower($deporte) !== 'padel' || strtolower($tipo) !== 'torneo' ) return;
   486	
   487	    $post_id = (int) $post->ID;
   488	
   489	    $reg = function( $handle, $rel_path, $deps = ['jquery'], $in_footer = true, $is_style = false ) {
   490	        $abs = STR_PLUGIN_PATH . $rel_path;
   491	        $ver = file_exists($abs) ? @filemtime($abs) : '1.0';
   492	        $url = STR_PLUGIN_URL  . $rel_path;
   493	
   494	        if ( $is_style ) {
   495	            if ( file_exists($abs) ) {
   496	                wp_register_style( $handle, $url, [], $ver );
   497	                wp_enqueue_style( $handle );
   498	                return true;
   499	            }
   500	        } else {
   501	            if ( file_exists($abs) ) {
   502	                wp_register_script( $handle, $url, $deps, $ver, $in_footer );
   503	                wp_enqueue_script( $handle );
   504	                return true;
   505	            }
   506	        }
   507	        return false;
   508	    };
   509	
   510	    // ---------- VISTA TORNEO ----------
   511	    $ok_js  = $reg('saas-torneo-view-js',  'includes/sports/padel/torneo/index.js');
   512	    $ok_css = $reg('saas-torneo-view-css', 'includes/sports/padel/torneo/index.css', [], false, true);
   513	
   514	    // ---------- PAIRS ----------
   515	    $ok_js  = $reg('saas-pairs-js',  'includes/features/pairs/index.js');
   516	    $ok_css = $reg('saas-pairs-css', 'includes/features/pairs/index.css', [], false, true);
   517	    if ( ! $ok_js ) { $reg('saas-pairs-js',  'assets/js/form-parejas-multiseleccion.js'); }
   518	    if ( ! $ok_css ) { $reg('saas-pairs-css', 'assets/css/form-parejas-multiseleccion.css', [], false, true); }
   519	    wp_localize_script('saas-pairs-js', 'str_parejas_ajax_obj', [
   520	        'ajax_url' => admin_url('admin-ajax.php'),
   521	        'nonce'    => wp_create_nonce('str_parejas_multiseleccion_nonce'),
   522	        'post_id'  => $post_id,
   523	        'actions'  => [
   524	            'buscar'  => 'str_buscar_jugadores',
   525	            'guardar' => 'str_guardar_pareja_multiseleccion',
   526	            'listar'  => 'str_listar_parejas_multiseleccion',
   527	        ],
   528	    ]);
   529	
   530	    // ---------- PLAYERS ----------
   531	    $ok_js  = $reg('saas-players-js',  'includes/features/players/index.js');
   532	    $ok_css = $reg('saas-players-css', 'includes/features/players/index.css', [], false, true);
   533	    if ( ! $ok_js ) { $reg('saas-players-js',  'assets/js/form-invitacion-jugador.js'); }
   534	    if ( ! $ok_css ) {
   535	        $reg('saas-players-css', 'assets/css/form-invitacion-jugador.css', [], false, true);
   536	        $reg('saas-players-css-manual', 'assets/css/form-invitacion-jugador-manual.css', [], false, true);
   537	    }
   538	    wp_localize_script('saas-players-js', 'str_players_ajax_obj', [
   539	        'ajax_url' => admin_url('admin-ajax.php'),
   540	        'nonce'    => wp_create_nonce('str_nonce'),
   541	        'post_id'  => $post_id,
   542	        'actions'  => [
   543	            'cargar_modal'   => 'str_cargar_modal_invitacion',
   544	            'form_auto'      => 'str_cargar_form_invitacion_automatica',
   545	            'form_manual'    => 'str_cargar_form_invitacion_manual',
   546	            'enviar_auto'    => 'str_invitar_jugador',
   547	            'enviar_manual'  => 'str_invitar_jugador_manual',
   548	            'registro_token' => 'str_registro_jugador',
   549	        ],
   550	    ]);
   551	
   552	    // ---------- GROUPS ----------
   553	    $ok_js  = $reg('saas-groups-js',  'includes/features/groups/index.js');
   554	    $ok_css = $reg('saas-groups-css', 'includes/features/groups/index.css', [], false, true);
   555	    if ( ! $ok_js ) { $reg('saas-groups-js',  'assets/js/grupos-torneo.js'); }
   556	    if ( ! $ok_css ) { $reg('saas-groups-css', 'assets/css/grupos-torneo.css', [], false, true); }
   557	
   558	    // **ÚNICO CAMBIO MÍNIMO**: añadimos 'crear' => 'saas_grupo_crear'
   559	    $groups_actions = [
   560	        'crear'     => 'saas_grupo_crear',
   561	        'cargar'    => 'saas_grupos_cargar',
   562	        'aleatorio' => 'saas_grupos_aleatorio',
   563	        'asignar'   => 'saas_grupo_asignar_pareja',
   564	        'standings' => 'saas_grupos_standings',
   565	        'bracket'   => 'saas_bracket_volcar',
   566	    ];
   567	    $groups_payload = [
   568	        'ajax_url' => admin_url('admin-ajax.php'),
   569	        'nonce'    => wp_create_nonce('str_nonce'),
   570	        'post_id'  => $post_id,
   571	        'actions'  => $groups_actions,
   572	    ];
   573	    wp_localize_script('saas-groups-js', 'str_groups_ajax_obj', $groups_payload);
   574	
   575	    // ENQUEUE LOG (lo dejas igual si ya lo tenías)
   576	    try {
   577	        $log_data = [
   578	            'post_id'   => $post_id,
   579	            'has_nonce' => ! empty($groups_payload['nonce']),
   580	            'actions'   => $groups_actions,
   581	            'handle'    => 'saas-groups-js',
   582	            'route'     => 'competicion',
   583	        ];
   584	        str_escribir_log('[GRUPOS:ENQUEUE] ' . wp_json_encode($log_data, JSON_UNESCAPED_UNICODE | JSON_UNESCAPED_SLASHES), 'GROUPS');
   585	    } catch (\Throwable $e) {}
   586	
   587	    // ---------- RESULTS (PÁDEL) ----------
   588	    $ok_js  = $reg('saas-resultado-padel-js',  'includes/features/results/padel/index.js');
   589	    $ok_css = $reg('saas-resultado-padel-css', 'includes/features/results/padel/index.css', [], false, true);
   590	    if ( ! $ok_js ) { $reg('saas-resultado-padel-js',  'assets/js/form-resultado-partido.js'); }
   591	    if ( ! $ok_css ) { $reg('saas-resultado-padel-css', 'assets/css/form-resultado-partido.css', [], false, true); }
   592	    wp_localize_script('saas-resultado-padel-js', 'str_resultado_ajax_obj', [
   593	        'ajax_url' => admin_url('admin-ajax.php'),
   594	        'nonce'    => wp_create_nonce('str_nonce'),
   595	        'post_id'  => $post_id,
   596	        'actions'  => [ 'guardar' => 'str_guardar_resultado' ],
   597	    ]);
   598	
   599	    if ( ! function_exists( 'str_enqueue_tournaments_css_only' ) ) {
   600	        function str_enqueue_tournaments_css_only() {
   601	            if ( ! is_singular( 'competicion' ) ) { return; }
   602	            $rel = 'includes/features/tournaments/index.css';
   603	            $abs = plugin_dir_path( __FILE__ ) . $rel;
   604	            $url = plugin_dir_url( __FILE__ )  . $rel;
   605	            if ( file_exists( $abs ) ) {
   606	                $ver = filemtime( $abs );
   607	                wp_enqueue_style( 'str_tournaments_css', $url, array(), $ver );
   608	            }
   609	        }
   610	        add_action( 'wp_enqueue_scripts', 'str_enqueue_tournaments_css_only', 20 );
   611	    }
   612	
   613	}, 20);
   614	
   615	if (!defined('ABSPATH')) { exit; }
   616	define('STR_PLUGIN_VERSION', '0.1.1'); // súbelo un número
   617	add_shortcode('str_version', fn() => 'SaaS Torneos versión: ' . esc_html(STR_PLUGIN_VERSION));
===== END saas-torneos-de-raqueta.php =====

===== BEGIN templates/dashboard/form-nueva-competicion-backup.php =====
     1	<!-- Contenedor del fondo gris -->
     2	<div id="modal-nueva-competicion" class="str-modal-overlay" style="display: none;" data-modal-auto-open="true">
     3	    <div class="str-modal-contenido">
     4	        <button class="str-modal-cerrar" id="cerrar-modal-competicion">✖</button>
     5	
     6	        <h2>Crear nueva competición</h2>
     7	        <form action="<?php echo esc_url(admin_url('admin-post.php')); ?>" method="POST">
     8	            <input type="hidden" name="action" value="str_guardar_competicion">
     9	            <input type="hidden" name="str_crear_competicion" value="1">
    10	
    11	            <label>Título del torneo</label>
    12	            <input type="text" name="titulo" required>
    13	
    14	            <label>Deporte</label>
    15	            <select name="deporte" required>
    16	                <option value="">Selecciona...</option>
    17	                <option value="Padel">Pádel</option>
    18	                <option value="Tenis">Tenis</option>
    19	                <option value="Pickleball">Pickleball</option>
    20	                <option value="Tenis Playa">Tenis Playa</option>
    21	            </select>
    22	
    23	            <label>Tipo de competición</label>
    24	            <select name="tipo_competicion" required>
    25	                <option value="">Selecciona...</option>
    26	                <option value="Torneo">Torneo</option>
    27	                <option value="Ranking">Ranking</option>
    28	            </select>
    29	
    30	            <label>Categoría</label>
    31	            <select name="categoria" required>
    32	                <option value="">Selecciona...</option>
    33	                <option value="Masculina">Masculina</option>
    34	                <option value="Femenina">Femenina</option>
    35	                <option value="Mixta">Mixta</option>
    36	            </select>
    37	
    38	            <label>Formato</label>
    39	            <select name="formato_competicion" required>
    40	                <option value="">Selecciona...</option>
    41	                <option value="Grupos">Grupos</option>
    42	                <option value="Grupos + Bracket Final">Grupos + Bracket Final</option>
    43	            </select>
    44	
    45	            <label>Sistema de puntuación</label>
    46	            <select name="sistema_puntuacion" required>
    47	                <option value="">Selecciona...</option>
    48	                <option value="3v-1d">Victoria 3 pts / Derrota 1 pt</option>
    49	                <option value="3v-0d">Victoria 3 pts / Derrota 0 pts</option>
    50	            </select>
    51	
    52	            <label>Nº de jugadores/parejas</label>
    53	            <input type="number" name="n_jugadores" min="2" required>
    54	
    55	            <label>Descripción</label>
    56	            <textarea name="descripcion_competicion" rows="3"></textarea>
    57	
    58	            <!-- Condicionales -->
    59	            <div class="tipo_torneo">
    60	                <label>Fecha del torneo</label>
    61	                <input type="date" name="fecha_torneo">
    62	
    63	                <label>Hora inicio</label>
    64	                <input type="time" name="hora_inicio">
    65	
    66	                <label>Hora fin</label>
    67	                <input type="time" name="hora_fin">
    68	            </div>
    69	
    70	            <div class="tipo_ranking">
    71	                <label>Fecha de inicio</label>
    72	                <input type="date" name="fecha_inicio">
    73	
    74	                <label>Fecha de fin</label>
    75	                <input type="date" name="fecha_fin">
    76	            </div>
    77	
    78	            <button type="submit" class="str-btn">Crear competición</button>
    79	        </form>
    80	    </div>
    81	</div>
===== END templates/dashboard/form-nueva-competicion-backup.php =====

===== BEGIN templates/login/login-form.php =====
     1	<?php
     2	// Redirección si ya está logueado
     3	if (!is_admin() && is_user_logged_in() && !current_user_can('administrator')) {
     4	    wp_redirect(home_url('/mis-competiciones'));
     5	    exit;
     6	}
     7	
     8	?>
     9	
    10	<form method="post" action="">
    11	    <h3>Iniciar sesión</h3>
    12	
    13	    <?php if (isset($_GET['login']) && $_GET['login'] == 'failed'): ?>
    14	        <div class="str-error">Usuario o contraseña incorrectos.</div>
    15	    <?php endif; ?>
    16	
    17	    <label for="username">Usuario o correo electrónico</label>
    18	    <input type="text" name="log" id="username" required>
    19	
    20	    <label for="password">Contraseña</label>
    21	    <input type="password" name="pwd" id="password" required>
    22	
    23	    <input type="submit" value="Entrar">
    24	    <input type="hidden" name="str_login_frontend" value="1">
    25	</form>
===== END templates/login/login-form.php =====

===== BEGIN templates/login/register-cliente.php =====
     1	<?php
     2	// Redirección si ya está logueado
     3	if (!is_admin() && is_user_logged_in() && !current_user_can('administrator')) {
     4	    wp_redirect(home_url('/mis-competiciones'));
     5	    exit;
     6	}
     7	
     8	?>
     9	
    10	<form method="post" action="">
    11	    <h3>Registro de cliente</h3>
    12	
    13	    <?php if (isset($_GET['registro']) && $_GET['registro'] == 'fallido'): ?>
    14	        <div class="str-error">Error en el registro. El usuario o email ya existen.</div>
    15	    <?php endif; ?>
    16	
    17	    <label for="username">Nombre de usuario</label>
    18	    <input type="text" name="str_username" id="username" required>
    19	
    20	    <label for="email">Correo electrónico</label>
    21	    <input type="email" name="str_email" id="email" required>
    22	
    23	    <label for="password">Contraseña</label>
    24	    <input type="password" name="str_password" id="password" required>
    25	
    26	    <input type="submit" value="Registrarse">
    27	    <input type="hidden" name="str_registro_cliente" value="1">
    28	</form>
===== END templates/login/register-cliente.php =====

